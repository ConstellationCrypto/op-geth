<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <title>op-geth - go-ethereum fork diff overview</title>

    <link rel="icon" type="image/x-icon" href="">

    <style>
        .line-stat {
            width: 14rem;
            float: right;
        }
        .line-stat div {
            width: 50%;
        }
    </style>

    
<style>
    .term-container {
        background: #171717;
        border-radius: 5px;
        color: white;
        word-break: break-word;
        overflow-wrap: break-word;
        font-family: "SFMono-Regular", Monaco, Menlo, Consolas, "Liberation Mono", Courier, monospace;
        font-size: 12px;
        line-height: 20px;
        padding: 14px 18px;
        white-space: pre-wrap;
    }

    .term-container img { max-width: 100%; }

    .term a { color: inherit; text-decoration: underline; text-decoration-style: dashed; }
    .term a:hover { color: #2882F9 }

    @keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }

    .term-fg1 { } /* don't bold beccause it looks weird */
    .term-fg2 { color: #838887; } /* faint (decreased intensity) - same as gray really */
    .term-fg3 { font-style: italic; } /* italic */
    .term-fg4 { text-decoration: underline; } /* underline */
    .term-fg5 { animation: blink-animation 1s steps(3, start) infinite; } /* blink */
    .term-fg9 { text-decoration: line-through; } /* crossed-out */

    .term-fg30 { color: #666666; } /* black (but we can't use black, so a diff color) */
    .term-fg31 { color: #ff7070; } /* red */
    .term-fg32 { color: #b0f986; } /* green */
    .term-fg33 { color: #c6c502; } /* yellow */
    .term-fg34 { color: #8db7e0; } /* blue */
    .term-fg35 { color: #f271fb; } /* magenta */
    .term-fg36 { color: #6bf7ff; } /* cyan */

    /* high intense colors */
    .term-fgi1 { color: #5ef765; }
    .term-fgi90 { color: #838887; } /* grey */
    .term-fgi91 { color: #ff3333; } /* red */
    .term-fgi92 { color: #00FF00; } /* green */
    .term-fgi93 { color: #fffc67; } /* yellow */
    .term-fgi94 { color: #6871ff; } /* blue */
    .term-fgi95 { color: #ff76ff; } /* magenta */
    .term-fgi96 { color: #60fcff; } /* cyan */

    /* background colors */
    .term-bg40 { background: #676767; } /* grey */
    .term-bg41 { background: #ff4343; } /* red */
    .term-bg42 { background: #99ff5f; } /* green */

    /* custom foreground/background combos for readability */
    .term-fg31.term-bg40 { color: #F8A39F; }

    /* xterm colors */
    .term-fgx16 { color: #000000; }
    .term-fgx17 { color: #00005f; }
    .term-fgx18 { color: #000087; }
    .term-fgx19 { color: #0000af; }
    .term-fgx20 { color: #0000d7; }
    .term-fgx21 { color: #0000ff; }
    .term-fgx22 { color: #005f00; }
    .term-fgx23 { color: #005f5f; }
    .term-fgx24 { color: #005f87; }
    .term-fgx25 { color: #005faf; }
    .term-fgx26 { color: #005fd7; }
    .term-fgx27 { color: #005fff; }
    .term-fgx28 { color: #008700; }
    .term-fgx29 { color: #00875f; }
    .term-fgx30 { color: #008787; }
    .term-fgx31 { color: #0087af; }
    .term-fgx32 { color: #0087d7; }
    .term-fgx33 { color: #0087ff; }
    .term-fgx34 { color: #00af00; }
    .term-fgx35 { color: #00af5f; }
    .term-fgx36 { color: #00af87; }
    .term-fgx37 { color: #00afaf; }
    .term-fgx38 { color: #00afd7; }
    .term-fgx39 { color: #00afff; }
    .term-fgx40 { color: #00d700; }
    .term-fgx41 { color: #00d75f; }
    .term-fgx42 { color: #00d787; }
    .term-fgx43 { color: #00d7af; }
    .term-fgx44 { color: #00d7d7; }
    .term-fgx45 { color: #00d7ff; }
    .term-fgx46 { color: #00ff00; }
    .term-fgx47 { color: #00ff5f; }
    .term-fgx48 { color: #00ff87; }
    .term-fgx49 { color: #00ffaf; }
    .term-fgx50 { color: #00ffd7; }
    .term-fgx51 { color: #00ffff; }
    .term-fgx52 { color: #5f0000; }
    .term-fgx53 { color: #5f005f; }
    .term-fgx54 { color: #5f0087; }
    .term-fgx55 { color: #5f00af; }
    .term-fgx56 { color: #5f00d7; }
    .term-fgx57 { color: #5f00ff; }
    .term-fgx58 { color: #5f5f00; }
    .term-fgx59 { color: #5f5f5f; }
    .term-fgx60 { color: #5f5f87; }
    .term-fgx61 { color: #5f5faf; }
    .term-fgx62 { color: #5f5fd7; }
    .term-fgx63 { color: #5f5fff; }
    .term-fgx64 { color: #5f8700; }
    .term-fgx65 { color: #5f875f; }
    .term-fgx66 { color: #5f8787; }
    .term-fgx67 { color: #5f87af; }
    .term-fgx68 { color: #5f87d7; }
    .term-fgx69 { color: #5f87ff; }
    .term-fgx70 { color: #5faf00; }
    .term-fgx71 { color: #5faf5f; }
    .term-fgx72 { color: #5faf87; }
    .term-fgx73 { color: #5fafaf; }
    .term-fgx74 { color: #5fafd7; }
    .term-fgx75 { color: #5fafff; }
    .term-fgx76 { color: #5fd700; }
    .term-fgx77 { color: #5fd75f; }
    .term-fgx78 { color: #5fd787; }
    .term-fgx79 { color: #5fd7af; }
    .term-fgx80 { color: #5fd7d7; }
    .term-fgx81 { color: #5fd7ff; }
    .term-fgx82 { color: #5fff00; }
    .term-fgx83 { color: #5fff5f; }
    .term-fgx84 { color: #5fff87; }
    .term-fgx85 { color: #5fffaf; }
    .term-fgx86 { color: #5fffd7; }
    .term-fgx87 { color: #5fffff; }
    .term-fgx88 { color: #870000; }
    .term-fgx89 { color: #87005f; }
    .term-fgx90 { color: #870087; }
    .term-fgx91 { color: #8700af; }
    .term-fgx92 { color: #8700d7; }
    .term-fgx93 { color: #8700ff; }
    .term-fgx94 { color: #875f00; }
    .term-fgx95 { color: #875f5f; }
    .term-fgx96 { color: #875f87; }
    .term-fgx97 { color: #875faf; }
    .term-fgx98 { color: #875fd7; }
    .term-fgx99 { color: #875fff; }
    .term-fgx100 { color: #878700; }
    .term-fgx101 { color: #87875f; }
    .term-fgx102 { color: #878787; }
    .term-fgx103 { color: #8787af; }
    .term-fgx104 { color: #8787d7; }
    .term-fgx105 { color: #8787ff; }
    .term-fgx106 { color: #87af00; }
    .term-fgx107 { color: #87af5f; }
    .term-fgx108 { color: #87af87; }
    .term-fgx109 { color: #87afaf; }
    .term-fgx110 { color: #87afd7; }
    .term-fgx111 { color: #87afff; }
    .term-fgx112 { color: #87d700; }
    .term-fgx113 { color: #87d75f; }
    .term-fgx114 { color: #87d787; }
    .term-fgx115 { color: #87d7af; }
    .term-fgx116 { color: #87d7d7; }
    .term-fgx117 { color: #87d7ff; }
    .term-fgx118 { color: #87ff00; }
    .term-fgx119 { color: #87ff5f; }
    .term-fgx120 { color: #87ff87; }
    .term-fgx121 { color: #87ffaf; }
    .term-fgx122 { color: #87ffd7; }
    .term-fgx123 { color: #87ffff; }
    .term-fgx124 { color: #af0000; }
    .term-fgx125 { color: #af005f; }
    .term-fgx126 { color: #af0087; }
    .term-fgx127 { color: #af00af; }
    .term-fgx128 { color: #af00d7; }
    .term-fgx129 { color: #af00ff; }
    .term-fgx130 { color: #af5f00; }
    .term-fgx131 { color: #af5f5f; }
    .term-fgx132 { color: #af5f87; }
    .term-fgx133 { color: #af5faf; }
    .term-fgx134 { color: #af5fd7; }
    .term-fgx135 { color: #af5fff; }
    .term-fgx136 { color: #af8700; }
    .term-fgx137 { color: #af875f; }
    .term-fgx138 { color: #af8787; }
    .term-fgx139 { color: #af87af; }
    .term-fgx140 { color: #af87d7; }
    .term-fgx141 { color: #af87ff; }
    .term-fgx142 { color: #afaf00; }
    .term-fgx143 { color: #afaf5f; }
    .term-fgx144 { color: #afaf87; }
    .term-fgx145 { color: #afafaf; }
    .term-fgx146 { color: #afafd7; }
    .term-fgx147 { color: #afafff; }
    .term-fgx148 { color: #afd700; }
    .term-fgx149 { color: #afd75f; }
    .term-fgx150 { color: #afd787; }
    .term-fgx151 { color: #afd7af; }
    .term-fgx152 { color: #afd7d7; }
    .term-fgx153 { color: #afd7ff; }
    .term-fgx154 { color: #afff00; }
    .term-fgx155 { color: #afff5f; }
    .term-fgx156 { color: #afff87; }
    .term-fgx157 { color: #afffaf; }
    .term-fgx158 { color: #afffd7; }
    .term-fgx159 { color: #afffff; }
    .term-fgx160 { color: #d70000; }
    .term-fgx161 { color: #d7005f; }
    .term-fgx162 { color: #d70087; }
    .term-fgx163 { color: #d700af; }
    .term-fgx164 { color: #d700d7; }
    .term-fgx165 { color: #d700ff; }
    .term-fgx166 { color: #d75f00; }
    .term-fgx167 { color: #d75f5f; }
    .term-fgx168 { color: #d75f87; }
    .term-fgx169 { color: #d75faf; }
    .term-fgx170 { color: #d75fd7; }
    .term-fgx171 { color: #d75fff; }
    .term-fgx172 { color: #d78700; }
    .term-fgx173 { color: #d7875f; }
    .term-fgx174 { color: #d78787; }
    .term-fgx175 { color: #d787af; }
    .term-fgx176 { color: #d787d7; }
    .term-fgx177 { color: #d787ff; }
    .term-fgx178 { color: #d7af00; }
    .term-fgx179 { color: #d7af5f; }
    .term-fgx180 { color: #d7af87; }
    .term-fgx181 { color: #d7afaf; }
    .term-fgx182 { color: #d7afd7; }
    .term-fgx183 { color: #d7afff; }
    .term-fgx184 { color: #d7d700; }
    .term-fgx185 { color: #d7d75f; }
    .term-fgx186 { color: #d7d787; }
    .term-fgx187 { color: #d7d7af; }
    .term-fgx188 { color: #d7d7d7; }
    .term-fgx189 { color: #d7d7ff; }
    .term-fgx190 { color: #d7ff00; }
    .term-fgx191 { color: #d7ff5f; }
    .term-fgx192 { color: #d7ff87; }
    .term-fgx193 { color: #d7ffaf; }
    .term-fgx194 { color: #d7ffd7; }
    .term-fgx195 { color: #d7ffff; }
    .term-fgx196 { color: #ff0000; }
    .term-fgx197 { color: #ff005f; }
    .term-fgx198 { color: #ff0087; }
    .term-fgx199 { color: #ff00af; }
    .term-fgx200 { color: #ff00d7; }
    .term-fgx201 { color: #ff00ff; }
    .term-fgx202 { color: #ff5f00; }
    .term-fgx203 { color: #ff5f5f; }
    .term-fgx204 { color: #ff5f87; }
    .term-fgx205 { color: #ff5faf; }
    .term-fgx206 { color: #ff5fd7; }
    .term-fgx207 { color: #ff5fff; }
    .term-fgx208 { color: #ff8700; }
    .term-fgx209 { color: #ff875f; }
    .term-fgx210 { color: #ff8787; }
    .term-fgx211 { color: #ff87af; }
    .term-fgx212 { color: #ff87d7; }
    .term-fgx213 { color: #ff87ff; }
    .term-fgx214 { color: #ffaf00; }
    .term-fgx215 { color: #ffaf5f; }
    .term-fgx216 { color: #ffaf87; }
    .term-fgx217 { color: #ffafaf; }
    .term-fgx218 { color: #ffafd7; }
    .term-fgx219 { color: #ffafff; }
    .term-fgx220 { color: #ffd700; }
    .term-fgx221 { color: #ffd75f; }
    .term-fgx222 { color: #ffd787; }
    .term-fgx223 { color: #ffd7af; }
    .term-fgx224 { color: #ffd7d7; }
    .term-fgx225 { color: #ffd7ff; }
    .term-fgx226 { color: #ffff00; }
    .term-fgx227 { color: #ffff5f; }
    .term-fgx228 { color: #ffff87; }
    .term-fgx229 { color: #ffffaf; }
    .term-fgx230 { color: #ffffd7; }
    .term-fgx231 { color: #ffffff; }
    .term-fgx232 { color: #080808; }
    .term-fgx233 { color: #121212; }
    .term-fgx234 { color: #1c1c1c; }
    .term-fgx235 { color: #262626; }
    .term-fgx236 { color: #303030; }
    .term-fgx237 { color: #3a3a3a; }
    .term-fgx238 { color: #444444; }
    .term-fgx239 { color: #4e4e4e; }
    .term-fgx240 { color: #585858; }
    .term-fgx241 { color: #626262; }
    .term-fgx242 { color: #6c6c6c; }
    .term-fgx243 { color: #767676; }
    .term-fgx244 { color: #808080; }
    .term-fgx245 { color: #8a8a8a; }
    .term-fgx246 { color: #949494; }
    .term-fgx247 { color: #9e9e9e; }
    .term-fgx248 { color: #a8a8a8; }
    .term-fgx249 { color: #b2b2b2; }
    .term-fgx250 { color: #bcbcbc; }
    .term-fgx251 { color: #c6c6c6; }
    .term-fgx252 { color: #d0d0d0; }
    .term-fgx253 { color: #dadada; }
    .term-fgx254 { color: #e4e4e4; }
    .term-fgx255 { color: #eeeeee; }
</style>

</head>
<body>
    <div class="col-xl-10 col-xxl-8 mx-auto px-3 py-1 py-md-3">
        <main class="container-fluid">
            <div class="row">
                <div>
                    <div class="float-end">
                        <div class="form-check form-switch">
                            <i class="bi bi-brightness-low" id="dark-mode-icon"></i>
                            <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle" data-bs-toggle="tooltip"
                                   data-bs-placement="bottom" data-bs-title="Toggle Dark Mode"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"role="button" aria-expanded="true" aria-controls="id-6b1a240881f756e323efe1a4">
        
            <div class="col-12 col-sm-9 text-start"><h1>op-geth</h1></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+6202</span></div>
                <div class="text-start"><span class="text-danger">-450</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse show border-1 ps-3 my-3" id="id-6b1a240881f756e323efe1a4">
        <div><p>This is an overview of the changes in <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>,
a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>, part of the OP-stack.</p>

<p>The OP-stack architecture is modular, following the Consensus/Execution split of post-Merge Ethereum L1:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-node"><code>op-node</code></a> implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node.</li>
<li><a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a> implements the Execution-Layer, with <strong>minimal changes</strong> for a secure Ethereum-equivalent application environment.</li>
</ul>

<p>Related <a href="https://github.com/ethereum-optimism/optimism/tree/develop/specs">op-stack specifications</a>:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 Execution Engine spec</a></li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">Deposit Transaction spec</a></li>
</ul>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-75d62138edf58226f32ae3b0"role="button" aria-expanded="false" aria-controls="id-75d62138edf58226f32ae3b0">
        
            <div class="col-12 col-sm-9 text-start"><h2>Core modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1165</span></div>
                <div class="text-start"><span class="text-danger">-118</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-75d62138edf58226f32ae3b0">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1d520efe1a7c1e5fe6de0400"role="button" aria-expanded="false" aria-controls="id-1d520efe1a7c1e5fe6de0400">
        
            <div class="col-12 col-sm-9 text-start"><h3>State-transition modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+582</span></div>
                <div class="text-start"><span class="text-danger">-24</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1d520efe1a7c1e5fe6de0400">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-844de30955b0703293c3ad7e"role="button" aria-expanded="false" aria-controls="id-844de30955b0703293c3ad7e">
        
            <div class="col-12 col-sm-9 text-start"><h4>Deposit Transaction type</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+199</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-844de30955b0703293c3ad7e">
        <div><p>The Bedrock upgrade introduces a <code>Deposit</code> transaction-type (<code>0x7E</code>) to enable both users and the
rollup system itself to change the L2 state based on L1 events and system rules as
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">specified</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0691eb3841e575ea095e0bcd" role="button"
                   aria-expanded="false" aria-controls="id-0691eb3841e575ea095e0bcd">
                    <code>core/types/deposit_tx.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/deposit_tx.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0691eb3841e575ea095e0bcd"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;deposit_tx.go op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4131ee7af037275dcacd795baab4e0d55a1acb07</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg36">@@ -0,0 +1,103 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2021 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;bytes&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const DepositTxType = 0x7E</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type DepositTx struct {</span>
<span class="term-fg32">+	&#47;&#47; SourceHash uniquely identifies the source of the deposit</span>
<span class="term-fg32">+	SourceHash common.Hash</span>
<span class="term-fg32">+	&#47;&#47; From is exposed through the types.Signer, not through TxData</span>
<span class="term-fg32">+	From common.Address</span>
<span class="term-fg32">+	&#47;&#47; nil means contract creation</span>
<span class="term-fg32">+	To *common.Address `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Mint is minted on L2, locked on L1, nil if no minting.</span>
<span class="term-fg32">+	Mint *big.Int `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Value is transferred from L2 balance, executed after Mint (if any)</span>
<span class="term-fg32">+	Value *big.Int</span>
<span class="term-fg32">+	&#47;&#47; gas limit</span>
<span class="term-fg32">+	Gas uint64</span>
<span class="term-fg32">+	&#47;&#47; Field indicating if this transaction is exempt from the L2 gas limit.</span>
<span class="term-fg32">+	IsSystemTransaction bool</span>
<span class="term-fg32">+	&#47;&#47; Normal Tx data</span>
<span class="term-fg32">+	Data []byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; copy creates a deep copy of the transaction data and initializes all fields.</span>
<span class="term-fg32">+func (tx *DepositTx) copy() TxData {</span>
<span class="term-fg32">+	cpy := &amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          tx.SourceHash,</span>
<span class="term-fg32">+		From:                tx.From,</span>
<span class="term-fg32">+		To:                  copyAddressPtr(tx.To),</span>
<span class="term-fg32">+		Mint:                nil,</span>
<span class="term-fg32">+		Value:               new(big.Int),</span>
<span class="term-fg32">+		Gas:                 tx.Gas,</span>
<span class="term-fg32">+		IsSystemTransaction: tx.IsSystemTransaction,</span>
<span class="term-fg32">+		Data:                common.CopyBytes(tx.Data),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Mint != nil {</span>
<span class="term-fg32">+		cpy.Mint = new(big.Int).Set(tx.Mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Value != nil {</span>
<span class="term-fg32">+		cpy.Value.Set(tx.Value)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return cpy</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; accessors for innerTx.</span>
<span class="term-fg32">+func (tx *DepositTx) txType() byte           { return DepositTxType }</span>
<span class="term-fg32">+func (tx *DepositTx) chainID() *big.Int      { return common.Big0 }</span>
<span class="term-fg32">+func (tx *DepositTx) accessList() AccessList { return nil }</span>
<span class="term-fg32">+func (tx *DepositTx) data() []byte           { return tx.Data }</span>
<span class="term-fg32">+func (tx *DepositTx) gas() uint64            { return tx.Gas }</span>
<span class="term-fg32">+func (tx *DepositTx) gasFeeCap() *big.Int    { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasTipCap() *big.Int    { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasPrice() *big.Int     { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) value() *big.Int        { return tx.Value }</span>
<span class="term-fg32">+func (tx *DepositTx) nonce() uint64          { return 0 }</span>
<span class="term-fg32">+func (tx *DepositTx) to() *common.Address    { return tx.To }</span>
<span class="term-fg32">+func (tx *DepositTx) isSystemTx() bool       { return tx.IsSystemTransaction }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {</span>
<span class="term-fg32">+	return dst.Set(new(big.Int))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveNonce() *uint64 { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) rawSignatureValues() (v, r, s *big.Int) {</span>
<span class="term-fg32">+	return common.Big0, common.Big0, common.Big0</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) setSignatureValues(chainID, v, r, s *big.Int) {</span>
<span class="term-fg32">+	&#47;&#47; this is a noop for deposit transactions</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) encode(b *bytes.Buffer) error {</span>
<span class="term-fg32">+	return rlp.Encode(b, tx)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) decode(input []byte) error {</span>
<span class="term-fg32">+	return rlp.DecodeBytes(input, tx)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-002af93071ce5a65eb0e319e" role="button"
                   aria-expanded="false" aria-controls="id-002af93071ce5a65eb0e319e">
                    <code>core/types/transaction_marshalling.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/transaction_marshalling.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/transaction_marshalling.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+80</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-002af93071ce5a65eb0e319e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">index 08ce80b07c6a18eb07d372e482303e58765fae78..fcb8bc21bc8a0c7540ff0805609b794fab87ea3a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg36">@@ -19,10 +19,12 @@</span>
 import (
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;io&quot;</span>
 	&quot;math&#47;big&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 )
&nbsp;
<span class="term-fg36">@@ -46,6 +48,12 @@</span> 	V                    *hexutil.Big    `json:&quot;v&quot;`
 	R                    *hexutil.Big    `json:&quot;r&quot;`
 	S                    *hexutil.Big    `json:&quot;s&quot;`
 	YParity              *hexutil.Uint64 `json:&quot;yParity,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Deposit transaction fields</span>
<span class="term-fg32">+	SourceHash *common.Hash    `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	From       *common.Address `json:&quot;from,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big    `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool           `json:&quot;isSystemTx,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Only used for encoding:
 	Hash common.Hash `json:&quot;hash&quot;`
<span class="term-fg36">@@ -142,6 +150,18 @@</span> 		enc.R = (*hexutil.Big)(itx.R.ToBig())
 		enc.S = (*hexutil.Big)(itx.S.ToBig())
 		yparity := itx.V.Uint64()
 		enc.YParity = (*hexutil.Uint64)(&amp;yparity)
<span class="term-fg32">+	case *DepositTx:</span>
<span class="term-fg32">+		enc.Gas = (*hexutil.Uint64)(&amp;itx.Gas)</span>
<span class="term-fg32">+		enc.Value = (*hexutil.Big)(itx.Value)</span>
<span class="term-fg32">+		enc.Input = (*hexutil.Bytes)(&amp;itx.Data)</span>
<span class="term-fg32">+		enc.To = tx.To()</span>
<span class="term-fg32">+		enc.SourceHash = &amp;itx.SourceHash</span>
<span class="term-fg32">+		enc.From = &amp;itx.From</span>
<span class="term-fg32">+		if itx.Mint != nil {</span>
<span class="term-fg32">+			enc.Mint = (*hexutil.Big)(itx.Mint)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		enc.IsSystemTx = &amp;itx.IsSystemTransaction</span>
<span class="term-fg32">+		&#47;&#47; other fields will show up as null.</span>
 	}
 	return json.Marshal(&amp;enc)
 }
<span class="term-fg36">@@ -398,6 +418,54 @@</span> 				return err
 			}
 		}
&nbsp;
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		if dec.AccessList != nil || dec.MaxFeePerGas != nil ||</span>
<span class="term-fg32">+			dec.MaxPriorityFeePerGas != nil {</span>
<span class="term-fg32">+			return errors.New(&quot;unexpected field(s) in deposit transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.GasPrice != nil &amp;&amp; dec.GasPrice.ToInt().Cmp(common.Big0) != 0 {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction GasPrice must be 0&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if (dec.V != nil &amp;&amp; dec.V.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.R != nil &amp;&amp; dec.R.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.S != nil &amp;&amp; dec.S.ToInt().Cmp(common.Big0) != 0) {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction signature must be 0 or unset&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var itx DepositTx</span>
<span class="term-fg32">+		inner = &amp;itx</span>
<span class="term-fg32">+		if dec.To != nil {</span>
<span class="term-fg32">+			itx.To = dec.To</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.Gas == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;gas&#39; for txdata&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Gas = uint64(*dec.Gas)</span>
<span class="term-fg32">+		if dec.Value == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;value&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Value = (*big.Int)(dec.Value)</span>
<span class="term-fg32">+		&#47;&#47; mint may be omitted or nil if there is nothing to mint.</span>
<span class="term-fg32">+		itx.Mint = (*big.Int)(dec.Mint)</span>
<span class="term-fg32">+		if dec.Input == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;input&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Data = *dec.Input</span>
<span class="term-fg32">+		if dec.From == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;from&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.From = *dec.From</span>
<span class="term-fg32">+		if dec.SourceHash == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;sourceHash&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.SourceHash = *dec.SourceHash</span>
<span class="term-fg32">+		&#47;&#47; IsSystemTx may be omitted. Defaults to false.</span>
<span class="term-fg32">+		if dec.IsSystemTx != nil {</span>
<span class="term-fg32">+			itx.IsSystemTransaction = *dec.IsSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		if dec.Nonce != nil {</span>
<span class="term-fg32">+			inner = &amp;depositTxWithNonce{DepositTx: itx, EffectiveNonce: uint64(*dec.Nonce)}</span>
<span class="term-fg32">+		}</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -408,3 +476,15 @@</span>
 	&#47;&#47; TODO: check hash here?
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+type depositTxWithNonce struct {</span>
<span class="term-fg32">+	DepositTx</span>
<span class="term-fg32">+	EffectiveNonce uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP ensures that RLP encoding this transaction excludes the nonce. Otherwise, the tx Hash would change</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	return rlp.Encode(w, tx.DepositTx)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) effectiveNonce() *uint64 { return &amp;tx.EffectiveNonce }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2310878c8e638afdaf6f8397" role="button"
                   aria-expanded="false" aria-controls="id-2310878c8e638afdaf6f8397">
                    <code>core/types/transaction_signing.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/transaction_signing.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/transaction_signing.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+16</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2310878c8e638afdaf6f8397"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_signing.go op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">index 9e26642f753db4f0b370aef0ce84f327defbf7b7..0ffe8c92d770bdb938ce10a0a253404cbc32824b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg36">@@ -40,7 +40,7 @@</span> &#47;&#47; MakeSigner returns a Signer based on the given chain config and block number.
 func MakeSigner(config *params.ChainConfig, blockNumber *big.Int, blockTime uint64) Signer {
 	var signer Signer
 	switch {
<span class="term-fg31">-	case config.IsCancun(blockNumber, blockTime):</span>
<span class="term-fg32">+	case config.IsCancun(blockNumber, blockTime) &amp;&amp; !config.IsOptimism():</span>
 		signer = NewCancunSigner(config.ChainID)
 	case config.IsLondon(blockNumber):
 		signer = NewLondonSigner(config.ChainID)
<span class="term-fg36">@@ -65,7 +65,7 @@</span> &#47;&#47; Use this in transaction-handling code where the current block number is unknown. If you
 &#47;&#47; have the current block number available, use MakeSigner instead.
 func LatestSigner(config *params.ChainConfig) Signer {
 	if config.ChainID != nil {
<span class="term-fg31">-		if config.CancunTime != nil {</span>
<span class="term-fg32">+		if config.CancunTime != nil &amp;&amp; !config.IsOptimism() {</span>
 			return NewCancunSigner(config.ChainID)
 		}
 		if config.LondonBlock != nil {
<span class="term-fg36">@@ -256,6 +256,14 @@</span> 	return londonSigner{eip2930Signer{NewEIP155Signer(chainId)}}
 }
&nbsp;
 func (s londonSigner) Sender(tx *Transaction) (common.Address, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		switch tx.inner.(type) {</span>
<span class="term-fg32">+		case *DepositTx:</span>
<span class="term-fg32">+			return tx.inner.(*DepositTx).From, nil</span>
<span class="term-fg32">+		case *depositTxWithNonce:</span>
<span class="term-fg32">+			return tx.inner.(*depositTxWithNonce).From, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Sender(tx)
 	}
<span class="term-fg36">@@ -275,6 +283,9 @@</span> 	return ok &amp;&amp; x.chainId.Cmp(s.chainId) == 0
 }
&nbsp;
 func (s londonSigner) SignatureValues(tx *Transaction, sig []byte) (R, S, V *big.Int, err error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return nil, nil, nil, fmt.Errorf(&quot;deposits do not have a signature&quot;)</span>
<span class="term-fg32">+	}</span>
 	txdata, ok := tx.inner.(*DynamicFeeTx)
 	if !ok {
 		return s.eip2930Signer.SignatureValues(tx, sig)
<span class="term-fg36">@@ -292,6 +303,9 @@</span>
 &#47;&#47; Hash returns the hash to be signed by the sender.
 &#47;&#47; It does not uniquely identify the transaction.
 func (s londonSigner) Hash(tx *Transaction) common.Hash {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		panic(&quot;deposits cannot be signed and do not have a signing hash&quot;)</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Hash(tx)
 	}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-967abc4ee9ca926a9b6ac83f"role="button" aria-expanded="false" aria-controls="id-967abc4ee9ca926a9b6ac83f">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction properties</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+88</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-967abc4ee9ca926a9b6ac83f">
        <div><p>The <code>Transaction</code> type now exposes the deposit-transaction and L1-cost properties required for the rollup.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fc6d4a7c08d4badd55118306" role="button"
                   aria-expanded="false" aria-controls="id-fc6d4a7c08d4badd55118306">
                    <code>core/types/transaction.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/transaction.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/transaction.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+84</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fc6d4a7c08d4badd55118306"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction.go op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">index 9ec0199a03836931c6d8c9fd0e06d9472b037faa..be096c56d236e23df3158a23ff43ebb5a9146ad5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span>
 import (
 	&quot;bytes&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;io&quot;
 	&quot;math&#47;big&quot;
 	&quot;sync&#47;atomic&quot;
<span class="term-fg36">@@ -27,6 +28,7 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 )
&nbsp;
<span class="term-fg36">@@ -59,6 +61,9 @@</span> 	&#47;&#47; caches
 	hash atomic.Value
 	size atomic.Value
 	from atomic.Value
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; cache of details to compute the data availability fee</span>
<span class="term-fg32">+	rollupCostData atomic.Value</span>
 }
&nbsp;
 &#47;&#47; NewTx creates a new transaction.
<span class="term-fg36">@@ -85,6 +90,7 @@</span> 	gasFeeCap() *big.Int
 	value() *big.Int
 	nonce() uint64
 	to() *common.Address
<span class="term-fg32">+	isSystemTx() bool</span>
&nbsp;
 	rawSignatureValues() (v, r, s *big.Int)
 	setSignatureValues(chainID, v, r, s *big.Int)
<span class="term-fg36">@@ -205,6 +211,8 @@</span> 	case DynamicFeeTxType:
 		inner = new(DynamicFeeTx)
 	case BlobTxType:
 		inner = new(BlobTx)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		inner = new(DepositTx)</span>
 	default:
 		return nil, ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -302,12 +310,56 @@</span>
 &#47;&#47; Nonce returns the sender account nonce of the transaction.
 func (tx *Transaction) Nonce() uint64 { return tx.inner.nonce() }
&nbsp;
<span class="term-fg32">+&#47;&#47; EffectiveNonce returns the nonce that was actually used as part of transaction execution</span>
<span class="term-fg32">+&#47;&#47; Returns nil if the effective nonce is not known</span>
<span class="term-fg32">+func (tx *Transaction) EffectiveNonce() *uint64 {</span>
<span class="term-fg32">+	type txWithEffectiveNonce interface {</span>
<span class="term-fg32">+		effectiveNonce() *uint64</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if itx, ok := tx.inner.(txWithEffectiveNonce); ok {</span>
<span class="term-fg32">+		return itx.effectiveNonce()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce := tx.inner.nonce()</span>
<span class="term-fg32">+	return &amp;nonce</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; To returns the recipient address of the transaction.
 &#47;&#47; For contract-creation transactions, To returns nil.
 func (tx *Transaction) To() *common.Address {
 	return copyAddressPtr(tx.inner.to())
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; SourceHash returns the hash that uniquely identifies the source of the deposit tx,</span>
<span class="term-fg32">+&#47;&#47; e.g. a user deposit event, or a L1 info deposit included in a specific L2 block height.</span>
<span class="term-fg32">+&#47;&#47; Non-deposit transactions return a zeroed hash.</span>
<span class="term-fg32">+func (tx *Transaction) SourceHash() common.Hash {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.SourceHash</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return common.Hash{}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Mint returns the ETH to mint in the deposit tx.</span>
<span class="term-fg32">+&#47;&#47; This returns nil if there is nothing to mint, or if this is not a deposit tx.</span>
<span class="term-fg32">+func (tx *Transaction) Mint() *big.Int {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.Mint</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsDepositTx returns true if the transaction is a deposit tx type.</span>
<span class="term-fg32">+func (tx *Transaction) IsDepositTx() bool {</span>
<span class="term-fg32">+	return tx.Type() == DepositTxType</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsSystemTx returns true for deposits that are system transactions. These transactions</span>
<span class="term-fg32">+&#47;&#47; are executed in an unmetered environment &amp; do not contribute to the block gas limit.</span>
<span class="term-fg32">+func (tx *Transaction) IsSystemTx() bool {</span>
<span class="term-fg32">+	return tx.inner.isSystemTx()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Cost returns (gas * gasPrice) + (blobGas * blobGasPrice) + value.
 func (tx *Transaction) Cost() *big.Int {
 	total := new(big.Int).Mul(tx.GasPrice(), new(big.Int).SetUint64(tx.Gas()))
<span class="term-fg36">@@ -318,6 +370,23 @@</span> 	total.Add(total, tx.Value())
 	return total
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; RollupCostData caches the information needed to efficiently compute the data availability fee</span>
<span class="term-fg32">+func (tx *Transaction) RollupCostData() RollupCostData {</span>
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return RollupCostData{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if v := tx.rollupCostData.Load(); v != nil {</span>
<span class="term-fg32">+		return v.(RollupCostData)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	data, err := tx.MarshalBinary()</span>
<span class="term-fg32">+	if err != nil { &#47;&#47; Silent error, invalid txs will not be marshalled&#47;unmarshalled for batch submission anyway.</span>
<span class="term-fg32">+		log.Error(&quot;failed to encode tx for L1 cost computation&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	out := NewRollupCostData(data)</span>
<span class="term-fg32">+	tx.rollupCostData.Store(out)</span>
<span class="term-fg32">+	return out</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; RawSignatureValues returns the V, R, S signature values of the transaction.
 &#47;&#47; The return values should not be modified by the caller.
 func (tx *Transaction) RawSignatureValues() (v, r, s *big.Int) {
<span class="term-fg36">@@ -348,6 +417,9 @@</span> &#47;&#47; EffectiveGasTip returns the effective miner gasTipCap for the given base fee.
 &#47;&#47; Note: if the effective gasTipCap is negative, this method returns both error
 &#47;&#47; the actual negative value, _and_ ErrGasFeeCapTooLow
 func (tx *Transaction) EffectiveGasTip(baseFee *big.Int) (*big.Int, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return new(big.Int), nil</span>
<span class="term-fg32">+	}</span>
 	if baseFee == nil {
 		return tx.GasTipCap(), nil
 	}
<span class="term-fg36">@@ -411,6 +483,18 @@</span> func (tx *Transaction) BlobTxSidecar() *BlobTxSidecar {
 	if blobtx, ok := tx.inner.(*BlobTx); ok {
 		return blobtx.Sidecar
 	}
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; SetBlobTxSidecar sets the sidecar of a transaction.</span>
<span class="term-fg32">+&#47;&#47; The sidecar should match the blob-tx versioned hashes, or the transaction will be invalid.</span>
<span class="term-fg32">+&#47;&#47; This allows tools to easily re-attach blob sidecars to signed transactions that omit the sidecar.</span>
<span class="term-fg32">+func (tx *Transaction) SetBlobTxSidecar(sidecar *BlobTxSidecar) error {</span>
<span class="term-fg32">+	blobtx, ok := tx.inner.(*BlobTx)</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return fmt.Errorf(&quot;not a blob tx, type = %d&quot;, tx.Type())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	blobtx.Sidecar = sidecar</span>
 	return nil
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-252943af70f34652ad9a8abb" role="button"
                   aria-expanded="false" aria-controls="id-252943af70f34652ad9a8abb">
                    <code>core/types/tx_access_list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/tx_access_list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/tx_access_list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-252943af70f34652ad9a8abb"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_access_list.go op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">index 730a77b752866afb5e6ba3d7ea8f4a5af6456d00..59880b0eabb182cd889a27b58d6c449187f4701a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg36">@@ -107,6 +107,7 @@</span> func (tx *AccessListTx) gasFeeCap() *big.Int    { return tx.GasPrice }
 func (tx *AccessListTx) value() *big.Int        { return tx.Value }
 func (tx *AccessListTx) nonce() uint64          { return tx.Nonce }
 func (tx *AccessListTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *AccessListTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *AccessListTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-66e5fff9aa957d16b3d990a2" role="button"
                   aria-expanded="false" aria-controls="id-66e5fff9aa957d16b3d990a2">
                    <code>core/types/tx_dynamic_fee.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/tx_dynamic_fee.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/tx_dynamic_fee.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-66e5fff9aa957d16b3d990a2"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">index 8b5b514fdec5b58fc8058e582a0a7c355e0ccba8..9c52cde57754d4826e6d673f297238ce02212657 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg36">@@ -96,6 +96,7 @@</span> func (tx *DynamicFeeTx) gasPrice() *big.Int     { return tx.GasFeeCap }
 func (tx *DynamicFeeTx) value() *big.Int        { return tx.Value }
 func (tx *DynamicFeeTx) nonce() uint64          { return tx.Nonce }
 func (tx *DynamicFeeTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *DynamicFeeTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *DynamicFeeTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-36d030e6e779531309598280" role="button"
                   aria-expanded="false" aria-controls="id-36d030e6e779531309598280">
                    <code>core/types/tx_legacy.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/tx_legacy.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/tx_legacy.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-36d030e6e779531309598280"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_legacy.go op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">index 71025b78fc060692c1d034f84b59b4cdc8e6cf65..bcb65c39349a3a1bef78948af48a30a1e14c71ba 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg36">@@ -103,6 +103,7 @@</span> func (tx *LegacyTx) gasFeeCap() *big.Int    { return tx.GasPrice }
 func (tx *LegacyTx) value() *big.Int        { return tx.Value }
 func (tx *LegacyTx) nonce() uint64          { return tx.Nonce }
 func (tx *LegacyTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *LegacyTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *LegacyTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e2d88d93132566dfcdc48b08" role="button"
                   aria-expanded="false" aria-controls="id-e2d88d93132566dfcdc48b08">
                    <code>core/types/tx_blob.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/tx_blob.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/tx_blob.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e2d88d93132566dfcdc48b08"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_blob.go op-geth&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg1">index caede7cc5334c553dc9cd35d09d35d1e05f9e9e7..d8b0ffc462a4f1303a259cd103e9769f5a55d947 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg36">@@ -162,6 +162,7 @@</span> func (tx *BlobTx) value() *big.Int        { return tx.Value.ToBig() }
 func (tx *BlobTx) nonce() uint64          { return tx.Nonce }
 func (tx *BlobTx) to() *common.Address    { tmp := tx.To; return &amp;tmp }
 func (tx *BlobTx) blobGas() uint64        { return params.BlobTxBlobGasPerBlob * uint64(len(tx.BlobHashes)) }
<span class="term-fg32">+func (tx *BlobTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *BlobTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e633ac6ac851ee2c30f5d5de"role="button" aria-expanded="false" aria-controls="id-e633ac6ac851ee2c30f5d5de">
        
            <div class="col-12 col-sm-9 text-start"><h4>L1 cost computation</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+35</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e633ac6ac851ee2c30f5d5de">
        <div><p>Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,
estimated based on gas-price-oracle information and encoded tx size.&rdquo;</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a5f7a445c1096d01a98de719" role="button"
                   aria-expanded="false" aria-controls="id-a5f7a445c1096d01a98de719">
                    <code>core/vm/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/vm/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/vm/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+11</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a5f7a445c1096d01a98de719"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;evm.go op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">index 985e6a9ae2ade6235ac9d776475998138d465293..ca8e3456a17b80a6dea0a285769823fe0a700558 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg36">@@ -20,11 +20,12 @@</span> import (
 	&quot;math&#47;big&quot;
 	&quot;sync&#47;atomic&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg31">-	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 type (
<span class="term-fg36">@@ -52,6 +53,13 @@</span> 	default:
 		precompiles = PrecompiledContractsHomestead
 	}
 	p, ok := precompiles[addr]
<span class="term-fg32">+	&#47;&#47; Restrict overrides to known precompiles</span>
<span class="term-fg32">+	if ok &amp;&amp; evm.chainConfig.IsOptimism() &amp;&amp; evm.Config.OptimismPrecompileOverrides != nil {</span>
<span class="term-fg32">+		override, ok := evm.Config.OptimismPrecompileOverrides(evm.chainRules, p, addr)</span>
<span class="term-fg32">+		if ok {</span>
<span class="term-fg32">+			return override, ok</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	return p, ok
 }
&nbsp;
<span class="term-fg36">@@ -65,6 +73,8 @@</span> 	&#47;&#47; Transfer transfers ether from one account to the other
 	Transfer TransferFunc
 	&#47;&#47; GetHash returns the hash corresponding to n
 	GetHash GetHashFunc
<span class="term-fg32">+	&#47;&#47; L1CostFunc returns the L1 cost of the rollup message, the function may be nil, or return nil</span>
<span class="term-fg32">+	L1CostFunc types.L1CostFunc</span>
&nbsp;
 	&#47;&#47; Block information
 	Coinbase    common.Address &#47;&#47; Provides information for COINBASE</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-776ca070ed3233de48e1424b" role="button"
                   aria-expanded="false" aria-controls="id-776ca070ed3233de48e1424b">
                    <code>core/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-776ca070ed3233de48e1424b"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;evm.go op-geth&#47;core&#47;evm.go</span>
<span class="term-fg1">index 73f6d7bc20a09ad5e2e9ae4f4a81018a5efe1444..d1e826d2a343a656650c26648e19cfe292998000 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;evm.go</span>
<span class="term-fg36">@@ -24,6 +24,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip4844&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 )
&nbsp;
<span class="term-fg36">@@ -38,7 +39,7 @@</span> 	GetHeader(common.Hash, uint64) *types.Header
 }
&nbsp;
 &#47;&#47; NewEVMBlockContext creates a new context for use in the EVM.
<span class="term-fg31">-func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address) vm.BlockContext {</span>
<span class="term-fg32">+func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address, config *params.ChainConfig, statedb types.StateGetter) vm.BlockContext {</span>
 	var (
 		beneficiary common.Address
 		baseFee     *big.Int
<span class="term-fg36">@@ -73,6 +74,7 @@</span> 		BaseFee:     baseFee,
 		BlobBaseFee: blobBaseFee,
 		GasLimit:    header.GasLimit,
 		Random:      random,
<span class="term-fg32">+		L1CostFunc:  types.NewL1CostFunc(config, statedb),</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f5e470055f0895ac335d8703" role="button"
                   aria-expanded="false" aria-controls="id-f5e470055f0895ac335d8703">
                    <code>core/state_processor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/state_processor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/state_processor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+20</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f5e470055f0895ac335d8703"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_processor.go op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg1">index 9e32ab4e569600636e88bd8c6579771bfdb18733..e11041a87c50a614c1c30c1c3f9a427a845af64e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_processor.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg36">@@ -71,8 +71,9 @@</span> 	&#47;&#47; Mutate the block and state according to any hard-fork specs
 	if p.config.DAOForkSupport &amp;&amp; p.config.DAOForkBlock != nil &amp;&amp; p.config.DAOForkBlock.Cmp(block.Number()) == 0 {
 		misc.ApplyDAOHardFork(statedb)
 	}
<span class="term-fg32">+	misc.EnsureCreate2Deployer(p.config, block.Time(), statedb)</span>
 	var (
<span class="term-fg31">-		context = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		context = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		vmenv   = vm.NewEVM(context, vm.TxContext{}, statedb, p.config, cfg)
 		signer  = types.MakeSigner(p.config, header.Number, header.Time)
 	)
<span class="term-fg36">@@ -109,6 +110,11 @@</span> 	&#47;&#47; Create a new context to be used in the EVM environment.
 	txContext := NewEVMTxContext(msg)
 	evm.Reset(txContext, statedb)
&nbsp;
<span class="term-fg32">+	nonce := tx.Nonce()</span>
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		nonce = statedb.GetNonce(msg.From)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Apply the transaction to the current state (included in the env).
 	result, err := ApplyMessage(evm, msg, gp)
 	if err != nil {
<span class="term-fg36">@@ -135,6 +141,17 @@</span> 	}
 	receipt.TxHash = tx.Hash()
 	receipt.GasUsed = result.UsedGas
&nbsp;
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		&#47;&#47; The actual nonce for deposit transactions is only recorded from Regolith onwards and</span>
<span class="term-fg32">+		&#47;&#47; otherwise must be nil.</span>
<span class="term-fg32">+		receipt.DepositNonce = &amp;nonce</span>
<span class="term-fg32">+		&#47;&#47; The DepositReceiptVersion for deposit transactions is only recorded from Canyon onwards</span>
<span class="term-fg32">+		&#47;&#47; and otherwise must be nil.</span>
<span class="term-fg32">+		if config.IsOptimismCanyon(evm.Context.Time) {</span>
<span class="term-fg32">+			receipt.DepositReceiptVersion = new(uint64)</span>
<span class="term-fg32">+			*receipt.DepositReceiptVersion = types.CanyonDepositReceiptVersion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() == types.BlobTxType {
 		receipt.BlobGasUsed = uint64(len(tx.BlobHashes()) * params.BlobTxBlobGasPerBlob)
 		receipt.BlobGasPrice = evm.Context.BlobBaseFee
<span class="term-fg36">@@ -142,7 +159,7 @@</span> 	}
&nbsp;
 	&#47;&#47; If the transaction created a contract, store the creation address in the receipt.
 	if msg.To == nil {
<span class="term-fg31">-		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, tx.Nonce())</span>
<span class="term-fg32">+		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, nonce)</span>
 	}
&nbsp;
 	&#47;&#47; Set the receipt logs and create the bloom filter.
<span class="term-fg36">@@ -164,7 +181,7 @@</span> 	if err != nil {
 		return nil, err
 	}
 	&#47;&#47; Create a new context to be used in the EVM environment
<span class="term-fg31">-	blockContext := NewEVMBlockContext(header, bc, author)</span>
<span class="term-fg32">+	blockContext := NewEVMBlockContext(header, bc, author, config, statedb)</span>
 	txContext := NewEVMTxContext(msg)
 	vmenv := vm.NewEVM(blockContext, txContext, statedb, config, cfg)
 	return applyTransaction(msg, config, gp, statedb, header.Number, header.Hash(), tx, usedGas, vmenv)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1bc9ec8f5d71b15ee308d994" role="button"
                   aria-expanded="false" aria-controls="id-1bc9ec8f5d71b15ee308d994">
                    <code>core/state_prefetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/state_prefetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/state_prefetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1bc9ec8f5d71b15ee308d994"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_prefetcher.go op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">index ff867309de302b90dc3e071e97cbe3705d34c970..bb6835202b9758e49611f8da677ddee3edc346f1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg36">@@ -51,7 +51,7 @@</span> func (p *statePrefetcher) Prefetch(block *types.Block, statedb *state.StateDB, cfg vm.Config, interrupt *atomic.Bool) {
 	var (
 		header       = block.Header()
 		gaspool      = new(GasPool).AddGas(block.GasLimit())
<span class="term-fg31">-		blockContext = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		blockContext = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		evm          = vm.NewEVM(blockContext, vm.TxContext{}, statedb, p.config, cfg)
 		signer       = types.MakeSigner(p.config, header.Number, header.Time)
 	)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-34d074ad1746b4edd2258f79"role="button" aria-expanded="false" aria-controls="id-34d074ad1746b4edd2258f79">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction processing</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+129</span></div>
                <div class="text-start"><span class="text-danger">-10</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-34d074ad1746b4edd2258f79">
        <div><p>Deposit transactions have special processing rules: gas is pre-paid on L1,
and deposits with EVM-failure are included with rolled back changes (except mint).
For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-489fc9d5b0231a24a5962ce8" role="button"
                   aria-expanded="false" aria-controls="id-489fc9d5b0231a24a5962ce8">
                    <code>core/state_transition.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/state_transition.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/state_transition.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+129</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-489fc9d5b0231a24a5962ce8"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_transition.go op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg1">index 2be54480f3931fc164a3b700d998ee035ff7e2d3..d6b299b14d3159f81b0227bba5cc0e6de4196f3b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_transition.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg36">@@ -145,20 +145,30 @@</span> 	&#47;&#47; When SkipAccountChecks is true, the message nonce is not checked against the
 	&#47;&#47; account nonce in state. It also disables checking that the sender is an EOA.
 	&#47;&#47; This field will be set to true for operations like RPC eth_call.
 	SkipAccountChecks bool
<span class="term-fg32">+</span>
<span class="term-fg32">+	IsSystemTx     bool                 &#47;&#47; IsSystemTx indicates the message, if also a deposit, does not emit gas usage.</span>
<span class="term-fg32">+	IsDepositTx    bool                 &#47;&#47; IsDepositTx indicates the message is force-included and can persist a mint.</span>
<span class="term-fg32">+	Mint           *big.Int             &#47;&#47; Mint is the amount to mint before EVM processing, or nil if there is no minting.</span>
<span class="term-fg32">+	RollupCostData types.RollupCostData &#47;&#47; RollupCostData caches data to compute the fee we charge for data availability</span>
 }
&nbsp;
 &#47;&#47; TransactionToMessage converts a transaction into a Message.
 func TransactionToMessage(tx *types.Transaction, s types.Signer, baseFee *big.Int) (*Message, error) {
 	msg := &amp;Message{
<span class="term-fg31">-		Nonce:             tx.Nonce(),</span>
<span class="term-fg31">-		GasLimit:          tx.Gas(),</span>
<span class="term-fg31">-		GasPrice:          new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg31">-		GasFeeCap:         new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg31">-		GasTipCap:         new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg31">-		To:                tx.To(),</span>
<span class="term-fg31">-		Value:             tx.Value(),</span>
<span class="term-fg31">-		Data:              tx.Data(),</span>
<span class="term-fg31">-		AccessList:        tx.AccessList(),</span>
<span class="term-fg32">+		Nonce:          tx.Nonce(),</span>
<span class="term-fg32">+		GasLimit:       tx.Gas(),</span>
<span class="term-fg32">+		GasPrice:       new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg32">+		GasFeeCap:      new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg32">+		GasTipCap:      new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg32">+		To:             tx.To(),</span>
<span class="term-fg32">+		Value:          tx.Value(),</span>
<span class="term-fg32">+		Data:           tx.Data(),</span>
<span class="term-fg32">+		AccessList:     tx.AccessList(),</span>
<span class="term-fg32">+		IsSystemTx:     tx.IsSystemTx(),</span>
<span class="term-fg32">+		IsDepositTx:    tx.IsDepositTx(),</span>
<span class="term-fg32">+		Mint:           tx.Mint(),</span>
<span class="term-fg32">+		RollupCostData: tx.RollupCostData(),</span>
<span class="term-fg32">+</span>
 		SkipAccountChecks: false,
 		BlobHashes:        tx.BlobHashes(),
 		BlobGasFeeCap:     tx.BlobGasFeeCap(),
<span class="term-fg36">@@ -235,11 +245,21 @@</span>
 func (st *StateTransition) buyGas() error {
 	mgval := new(big.Int).SetUint64(st.msg.GasLimit)
 	mgval = mgval.Mul(mgval, st.msg.GasPrice)
<span class="term-fg32">+	var l1Cost *big.Int</span>
<span class="term-fg32">+	if st.evm.Context.L1CostFunc != nil &amp;&amp; !st.msg.SkipAccountChecks {</span>
<span class="term-fg32">+		l1Cost = st.evm.Context.L1CostFunc(st.msg.RollupCostData, st.evm.Context.Time)</span>
<span class="term-fg32">+		if l1Cost != nil {</span>
<span class="term-fg32">+			mgval = mgval.Add(mgval, l1Cost)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	balanceCheck := new(big.Int).Set(mgval)
 	if st.msg.GasFeeCap != nil {
 		balanceCheck.SetUint64(st.msg.GasLimit)
 		balanceCheck = balanceCheck.Mul(balanceCheck, st.msg.GasFeeCap)
 		balanceCheck.Add(balanceCheck, st.msg.Value)
<span class="term-fg32">+		if l1Cost != nil {</span>
<span class="term-fg32">+			balanceCheck.Add(balanceCheck, l1Cost)</span>
<span class="term-fg32">+		}</span>
 	}
 	if st.evm.ChainConfig().IsCancun(st.evm.Context.BlockNumber, st.evm.Context.Time) {
 		if blobGas := st.blobGasUsed(); blobGas &gt; 0 {
<span class="term-fg36">@@ -272,6 +292,21 @@</span> 	return nil
 }
&nbsp;
 func (st *StateTransition) preCheck() error {
<span class="term-fg32">+	if st.msg.IsDepositTx {</span>
<span class="term-fg32">+		&#47;&#47; No fee fields to check, no nonce to check, and no need to check if EOA (L1 already verified it for us)</span>
<span class="term-fg32">+		&#47;&#47; Gas is free, but no refunds!</span>
<span class="term-fg32">+		st.initialGas = st.msg.GasLimit</span>
<span class="term-fg32">+		st.gasRemaining += st.msg.GasLimit &#47;&#47; Add gas here in order to be able to execute calls.</span>
<span class="term-fg32">+		&#47;&#47; Don&#39;t touch the gas pool for system transactions</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			if st.evm.ChainConfig().IsOptimismRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+				return fmt.Errorf(&quot;%w: address %v&quot;, ErrSystemTxNotSupported,</span>
<span class="term-fg32">+					st.msg.From.Hex())</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return st.gp.SubGas(st.msg.GasLimit) &#47;&#47; gas used by deposits may not be used by other txs</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Only check transactions that are not fake
 	msg := st.msg
 	if !msg.SkipAccountChecks {
<span class="term-fg36">@@ -365,6 +400,41 @@</span> &#47;&#47;
 &#47;&#47; However if any consensus issue encountered, return the error directly with
 &#47;&#47; nil evm execution result.
 func (st *StateTransition) TransitionDb() (*ExecutionResult, error) {
<span class="term-fg32">+	if mint := st.msg.Mint; mint != nil {</span>
<span class="term-fg32">+		mintU256, overflow := uint256.FromBig(mint)</span>
<span class="term-fg32">+		if overflow {</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;mint value exceeds uint256: %d&quot;, mintU256)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		st.state.AddBalance(st.msg.From, mintU256)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	snap := st.state.Snapshot()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := st.innerTransitionDb()</span>
<span class="term-fg32">+	&#47;&#47; Failed deposits must still be included. Unless we cannot produce the block at all due to the gas limit.</span>
<span class="term-fg32">+	&#47;&#47; On deposit failure, we rewind any state changes from after the minting, and increment the nonce.</span>
<span class="term-fg32">+	if err != nil &amp;&amp; err != ErrGasLimitReached &amp;&amp; st.msg.IsDepositTx {</span>
<span class="term-fg32">+		st.state.RevertToSnapshot(snap)</span>
<span class="term-fg32">+		&#47;&#47; Even though we revert the state changes, always increment the nonce for the next deposit transaction</span>
<span class="term-fg32">+		st.state.SetNonce(st.msg.From, st.state.GetNonce(st.msg.From)+1)</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		&#47;&#47; Regolith changes this behaviour so the actual gas used is reported.</span>
<span class="term-fg32">+		&#47;&#47; In this case the tx is invalid so is recorded as using all gas.</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx &amp;&amp; !st.evm.ChainConfig().IsRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result = &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        fmt.Errorf(&quot;failed deposit: %w&quot;, err),</span>
<span class="term-fg32">+			ReturnData: nil,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		err = nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return result, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (st *StateTransition) innerTransitionDb() (*ExecutionResult, error) {</span>
 	&#47;&#47; First check this message satisfies all consensus rules before
 	&#47;&#47; applying the message. The rules include these clauses
 	&#47;&#47;
<span class="term-fg36">@@ -383,7 +453,11 @@</span>
 	if tracer := st.evm.Config.Tracer; tracer != nil {
 		tracer.CaptureTxStart(st.initialGas)
 		defer func() {
<span class="term-fg31">-			tracer.CaptureTxEnd(st.gasRemaining)</span>
<span class="term-fg32">+			if st.msg.IsDepositTx {</span>
<span class="term-fg32">+				tracer.CaptureTxEnd(0)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				tracer.CaptureTxEnd(st.gasRemaining)</span>
<span class="term-fg32">+			}</span>
 		}()
 	}
&nbsp;
<span class="term-fg36">@@ -435,6 +509,24 @@</span> 		st.state.SetNonce(msg.From, st.state.GetNonce(sender.Address())+1)
 		ret, st.gasRemaining, vmerr = st.evm.Call(sender, st.to(), msg.Data, st.gasRemaining, value)
 	}
&nbsp;
<span class="term-fg32">+	&#47;&#47; if deposit: skip refunds, skip tipping coinbase</span>
<span class="term-fg32">+	&#47;&#47; Regolith changes this behaviour to report the actual gasUsed instead of always reporting all gas used.</span>
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; !rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Note for deposit tx there is no ETH refunded for unused gas, but that&#39;s taken care of by the fact that gasPrice</span>
<span class="term-fg32">+	&#47;&#47; is always 0 for deposit tx. So calling refundGas will ensure the gasUsed accounting is correct without actually</span>
<span class="term-fg32">+	&#47;&#47; changing the sender&#39;s balance</span>
 	var gasRefund uint64
 	if !rules.IsLondon {
 		&#47;&#47; Before EIP-3529: refunds were capped to gasUsed &#47; 2
<span class="term-fg36">@@ -443,6 +535,15 @@</span> 	} else {
 		&#47;&#47; After EIP-3529: refunds are capped to gasUsed &#47; 5
 		gasRefund = st.refundGas(params.RefundQuotientEIP3529)
 	}
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Skip coinbase payments for deposit tx in Regolith</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:     st.gasUsed(),</span>
<span class="term-fg32">+			RefundedGas: gasRefund,</span>
<span class="term-fg32">+			Err:         vmerr,</span>
<span class="term-fg32">+			ReturnData:  ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
 	effectiveTip := msg.GasPrice
 	if rules.IsLondon {
 		effectiveTip = cmath.BigMin(msg.GasTipCap, new(big.Int).Sub(msg.GasFeeCap, st.evm.Context.BaseFee))
<span class="term-fg36">@@ -457,6 +558,24 @@</span> 	} else {
 		fee := new(uint256.Int).SetUint64(st.gasUsed())
 		fee.Mul(fee, effectiveTipU256)
 		st.state.AddBalance(st.evm.Context.Coinbase, fee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we are post bedrock to enable op-geth to be able to create pseudo pre-bedrock blocks (these are pre-bedrock, but don&#39;t follow l2 geth rules)</span>
<span class="term-fg32">+	&#47;&#47; Note optimismConfig will not be nil if rules.IsOptimismBedrock is true</span>
<span class="term-fg32">+	if optimismConfig := st.evm.ChainConfig().Optimism; optimismConfig != nil &amp;&amp; rules.IsOptimismBedrock &amp;&amp; !st.msg.IsDepositTx {</span>
<span class="term-fg32">+		gasCost := new(big.Int).Mul(new(big.Int).SetUint64(st.gasUsed()), st.evm.Context.BaseFee)</span>
<span class="term-fg32">+		amtU256, overflow := uint256.FromBig(gasCost)</span>
<span class="term-fg32">+		if overflow {</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;optimism gas cost overflows U256: %d&quot;, gasCost)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		st.state.AddBalance(params.OptimismBaseFeeRecipient, amtU256)</span>
<span class="term-fg32">+		if l1Cost := st.evm.Context.L1CostFunc(st.msg.RollupCostData, st.evm.Context.Time); l1Cost != nil {</span>
<span class="term-fg32">+			amtU256, overflow = uint256.FromBig(l1Cost)</span>
<span class="term-fg32">+			if overflow {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;optimism l1 cost overflows U256: %d&quot;, l1Cost)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			st.state.AddBalance(params.OptimismL1FeeRecipient, amtU256)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	return &amp;ExecutionResult{</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-55b7eb7b936b2269ef8d1943"role="button" aria-expanded="false" aria-controls="id-55b7eb7b936b2269ef8d1943">
        
            <div class="col-12 col-sm-9 text-start"><h4>Core Error definitions</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-55b7eb7b936b2269ef8d1943">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8d629f3387274bc7a52f210d" role="button"
                   aria-expanded="false" aria-controls="id-8d629f3387274bc7a52f210d">
                    <code>core/error.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/error.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/error.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8d629f3387274bc7a52f210d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;error.go op-geth&#47;core&#47;error.go</span>
<span class="term-fg1">index 72cacf8c78d2fdb4ee98563edbfda8c094057521..8c691b17ff761c541093a5de23db70edba74e5d7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;error.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;error.go</span>
<span class="term-fg36">@@ -110,4 +110,7 @@</span> 	ErrMissingBlobHashes = errors.New(&quot;blob transaction missing blob hashes&quot;)
&nbsp;
 	&#47;&#47; ErrBlobTxCreate is returned if a blob transaction has no explicit to field.
 	ErrBlobTxCreate = errors.New(&quot;blob transaction of type create&quot;)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; ErrSystemTxNotSupported is returned for any deposit tx with IsSystemTx=true after the Regolith fork</span>
<span class="term-fg32">+	ErrSystemTxNotSupported = errors.New(&quot;system tx not supported&quot;)</span>
 )</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-32b8c696f7fc0852c3f457d0"role="button" aria-expanded="false" aria-controls="id-32b8c696f7fc0852c3f457d0">
        
            <div class="col-12 col-sm-9 text-start"><h4>Gaslimit</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+9</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-32b8c696f7fc0852c3f457d0">
        <div><p>The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the
gaslimit in increments of <sup>1</sup>&frasl;<sub>1024</sub> of the previous gaslimit.
The gaslimit is changed (and limited) through the <code>SystemConfig</code> contract.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4300c4b9a333df0716801ac3" role="button"
                   aria-expanded="false" aria-controls="id-4300c4b9a333df0716801ac3">
                    <code>consensus/misc/eip1559/eip1559.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/consensus/misc/eip1559/eip1559.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/consensus/misc/eip1559/eip1559.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4300c4b9a333df0716801ac3"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go op-geth&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go</span>
<span class="term-fg1">index 84b82c4c492ec1351da2129b51b99fc50d3c6b28..a66298af692fbb7bb477847452aff5937af55c83 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go</span>
<span class="term-fg36">@@ -37,15 +37,17 @@</span> 	parentGasLimit := parent.GasLimit
 	if !config.IsLondon(parent.Number) {
 		parentGasLimit = parent.GasLimit * config.ElasticityMultiplier()
 	}
<span class="term-fg31">-	if err := misc.VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg31">-		return err</span>
<span class="term-fg32">+	if config.Optimism == nil { &#47;&#47; gasLimit can adjust instantly in optimism</span>
<span class="term-fg32">+		if err := misc.VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
 	}
 	&#47;&#47; Verify the header is not malformed
 	if header.BaseFee == nil {
 		return errors.New(&quot;header is missing baseFee&quot;)
 	}
 	&#47;&#47; Verify the baseFee is correct based on the parent header.
<span class="term-fg31">-	expectedBaseFee := CalcBaseFee(config, parent)</span>
<span class="term-fg32">+	expectedBaseFee := CalcBaseFee(config, parent, header.Time)</span>
 	if header.BaseFee.Cmp(expectedBaseFee) != 0 {
 		return fmt.Errorf(&quot;invalid baseFee: have %s, want %s, parentBaseFee %s, parentGasUsed %d&quot;,
 			header.BaseFee, expectedBaseFee, parent.BaseFee, parent.GasUsed)
<span class="term-fg36">@@ -54,7 +56,8 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; CalcBaseFee calculates the basefee of the header.
<span class="term-fg31">-func CalcBaseFee(config *params.ChainConfig, parent *types.Header) *big.Int {</span>
<span class="term-fg32">+&#47;&#47; The time belongs to the new block to check if Canyon is activted or not</span>
<span class="term-fg32">+func CalcBaseFee(config *params.ChainConfig, parent *types.Header, time uint64) *big.Int {</span>
 	&#47;&#47; If the current block is the first EIP-1559 block, return the InitialBaseFee.
 	if !config.IsLondon(parent.Number) {
 		return new(big.Int).SetUint64(params.InitialBaseFee)
<span class="term-fg36">@@ -77,7 +80,7 @@</span> 		&#47;&#47; max(1, parentBaseFee * gasUsedDelta &#47; parentGasTarget &#47; baseFeeChangeDenominator)
 		num.SetUint64(parent.GasUsed - parentGasTarget)
 		num.Mul(num, parent.BaseFee)
 		num.Div(num, denom.SetUint64(parentGasTarget))
<span class="term-fg31">-		num.Div(num, denom.SetUint64(config.BaseFeeChangeDenominator()))</span>
<span class="term-fg32">+		num.Div(num, denom.SetUint64(config.BaseFeeChangeDenominator(time)))</span>
 		baseFeeDelta := math.BigMax(num, common.Big1)
&nbsp;
 		return num.Add(parent.BaseFee, baseFeeDelta)
<span class="term-fg36">@@ -87,7 +90,7 @@</span> 		&#47;&#47; max(0, parentBaseFee * gasUsedDelta &#47; parentGasTarget &#47; baseFeeChangeDenominator)
 		num.SetUint64(parentGasTarget - parent.GasUsed)
 		num.Mul(num, parent.BaseFee)
 		num.Div(num, denom.SetUint64(parentGasTarget))
<span class="term-fg31">-		num.Div(num, denom.SetUint64(config.BaseFeeChangeDenominator()))</span>
<span class="term-fg32">+		num.Div(num, denom.SetUint64(config.BaseFeeChangeDenominator(time)))</span>
 		baseFee := num.Sub(parent.BaseFee, num)
&nbsp;
 		return math.BigMax(baseFee, common.Big0)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-8c3c13b3435e880e5f4aa151"role="button" aria-expanded="false" aria-controls="id-8c3c13b3435e880e5f4aa151">
        
            <div class="col-12 col-sm-9 text-start"><h4>Consensus tweaks</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+28</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-8c3c13b3435e880e5f4aa151">
        <div><p>The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).
The rollup starts post-merge, and thus sets the TTD to 0.
The TTD is always &ldquo;reached&rdquo; starting at the bedrock block.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9967d97f79abaf131ba79a25" role="button"
                   aria-expanded="false" aria-controls="id-9967d97f79abaf131ba79a25">
                    <code>consensus/beacon/consensus.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/consensus/beacon/consensus.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/consensus/beacon/consensus.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9967d97f79abaf131ba79a25"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;beacon&#47;consensus.go op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">index a350e383a293223be8f50e236d808c6e5fbe0345..ba4980b8d4ebf46a9d33a70951a3754f719ddf79 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg36">@@ -59,6 +59,7 @@</span> &#47;&#47; The beacon here is a half-functional consensus engine with partial functions which
 &#47;&#47; is only used for necessary consensus checks. The legacy consensus engine can be any
 &#47;&#47; engine implements the consensus interface (except the beacon itself).
 type Beacon struct {
<span class="term-fg32">+	&#47;&#47; For migrated OP chains (OP mainnet, OP Goerli), ethone is a dummy legacy pre-Bedrock consensus</span>
 	ethone consensus.Engine &#47;&#47; Original consensus engine used in eth1, e.g. ethash or clique
 }
&nbsp;
<span class="term-fg36">@@ -106,12 +107,27 @@</span> 	}
 	return errs
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; OP-Stack Bedrock variant of splitHeaders: the total-terminal difficulty is terminated at bedrock transition, but also reset to 0.</span>
<span class="term-fg32">+&#47;&#47; So just use the bedrock fork check to split the headers, to simplify the splitting.</span>
<span class="term-fg32">+&#47;&#47; The returned slices are slices over the input. The input must be sorted.</span>
<span class="term-fg32">+func (beacon *Beacon) splitBedrockHeaders(chain consensus.ChainHeaderReader, headers []*types.Header) ([]*types.Header, []*types.Header, error) {</span>
<span class="term-fg32">+	for i, h := range headers {</span>
<span class="term-fg32">+		if chain.Config().IsBedrock(h.Number) {</span>
<span class="term-fg32">+			return headers[:i], headers[i:], nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return headers, nil, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; splitHeaders splits the provided header batch into two parts according to
 &#47;&#47; the configured ttd. It requires the parent of header batch along with its
 &#47;&#47; td are stored correctly in chain. If ttd is not configured yet, all headers
 &#47;&#47; will be treated legacy PoW headers.
 &#47;&#47; Note, this function will not verify the header validity but just split them.
 func (beacon *Beacon) splitHeaders(chain consensus.ChainHeaderReader, headers []*types.Header) ([]*types.Header, []*types.Header, error) {
<span class="term-fg32">+	if chain.Config().Optimism != nil {</span>
<span class="term-fg32">+		return beacon.splitBedrockHeaders(chain, headers)</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; TTD is not defined yet, all headers should be in legacy format.
 	ttd := chain.Config().TerminalTotalDifficulty
 	if ttd == nil {
<span class="term-fg36">@@ -447,6 +463,10 @@</span> func (beacon *Beacon) InnerEngine() consensus.Engine {
 	return beacon.ethone
 }
&nbsp;
<span class="term-fg32">+func (beacon *Beacon) SwapInner(inner consensus.Engine) {</span>
<span class="term-fg32">+	beacon.ethone = inner</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; SetThreads updates the mining threads. Delegate the call
 &#47;&#47; to the eth1 engine if it&#39;s threaded.
 func (beacon *Beacon) SetThreads(threads int) {
<span class="term-fg36">@@ -462,8 +482,16 @@</span> &#47;&#47; IsTTDReached checks if the TotalTerminalDifficulty has been surpassed on the `parentHash` block.
 &#47;&#47; It depends on the parentHash already being stored in the database.
 &#47;&#47; If the parentHash is not stored in the database a UnknownAncestor error is returned.
 func IsTTDReached(chain consensus.ChainHeaderReader, parentHash common.Hash, parentNumber uint64) (bool, error) {
<span class="term-fg32">+	if cfg := chain.Config(); cfg.Optimism != nil {</span>
<span class="term-fg32">+		&#47;&#47; If OP-Stack then bedrock activation number determines when TTD (eth Merge) has been reached.</span>
<span class="term-fg32">+		&#47;&#47; Note: some tests&#47;utils will set parentNumber == max_uint64 as &quot;parent&quot; of the genesis block, this is fine.</span>
<span class="term-fg32">+		return cfg.IsBedrock(new(big.Int).SetUint64(parentNumber + 1)), nil</span>
<span class="term-fg32">+	}</span>
 	if chain.Config().TerminalTotalDifficulty == nil {
 		return false, nil
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if common.Big0.Cmp(chain.Config().TerminalTotalDifficulty) == 0 { &#47;&#47; in case TTD is reached at genesis.</span>
<span class="term-fg32">+		return true, nil</span>
 	}
 	td := chain.GetTd(parentHash, parentNumber)
 	if td == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-c550a726aec15950ec72145c"role="button" aria-expanded="false" aria-controls="id-c550a726aec15950ec72145c">
        
            <div class="col-12 col-sm-9 text-start"><h4>Legacy OP-mainnet / OP-goerli header-verification support</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+91</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-c550a726aec15950ec72145c">
        <div><p>Pre-Bedrock OP-mainnet and OP-Goerli had differently formatted block-headers, loosely compatible with the geth types (since it was based on Clique).
However, due to differences like the extra-data length (97+ bytes), these legacy block-headers need special verification.
The pre-merge &ldquo;consensus&rdquo; fallback is set to this custom but basic verifier, to accept these headers when syncing a pre-bedrock part of the chain,
independent of any clique code or configuration (which may be removed from geth at a later point).
All the custom verifier has to do is accept the headers, as the headers are already verified by block-hash through the reverse-header-sync.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-01ebbb2d227a26e1a3ba3955" role="button"
                   aria-expanded="false" aria-controls="id-01ebbb2d227a26e1a3ba3955">
                    <code>consensus/beacon/oplegacy.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/consensus/beacon/oplegacy.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+91</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-01ebbb2d227a26e1a3ba3955"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;beacon&#47;oplegacy.go op-geth&#47;consensus&#47;beacon&#47;oplegacy.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..62810cb03f15680aeef90074196bdb1dbefb5dee</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;beacon&#47;oplegacy.go</span>
<span class="term-fg36">@@ -0,0 +1,91 @@</span>
<span class="term-fg32">+package beacon</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type OpLegacy struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) Author(header *types.Header) (common.Address, error) {</span>
<span class="term-fg32">+	return header.Coinbase, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) VerifyHeader(chain consensus.ChainHeaderReader, header *types.Header) error {</span>
<span class="term-fg32">+	&#47;&#47; Short circuit if the header is known, or its parent not</span>
<span class="term-fg32">+	number := header.Number.Uint64()</span>
<span class="term-fg32">+	if chain.GetHeader(header.Hash(), number) != nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	parent := chain.GetHeader(header.ParentHash, number-1)</span>
<span class="term-fg32">+	if parent == nil {</span>
<span class="term-fg32">+		return consensus.ErrUnknownAncestor</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; legacy chain is verified by block-hash reverse sync otherwise</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) VerifyHeaders(chain consensus.ChainHeaderReader, headers []*types.Header) (chan&lt;- struct{}, &lt;-chan error) {</span>
<span class="term-fg32">+	abort := make(chan struct{})</span>
<span class="term-fg32">+	results := make(chan error, len(headers))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for i := range headers {</span>
<span class="term-fg32">+		&#47;&#47; legacy chain is verified by block-hash reverse sync</span>
<span class="term-fg32">+		var parent *types.Header</span>
<span class="term-fg32">+		if i == 0 {</span>
<span class="term-fg32">+			parent = chain.GetHeader(headers[0].ParentHash, headers[0].Number.Uint64()-1)</span>
<span class="term-fg32">+		} else if headers[i-1].Hash() == headers[i].ParentHash {</span>
<span class="term-fg32">+			parent = headers[i-1]</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var err error</span>
<span class="term-fg32">+		if parent == nil {</span>
<span class="term-fg32">+			err = consensus.ErrUnknownAncestor</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		results &lt;- err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return abort, results</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) VerifyUncles(chain consensus.ChainReader, block *types.Block) error {</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) Prepare(chain consensus.ChainHeaderReader, header *types.Header) error {</span>
<span class="term-fg32">+	return fmt.Errorf(&quot;cannot prepare for legacy block header: %s (num %d)&quot;, header.Hash(), header.Number)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) Finalize(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, withdrawals []*types.Withdrawal) {</span>
<span class="term-fg32">+	panic(fmt.Errorf(&quot;cannot finalize legacy block header: %s (num %d)&quot;, header.Hash(), header.Number))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) FinalizeAndAssemble(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, receipts []*types.Receipt, withdrawals []*types.Withdrawal) (*types.Block, error) {</span>
<span class="term-fg32">+	return nil, fmt.Errorf(&quot;cannot finalize and assemble for legacy block header: %s (num %d)&quot;, header.Hash(), header.Number)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) Seal(chain consensus.ChainHeaderReader, block *types.Block, results chan&lt;- *types.Block, stop &lt;-chan struct{}) error {</span>
<span class="term-fg32">+	return fmt.Errorf(&quot;cannot seal legacy block header: %s (num %d)&quot;, block.Hash(), block.Number())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) SealHash(header *types.Header) common.Hash {</span>
<span class="term-fg32">+	panic(fmt.Errorf(&quot;cannot compute pow&#47;poa seal-hash for legacy block header: %s (num %d)&quot;, header.Hash(), header.Number))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) CalcDifficulty(chain consensus.ChainHeaderReader, time uint64, parent *types.Header) *big.Int {</span>
<span class="term-fg32">+	return big.NewInt(0)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) APIs(chain consensus.ChainHeaderReader) []rpc.API {</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (o *OpLegacy) Close() error {</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var _ consensus.Engine = (*OpLegacy)(nil)</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-468cf18f0dc318bd0ab25bc9"role="button" aria-expanded="false" aria-controls="id-468cf18f0dc318bd0ab25bc9">
        
            <div class="col-12 col-sm-9 text-start"><h3>Engine API modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+65</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-468cf18f0dc318bd0ab25bc9">
        <div><p>The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,
to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.
See <a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 execution engine specs</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e64b2aa23956daa3bcc94202" role="button"
                   aria-expanded="false" aria-controls="id-e64b2aa23956daa3bcc94202">
                    <code>beacon/engine/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/beacon/engine/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/beacon/engine/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e64b2aa23956daa3bcc94202"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;types.go op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">index f72319ad50b5e3905512a37bc6d571813f0b80ec..52d26c6d8432cc6b09a03174edede5cf05bbac86 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg36">@@ -46,11 +46,22 @@</span> 	Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 	SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
 	Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`
 	BeaconRoot            *common.Hash        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Transactions is a field for rollups: the transactions list is forced into the block</span>
<span class="term-fg32">+	Transactions [][]byte `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; NoTxPool is a field for rollups: if true, the no transactions are taken out of the tx-pool,</span>
<span class="term-fg32">+	&#47;&#47; only transactions from the above Transactions list will be included.</span>
<span class="term-fg32">+	NoTxPool bool `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; GasLimit is a field for rollups: if set, this sets the exact gas limit the block produced with.</span>
<span class="term-fg32">+	GasLimit *uint64 `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 }
&nbsp;
 &#47;&#47; JSON type overrides for PayloadAttributes.
 type payloadAttributesMarshaling struct {
 	Timestamp hexutil.Uint64
<span class="term-fg32">+</span>
<span class="term-fg32">+	Transactions []hexutil.Bytes</span>
<span class="term-fg32">+	GasLimit     *hexutil.Uint64</span>
 }
&nbsp;
 &#47;&#47;go:generate go run github.com&#47;fjl&#47;gencodec -type ExecutableData -field-override executableDataMarshaling -out gen_ed.go
<span class="term-fg36">@@ -97,6 +108,9 @@</span> 	ExecutionPayload *ExecutableData `json:&quot;executionPayload&quot;  gencodec:&quot;required&quot;`
 	BlockValue       *big.Int        `json:&quot;blockValue&quot;  gencodec:&quot;required&quot;`
 	BlobsBundle      *BlobsBundleV1  `json:&quot;blobsBundle&quot;`
 	Override         bool            `json:&quot;shouldOverrideBuilder&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; OP-Stack: Ecotone specific fields</span>
<span class="term-fg32">+	ParentBeaconBlockRoot *common.Hash `json:&quot;parentBeaconBlockRoot,omitempty&quot;`</span>
 }
&nbsp;
 type BlobsBundleV1 struct {
<span class="term-fg36">@@ -295,7 +309,13 @@</span> 			bundle.Commitments = append(bundle.Commitments, hexutil.Bytes(sidecar.Commitments[j][:]))
 			bundle.Proofs = append(bundle.Proofs, hexutil.Bytes(sidecar.Proofs[j][:]))
 		}
 	}
<span class="term-fg31">-	return &amp;ExecutionPayloadEnvelope{ExecutionPayload: data, BlockValue: fees, BlobsBundle: &amp;bundle, Override: false}</span>
<span class="term-fg32">+	return &amp;ExecutionPayloadEnvelope{</span>
<span class="term-fg32">+		ExecutionPayload:      data,</span>
<span class="term-fg32">+		BlockValue:            fees,</span>
<span class="term-fg32">+		BlobsBundle:           &amp;bundle,</span>
<span class="term-fg32">+		Override:              false,</span>
<span class="term-fg32">+		ParentBeaconBlockRoot: block.BeaconRoot(),</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; ExecutionPayloadBodyV1 is used in the response to GetPayloadBodiesByHashV1 and GetPayloadBodiesByRangeV1</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-699a633624cc50a3d0d5f46b" role="button"
                   aria-expanded="false" aria-controls="id-699a633624cc50a3d0d5f46b">
                    <code>beacon/engine/gen_blockparams.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/beacon/engine/gen_blockparams.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/beacon/engine/gen_blockparams.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+26</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-699a633624cc50a3d0d5f46b"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">index b1f01b50ff8e3b1adf0454ff989356a6f612a337..c343e5890668558738a5f31b287a89a427888f66 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg36">@@ -21,6 +21,9 @@</span> 		Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
 		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`
 		BeaconRoot            *common.Hash        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              bool                `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var enc PayloadAttributes
 	enc.Timestamp = hexutil.Uint64(p.Timestamp)
<span class="term-fg36">@@ -28,6 +31,14 @@</span> 	enc.Random = p.Random
 	enc.SuggestedFeeRecipient = p.SuggestedFeeRecipient
 	enc.Withdrawals = p.Withdrawals
 	enc.BeaconRoot = p.BeaconRoot
<span class="term-fg32">+	if p.Transactions != nil {</span>
<span class="term-fg32">+		enc.Transactions = make([]hexutil.Bytes, len(p.Transactions))</span>
<span class="term-fg32">+		for k, v := range p.Transactions {</span>
<span class="term-fg32">+			enc.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	enc.NoTxPool = p.NoTxPool</span>
<span class="term-fg32">+	enc.GasLimit = (*hexutil.Uint64)(p.GasLimit)</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -39,6 +50,9 @@</span> 		Random                *common.Hash        `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient *common.Address     `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
 		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`
 		BeaconRoot            *common.Hash        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              *bool               `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var dec PayloadAttributes
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -61,6 +75,18 @@</span> 		p.Withdrawals = dec.Withdrawals
 	}
 	if dec.BeaconRoot != nil {
 		p.BeaconRoot = dec.BeaconRoot
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.Transactions != nil {</span>
<span class="term-fg32">+		p.Transactions = make([][]byte, len(dec.Transactions))</span>
<span class="term-fg32">+		for k, v := range dec.Transactions {</span>
<span class="term-fg32">+			p.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.NoTxPool != nil {</span>
<span class="term-fg32">+		p.NoTxPool = *dec.NoTxPool</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.GasLimit != nil {</span>
<span class="term-fg32">+		p.GasLimit = (*uint64)(dec.GasLimit)</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-213614a1f91d1cabbbbeed06" role="button"
                   aria-expanded="false" aria-controls="id-213614a1f91d1cabbbbeed06">
                    <code>eth/catalyst/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/catalyst/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/catalyst/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+18</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-213614a1f91d1cabbbbeed06"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api.go op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">index 87a9731fdff0ebc29db4b9797daeace3a80f83f9..1270a6d2cbffc8465ea4c17bb3ef3f603a97854d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg36">@@ -316,7 +316,7 @@</span> 	} else if api.eth.BlockChain().CurrentBlock().Hash() == update.HeadBlockHash {
 		&#47;&#47; If the specified head matches with our local head, do nothing and keep
 		&#47;&#47; generating the payload. It&#39;s a special corner case that a few slots are
 		&#47;&#47; missing and we are requested to generate the payload in slot.
<span class="term-fg31">-	} else {</span>
<span class="term-fg32">+	} else if api.eth.BlockChain().Config().Optimism == nil { &#47;&#47; minor Engine API divergence: allow proposers to reorg their own chain</span>
 		&#47;&#47; If the head block is already in our canonical chain, the beacon client is
 		&#47;&#47; probably resyncing. Ignore the update.
 		log.Info(&quot;Ignoring beacon update to old head&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, update.HeadBlockHash, &quot;age&quot;, common.PrettyAge(time.Unix(int64(block.Time()), 0)), &quot;have&quot;, api.eth.BlockChain().CurrentBlock().Number)
<span class="term-fg36">@@ -360,6 +360,17 @@</span> 	&#47;&#47; If payload generation was requested, create a new block to be potentially
 	&#47;&#47; sealed by the beacon client. The payload will be requested later, and we
 	&#47;&#47; will replace it arbitrarily many times in between.
 	if payloadAttributes != nil {
<span class="term-fg32">+		if api.eth.BlockChain().Config().Optimism != nil &amp;&amp; payloadAttributes.GasLimit == nil {</span>
<span class="term-fg32">+			return engine.STATUS_INVALID, engine.InvalidPayloadAttributes.With(errors.New(&quot;gasLimit parameter is required&quot;))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		transactions := make(types.Transactions, 0, len(payloadAttributes.Transactions))</span>
<span class="term-fg32">+		for i, otx := range payloadAttributes.Transactions {</span>
<span class="term-fg32">+			var tx types.Transaction</span>
<span class="term-fg32">+			if err := tx.UnmarshalBinary(otx); err != nil {</span>
<span class="term-fg32">+				return engine.STATUS_INVALID, fmt.Errorf(&quot;transaction %d is not valid: %v&quot;, i, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			transactions = append(transactions, &amp;tx)</span>
<span class="term-fg32">+		}</span>
 		args := &amp;miner.BuildPayloadArgs{
 			Parent:       update.HeadBlockHash,
 			Timestamp:    payloadAttributes.Timestamp,
<span class="term-fg36">@@ -367,6 +378,9 @@</span> 			FeeRecipient: payloadAttributes.SuggestedFeeRecipient,
 			Random:       payloadAttributes.Random,
 			Withdrawals:  payloadAttributes.Withdrawals,
 			BeaconRoot:   payloadAttributes.BeaconRoot,
<span class="term-fg32">+			NoTxPool:     payloadAttributes.NoTxPool,</span>
<span class="term-fg32">+			Transactions: transactions,</span>
<span class="term-fg32">+			GasLimit:     payloadAttributes.GasLimit,</span>
 			Version:      payloadVersion,
 		}
 		id := args.Id()
<span class="term-fg36">@@ -748,6 +762,9 @@</span> &#47;&#47; user that something might be off with their consensus node.
 &#47;&#47;
 &#47;&#47; TODO(karalabe): Spin this goroutine down somehow
 func (api *ConsensusAPI) heartbeat() {
<span class="term-fg32">+	if api.eth.BlockChain().Config().Optimism != nil { &#47;&#47; don&#39;t start the api heartbeat, there is no transition</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Sleep a bit on startup since there&#39;s obviously no beacon client yet
 	&#47;&#47; attached, so no need to print scary warnings to the user.
 	time.Sleep(beaconUpdateStartupTimeout)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-41677879c98843da704c8fe9"role="button" aria-expanded="false" aria-controls="id-41677879c98843da704c8fe9">
        
            <div class="col-12 col-sm-9 text-start"><h3>Block-building modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+373</span></div>
                <div class="text-start"><span class="text-danger">-67</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-41677879c98843da704c8fe9">
        <div><p>The block-building code (in the &ldquo;miner&rdquo; package because of Proof-Of-Work legacy of ethereum) implements the
changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-82c3ed1097f1422815f2f7ad" role="button"
                   aria-expanded="false" aria-controls="id-82c3ed1097f1422815f2f7ad">
                    <code>miner/miner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/miner/miner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/miner/miner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-82c3ed1097f1422815f2f7ad"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;miner.go op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg1">index b7273948f5e75dac52548cc07faa19abd5705072..82d353a336eff601566da2f938e344a62f474027 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;miner.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package miner implements Ethereum block creation and mining.
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -31,6 +32,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -43,6 +45,10 @@</span> 	BlockChain() *core.BlockChain
 	TxPool() *txpool.TxPool
 }
&nbsp;
<span class="term-fg32">+type BackendWithHistoricalState interface {</span>
<span class="term-fg32">+	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, tracers.StateReleaseFunc, error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Config is the configuration parameters of mining.
 type Config struct {
 	Etherbase common.Address `toml:&quot;,omitempty&quot;` &#47;&#47; Public address for block mining rewards
<span class="term-fg36">@@ -53,6 +59,8 @@</span> 	GasPrice  *big.Int       &#47;&#47; Minimum gas price for mining a transaction
 	Recommit  time.Duration  &#47;&#47; The time interval for miner to re-create mining work.
&nbsp;
 	NewPayloadTimeout time.Duration &#47;&#47; The maximum time allowance for creating a new payload
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupComputePendingBlock bool &#47;&#47; Compute the pending block from tx-pool, instead of copying the latest-block</span>
 }
&nbsp;
 &#47;&#47; DefaultConfig contains default settings for miner.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-96c02c8b45ec8811e5a94f1a" role="button"
                   aria-expanded="false" aria-controls="id-96c02c8b45ec8811e5a94f1a">
                    <code>miner/payload_building_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/miner/payload_building_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/miner/payload_building_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+58</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-96c02c8b45ec8811e5a94f1a"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;payload_building_test.go op-geth&#47;miner&#47;payload_building_test.go</span>
<span class="term-fg1">index 708072b5ecf2b593d22a6447d535f76618ee8b7f..3696a60f452d2aeaed6d053850577059a61832fe 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;payload_building_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;payload_building_test.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
<span class="term-fg36">@@ -30,6 +31,14 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 )
&nbsp;
 func TestBuildPayload(t *testing.T) {
<span class="term-fg32">+	t.Run(&quot;no-tx-pool&quot;, func(t *testing.T) { testBuildPayload(t, true, false) })</span>
<span class="term-fg32">+	&#47;&#47; no-tx-pool case with interrupt not interesting because no-tx-pool doesn&#39;t run</span>
<span class="term-fg32">+	&#47;&#47; the builder routine</span>
<span class="term-fg32">+	t.Run(&quot;with-tx-pool&quot;, func(t *testing.T) { testBuildPayload(t, false, false) })</span>
<span class="term-fg32">+	t.Run(&quot;with-tx-pool-interrupt&quot;, func(t *testing.T) { testBuildPayload(t, false, true) })</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testBuildPayload(t *testing.T, noTxPool, interrupt bool) {</span>
 	t.Parallel()
 	var (
 		db        = rawdb.NewMemoryDatabase()
<span class="term-fg36">@@ -38,18 +47,33 @@</span> 	)
 	w, b := newTestWorker(t, params.TestChainConfig, ethash.NewFaker(), db, 0)
 	defer w.close()
&nbsp;
<span class="term-fg32">+	const numInterruptTxs = 256</span>
<span class="term-fg32">+	if interrupt {</span>
<span class="term-fg32">+		&#47;&#47; when doing interrupt testing, create a large pool so interruption will</span>
<span class="term-fg32">+		&#47;&#47; definitely be visible.</span>
<span class="term-fg32">+		txs := genTxs(1, numInterruptTxs)</span>
<span class="term-fg32">+		b.txPool.Add(txs, true, false)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	timestamp := uint64(time.Now().Unix())
 	args := &amp;BuildPayloadArgs{
 		Parent:       b.chain.CurrentBlock().Hash(),
 		Timestamp:    timestamp,
 		Random:       common.Hash{},
 		FeeRecipient: recipient,
<span class="term-fg32">+		NoTxPool:     noTxPool,</span>
 	}
<span class="term-fg32">+	&#47;&#47; payload resolution now interrupts block building, so we have to</span>
<span class="term-fg32">+	&#47;&#47; wait for the payloading building process to build its first block</span>
 	payload, err := w.buildPayload(args)
 	if err != nil {
 		t.Fatalf(&quot;Failed to build payload %v&quot;, err)
 	}
 	verify := func(outer *engine.ExecutionPayloadEnvelope, txs int) {
<span class="term-fg32">+		t.Helper()</span>
<span class="term-fg32">+		if outer == nil {</span>
<span class="term-fg32">+			t.Fatal(&quot;ExecutionPayloadEnvelope is nil&quot;)</span>
<span class="term-fg32">+		}</span>
 		payload := outer.ExecutionPayload
 		if payload.ParentHash != b.chain.CurrentBlock().Hash() {
 			t.Fatal(&quot;Unexpected parent hash&quot;)
<span class="term-fg36">@@ -63,15 +87,27 @@</span> 		}
 		if payload.FeeRecipient != recipient {
 			t.Fatal(&quot;Unexpected fee recipient&quot;)
 		}
<span class="term-fg31">-		if len(payload.Transactions) != txs {</span>
<span class="term-fg31">-			t.Fatal(&quot;Unexpected transaction set&quot;)</span>
<span class="term-fg32">+		if !interrupt &amp;&amp; len(payload.Transactions) != txs {</span>
<span class="term-fg32">+			t.Fatalf(&quot;Unexpect transaction set: got %d, expected %d&quot;, len(payload.Transactions), txs)</span>
<span class="term-fg32">+		} else if interrupt &amp;&amp; len(payload.Transactions) &gt;= txs {</span>
<span class="term-fg32">+			t.Fatalf(&quot;Unexpect transaction set: got %d, expected less than %d&quot;, len(payload.Transactions), txs)</span>
 		}
 	}
<span class="term-fg31">-	empty := payload.ResolveEmpty()</span>
<span class="term-fg31">-	verify(empty, 0)</span>
&nbsp;
<span class="term-fg31">-	full := payload.ResolveFull()</span>
<span class="term-fg31">-	verify(full, len(pendingTxs))</span>
<span class="term-fg32">+	if noTxPool {</span>
<span class="term-fg32">+		&#47;&#47; we only build the empty block when ignoring the tx pool</span>
<span class="term-fg32">+		empty := payload.ResolveEmpty()</span>
<span class="term-fg32">+		verify(empty, 0)</span>
<span class="term-fg32">+		full := payload.ResolveFull()</span>
<span class="term-fg32">+		verify(full, 0)</span>
<span class="term-fg32">+	} else if interrupt {</span>
<span class="term-fg32">+		full := payload.ResolveFull()</span>
<span class="term-fg32">+		verify(full, len(pendingTxs)+numInterruptTxs)</span>
<span class="term-fg32">+	} else { &#47;&#47; tx-pool and no interrupt</span>
<span class="term-fg32">+		payload.WaitFull()</span>
<span class="term-fg32">+		full := payload.ResolveFull()</span>
<span class="term-fg32">+		verify(full, len(pendingTxs))</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Ensure resolve can be called multiple times and the
 	&#47;&#47; result should be unchanged
<span class="term-fg36">@@ -80,6 +116,22 @@</span> 	dataTwo := payload.Resolve()
 	if !reflect.DeepEqual(dataOne, dataTwo) {
 		t.Fatal(&quot;Unexpected payload data&quot;)
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func genTxs(startNonce, count uint64) types.Transactions {</span>
<span class="term-fg32">+	txs := make(types.Transactions, 0, count)</span>
<span class="term-fg32">+	signer := types.LatestSigner(params.TestChainConfig)</span>
<span class="term-fg32">+	for nonce := startNonce; nonce &lt; startNonce+count; nonce++ {</span>
<span class="term-fg32">+		txs = append(txs, types.MustSignNewTx(testBankKey, signer, &amp;types.AccessListTx{</span>
<span class="term-fg32">+			ChainID:  params.TestChainConfig.ChainID,</span>
<span class="term-fg32">+			Nonce:    nonce,</span>
<span class="term-fg32">+			To:       &amp;testUserAddress,</span>
<span class="term-fg32">+			Value:    big.NewInt(1000),</span>
<span class="term-fg32">+			Gas:      params.TxGas,</span>
<span class="term-fg32">+			GasPrice: big.NewInt(params.InitialBaseFee),</span>
<span class="term-fg32">+		}))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return txs</span>
 }
&nbsp;
 func TestPayloadId(t *testing.T) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0291e7cdb1f6d905577b0324" role="button"
                   aria-expanded="false" aria-controls="id-0291e7cdb1f6d905577b0324">
                    <code>miner/payload_building.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/miner/payload_building.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/miner/payload_building.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+182</span></div>
                        <div class="text-start"><span class="text-danger">-50</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0291e7cdb1f6d905577b0324"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;payload_building.go op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">index 719736c4795c03b461a3a8b0fdde6b1cd9495670..0190496c5964a1d70e124d72013446cd57e8a917 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg36">@@ -19,8 +19,10 @@</span>
 import (
 	&quot;crypto&#47;sha256&quot;
 	&quot;encoding&#47;binary&quot;
<span class="term-fg32">+	&quot;errors&quot;</span>
 	&quot;math&#47;big&quot;
 	&quot;sync&quot;
<span class="term-fg32">+	&quot;sync&#47;atomic&quot;</span>
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;beacon&#47;engine&quot;
<span class="term-fg36">@@ -42,6 +44,10 @@</span> 	Random       common.Hash           &#47;&#47; The provided randomness value
 	Withdrawals  types.Withdrawals     &#47;&#47; The provided withdrawals
 	BeaconRoot   *common.Hash          &#47;&#47; The provided beaconRoot (Cancun)
 	Version      engine.PayloadVersion &#47;&#47; Versioning byte for payload id calculation.
<span class="term-fg32">+</span>
<span class="term-fg32">+	NoTxPool     bool                 &#47;&#47; Optimism addition: option to disable tx pool contents from being included</span>
<span class="term-fg32">+	Transactions []*types.Transaction &#47;&#47; Optimism addition: txs forced into the block via engine API</span>
<span class="term-fg32">+	GasLimit     *uint64              &#47;&#47; Optimism addition: override gas limit of the block to build</span>
 }
&nbsp;
 &#47;&#47; Id computes an 8-byte identifier by hashing the components of the payload arguments.
<span class="term-fg36">@@ -56,6 +62,19 @@</span> 	rlp.Encode(hasher, args.Withdrawals)
 	if args.BeaconRoot != nil {
 		hasher.Write(args.BeaconRoot[:])
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if args.NoTxPool || len(args.Transactions) &gt; 0 { &#47;&#47; extend if extra payload attributes are used</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, args.NoTxPool)</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, uint64(len(args.Transactions)))</span>
<span class="term-fg32">+		for _, tx := range args.Transactions {</span>
<span class="term-fg32">+			h := tx.Hash()</span>
<span class="term-fg32">+			hasher.Write(h[:])</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if args.GasLimit != nil {</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, *args.GasLimit)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var out engine.PayloadID
 	copy(out[:], hasher.Sum(nil)[:8])
 	out[0] = byte(args.Version)
<span class="term-fg36">@@ -76,6 +95,10 @@</span> 	fullFees *big.Int
 	stop     chan struct{}
 	lock     sync.Mutex
 	cond     *sync.Cond
<span class="term-fg32">+</span>
<span class="term-fg32">+	err       error</span>
<span class="term-fg32">+	stopOnce  sync.Once</span>
<span class="term-fg32">+	interrupt *atomic.Int32 &#47;&#47; interrupt signal shared with worker</span>
 }
&nbsp;
 &#47;&#47; newPayload initializes the payload object.
<span class="term-fg36">@@ -84,12 +107,16 @@</span> 	payload := &amp;Payload{
 		id:    id,
 		empty: empty,
 		stop:  make(chan struct{}),
<span class="term-fg32">+</span>
<span class="term-fg32">+		interrupt: new(atomic.Int32),</span>
 	}
 	log.Info(&quot;Starting work on payload&quot;, &quot;id&quot;, payload.id)
 	payload.cond = sync.NewCond(&amp;payload.lock)
 	return payload
 }
&nbsp;
<span class="term-fg32">+var errInterruptedUpdate = errors.New(&quot;interrupted payload update&quot;)</span>
<span class="term-fg32">+</span>
 &#47;&#47; update updates the full-block with latest built version.
 func (payload *Payload) update(r *newPayloadResult, elapsed time.Duration) {
 	payload.lock.Lock()
<span class="term-fg36">@@ -100,6 +127,19 @@</span> 	case &lt;-payload.stop:
 		return &#47;&#47; reject stale update
 	default:
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	defer payload.cond.Broadcast() &#47;&#47; fire signal for notifying any full block result</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if errors.Is(r.err, errInterruptedUpdate) {</span>
<span class="term-fg32">+		log.Debug(&quot;Ignoring interrupted payload update&quot;, &quot;id&quot;, payload.id)</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	} else if r.err != nil {</span>
<span class="term-fg32">+		log.Warn(&quot;Error building payload update&quot;, &quot;id&quot;, payload.id, &quot;err&quot;, r.err)</span>
<span class="term-fg32">+		payload.err = r.err &#47;&#47; record latest error</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Debug(&quot;New payload update&quot;, &quot;id&quot;, payload.id, &quot;elapsed&quot;, common.PrettyDuration(elapsed))</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Ensure the newly provided full block has a higher transaction fee.
 	&#47;&#47; In post-merge stage, there is no uncle reward anymore and transaction
 	&#47;&#47; fee(apart from the mev revenue) is the only indicator for comparison.
<span class="term-fg36">@@ -121,24 +161,12 @@</span> 			&quot;root&quot;, r.block.Root(),
 			&quot;elapsed&quot;, common.PrettyDuration(elapsed),
 		)
 	}
<span class="term-fg31">-	payload.cond.Broadcast() &#47;&#47; fire signal for notifying full block</span>
 }
&nbsp;
 &#47;&#47; Resolve returns the latest built payload and also terminates the background
 &#47;&#47; thread for updating payload. It&#39;s safe to be called multiple times.
 func (payload *Payload) Resolve() *engine.ExecutionPayloadEnvelope {
<span class="term-fg31">-	payload.lock.Lock()</span>
<span class="term-fg31">-	defer payload.lock.Unlock()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	select {</span>
<span class="term-fg31">-	case &lt;-payload.stop:</span>
<span class="term-fg31">-	default:</span>
<span class="term-fg31">-		close(payload.stop)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if payload.full != nil {</span>
<span class="term-fg31">-		return engine.BlockToExecutableData(payload.full, payload.fullFees, payload.sidecars)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return engine.BlockToExecutableData(payload.empty, big.NewInt(0), nil)</span>
<span class="term-fg32">+	return payload.resolve(false)</span>
 }
&nbsp;
 &#47;&#47; ResolveEmpty is basically identical to Resolve, but it expects empty block only.
<span class="term-fg36">@@ -153,10 +181,24 @@</span>
 &#47;&#47; ResolveFull is basically identical to Resolve, but it expects full block only.
 &#47;&#47; Don&#39;t call Resolve until ResolveFull returns, otherwise it might block forever.
 func (payload *Payload) ResolveFull() *engine.ExecutionPayloadEnvelope {
<span class="term-fg32">+	return payload.resolve(true)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (payload *Payload) WaitFull() {</span>
 	payload.lock.Lock()
 	defer payload.lock.Unlock()
<span class="term-fg32">+	payload.cond.Wait()</span>
<span class="term-fg32">+}</span>
&nbsp;
<span class="term-fg31">-	if payload.full == nil {</span>
<span class="term-fg32">+func (payload *Payload) resolve(onlyFull bool) *engine.ExecutionPayloadEnvelope {</span>
<span class="term-fg32">+	payload.lock.Lock()</span>
<span class="term-fg32">+	defer payload.lock.Unlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; We interrupt any active building block to prevent it from adding more transactions,</span>
<span class="term-fg32">+	&#47;&#47; and if it is an update, don&#39;t attempt to seal the block.</span>
<span class="term-fg32">+	payload.interruptBuilding()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if payload.full == nil &amp;&amp; (onlyFull || payload.empty == nil) {</span>
 		select {
 		case &lt;-payload.stop:
 			return nil
<span class="term-fg36">@@ -167,21 +209,82 @@</span> 		&#47;&#47; forever if Resolve is called in the meantime which
 		&#47;&#47; terminates the background construction process.
 		payload.cond.Wait()
 	}
<span class="term-fg31">-	&#47;&#47; Terminate the background payload construction</span>
<span class="term-fg31">-	select {</span>
<span class="term-fg31">-	case &lt;-payload.stop:</span>
<span class="term-fg31">-	default:</span>
<span class="term-fg31">-		close(payload.stop)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Now we can signal the building routine to stop.</span>
<span class="term-fg32">+	payload.stopBuilding()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if payload.full != nil {</span>
<span class="term-fg32">+		return engine.BlockToExecutableData(payload.full, payload.fullFees, payload.sidecars)</span>
<span class="term-fg32">+	} else if !onlyFull &amp;&amp; payload.empty != nil {</span>
<span class="term-fg32">+		return engine.BlockToExecutableData(payload.empty, big.NewInt(0), nil)</span>
<span class="term-fg32">+	} else if err := payload.err; err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;Error building any payload&quot;, &quot;id&quot;, payload.id, &quot;err&quot;, err)</span>
 	}
<span class="term-fg31">-	return engine.BlockToExecutableData(payload.full, payload.fullFees, payload.sidecars)</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; interruptBuilding sets an interrupt for a potentially ongoing</span>
<span class="term-fg32">+&#47;&#47; block building process.</span>
<span class="term-fg32">+&#47;&#47; This will prevent it from adding new transactions to the block, and if it is</span>
<span class="term-fg32">+&#47;&#47; building an update, the block will also not be sealed, as we would discard</span>
<span class="term-fg32">+&#47;&#47; the update anyways.</span>
<span class="term-fg32">+&#47;&#47; interruptBuilding is safe to be called concurrently.</span>
<span class="term-fg32">+func (payload *Payload) interruptBuilding() {</span>
<span class="term-fg32">+	&#47;&#47; Set the interrupt if not interrupted already.</span>
<span class="term-fg32">+	&#47;&#47; It&#39;s ok if it has either already been interrupted by payload resolution earlier,</span>
<span class="term-fg32">+	&#47;&#47; or by the timeout timer set to commitInterruptTimeout.</span>
<span class="term-fg32">+	if payload.interrupt.CompareAndSwap(commitInterruptNone, commitInterruptResolve) {</span>
<span class="term-fg32">+		log.Debug(&quot;Interrupted payload building.&quot;, &quot;id&quot;, payload.id)</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		log.Debug(&quot;Payload building already interrupted.&quot;,</span>
<span class="term-fg32">+			&quot;id&quot;, payload.id, &quot;interrupt&quot;, payload.interrupt.Load())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; stopBuilding signals to the block updating routine to stop. An ongoing payload</span>
<span class="term-fg32">+&#47;&#47; building job will still complete. It can be interrupted to stop filling new</span>
<span class="term-fg32">+&#47;&#47; transactions with interruptBuilding.</span>
<span class="term-fg32">+&#47;&#47; stopBuilding is safe to be called concurrently.</span>
<span class="term-fg32">+func (payload *Payload) stopBuilding() {</span>
<span class="term-fg32">+	&#47;&#47; Concurrent Resolve calls should only stop once.</span>
<span class="term-fg32">+	payload.stopOnce.Do(func() {</span>
<span class="term-fg32">+		log.Debug(&quot;Stop payload building.&quot;, &quot;id&quot;, payload.id)</span>
<span class="term-fg32">+		close(payload.stop)</span>
<span class="term-fg32">+	})</span>
 }
&nbsp;
 &#47;&#47; buildPayload builds the payload according to the provided parameters.
 func (w *worker) buildPayload(args *BuildPayloadArgs) (*Payload, error) {
<span class="term-fg31">-	&#47;&#47; Build the initial version with no transaction included. It should be fast</span>
<span class="term-fg31">-	&#47;&#47; enough to run. The empty payload can at least make sure there is something</span>
<span class="term-fg31">-	&#47;&#47; to deliver for not missing slot.</span>
<span class="term-fg31">-	emptyParams := &amp;generateParams{</span>
<span class="term-fg32">+	if args.NoTxPool { &#47;&#47; don&#39;t start the background payload updating job if there is no tx pool to pull from</span>
<span class="term-fg32">+		&#47;&#47; Build the initial version with no transaction included. It should be fast</span>
<span class="term-fg32">+		&#47;&#47; enough to run. The empty payload can at least make sure there is something</span>
<span class="term-fg32">+		&#47;&#47; to deliver for not missing slot.</span>
<span class="term-fg32">+		&#47;&#47; In OP-Stack, the &quot;empty&quot; block is constructed from provided txs only, i.e. no tx-pool usage.</span>
<span class="term-fg32">+		emptyParams := &amp;generateParams{</span>
<span class="term-fg32">+			timestamp:   args.Timestamp,</span>
<span class="term-fg32">+			forceTime:   true,</span>
<span class="term-fg32">+			parentHash:  args.Parent,</span>
<span class="term-fg32">+			coinbase:    args.FeeRecipient,</span>
<span class="term-fg32">+			random:      args.Random,</span>
<span class="term-fg32">+			withdrawals: args.Withdrawals,</span>
<span class="term-fg32">+			beaconRoot:  args.BeaconRoot,</span>
<span class="term-fg32">+			noTxs:       true,</span>
<span class="term-fg32">+			txs:         args.Transactions,</span>
<span class="term-fg32">+			gasLimit:    args.GasLimit,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		empty := w.getSealingBlock(emptyParams)</span>
<span class="term-fg32">+		if empty.err != nil {</span>
<span class="term-fg32">+			return nil, empty.err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		payload := newPayload(empty.block, args.Id())</span>
<span class="term-fg32">+		&#47;&#47; make sure to make it appear as full, otherwise it will wait indefinitely for payload building to complete.</span>
<span class="term-fg32">+		payload.full = empty.block</span>
<span class="term-fg32">+		payload.fullFees = empty.fees</span>
<span class="term-fg32">+		payload.cond.Broadcast() &#47;&#47; unblocks Resolve</span>
<span class="term-fg32">+		return payload, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	fullParams := &amp;generateParams{</span>
 		timestamp:   args.Timestamp,
 		forceTime:   true,
 		parentHash:  args.Parent,
<span class="term-fg36">@@ -189,15 +292,21 @@</span> 		coinbase:    args.FeeRecipient,
 		random:      args.Random,
 		withdrawals: args.Withdrawals,
 		beaconRoot:  args.BeaconRoot,
<span class="term-fg31">-		noTxs:       true,</span>
<span class="term-fg32">+		noTxs:       false,</span>
<span class="term-fg32">+		txs:         args.Transactions,</span>
<span class="term-fg32">+		gasLimit:    args.GasLimit,</span>
 	}
<span class="term-fg31">-	empty := w.getSealingBlock(emptyParams)</span>
<span class="term-fg31">-	if empty.err != nil {</span>
<span class="term-fg31">-		return nil, empty.err</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Since we skip building the empty block when using the tx pool, we need to explicitly</span>
<span class="term-fg32">+	&#47;&#47; validate the BuildPayloadArgs here.</span>
<span class="term-fg32">+	blockTime, err := w.validateParams(fullParams)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
 	}
&nbsp;
<span class="term-fg31">-	&#47;&#47; Construct a payload object for return.</span>
<span class="term-fg31">-	payload := newPayload(empty.block, args.Id())</span>
<span class="term-fg32">+	payload := newPayload(nil, args.Id())</span>
<span class="term-fg32">+	&#47;&#47; set shared interrupt</span>
<span class="term-fg32">+	fullParams.interrupt = payload.interrupt</span>
&nbsp;
 	&#47;&#47; Spin up a routine for updating the payload in background. This strategy
 	&#47;&#47; can maximum the revenue for including transactions with highest fee.
<span class="term-fg36">@@ -207,36 +316,59 @@</span> 		&#47;&#47; for triggering process immediately.
 		timer := time.NewTimer(0)
 		defer timer.Stop()
&nbsp;
<span class="term-fg31">-		&#47;&#47; Setup the timer for terminating the process if SECONDS_PER_SLOT (12s in</span>
<span class="term-fg31">-		&#47;&#47; the Mainnet configuration) have passed since the point in time identified</span>
<span class="term-fg31">-		&#47;&#47; by the timestamp parameter.</span>
<span class="term-fg31">-		endTimer := time.NewTimer(time.Second * 12)</span>
<span class="term-fg32">+		start := time.Now()</span>
<span class="term-fg32">+		&#47;&#47; Setup the timer for terminating the payload building process as determined</span>
<span class="term-fg32">+		&#47;&#47; by validateParams.</span>
<span class="term-fg32">+		endTimer := time.NewTimer(blockTime)</span>
<span class="term-fg32">+		defer endTimer.Stop()</span>
&nbsp;
<span class="term-fg31">-		fullParams := &amp;generateParams{</span>
<span class="term-fg31">-			timestamp:   args.Timestamp,</span>
<span class="term-fg31">-			forceTime:   true,</span>
<span class="term-fg31">-			parentHash:  args.Parent,</span>
<span class="term-fg31">-			coinbase:    args.FeeRecipient,</span>
<span class="term-fg31">-			random:      args.Random,</span>
<span class="term-fg31">-			withdrawals: args.Withdrawals,</span>
<span class="term-fg31">-			beaconRoot:  args.BeaconRoot,</span>
<span class="term-fg31">-			noTxs:       false,</span>
<span class="term-fg32">+		timeout := time.Now().Add(blockTime)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		stopReason := &quot;delivery&quot;</span>
<span class="term-fg32">+		defer func() {</span>
<span class="term-fg32">+			log.Info(&quot;Stopping work on payload&quot;,</span>
<span class="term-fg32">+				&quot;id&quot;, payload.id,</span>
<span class="term-fg32">+				&quot;reason&quot;, stopReason,</span>
<span class="term-fg32">+				&quot;elapsed&quot;, time.Since(start).Milliseconds())</span>
<span class="term-fg32">+		}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		updatePayload := func() time.Duration {</span>
<span class="term-fg32">+			start := time.Now()</span>
<span class="term-fg32">+			&#47;&#47; getSealingBlock is interrupted by shared interrupt</span>
<span class="term-fg32">+			r := w.getSealingBlock(fullParams)</span>
<span class="term-fg32">+			dur := time.Since(start)</span>
<span class="term-fg32">+			&#47;&#47; update handles error case</span>
<span class="term-fg32">+			payload.update(r, dur)</span>
<span class="term-fg32">+			if r.err == nil {</span>
<span class="term-fg32">+				&#47;&#47; after first successful pass, we&#39;re updating</span>
<span class="term-fg32">+				fullParams.isUpdate = true</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			timer.Reset(w.recommit)</span>
<span class="term-fg32">+			return dur</span>
 		}
&nbsp;
<span class="term-fg32">+		var lastDuration time.Duration</span>
 		for {
 			select {
 			case &lt;-timer.C:
<span class="term-fg31">-				start := time.Now()</span>
<span class="term-fg31">-				r := w.getSealingBlock(fullParams)</span>
<span class="term-fg31">-				if r.err == nil {</span>
<span class="term-fg31">-					payload.update(r, time.Since(start))</span>
<span class="term-fg32">+				&#47;&#47; We have to prioritize the stop signal because the recommit timer</span>
<span class="term-fg32">+				&#47;&#47; might have fired while stop also got closed.</span>
<span class="term-fg32">+				select {</span>
<span class="term-fg32">+				case &lt;-payload.stop:</span>
<span class="term-fg32">+					return</span>
<span class="term-fg32">+				default:</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+				&#47;&#47; Assuming last payload building duration as lower bound for next one,</span>
<span class="term-fg32">+				&#47;&#47; skip new update if we&#39;re too close to the timeout anyways.</span>
<span class="term-fg32">+				if lastDuration &gt; 0 &amp;&amp; time.Now().Add(lastDuration).After(timeout) {</span>
<span class="term-fg32">+					stopReason = &quot;near-timeout&quot;</span>
<span class="term-fg32">+					return</span>
 				}
<span class="term-fg31">-				timer.Reset(w.recommit)</span>
<span class="term-fg32">+				lastDuration = updatePayload()</span>
 			case &lt;-payload.stop:
<span class="term-fg31">-				log.Info(&quot;Stopping work on payload&quot;, &quot;id&quot;, payload.id, &quot;reason&quot;, &quot;delivery&quot;)</span>
 				return
 			case &lt;-endTimer.C:
<span class="term-fg31">-				log.Info(&quot;Stopping work on payload&quot;, &quot;id&quot;, payload.id, &quot;reason&quot;, &quot;timeout&quot;)</span>
<span class="term-fg32">+				stopReason = &quot;timeout&quot;</span>
 				return
 			}
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a94e1e7943aa64aac999bedc" role="button"
                   aria-expanded="false" aria-controls="id-a94e1e7943aa64aac999bedc">
                    <code>miner/worker.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/miner/worker.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/miner/worker.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+123</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a94e1e7943aa64aac999bedc"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker.go op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg1">index 2ed91cc18781775121a77035b8e4879abdec7c17..8fe96f9a6c77bb2eea9c3bb731b3210573a449c0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg36">@@ -26,6 +27,7 @@</span> 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip1559&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip4844&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
<span class="term-fg36">@@ -33,6 +35,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -55,7 +58,7 @@</span> 	resubmitAdjustChanSize = 10
&nbsp;
 	&#47;&#47; minRecommitInterval is the minimal time interval to recreate the sealing block with
 	&#47;&#47; any newly arrived transactions.
<span class="term-fg31">-	minRecommitInterval = 1 * time.Second</span>
<span class="term-fg32">+	minRecommitInterval = 100 * time.Millisecond</span>
&nbsp;
 	&#47;&#47; maxRecommitInterval is the maximum time interval to recreate the sealing block with
 	&#47;&#47; any newly arrived transactions.
<span class="term-fg36">@@ -77,6 +80,7 @@</span> var (
 	errBlockInterruptedByNewHead  = errors.New(&quot;new head arrived while building block&quot;)
 	errBlockInterruptedByRecommit = errors.New(&quot;recommit interrupt while building block&quot;)
 	errBlockInterruptedByTimeout  = errors.New(&quot;timeout while building block&quot;)
<span class="term-fg32">+	errBlockInterruptedByResolve  = errors.New(&quot;payload resolution while building block&quot;)</span>
 )
&nbsp;
 &#47;&#47; environment is the worker&#39;s current environment and holds all
<span class="term-fg36">@@ -141,6 +145,7 @@</span> 	commitInterruptNone int32 = iota
 	commitInterruptNewHead
 	commitInterruptResubmit
 	commitInterruptTimeout
<span class="term-fg32">+	commitInterruptResolve</span>
 )
&nbsp;
 &#47;&#47; newWorkReq represents a request for new sealing work submitting with relative interrupt notifier.
<span class="term-fg36">@@ -338,6 +343,9 @@</span>
 &#47;&#47; pending returns the pending state and corresponding block. The returned
 &#47;&#47; values can be nil in case the pending block is not initialized.
 func (w *worker) pending() (*types.Block, *state.StateDB) {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		return nil, nil &#47;&#47; when not computing the pending block, there is never a pending state</span>
<span class="term-fg32">+	}</span>
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
 	if w.snapshotState == nil {
<span class="term-fg36">@@ -349,6 +357,12 @@</span>
 &#47;&#47; pendingBlock returns pending block. The returned block can be nil in case the
 &#47;&#47; pending block is not initialized.
 func (w *worker) pendingBlock() *types.Block {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		&#47;&#47; For compatibility when not computing a pending block, we serve the latest block as &quot;pending&quot;</span>
<span class="term-fg32">+		headHeader := w.eth.BlockChain().CurrentHeader()</span>
<span class="term-fg32">+		headBlock := w.eth.BlockChain().GetBlock(headHeader.Hash(), headHeader.Number.Uint64())</span>
<span class="term-fg32">+		return headBlock</span>
<span class="term-fg32">+	}</span>
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
 	return w.snapshotBlock
<span class="term-fg36">@@ -357,6 +371,9 @@</span>
 &#47;&#47; pendingBlockAndReceipts returns pending block and corresponding receipts.
 &#47;&#47; The returned values can be nil in case the pending block is not initialized.
 func (w *worker) pendingBlockAndReceipts() (*types.Block, types.Receipts) {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		return nil, nil &#47;&#47; when not computing the pending block, there are no pending receipts, and thus no pending logs</span>
<span class="term-fg32">+	}</span>
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
 	return w.snapshotBlock, w.snapshotReceipts
<span class="term-fg36">@@ -411,6 +428,19 @@</span>
 &#47;&#47; newWorkLoop is a standalone goroutine to submit new sealing work upon received events.
 func (w *worker) newWorkLoop(recommit time.Duration) {
 	defer w.wg.Done()
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		for { &#47;&#47; do not update the pending-block, instead drain work without doing it, to keep producers from blocking.</span>
<span class="term-fg32">+			select {</span>
<span class="term-fg32">+			case &lt;-w.startCh:</span>
<span class="term-fg32">+			case &lt;-w.chainHeadCh:</span>
<span class="term-fg32">+			case &lt;-w.resubmitIntervalCh:</span>
<span class="term-fg32">+			case &lt;-w.resubmitAdjustCh:</span>
<span class="term-fg32">+			case &lt;-w.exitCh:</span>
<span class="term-fg32">+				return</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var (
 		interrupt   *atomic.Int32
 		minRecommit = recommit &#47;&#47; minimal resubmit interval specified by user.
<span class="term-fg36">@@ -528,6 +558,9 @@</span> 		case req := &lt;-w.getWorkCh:
 			req.result &lt;- w.generateWork(req.params)
&nbsp;
 		case ev := &lt;-w.txsCh:
<span class="term-fg32">+			if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+				continue &#47;&#47; don&#39;t update the pending-block snapshot if we are not computing the pending block</span>
<span class="term-fg32">+			}</span>
 			&#47;&#47; Apply transactions to the pending state if we&#39;re not sealing
 			&#47;&#47;
 			&#47;&#47; Note all transactions received may not be continuous with transactions
<span class="term-fg36">@@ -708,6 +741,15 @@</span> func (w *worker) makeEnv(parent *types.Header, header *types.Header, coinbase common.Address) (*environment, error) {
 	&#47;&#47; Retrieve the parent state to execute on top and start a prefetcher for
 	&#47;&#47; the miner to speed block sealing up a bit.
 	state, err := w.chain.StateAt(parent.Root)
<span class="term-fg32">+	if err != nil &amp;&amp; w.chainConfig.Optimism != nil { &#47;&#47; Allow the miner to reorg its own chain arbitrarily deep</span>
<span class="term-fg32">+		if historicalBackend, ok := w.eth.(BackendWithHistoricalState); ok {</span>
<span class="term-fg32">+			var release tracers.StateReleaseFunc</span>
<span class="term-fg32">+			parentBlock := w.eth.BlockChain().GetBlockByHash(parent.Hash())</span>
<span class="term-fg32">+			state, release, err = historicalBackend.StateAtBlock(context.Background(), parentBlock, ^uint64(0), nil, false, false)</span>
<span class="term-fg32">+			state = state.Copy()</span>
<span class="term-fg32">+			release()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -896,6 +938,43 @@</span> 	random      common.Hash       &#47;&#47; The randomness generated by beacon chain, empty before the merge
 	withdrawals types.Withdrawals &#47;&#47; List of withdrawals to include in block.
 	beaconRoot  *common.Hash      &#47;&#47; The beacon root (cancun field).
 	noTxs       bool              &#47;&#47; Flag whether an empty block without any transaction is expected
<span class="term-fg32">+</span>
<span class="term-fg32">+	txs       types.Transactions &#47;&#47; Deposit transactions to include at the start of the block</span>
<span class="term-fg32">+	gasLimit  *uint64            &#47;&#47; Optional gas limit override</span>
<span class="term-fg32">+	interrupt *atomic.Int32      &#47;&#47; Optional interruption signal to pass down to worker.generateWork</span>
<span class="term-fg32">+	isUpdate  bool               &#47;&#47; Optional flag indicating that this is building a discardable update</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; validateParams validates the given parameters.</span>
<span class="term-fg32">+&#47;&#47; It currently checks that the parent block is known and that the timestamp is valid,</span>
<span class="term-fg32">+&#47;&#47; i.e., after the parent block&#39;s timestamp.</span>
<span class="term-fg32">+&#47;&#47; It returns an upper bound of the payload building duration as computed</span>
<span class="term-fg32">+&#47;&#47; by the difference in block timestamps between the parent and genParams.</span>
<span class="term-fg32">+func (w *worker) validateParams(genParams *generateParams) (time.Duration, error) {</span>
<span class="term-fg32">+	w.mu.RLock()</span>
<span class="term-fg32">+	defer w.mu.RUnlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Find the parent block for sealing task</span>
<span class="term-fg32">+	parent := w.chain.CurrentBlock()</span>
<span class="term-fg32">+	if genParams.parentHash != (common.Hash{}) {</span>
<span class="term-fg32">+		block := w.chain.GetBlockByHash(genParams.parentHash)</span>
<span class="term-fg32">+		if block == nil {</span>
<span class="term-fg32">+			return 0, fmt.Errorf(&quot;missing parent %v&quot;, genParams.parentHash)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		parent = block.Header()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Sanity check the timestamp correctness</span>
<span class="term-fg32">+	blockTime := int64(genParams.timestamp) - int64(parent.Time)</span>
<span class="term-fg32">+	if blockTime &lt;= 0 &amp;&amp; genParams.forceTime {</span>
<span class="term-fg32">+		return 0, fmt.Errorf(&quot;invalid timestamp, parent %d given %d&quot;, parent.Time, genParams.timestamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; minimum payload build time of 2s</span>
<span class="term-fg32">+	if blockTime &lt; 2 {</span>
<span class="term-fg32">+		blockTime = 2</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return time.Duration(blockTime) * time.Second, nil</span>
 }
&nbsp;
 &#47;&#47; prepareWork constructs the sealing task according to the given parameters,
<span class="term-fg36">@@ -932,7 +1011,7 @@</span> 		Time:       timestamp,
 		Coinbase:   genParams.coinbase,
 	}
 	&#47;&#47; Set the extra field.
<span class="term-fg31">-	if len(w.extra) != 0 {</span>
<span class="term-fg32">+	if len(w.extra) != 0 &amp;&amp; w.chainConfig.Optimism == nil { &#47;&#47; Optimism chains must not set any extra data.</span>
 		header.Extra = w.extra
 	}
 	&#47;&#47; Set the randomness field from the beacon chain if it&#39;s available.
<span class="term-fg36">@@ -941,11 +1020,17 @@</span> 		header.MixDigest = genParams.random
 	}
 	&#47;&#47; Set baseFee and GasLimit if we are on an EIP-1559 chain
 	if w.chainConfig.IsLondon(header.Number) {
<span class="term-fg31">-		header.BaseFee = eip1559.CalcBaseFee(w.chainConfig, parent)</span>
<span class="term-fg32">+		header.BaseFee = eip1559.CalcBaseFee(w.chainConfig, parent, header.Time)</span>
 		if !w.chainConfig.IsLondon(parent.Number) {
 			parentGasLimit := parent.GasLimit * w.chainConfig.ElasticityMultiplier()
 			header.GasLimit = core.CalcGasLimit(parentGasLimit, w.config.GasCeil)
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if genParams.gasLimit != nil { &#47;&#47; override gas limit if specified</span>
<span class="term-fg32">+		header.GasLimit = *genParams.gasLimit</span>
<span class="term-fg32">+	} else if w.chain.Config().Optimism != nil &amp;&amp; w.config.GasCeil != 0 {</span>
<span class="term-fg32">+		&#47;&#47; configure the gas limit of pending blocks with the miner gas limit config when using optimism</span>
<span class="term-fg32">+		header.GasLimit = w.config.GasCeil</span>
 	}
 	&#47;&#47; Apply EIP-4844, EIP-4788.
 	if w.chainConfig.IsCancun(header.Number, header.Time) {
<span class="term-fg36">@@ -974,7 +1059,7 @@</span> 		log.Error(&quot;Failed to create sealing context&quot;, &quot;err&quot;, err)
 		return nil, err
 	}
 	if header.ParentBeaconRoot != nil {
<span class="term-fg31">-		context := core.NewEVMBlockContext(header, w.chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(header, w.chain, nil, w.chainConfig, env.state)</span>
 		vmenv := vm.NewEVM(context, vm.TxContext{}, env.state, w.chainConfig, vm.Config{})
 		core.ProcessBeaconBlockRoot(*header.ParentBeaconRoot, vmenv, env.state)
 	}
<span class="term-fg36">@@ -1013,26 +1098,52 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; generateWork generates a sealing block based on the given parameters.
<span class="term-fg31">-func (w *worker) generateWork(params *generateParams) *newPayloadResult {</span>
<span class="term-fg31">-	work, err := w.prepareWork(params)</span>
<span class="term-fg32">+func (w *worker) generateWork(genParams *generateParams) *newPayloadResult {</span>
<span class="term-fg32">+	work, err := w.prepareWork(genParams)</span>
 	if err != nil {
 		return &amp;newPayloadResult{err: err}
 	}
 	defer work.discard()
<span class="term-fg32">+	if work.gasPool == nil {</span>
<span class="term-fg32">+		work.gasPool = new(core.GasPool).AddGas(work.header.GasLimit)</span>
<span class="term-fg32">+	}</span>
&nbsp;
<span class="term-fg31">-	if !params.noTxs {</span>
<span class="term-fg31">-		interrupt := new(atomic.Int32)</span>
<span class="term-fg32">+	misc.EnsureCreate2Deployer(w.chainConfig, work.header.Time, work.state)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, tx := range genParams.txs {</span>
<span class="term-fg32">+		from, _ := types.Sender(work.signer, tx)</span>
<span class="term-fg32">+		work.state.SetTxContext(tx.Hash(), work.tcount)</span>
<span class="term-fg32">+		_, err := w.commitTransaction(work, tx)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return &amp;newPayloadResult{err: fmt.Errorf(&quot;failed to force-include tx: %s type: %d sender: %s nonce: %d, err: %w&quot;, tx.Hash(), tx.Type(), from, tx.Nonce(), err)}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		work.tcount++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; forced transactions done, fill rest of block with transactions</span>
<span class="term-fg32">+	if !genParams.noTxs {</span>
<span class="term-fg32">+		&#47;&#47; use shared interrupt if present</span>
<span class="term-fg32">+		interrupt := genParams.interrupt</span>
<span class="term-fg32">+		if interrupt == nil {</span>
<span class="term-fg32">+			interrupt = new(atomic.Int32)</span>
<span class="term-fg32">+		}</span>
 		timer := time.AfterFunc(w.newpayloadTimeout, func() {
 			interrupt.Store(commitInterruptTimeout)
 		})
<span class="term-fg31">-		defer timer.Stop()</span>
&nbsp;
 		err := w.fillTransactions(interrupt, work)
<span class="term-fg32">+		timer.Stop() &#47;&#47; don&#39;t need timeout interruption any more</span>
 		if errors.Is(err, errBlockInterruptedByTimeout) {
 			log.Warn(&quot;Block building is interrupted&quot;, &quot;allowance&quot;, common.PrettyDuration(w.newpayloadTimeout))
<span class="term-fg32">+		} else if errors.Is(err, errBlockInterruptedByResolve) {</span>
<span class="term-fg32">+			log.Info(&quot;Block building got interrupted by payload resolution&quot;)</span>
 		}
 	}
<span class="term-fg31">-	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, nil, work.receipts, params.withdrawals)</span>
<span class="term-fg32">+	if intr := genParams.interrupt; intr != nil &amp;&amp; genParams.isUpdate &amp;&amp; intr.Load() != commitInterruptNone {</span>
<span class="term-fg32">+		return &amp;newPayloadResult{err: errInterruptedUpdate}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, nil, work.receipts, genParams.withdrawals)</span>
 	if err != nil {
 		return &amp;newPayloadResult{err: err}
 	}
<span class="term-fg36">@@ -1208,6 +1319,8 @@</span> 	case commitInterruptResubmit:
 		return errBlockInterruptedByRecommit
 	case commitInterruptTimeout:
 		return errBlockInterruptedByTimeout
<span class="term-fg32">+	case commitInterruptResolve:</span>
<span class="term-fg32">+		return errBlockInterruptedByResolve</span>
 	default:
 		panic(fmt.Errorf(&quot;undefined signal %d&quot;, signal))
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-235eafa77fe484046ca09f28" role="button"
                   aria-expanded="false" aria-controls="id-235eafa77fe484046ca09f28">
                    <code>miner/worker_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/miner/worker_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/miner/worker_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-235eafa77fe484046ca09f28"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker_test.go op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">index 675b8d55b9171897a9d33bd5312e7987d71d7089..448328e86c9e9e0d38bafe5b2630be52c273ea69 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg36">@@ -303,7 +303,8 @@</span> 			min := float64(3 * time.Second.Nanoseconds())
 			estimate = estimate*(1-intervalAdjustRatio) + intervalAdjustRatio*(min-intervalAdjustBias)
 			wantMinInterval, wantRecommitInterval = 3*time.Second, time.Duration(estimate)*time.Nanosecond
 		case 3:
<span class="term-fg31">-			wantMinInterval, wantRecommitInterval = time.Second, time.Second</span>
<span class="term-fg32">+			&#47;&#47; lower than upstream test, since enforced min recommit interval is lower</span>
<span class="term-fg32">+			wantMinInterval, wantRecommitInterval = 500*time.Millisecond, 500*time.Millisecond</span>
 		}
&nbsp;
 		&#47;&#47; Check interval</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-0ebc0400100a1fb2feb73a5a"role="button" aria-expanded="false" aria-controls="id-0ebc0400100a1fb2feb73a5a">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx-pool tx cost updates</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+145</span></div>
                <div class="text-start"><span class="text-danger">-25</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-0ebc0400100a1fb2feb73a5a">
        <div><p>Transaction queueing and inclusion needs to account for the L1 cost component.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3bf236039c3411c224552f9f" role="button"
                   aria-expanded="false" aria-controls="id-3bf236039c3411c224552f9f">
                    <code>core/txpool/validation.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/validation.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/validation.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+34</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3bf236039c3411c224552f9f"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;validation.go op-geth&#47;core&#47;txpool&#47;validation.go</span>
<span class="term-fg1">index a9bd14020bc97ac5d33adfedd8d260d37eace90e..3b62dc7b7614823aa18907172b2ded8139f6834b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;validation.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;validation.go</span>
<span class="term-fg36">@@ -30,6 +30,22 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; L1 Info Gas Overhead is the amount of gas the the L1 info deposit consumes.</span>
<span class="term-fg32">+&#47;&#47; It is removed from the tx pool max gas to better indicate that L2 transactions</span>
<span class="term-fg32">+&#47;&#47; are not able to consume all of the gas in a L2 block as the L1 info deposit is always present.</span>
<span class="term-fg32">+const l1InfoGasOverhead = uint64(70_000)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func EffectiveGasLimit(chainConfig *params.ChainConfig, gasLimit uint64) uint64 {</span>
<span class="term-fg32">+	if chainConfig.Optimism != nil {</span>
<span class="term-fg32">+		if l1InfoGasOverhead &lt; gasLimit {</span>
<span class="term-fg32">+			gasLimit -= l1InfoGasOverhead</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			gasLimit = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return gasLimit</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; ValidationOptions define certain differences between transaction validation
 &#47;&#47; across the different pools without having to duplicate those checks.
 type ValidationOptions struct {
<span class="term-fg36">@@ -47,6 +63,15 @@</span> &#47;&#47;
 &#47;&#47; This check is public to allow different transaction pools to check the basic
 &#47;&#47; rules without duplicating code and running the risk of missed updates.
 func ValidateTransaction(tx *types.Transaction, head *types.Header, signer types.Signer, opts *ValidationOptions) error {
<span class="term-fg32">+	&#47;&#47; No unauthenticated deposits allowed in the transaction pool.</span>
<span class="term-fg32">+	&#47;&#47; This is for spam protection, not consensus,</span>
<span class="term-fg32">+	&#47;&#47; as the external engine-API user authenticates deposits.</span>
<span class="term-fg32">+	if tx.Type() == types.DepositTxType {</span>
<span class="term-fg32">+		return core.ErrTxTypeNotSupported</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if opts.Config.IsOptimism() &amp;&amp; tx.Type() == types.BlobTxType {</span>
<span class="term-fg32">+		return core.ErrTxTypeNotSupported</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Ensure transactions not implemented by the calling pool are rejected
 	if opts.Accept&amp;(1&lt;&lt;tx.Type()) == 0 {
 		return fmt.Errorf(&quot;%w: tx type %v not supported by this pool&quot;, core.ErrTxTypeNotSupported, tx.Type())
<span class="term-fg36">@@ -76,7 +101,7 @@</span> 	if tx.Value().Sign() &lt; 0 {
 		return ErrNegativeValue
 	}
 	&#47;&#47; Ensure the transaction doesn&#39;t exceed the current block limit gas
<span class="term-fg31">-	if head.GasLimit &lt; tx.Gas() {</span>
<span class="term-fg32">+	if EffectiveGasLimit(opts.Config, head.GasLimit) &lt; tx.Gas() {</span>
 		return ErrGasLimit
 	}
 	&#47;&#47; Sanity check for extremely large numbers (supported by RLP or RPC)
<span class="term-fg36">@@ -182,6 +207,9 @@</span>
 	&#47;&#47; ExistingCost is a mandatory callback to retrieve an already pooled
 	&#47;&#47; transaction&#39;s cost with the given nonce to check for overdrafts.
 	ExistingCost func(addr common.Address, nonce uint64) *big.Int
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; L1CostFn is an optional extension, to validate L1 rollup costs of a tx</span>
<span class="term-fg32">+	L1CostFn L1CostFunc</span>
 }
&nbsp;
 &#47;&#47; ValidateTransactionWithState is a helper method to check whether a transaction
<span class="term-fg36">@@ -212,6 +240,11 @@</span> 	var (
 		balance = opts.State.GetBalance(from).ToBig()
 		cost    = tx.Cost()
 	)
<span class="term-fg32">+	if opts.L1CostFn != nil {</span>
<span class="term-fg32">+		if l1Cost := opts.L1CostFn(tx.RollupCostData()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+			cost = cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if balance.Cmp(cost) &lt; 0 {
 		return fmt.Errorf(&quot;%w: balance %v, tx cost %v, overshot %v&quot;, core.ErrInsufficientFunds, balance, cost, new(big.Int).Sub(cost, balance))
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f9c73f3751142f5f0a19adc7" role="button"
                   aria-expanded="false" aria-controls="id-f9c73f3751142f5f0a19adc7">
                    <code>core/txpool/txpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/txpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/txpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f9c73f3751142f5f0a19adc7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool.go op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">index d03e025a9e6c3d1d6e43dd3d2af93550343e1b11..12361bba45b0817ec872dc2cb00a242c67e8b9a4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg36">@@ -30,6 +30,8 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;
 )
&nbsp;
<span class="term-fg32">+type L1CostFunc func(dataGas types.RollupCostData) *big.Int</span>
<span class="term-fg32">+</span>
 &#47;&#47; TxStatus is the current status of a transaction as seen by the pool.
 type TxStatus uint
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e9eb65ad071acecba54477ac" role="button"
                   aria-expanded="false" aria-controls="id-e9eb65ad071acecba54477ac">
                    <code>core/txpool/legacypool/legacypool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/legacypool/legacypool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/legacypool/legacypool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+70</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e9eb65ad071acecba54477ac"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go</span>
<span class="term-fg1">index 624dafc60d03abfb93b502d10d0d2e385f2a04db..430ed3aa1c2f50a1fc2053f3b6821e47f71306fc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go</span>
<span class="term-fg36">@@ -125,6 +125,10 @@</span> 	NoLocals  bool             &#47;&#47; Whether local transaction handling should be disabled
 	Journal   string           &#47;&#47; Journal of local transactions to survive node restarts
 	Rejournal time.Duration    &#47;&#47; Time interval to regenerate the local transaction journal
&nbsp;
<span class="term-fg32">+	&#47;&#47; JournalRemote controls whether journaling includes remote transactions or not.</span>
<span class="term-fg32">+	&#47;&#47; When true, all transactions loaded from the journal are treated as remote.</span>
<span class="term-fg32">+	JournalRemote bool</span>
<span class="term-fg32">+</span>
 	PriceLimit uint64 &#47;&#47; Minimum gas price to enforce for acceptance into the pool
 	PriceBump  uint64 &#47;&#47; Minimum price bump percentage to replace an already existing transaction (nonce)
&nbsp;
<span class="term-fg36">@@ -230,6 +234,8 @@</span> 	wg              sync.WaitGroup &#47;&#47; tracks loop, scheduleReorgLoop
 	initDoneCh      chan struct{}  &#47;&#47; is closed once the pool is initialized (for tests)
&nbsp;
 	changesSinceReorg int &#47;&#47; A counter for how many drops we&#39;ve performed in-between reorg.
<span class="term-fg32">+</span>
<span class="term-fg32">+	l1CostFn txpool.L1CostFunc &#47;&#47; To apply L1 costs as rollup, optional field, may be nil.</span>
 }
&nbsp;
 type txpoolResetRequest struct {
<span class="term-fg36">@@ -266,7 +272,7 @@</span> 		pool.locals.add(addr)
 	}
 	pool.priced = newPricedList(pool.all)
&nbsp;
<span class="term-fg31">-	if !config.NoLocals &amp;&amp; config.Journal != &quot;&quot; {</span>
<span class="term-fg32">+	if (!config.NoLocals || config.JournalRemote) &amp;&amp; config.Journal != &quot;&quot; {</span>
 		pool.journal = newTxJournal(config.Journal)
 	}
 	return pool
<span class="term-fg36">@@ -315,10 +321,14 @@</span> 	go pool.scheduleReorgLoop()
&nbsp;
 	&#47;&#47; If local transactions and journaling is enabled, load from disk
 	if pool.journal != nil {
<span class="term-fg31">-		if err := pool.journal.load(pool.addLocals); err != nil {</span>
<span class="term-fg32">+		add := pool.addLocals</span>
<span class="term-fg32">+		if pool.config.JournalRemote {</span>
<span class="term-fg32">+			add = pool.addRemotesSync &#47;&#47; Use sync version to match pool.AddLocals</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := pool.journal.load(add); err != nil {</span>
 			log.Warn(&quot;Failed to load transaction journal&quot;, &quot;err&quot;, err)
 		}
<span class="term-fg31">-		if err := pool.journal.rotate(pool.local()); err != nil {</span>
<span class="term-fg32">+		if err := pool.journal.rotate(pool.toJournal()); err != nil {</span>
 			log.Warn(&quot;Failed to rotate transaction journal&quot;, &quot;err&quot;, err)
 		}
 	}
<span class="term-fg36">@@ -388,7 +398,7 @@</span> 		&#47;&#47; Handle local transaction journal rotation
 		case &lt;-journal.C:
 			if pool.journal != nil {
 				pool.mu.Lock()
<span class="term-fg31">-				if err := pool.journal.rotate(pool.local()); err != nil {</span>
<span class="term-fg32">+				if err := pool.journal.rotate(pool.toJournal()); err != nil {</span>
 					log.Warn(&quot;Failed to rotate local tx journal&quot;, &quot;err&quot;, err)
 				}
 				pool.mu.Unlock()
<span class="term-fg36">@@ -566,6 +576,23 @@</span>
 	return pool.locals.flatten()
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; toJournal retrieves all transactions that should be included in the journal,</span>
<span class="term-fg32">+&#47;&#47; grouped by origin account and sorted by nonce.</span>
<span class="term-fg32">+&#47;&#47; The returned transaction set is a copy and can be freely modified by calling code.</span>
<span class="term-fg32">+func (pool *LegacyPool) toJournal() map[common.Address]types.Transactions {</span>
<span class="term-fg32">+	if !pool.config.JournalRemote {</span>
<span class="term-fg32">+		return pool.local()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	txs := make(map[common.Address]types.Transactions)</span>
<span class="term-fg32">+	for addr, pending := range pool.pending {</span>
<span class="term-fg32">+		txs[addr] = append(txs[addr], pending.Flatten()...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for addr, queued := range pool.queue {</span>
<span class="term-fg32">+		txs[addr] = append(txs[addr], queued.Flatten()...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return txs</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; local retrieves all currently known local transactions, grouped by origin
 &#47;&#47; account and sorted by nonce. The returned transaction set is a copy and can be
 &#47;&#47; freely modified by calling code.
<span class="term-fg36">@@ -631,11 +658,18 @@</span> 		},
 		ExistingCost: func(addr common.Address, nonce uint64) *big.Int {
 			if list := pool.pending[addr]; list != nil {
 				if tx := list.txs.Get(nonce); tx != nil {
<span class="term-fg31">-					return tx.Cost()</span>
<span class="term-fg32">+					cost := tx.Cost()</span>
<span class="term-fg32">+					if pool.l1CostFn != nil {</span>
<span class="term-fg32">+						if l1Cost := pool.l1CostFn(tx.RollupCostData()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+							cost = cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+						}</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					return cost</span>
 				}
 			}
 			return nil
 		},
<span class="term-fg32">+		L1CostFn: pool.l1CostFn,</span>
 	}
 	if err := txpool.ValidateTransactionWithState(tx, pool.signer, opts); err != nil {
 		return err
<span class="term-fg36">@@ -758,7 +792,7 @@</span>
 	&#47;&#47; Try to replace an existing transaction in the pending pool
 	if list := pool.pending[from]; list != nil &amp;&amp; list.Contains(tx.Nonce()) {
 		&#47;&#47; Nonce already pending, check if required price bump is met
<span class="term-fg31">-		inserted, old := list.Add(tx, pool.config.PriceBump)</span>
<span class="term-fg32">+		inserted, old := list.Add(tx, pool.config.PriceBump, pool.l1CostFn)</span>
 		if !inserted {
 			pendingDiscardMeter.Mark(1)
 			return false, txpool.ErrReplaceUnderpriced
<span class="term-fg36">@@ -832,7 +866,7 @@</span> 	from, _ := types.Sender(pool.signer, tx) &#47;&#47; already validated
 	if pool.queue[from] == nil {
 		pool.queue[from] = newList(false)
 	}
<span class="term-fg31">-	inserted, old := pool.queue[from].Add(tx, pool.config.PriceBump)</span>
<span class="term-fg32">+	inserted, old := pool.queue[from].Add(tx, pool.config.PriceBump, pool.l1CostFn)</span>
 	if !inserted {
 		&#47;&#47; An older transaction was better, discard this
 		queuedDiscardMeter.Mark(1)
<span class="term-fg36">@@ -867,7 +901,7 @@</span> &#47;&#47; journalTx adds the specified transaction to the local disk journal if it is
 &#47;&#47; deemed to have been sent from a local account.
 func (pool *LegacyPool) journalTx(from common.Address, tx *types.Transaction) {
 	&#47;&#47; Only journal if it&#39;s enabled and the transaction is local
<span class="term-fg31">-	if pool.journal == nil || !pool.locals.contains(from) {</span>
<span class="term-fg32">+	if pool.journal == nil || (!pool.config.JournalRemote &amp;&amp; !pool.locals.contains(from)) {</span>
 		return
 	}
 	if err := pool.journal.insert(tx); err != nil {
<span class="term-fg36">@@ -886,7 +920,7 @@</span> 		pool.pending[addr] = newList(true)
 	}
 	list := pool.pending[addr]
&nbsp;
<span class="term-fg31">-	inserted, old := list.Add(tx, pool.config.PriceBump)</span>
<span class="term-fg32">+	inserted, old := list.Add(tx, pool.config.PriceBump, pool.l1CostFn)</span>
 	if !inserted {
 		&#47;&#47; An older transaction was better, discard this
 		pool.all.Remove(hash)
<span class="term-fg36">@@ -1281,7 +1315,7 @@</span> 	if reset != nil {
 		pool.demoteUnexecutables()
 		if reset.newHead != nil {
 			if pool.chainconfig.IsLondon(new(big.Int).Add(reset.newHead.Number, big.NewInt(1))) {
<span class="term-fg31">-				pendingBaseFee := eip1559.CalcBaseFee(pool.chainconfig, reset.newHead)</span>
<span class="term-fg32">+				pendingBaseFee := eip1559.CalcBaseFee(pool.chainconfig, reset.newHead, reset.newHead.Time+1)</span>
 				pool.priced.SetBaseFee(pendingBaseFee)
 			} else {
 				pool.priced.Reheap()
<span class="term-fg36">@@ -1413,6 +1447,12 @@</span> 	pool.currentHead.Store(newHead)
 	pool.currentState = statedb
 	pool.pendingNonces = newNoncer(statedb)
&nbsp;
<span class="term-fg32">+	if costFn := types.NewL1CostFunc(pool.chainconfig, statedb); costFn != nil {</span>
<span class="term-fg32">+		pool.l1CostFn = func(rollupCostData types.RollupCostData) *big.Int {</span>
<span class="term-fg32">+			return costFn(rollupCostData, newHead.Time)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Inject any transactions discarded due to reorgs
 	log.Debug(&quot;Reinjecting stale transactions&quot;, &quot;count&quot;, len(reinject))
 	core.SenderCacher.Recover(pool.signer, reinject)
<span class="term-fg36">@@ -1427,7 +1467,7 @@</span> 	&#47;&#47; Track the promoted transactions to broadcast them at once
 	var promoted []*types.Transaction
&nbsp;
 	&#47;&#47; Iterate over all accounts and promote any executable transactions
<span class="term-fg31">-	gasLimit := pool.currentHead.Load().GasLimit</span>
<span class="term-fg32">+	gasLimit := txpool.EffectiveGasLimit(pool.chainconfig, pool.currentHead.Load().GasLimit)</span>
 	for _, addr := range accounts {
 		list := pool.queue[addr]
 		if list == nil {
<span class="term-fg36">@@ -1440,8 +1480,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 		}
 		log.Trace(&quot;Removed old queued transactions&quot;, &quot;count&quot;, len(forwards))
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr).ToBig()</span>
<span class="term-fg32">+		if !list.Empty() &amp;&amp; pool.l1CostFn != nil {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupCostData()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas)
<span class="term-fg31">-		drops, _ := list.Filter(pool.currentState.GetBalance(addr).ToBig(), gasLimit)</span>
<span class="term-fg32">+		drops, _ := list.Filter(balance, gasLimit)</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			pool.all.Remove(hash)
<span class="term-fg36">@@ -1630,7 +1678,7 @@</span> &#47;&#47; is always explicitly triggered by SetBaseFee and it would be unnecessary and wasteful
 &#47;&#47; to trigger a re-heap is this function
 func (pool *LegacyPool) demoteUnexecutables() {
 	&#47;&#47; Iterate over all accounts and demote any non-executable transactions
<span class="term-fg31">-	gasLimit := pool.currentHead.Load().GasLimit</span>
<span class="term-fg32">+	gasLimit := txpool.EffectiveGasLimit(pool.chainconfig, pool.currentHead.Load().GasLimit)</span>
 	for addr, list := range pool.pending {
 		nonce := pool.currentState.GetNonce(addr)
&nbsp;
<span class="term-fg36">@@ -1641,8 +1689,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 			log.Trace(&quot;Removed old pending transaction&quot;, &quot;hash&quot;, hash)
 		}
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr).ToBig()</span>
<span class="term-fg32">+		if !list.Empty() &amp;&amp; pool.l1CostFn != nil {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupCostData()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas), and queue any invalids back for later
<span class="term-fg31">-		drops, invalids := list.Filter(pool.currentState.GetBalance(addr).ToBig(), gasLimit)</span>
<span class="term-fg32">+		drops, invalids := list.Filter(balance, gasLimit)</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			log.Trace(&quot;Removed unpayable pending transaction&quot;, &quot;hash&quot;, hash)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1a266791540814e4eb528688" role="button"
                   aria-expanded="false" aria-controls="id-1a266791540814e4eb528688">
                    <code>core/txpool/legacypool/list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/legacypool/list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/legacypool/list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+16</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1a266791540814e4eb528688"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;list.go</span>
<span class="term-fg1">index 05ae0b58cd59766145c3dc4c80045878368f8e28..28333a2c052946164f3c7ca501cb4a4984b83ea4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;list.go</span>
<span class="term-fg36">@@ -26,6 +26,7 @@</span> 	&quot;sync&#47;atomic&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 )
&nbsp;
<span class="term-fg36">@@ -263,6 +264,15 @@</span> 	cache := m.flatten()
 	return cache[len(cache)-1]
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; FirstElement returns the first element from the heap (guaranteed to be lowest), thus, the</span>
<span class="term-fg32">+&#47;&#47; transaction with the lowest nonce. Returns nil if there are no elements.</span>
<span class="term-fg32">+func (m *sortedMap) FirstElement() *types.Transaction {</span>
<span class="term-fg32">+	if m.Len() == 0 {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return m.Get((*m.index)[0])</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; list is a &quot;list&quot; of transactions belonging to an account, sorted by account
 &#47;&#47; nonce. The same type can be used both for storing contiguous transactions for
 &#47;&#47; the executable&#47;pending queue; and for storing gapped transactions for the non-
<span class="term-fg36">@@ -298,7 +308,7 @@</span> &#47;&#47; transaction was accepted, and if yes, any previous transaction it replaced.
 &#47;&#47;
 &#47;&#47; If the new transaction is accepted into the list, the lists&#39; cost and gas
 &#47;&#47; thresholds are also potentially updated.
<span class="term-fg31">-func (l *list) Add(tx *types.Transaction, priceBump uint64) (bool, *types.Transaction) {</span>
<span class="term-fg32">+func (l *list) Add(tx *types.Transaction, priceBump uint64, l1CostFn txpool.L1CostFunc) (bool, *types.Transaction) {</span>
 	&#47;&#47; If there&#39;s an older better transaction, abort
 	old := l.txs.Get(tx.Nonce())
 	if old != nil {
<span class="term-fg36">@@ -326,6 +336,11 @@</span> 		l.subTotalCost([]*types.Transaction{old})
 	}
 	&#47;&#47; Add new tx cost to totalcost
 	l.totalcost.Add(l.totalcost, tx.Cost())
<span class="term-fg32">+	if l1CostFn != nil {</span>
<span class="term-fg32">+		if l1Cost := l1CostFn(tx.RollupCostData()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+			l.totalcost.Add(l.totalcost, l1Cost)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Otherwise overwrite the old transaction with the current one
 	l.txs.Put(tx)
 	if cost := tx.Cost(); l.costcap.Cmp(cost) &lt; 0 {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b71cab78fd13a220d4912694" role="button"
                   aria-expanded="false" aria-controls="id-b71cab78fd13a220d4912694">
                    <code>core/txpool/legacypool/list_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/legacypool/list_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/legacypool/list_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b71cab78fd13a220d4912694"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list_test.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;list_test.go</span>
<span class="term-fg1">index b5cd34b23b622425518f8fcd1a9896eb5a4ec021..b1f6ec305d575c8e7e0d6bc1d84fcedcfaf7d28e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;list_test.go</span>
<span class="term-fg36">@@ -38,7 +38,7 @@</span> 	}
 	&#47;&#47; Insert the transactions in a random order
 	list := newList(true)
 	for _, v := range rand.Perm(len(txs)) {
<span class="term-fg31">-		list.Add(txs[v], DefaultConfig.PriceBump)</span>
<span class="term-fg32">+		list.Add(txs[v], DefaultConfig.PriceBump, nil)</span>
 	}
 	&#47;&#47; Verify internal state
 	if len(list.txs.items) != len(txs) {
<span class="term-fg36">@@ -65,7 +65,7 @@</span> 	b.ResetTimer()
 	for i := 0; i &lt; b.N; i++ {
 		list := newList(true)
 		for _, v := range rand.Perm(len(txs)) {
<span class="term-fg31">-			list.Add(txs[v], DefaultConfig.PriceBump)</span>
<span class="term-fg32">+			list.Add(txs[v], DefaultConfig.PriceBump, nil)</span>
 			list.Filter(priceLimit, DefaultConfig.PriceBump)
 		}
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-807646ab6efdd3b1ce618fae" role="button"
                   aria-expanded="false" aria-controls="id-807646ab6efdd3b1ce618fae">
                    <code>core/txpool/legacypool/legacypool_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/legacypool/legacypool_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/legacypool/legacypool_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-807646ab6efdd3b1ce618fae"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go</span>
<span class="term-fg1">index cd2cfb92e4927000da93db9d8e6eb3bec2ac5e68..a35954194aa149844d434d0aee0d2ca99882fee7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go</span>
<span class="term-fg36">@@ -2346,10 +2346,13 @@</span> }
&nbsp;
 &#47;&#47; Tests that local transactions are journaled to disk, but remote transactions
 &#47;&#47; get discarded between restarts.
<span class="term-fg31">-func TestJournaling(t *testing.T)         { testJournaling(t, false) }</span>
<span class="term-fg31">-func TestJournalingNoLocals(t *testing.T) { testJournaling(t, true) }</span>
<span class="term-fg32">+func TestJournaling(t *testing.T)         { testJournaling(t, false, false) }</span>
<span class="term-fg32">+func TestJournalingNoLocals(t *testing.T) { testJournaling(t, true, false) }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestJournalingRemotes(t *testing.T)         { testJournaling(t, false, true) }</span>
<span class="term-fg32">+func TestJournalingRemotesNoLocals(t *testing.T) { testJournaling(t, true, true) }</span>
&nbsp;
<span class="term-fg31">-func testJournaling(t *testing.T, nolocals bool) {</span>
<span class="term-fg32">+func testJournaling(t *testing.T, nolocals bool, journalRemotes bool) {</span>
 	t.Parallel()
&nbsp;
 	&#47;&#47; Create a temporary file for the journal
<span class="term-fg36">@@ -2370,6 +2373,7 @@</span> 	blockchain := newTestBlockChain(params.TestChainConfig, 1000000, statedb, new(event.Feed))
&nbsp;
 	config := testTxPoolConfig
 	config.NoLocals = nolocals
<span class="term-fg32">+	config.JournalRemote = journalRemotes</span>
 	config.Journal = journal
 	config.Rejournal = time.Second
&nbsp;
<span class="term-fg36">@@ -2418,10 +2422,14 @@</span> 	pending, queued = pool.Stats()
 	if queued != 0 {
 		t.Fatalf(&quot;queued transactions mismatched: have %d, want %d&quot;, queued, 0)
 	}
<span class="term-fg31">-	if nolocals {</span>
<span class="term-fg32">+	if nolocals &amp;&amp; !journalRemotes {</span>
 		if pending != 0 {
 			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)
 		}
<span class="term-fg32">+	} else if journalRemotes {</span>
<span class="term-fg32">+		if pending != 3 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 3)</span>
<span class="term-fg32">+		}</span>
 	} else {
 		if pending != 2 {
 			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 2)
<span class="term-fg36">@@ -2442,10 +2450,16 @@</span> 	pool = New(config, blockchain)
 	pool.Init(new(big.Int).SetUint64(config.PriceLimit), blockchain.CurrentBlock(), makeAddressReserver())
&nbsp;
 	pending, queued = pool.Stats()
<span class="term-fg31">-	if pending != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)</span>
<span class="term-fg32">+	if journalRemotes {</span>
<span class="term-fg32">+		if pending != 1 { &#47;&#47; Remove the 2 replaced local transactions, but preserve the remote</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 1)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		if pending != 0 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg31">-	if nolocals {</span>
<span class="term-fg32">+	if nolocals &amp;&amp; !journalRemotes {</span>
 		if queued != 0 {
 			t.Fatalf(&quot;queued transactions mismatched: have %d, want %d&quot;, queued, 0)
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-ad12db53d279bac17388d0d9"role="button" aria-expanded="false" aria-controls="id-ad12db53d279bac17388d0d9">
        
            <div class="col-12 col-sm-9 text-start"><h2>Chain Configuration</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+602</span></div>
                <div class="text-start"><span class="text-danger">-8</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-ad12db53d279bac17388d0d9">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-3d33b9a5cdf40188c911776b"role="button" aria-expanded="false" aria-controls="id-3d33b9a5cdf40188c911776b">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+217</span></div>
                <div class="text-start"><span class="text-danger">-8</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-3d33b9a5cdf40188c911776b">
        <div><p>The rollup functionality is enabled with the <code>optimism</code> field in the chain config.
The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.
The parameters can be overriden for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1a43dbe6aa55f4729c797009" role="button"
                   aria-expanded="false" aria-controls="id-1a43dbe6aa55f4729c797009">
                    <code>params/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/params/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+144</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1a43dbe6aa55f4729c797009"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config.go op-geth&#47;params&#47;config.go</span>
<span class="term-fg1">index fb5175119ad1976c9e3444af7edac325f29b5cbd..e7b3c0494b56c1057f068cc92134226f6ef3ae83 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config.go</span>
<span class="term-fg36">@@ -32,6 +32,32 @@</span> 	SepoliaGenesisHash = common.HexToHash(&quot;0x25a5cc106eea7138acab33231d7160d69cb777ee0c2c553fcddf5138993e6dd9&quot;)
 	GoerliGenesisHash  = common.HexToHash(&quot;0xbf7e331f7f7c1dd2e05159666b3bf8bc7a8a3a9eb1d518969eab529dd9b88c1a&quot;)
 )
&nbsp;
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	OPMainnetChainID        = 10</span>
<span class="term-fg32">+	OPGoerliChainID         = 420</span>
<span class="term-fg32">+	BaseMainnetChainID      = 8453</span>
<span class="term-fg32">+	BaseGoerliChainID       = 84531</span>
<span class="term-fg32">+	baseSepoliaChainID      = 84532</span>
<span class="term-fg32">+	baseGoerliDevnetChainID = 11763071</span>
<span class="term-fg32">+	pgnSepoliaChainID       = 58008</span>
<span class="term-fg32">+	devnetChainID           = 997</span>
<span class="term-fg32">+	chaosnetChainID         = 888</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; OP Stack chain config</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; March 17, 2023 @ 7:00:00 pm UTC</span>
<span class="term-fg32">+	OptimismGoerliRegolithTime = uint64(1679079600)</span>
<span class="term-fg32">+	&#47;&#47; May 4, 2023 @ 5:00:00 pm UTC</span>
<span class="term-fg32">+	BaseGoerliRegolithTime = uint64(1683219600)</span>
<span class="term-fg32">+	&#47;&#47; Apr 21, 2023 @ 6:30:00 pm UTC</span>
<span class="term-fg32">+	baseGoerliDevnetRegolithTime = uint64(1682101800)</span>
<span class="term-fg32">+	&#47;&#47; March 5, 2023 @ 2:48:00 am UTC</span>
<span class="term-fg32">+	devnetRegolithTime = uint64(1677984480)</span>
<span class="term-fg32">+	&#47;&#47; August 16, 2023 @ 3:34:22 am UTC</span>
<span class="term-fg32">+	chaosnetRegolithTime = uint64(1692156862)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
 func newUint64(val uint64) *uint64 { return &amp;val }
&nbsp;
 var (
<span class="term-fg36">@@ -306,6 +332,16 @@</span> 		Ethash:                        new(EthashConfig),
 		Clique:                        nil,
 	}
 	TestRules = TestChainConfig.Rules(new(big.Int), false, 0)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; This is an Optimism chain config with bedrock starting a block 5, introduced for historical endpoint testing, largely based on the clique config</span>
<span class="term-fg32">+	OptimismTestConfig = func() *ChainConfig {</span>
<span class="term-fg32">+		conf := *AllCliqueProtocolChanges &#47;&#47; copy the config</span>
<span class="term-fg32">+		conf.Clique = nil</span>
<span class="term-fg32">+		conf.TerminalTotalDifficultyPassed = true</span>
<span class="term-fg32">+		conf.BedrockBlock = big.NewInt(5)</span>
<span class="term-fg32">+		conf.Optimism = &amp;OptimismConfig{EIP1559Elasticity: 50, EIP1559Denominator: 10}</span>
<span class="term-fg32">+		return &amp;conf</span>
<span class="term-fg32">+	}()</span>
 )
&nbsp;
 &#47;&#47; NetworkNames are user friendly names to use in the chain spec banner.
<span class="term-fg36">@@ -352,6 +388,14 @@</span> 	CancunTime   *uint64 `json:&quot;cancunTime,omitempty&quot;`   &#47;&#47; Cancun switch time (nil = no fork, 0 = already on cancun)
 	PragueTime   *uint64 `json:&quot;pragueTime,omitempty&quot;`   &#47;&#47; Prague switch time (nil = no fork, 0 = already on prague)
 	VerkleTime   *uint64 `json:&quot;verkleTime,omitempty&quot;`   &#47;&#47; Verkle switch time (nil = no fork, 0 = already on verkle)
&nbsp;
<span class="term-fg32">+	BedrockBlock *big.Int `json:&quot;bedrockBlock,omitempty&quot;` &#47;&#47; Bedrock switch block (nil = no fork, 0 = already on optimism bedrock)</span>
<span class="term-fg32">+	RegolithTime *uint64  `json:&quot;regolithTime,omitempty&quot;` &#47;&#47; Regolith switch time (nil = no fork, 0 = already on optimism regolith)</span>
<span class="term-fg32">+	CanyonTime   *uint64  `json:&quot;canyonTime,omitempty&quot;`   &#47;&#47; Canyon switch time (nil = no fork, 0 = already on optimism canyon)</span>
<span class="term-fg32">+	&#47;&#47; Delta: the Delta upgrade does not affect the execution-layer, and is thus not configurable in the chain config.</span>
<span class="term-fg32">+	EcotoneTime *uint64 `json:&quot;ecotoneTime,omitempty&quot;` &#47;&#47; Ecotone switch time (nil = no fork, 0 = already on optimism ecotone)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	InteropTime *uint64 `json:&quot;interopTime,omitempty&quot;` &#47;&#47; Interop switch time (nil = no fork, 0 = already on optimism interop)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; TerminalTotalDifficulty is the amount of total difficulty reached by
 	&#47;&#47; the network that triggers the consensus upgrade.
 	TerminalTotalDifficulty *big.Int `json:&quot;terminalTotalDifficulty,omitempty&quot;`
<span class="term-fg36">@@ -364,6 +408,9 @@</span>
 	&#47;&#47; Various consensus engines
 	Ethash *EthashConfig `json:&quot;ethash,omitempty&quot;`
 	Clique *CliqueConfig `json:&quot;clique,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism config, nil if not active</span>
<span class="term-fg32">+	Optimism *OptimismConfig `json:&quot;optimism,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; EthashConfig is the consensus engine configs for proof-of-work based sealing.
<span class="term-fg36">@@ -385,6 +432,18 @@</span> func (c *CliqueConfig) String() string {
 	return &quot;clique&quot;
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; OptimismConfig is the optimism config.</span>
<span class="term-fg32">+type OptimismConfig struct {</span>
<span class="term-fg32">+	EIP1559Elasticity        uint64 `json:&quot;eip1559Elasticity&quot;`</span>
<span class="term-fg32">+	EIP1559Denominator       uint64 `json:&quot;eip1559Denominator&quot;`</span>
<span class="term-fg32">+	EIP1559DenominatorCanyon uint64 `json:&quot;eip1559DenominatorCanyon&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; String implements the stringer interface, returning the optimism fee config details.</span>
<span class="term-fg32">+func (o *OptimismConfig) String() string {</span>
<span class="term-fg32">+	return &quot;optimism&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Description returns a human-readable description of ChainConfig.
 func (c *ChainConfig) Description() string {
 	var banner string
<span class="term-fg36">@@ -396,6 +455,8 @@</span> 		network = &quot;unknown&quot;
 	}
 	banner += fmt.Sprintf(&quot;Chain ID:  %v (%s)\n&quot;, c.ChainID, network)
 	switch {
<span class="term-fg32">+	case c.Optimism != nil:</span>
<span class="term-fg32">+		banner += &quot;Consensus: Optimism\n&quot;</span>
 	case c.Ethash != nil:
 		if c.TerminalTotalDifficulty == nil {
 			banner += &quot;Consensus: Ethash (proof-of-work)\n&quot;
<span class="term-fg36">@@ -474,6 +535,18 @@</span> 	}
 	if c.VerkleTime != nil {
 		banner += fmt.Sprintf(&quot; - Verkle:                      @%-10v\n&quot;, *c.VerkleTime)
 	}
<span class="term-fg32">+	if c.RegolithTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Regolith:                    @%-10v\n&quot;, *c.RegolithTime)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c.CanyonTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Canyon:                      @%-10v\n&quot;, *c.CanyonTime)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c.EcotoneTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Ecotone:                     @%-10v\n&quot;, *c.EcotoneTime)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c.InteropTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Interop:                     @%-10v\n&quot;, *c.InteropTime)</span>
<span class="term-fg32">+	}</span>
 	return banner
 }
&nbsp;
<span class="term-fg36">@@ -577,6 +650,54 @@</span> func (c *ChainConfig) IsVerkle(num *big.Int, time uint64) bool {
 	return c.IsLondon(num) &amp;&amp; isTimestampForked(c.VerkleTime, time)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; IsBedrock returns whether num is either equal to the Bedrock fork block or greater.</span>
<span class="term-fg32">+func (c *ChainConfig) IsBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return isBlockForked(c.BedrockBlock, num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.RegolithTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsCanyon(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.CanyonTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsEcotone(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.EcotoneTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsInterop(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.InteropTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimism returns whether the node is an optimism node or not.</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimism() bool {</span>
<span class="term-fg32">+	return c.Optimism != nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismBedrock returns true iff this is an optimism node &amp; bedrock is active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsRegolith(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismCanyon(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsCanyon(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismEcotone(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsEcotone(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismPreBedrock returns true iff this is an optimism node &amp; bedrock is not yet active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismPreBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; !c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; CheckCompatible checks whether scheduled fork transitions have been imported
 &#47;&#47; with a mismatching chain configuration.
 func (c *ChainConfig) CheckCompatible(newcfg *ChainConfig, height uint64, time uint64) *ConfigCompatError {
<span class="term-fg36">@@ -742,12 +863,22 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; BaseFeeChangeDenominator bounds the amount the base fee can change between blocks.
<span class="term-fg31">-func (c *ChainConfig) BaseFeeChangeDenominator() uint64 {</span>
<span class="term-fg32">+&#47;&#47; The time parameters is the timestamp of the block to determine if Canyon is active or not</span>
<span class="term-fg32">+func (c *ChainConfig) BaseFeeChangeDenominator(time uint64) uint64 {</span>
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		if c.IsCanyon(time) {</span>
<span class="term-fg32">+			return c.Optimism.EIP1559DenominatorCanyon</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Denominator</span>
<span class="term-fg32">+	}</span>
 	return DefaultBaseFeeChangeDenominator
 }
&nbsp;
 &#47;&#47; ElasticityMultiplier bounds the maximum gas limit an EIP-1559 block may have.
 func (c *ChainConfig) ElasticityMultiplier() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Elasticity</span>
<span class="term-fg32">+	}</span>
 	return DefaultElasticityMultiplier
 }
&nbsp;
<span class="term-fg36">@@ -901,6 +1032,8 @@</span> 	IsByzantium, IsConstantinople, IsPetersburg, IsIstanbul bool
 	IsBerlin, IsLondon                                      bool
 	IsMerge, IsShanghai, IsCancun, IsPrague                 bool
 	IsVerkle                                                bool
<span class="term-fg32">+	IsOptimismBedrock, IsOptimismRegolith                   bool</span>
<span class="term-fg32">+	IsOptimismCanyon                                        bool</span>
 }
&nbsp;
 &#47;&#47; Rules ensures c&#39;s ChainID is not nil.
<span class="term-fg36">@@ -909,6 +1042,8 @@</span> 	chainID := c.ChainID
 	if chainID == nil {
 		chainID = new(big.Int)
 	}
<span class="term-fg32">+	&#47;&#47; disallow setting Merge out of order</span>
<span class="term-fg32">+	isMerge = isMerge &amp;&amp; c.IsLondon(num)</span>
 	return Rules{
 		ChainID:          new(big.Int).Set(chainID),
 		IsHomestead:      c.IsHomestead(num),
<span class="term-fg36">@@ -922,9 +1057,13 @@</span> 		IsIstanbul:       c.IsIstanbul(num),
 		IsBerlin:         c.IsBerlin(num),
 		IsLondon:         c.IsLondon(num),
 		IsMerge:          isMerge,
<span class="term-fg31">-		IsShanghai:       c.IsShanghai(num, timestamp),</span>
<span class="term-fg31">-		IsCancun:         c.IsCancun(num, timestamp),</span>
<span class="term-fg31">-		IsPrague:         c.IsPrague(num, timestamp),</span>
<span class="term-fg31">-		IsVerkle:         c.IsVerkle(num, timestamp),</span>
<span class="term-fg32">+		IsShanghai:       isMerge &amp;&amp; c.IsShanghai(num, timestamp),</span>
<span class="term-fg32">+		IsCancun:         isMerge &amp;&amp; c.IsCancun(num, timestamp),</span>
<span class="term-fg32">+		IsPrague:         isMerge &amp;&amp; c.IsPrague(num, timestamp),</span>
<span class="term-fg32">+		IsVerkle:         isMerge &amp;&amp; c.IsVerkle(num, timestamp),</span>
<span class="term-fg32">+		&#47;&#47; Optimism</span>
<span class="term-fg32">+		IsOptimismBedrock:  isMerge &amp;&amp; c.IsOptimismBedrock(num),</span>
<span class="term-fg32">+		IsOptimismRegolith: isMerge &amp;&amp; c.IsOptimismRegolith(timestamp),</span>
<span class="term-fg32">+		IsOptimismCanyon:   isMerge &amp;&amp; c.IsOptimismCanyon(timestamp),</span>
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-182cf749cfe5f549db1056bc" role="button"
                   aria-expanded="false" aria-controls="id-182cf749cfe5f549db1056bc">
                    <code>params/protocol_params.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/params/protocol_params.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/protocol_params.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-182cf749cfe5f549db1056bc"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;protocol_params.go op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">index 7eb63e89ac619c28b9f96bdf7617aa0a2d0fe504..872f002e91d2b1ea4c722391c53ea42bd1c07ffe 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg36">@@ -22,6 +22,13 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 )
&nbsp;
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; The base fee portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismBaseFeeRecipient = common.HexToAddress(&quot;0x4200000000000000000000000000000000000019&quot;)</span>
<span class="term-fg32">+	&#47;&#47; The L1 portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismL1FeeRecipient = common.HexToAddress(&quot;0x420000000000000000000000000000000000001A&quot;)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
 const (
 	GasLimitBoundDivisor uint64 = 1024               &#47;&#47; The bound divisor of the gas limit, used in update calculations.
 	MinGasLimit          uint64 = 5000               &#47;&#47; Minimum the gas limit may ever be.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-156d9bf9a35387c2566e1845" role="button"
                   aria-expanded="false" aria-controls="id-156d9bf9a35387c2566e1845">
                    <code>core/genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+66</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-156d9bf9a35387c2566e1845"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;genesis.go op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg1">index aec86744181d9a5b844b0f4b9b5a47521d09d64a..839f10e179fe8e9a36e4eebcc6085541967ca6df 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg36">@@ -25,6 +25,8 @@</span> 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;strings&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg36">@@ -67,6 +69,11 @@</span> 	ParentHash    common.Hash `json:&quot;parentHash&quot;`
 	BaseFee       *big.Int    `json:&quot;baseFeePerGas&quot;` &#47;&#47; EIP-1559
 	ExcessBlobGas *uint64     `json:&quot;excessBlobGas&quot;` &#47;&#47; EIP-4844
 	BlobGasUsed   *uint64     `json:&quot;blobGasUsed&quot;`   &#47;&#47; EIP-4844
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; StateHash represents the genesis state, to allow instantiation of a chain with missing initial state.</span>
<span class="term-fg32">+	&#47;&#47; Chains with history pruning, or extraordinarily large genesis allocation (e.g. after a regenesis event)</span>
<span class="term-fg32">+	&#47;&#47; may utilize this to get started, and then state-sync the latest state, while still verifying the header chain.</span>
<span class="term-fg32">+	StateHash *common.Hash `json:&quot;stateHash,omitempty&quot;`</span>
 }
&nbsp;
 func ReadGenesis(db ethdb.Database) (*Genesis, error) {
<span class="term-fg36">@@ -103,6 +110,10 @@</span> 	genesis.Coinbase = genesisHeader.Coinbase
 	genesis.BaseFee = genesisHeader.BaseFee
 	genesis.ExcessBlobGas = genesisHeader.ExcessBlobGas
 	genesis.BlobGasUsed = genesisHeader.BlobGasUsed
<span class="term-fg32">+	if genesis.Alloc == nil {</span>
<span class="term-fg32">+		h := genesisHeader.Hash()</span>
<span class="term-fg32">+		genesis.StateHash = &amp;h</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	return &amp;genesis, nil
 }
<span class="term-fg36">@@ -257,6 +268,11 @@</span> &#47;&#47; ChainOverrides contains the changes to chain config.
 type ChainOverrides struct {
 	OverrideCancun *uint64
 	OverrideVerkle *uint64
<span class="term-fg32">+	&#47;&#47; optimism</span>
<span class="term-fg32">+	OverrideOptimismCanyon  *uint64</span>
<span class="term-fg32">+	OverrideOptimismEcotone *uint64</span>
<span class="term-fg32">+	ApplySuperchainUpgrades bool</span>
<span class="term-fg32">+	OverrideOptimismInterop *uint64</span>
 }
&nbsp;
 &#47;&#47; SetupGenesisBlock writes or updates the genesis block in db.
<span class="term-fg36">@@ -282,12 +298,47 @@</span> 		return params.AllEthashProtocolChanges, common.Hash{}, errGenesisNoConfig
 	}
 	applyOverrides := func(config *params.ChainConfig) {
 		if config != nil {
<span class="term-fg32">+			&#47;&#47; If applying the superchain-registry to a known OP-Stack chain,</span>
<span class="term-fg32">+			&#47;&#47; then override the local chain-config with that from the registry.</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.ApplySuperchainUpgrades &amp;&amp; config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.IsUint64() {</span>
<span class="term-fg32">+				if _, ok := superchain.OPChains[config.ChainID.Uint64()]; ok {</span>
<span class="term-fg32">+					conf, err := params.LoadOPStackChainConfig(config.ChainID.Uint64())</span>
<span class="term-fg32">+					if err != nil {</span>
<span class="term-fg32">+						log.Warn(&quot;failed to load chain config from superchain-registry, skipping override&quot;, &quot;err&quot;, err, &quot;chain_id&quot;, config.ChainID)</span>
<span class="term-fg32">+					} else {</span>
<span class="term-fg32">+						*config = *conf</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(big.NewInt(params.OPGoerliChainID)) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Optimism Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.OptimismGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(big.NewInt(params.BaseGoerliChainID)) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Base Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.BaseGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
 			if overrides != nil &amp;&amp; overrides.OverrideCancun != nil {
 				config.CancunTime = overrides.OverrideCancun
 			}
 			if overrides != nil &amp;&amp; overrides.OverrideVerkle != nil {
 				config.VerkleTime = overrides.OverrideVerkle
 			}
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismCanyon != nil {</span>
<span class="term-fg32">+				config.CanyonTime = overrides.OverrideOptimismCanyon</span>
<span class="term-fg32">+				config.ShanghaiTime = overrides.OverrideOptimismCanyon</span>
<span class="term-fg32">+				if config.Optimism != nil &amp;&amp; config.Optimism.EIP1559DenominatorCanyon == 0 {</span>
<span class="term-fg32">+					config.Optimism.EIP1559DenominatorCanyon = 250</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismEcotone != nil {</span>
<span class="term-fg32">+				config.EcotoneTime = overrides.OverrideOptimismEcotone</span>
<span class="term-fg32">+				config.CancunTime = overrides.OverrideOptimismEcotone</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismInterop != nil {</span>
<span class="term-fg32">+				config.InteropTime = overrides.OverrideOptimismInterop</span>
<span class="term-fg32">+			}</span>
 		}
 	}
 	&#47;&#47; Just commit the new block if there is no stored genesis block.
<span class="term-fg36">@@ -310,8 +361,13 @@</span> 	&#47;&#47; The genesis block is present(perhaps in ancient database) while the
 	&#47;&#47; state database is not initialized yet. It can happen that the node
 	&#47;&#47; is initialized with an external ancient store. Commit genesis state
 	&#47;&#47; in this case.
<span class="term-fg32">+	&#47;&#47; If the bedrock block is not 0, that implies that the network was migrated at the bedrock block.</span>
<span class="term-fg32">+	&#47;&#47; In this case the genesis state may not be in the state database (e.g. op-geth is performing a snap</span>
<span class="term-fg32">+	&#47;&#47; sync without an existing datadir) &amp; even if it were, would not be useful as op-geth is not able to</span>
<span class="term-fg32">+	&#47;&#47; execute the pre-bedrock STF.</span>
 	header := rawdb.ReadHeader(db, stored, 0)
<span class="term-fg31">-	if header.Root != types.EmptyRootHash &amp;&amp; !triedb.Initialized(header.Root) {</span>
<span class="term-fg32">+	transitionedNetwork := genesis != nil &amp;&amp; genesis.Config != nil &amp;&amp; genesis.Config.BedrockBlock != nil &amp;&amp; genesis.Config.BedrockBlock.Uint64() != 0</span>
<span class="term-fg32">+	if header.Root != types.EmptyRootHash &amp;&amp; !triedb.Initialized(header.Root) &amp;&amp; !transitionedNetwork {</span>
 		if genesis == nil {
 			genesis = DefaultGenesisBlock()
 		}
<span class="term-fg36">@@ -430,8 +486,15 @@</span> }
&nbsp;
 &#47;&#47; ToBlock returns the genesis block according to genesis specification.
 func (g *Genesis) ToBlock() *types.Block {
<span class="term-fg31">-	root, err := g.Alloc.hash(g.IsVerkle())</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg32">+	var root common.Hash</span>
<span class="term-fg32">+	var err error</span>
<span class="term-fg32">+	if g.StateHash != nil {</span>
<span class="term-fg32">+		if len(g.Alloc) &gt; 0 {</span>
<span class="term-fg32">+			panic(fmt.Errorf(&quot;cannot both have genesis hash %s &quot;+</span>
<span class="term-fg32">+				&quot;and non-empty state-allocation&quot;, *g.StateHash))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		root = *g.StateHash</span>
<span class="term-fg32">+	} else if root, err = g.Alloc.hash(g.IsVerkle()); err != nil {</span>
 		panic(err)
 	}
 	head := &amp;types.Header{</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1d93f5e4ac581a41dfe4d615"role="button" aria-expanded="false" aria-controls="id-1d93f5e4ac581a41dfe4d615">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config cleanup</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1d93f5e4ac581a41dfe4d615">
        <div><p>The optimism Goerli testnet used clique-config data to make geth internals accept blocks.
Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-de18e3e0e9f385b214098743" role="button"
                   aria-expanded="false" aria-controls="id-de18e3e0e9f385b214098743">
                    <code>core/rawdb/accessors_metadata.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/rawdb/accessors_metadata.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/rawdb/accessors_metadata.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-de18e3e0e9f385b214098743"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">index 859566f722f5960b0ce417514d6f20ff35a5cbe9..7dae87a98f2f5383b3b14f0d04012eb64c98a91b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg36">@@ -64,6 +64,9 @@</span> 	if err := json.Unmarshal(data, &amp;config); err != nil {
 		log.Error(&quot;Invalid chain config JSON&quot;, &quot;hash&quot;, hash, &quot;err&quot;, err)
 		return nil
 	}
<span class="term-fg32">+	if config.Optimism != nil {</span>
<span class="term-fg32">+		config.Clique = nil &#47;&#47; get rid of legacy clique data in chain config (optimism goerli issue)</span>
<span class="term-fg32">+	}</span>
 	return &amp;config
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-12bc729b747c5b531cdff4a4"role="button" aria-expanded="false" aria-controls="id-12bc729b747c5b531cdff4a4">
        
            <div class="col-12 col-sm-9 text-start"><h3>Genesis loading</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+6</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-12bc729b747c5b531cdff4a4">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-806c72b2df162b9f984751dc" role="button"
                   aria-expanded="false" aria-controls="id-806c72b2df162b9f984751dc">
                    <code>core/gen_genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/gen_genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/gen_genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-806c72b2df162b9f984751dc"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;gen_genesis.go op-geth&#47;core&#47;gen_genesis.go</span>
<span class="term-fg1">index 38614252a38047715e012a2f5d91973f46fdd999..bd2a069b541a67b3445e18d74af95e69874ef46b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;gen_genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;gen_genesis.go</span>
<span class="term-fg36">@@ -33,6 +33,7 @@</span> 		ParentHash    common.Hash                                 `json:&quot;parentHash&quot;`
 		BaseFee       *math.HexOrDecimal256                       `json:&quot;baseFeePerGas&quot;`
 		ExcessBlobGas *math.HexOrDecimal64                        `json:&quot;excessBlobGas&quot;`
 		BlobGasUsed   *math.HexOrDecimal64                        `json:&quot;blobGasUsed&quot;`
<span class="term-fg32">+		StateHash     *common.Hash                                `json:&quot;stateHash,omitempty&quot;`</span>
 	}
 	var enc Genesis
 	enc.Config = g.Config
<span class="term-fg36">@@ -55,6 +56,7 @@</span> 	enc.ParentHash = g.ParentHash
 	enc.BaseFee = (*math.HexOrDecimal256)(g.BaseFee)
 	enc.ExcessBlobGas = (*math.HexOrDecimal64)(g.ExcessBlobGas)
 	enc.BlobGasUsed = (*math.HexOrDecimal64)(g.BlobGasUsed)
<span class="term-fg32">+	enc.StateHash = g.StateHash</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -76,6 +78,7 @@</span> 		ParentHash    *common.Hash                                `json:&quot;parentHash&quot;`
 		BaseFee       *math.HexOrDecimal256                       `json:&quot;baseFeePerGas&quot;`
 		ExcessBlobGas *math.HexOrDecimal64                        `json:&quot;excessBlobGas&quot;`
 		BlobGasUsed   *math.HexOrDecimal64                        `json:&quot;blobGasUsed&quot;`
<span class="term-fg32">+		StateHash     *common.Hash                                `json:&quot;stateHash,omitempty&quot;`</span>
 	}
 	var dec Genesis
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -131,6 +134,9 @@</span> 		g.ExcessBlobGas = (*uint64)(dec.ExcessBlobGas)
 	}
 	if dec.BlobGasUsed != nil {
 		g.BlobGasUsed = (*uint64)(dec.BlobGasUsed)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.StateHash != nil {</span>
<span class="term-fg32">+		g.StateHash = dec.StateHash</span>
 	}
 	return nil
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-5418aee50aab94d1666626b1"role="button" aria-expanded="false" aria-controls="id-5418aee50aab94d1666626b1">
        
            <div class="col-12 col-sm-9 text-start"><h3>Superchain config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+376</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-5418aee50aab94d1666626b1">
        <div><p>Testing of the superchain configuration</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b5bd7c0b21fbd9ec637f88fe" role="button"
                   aria-expanded="false" aria-controls="id-b5bd7c0b21fbd9ec637f88fe">
                    <code>core/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+99</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b5bd7c0b21fbd9ec637f88fe"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;superchain.go op-geth&#47;core&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..96f68cedcf437f251d18e35764e4d49f4ddcab6b</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,99 @@</span>
<span class="term-fg32">+package core</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LoadOPStackGenesis(chainID uint64) (*Genesis, error) {</span>
<span class="term-fg32">+	chConfig, ok := superchain.OPChains[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown chain ID: %d&quot;, chainID)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	cfg, err := params.LoadOPStackChainConfig(chainID)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;failed to load params.ChainConfig for chain %d: %w&quot;, chainID, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	gen, err := superchain.LoadGenesis(chainID)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;failed to load genesis definition for chain %d: %w&quot;, chainID, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesis := &amp;Genesis{</span>
<span class="term-fg32">+		Config:     cfg,</span>
<span class="term-fg32">+		Nonce:      gen.Nonce,</span>
<span class="term-fg32">+		Timestamp:  gen.Timestamp,</span>
<span class="term-fg32">+		ExtraData:  gen.ExtraData,</span>
<span class="term-fg32">+		GasLimit:   gen.GasLimit,</span>
<span class="term-fg32">+		Difficulty: (*big.Int)(gen.Difficulty),</span>
<span class="term-fg32">+		Mixhash:    common.Hash(gen.Mixhash),</span>
<span class="term-fg32">+		Coinbase:   common.Address(gen.Coinbase),</span>
<span class="term-fg32">+		Alloc:      make(GenesisAlloc),</span>
<span class="term-fg32">+		Number:     gen.Number,</span>
<span class="term-fg32">+		GasUsed:    gen.GasUsed,</span>
<span class="term-fg32">+		ParentHash: common.Hash(gen.ParentHash),</span>
<span class="term-fg32">+		BaseFee:    (*big.Int)(gen.BaseFee),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for addr, acc := range gen.Alloc {</span>
<span class="term-fg32">+		var code []byte</span>
<span class="term-fg32">+		if acc.CodeHash != ([32]byte{}) {</span>
<span class="term-fg32">+			dat, err := superchain.LoadContractBytecode(acc.CodeHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;failed to load bytecode %s of address %s in chain %d: %w&quot;, acc.CodeHash, addr, chainID, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			code = dat</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var storage map[common.Hash]common.Hash</span>
<span class="term-fg32">+		if len(acc.Storage) &gt; 0 {</span>
<span class="term-fg32">+			storage = make(map[common.Hash]common.Hash)</span>
<span class="term-fg32">+			for k, v := range acc.Storage {</span>
<span class="term-fg32">+				storage[common.Hash(k)] = common.Hash(v)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		bal := common.Big0</span>
<span class="term-fg32">+		if acc.Balance != nil {</span>
<span class="term-fg32">+			bal = (*big.Int)(acc.Balance)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis.Alloc[common.Address(addr)] = GenesisAccount{</span>
<span class="term-fg32">+			Code:    code,</span>
<span class="term-fg32">+			Storage: storage,</span>
<span class="term-fg32">+			Balance: bal,</span>
<span class="term-fg32">+			Nonce:   acc.Nonce,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gen.StateHash != nil {</span>
<span class="term-fg32">+		if len(gen.Alloc) &gt; 0 {</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;chain definition unexpectedly contains both allocation (%d) and state-hash %s&quot;, len(gen.Alloc), *gen.StateHash)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis.StateHash = (*common.Hash)(gen.StateHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesisBlock := genesis.ToBlock()</span>
<span class="term-fg32">+	genesisBlockHash := genesisBlock.Hash()</span>
<span class="term-fg32">+	expectedHash := common.Hash([32]byte(chConfig.Genesis.L2.Hash))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Verify we correctly produced the genesis config by recomputing the genesis-block-hash,</span>
<span class="term-fg32">+	&#47;&#47; and check the genesis matches the chain genesis definition.</span>
<span class="term-fg32">+	if chConfig.Genesis.L2.Number != genesisBlock.NumberU64() {</span>
<span class="term-fg32">+		switch chainID {</span>
<span class="term-fg32">+		case params.OPMainnetChainID:</span>
<span class="term-fg32">+			expectedHash = common.HexToHash(&quot;0x7ca38a1916c42007829c55e69d3e9a73265554b586a499015373241b8a3fa48b&quot;)</span>
<span class="term-fg32">+		case params.OPGoerliChainID:</span>
<span class="term-fg32">+			expectedHash = common.HexToHash(&quot;0xc1fc15cd51159b1f1e5cbc4b82e85c1447ddfa33c52cf1d98d14fba0d6354be1&quot;)</span>
<span class="term-fg32">+		default:</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;unknown stateless genesis definition for chain %d&quot;, chainID)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if expectedHash != genesisBlockHash {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;produced genesis with hash %s but expected %s&quot;, genesisBlockHash, expectedHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return genesis, nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ca1897cce97a367519540474" role="button"
                   aria-expanded="false" aria-controls="id-ca1897cce97a367519540474">
                    <code>params/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+277</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ca1897cce97a367519540474"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;superchain.go op-geth&#47;params&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..83a5b47f5bf9912d5f4cdeab3153dd67314dcc8d</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,277 @@</span>
<span class="term-fg32">+package params</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;binary&quot;</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;sort&quot;</span>
<span class="term-fg32">+	&quot;strings&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var OPStackSupport = ProtocolVersionV0{Build: [8]byte{}, Major: 6, Minor: 0, Patch: 0, PreRelease: 0}.Encode()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func init() {</span>
<span class="term-fg32">+	for id, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		NetworkNames[fmt.Sprintf(&quot;%d&quot;, id)] = ch.Name</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func OPStackChainIDByName(name string) (uint64, error) {</span>
<span class="term-fg32">+	for id, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		if ch.Chain+&quot;-&quot;+ch.Superchain == name {</span>
<span class="term-fg32">+			return id, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, fmt.Errorf(&quot;unknown chain %q&quot;, name)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func OPStackChainNames() (out []string) {</span>
<span class="term-fg32">+	for _, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		out = append(out, ch.Chain+&quot;-&quot;+ch.Superchain)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	sort.Strings(out)</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LoadOPStackChainConfig(chainID uint64) (*ChainConfig, error) {</span>
<span class="term-fg32">+	chConfig, ok := superchain.OPChains[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown chain ID: %d&quot;, chainID)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesisActivation := uint64(0)</span>
<span class="term-fg32">+	out := &amp;ChainConfig{</span>
<span class="term-fg32">+		ChainID:                       new(big.Int).SetUint64(chainID),</span>
<span class="term-fg32">+		HomesteadBlock:                common.Big0,</span>
<span class="term-fg32">+		DAOForkBlock:                  nil,</span>
<span class="term-fg32">+		DAOForkSupport:                false,</span>
<span class="term-fg32">+		EIP150Block:                   common.Big0,</span>
<span class="term-fg32">+		EIP155Block:                   common.Big0,</span>
<span class="term-fg32">+		EIP158Block:                   common.Big0,</span>
<span class="term-fg32">+		ByzantiumBlock:                common.Big0,</span>
<span class="term-fg32">+		ConstantinopleBlock:           common.Big0,</span>
<span class="term-fg32">+		PetersburgBlock:               common.Big0,</span>
<span class="term-fg32">+		IstanbulBlock:                 common.Big0,</span>
<span class="term-fg32">+		MuirGlacierBlock:              common.Big0,</span>
<span class="term-fg32">+		BerlinBlock:                   common.Big0,</span>
<span class="term-fg32">+		LondonBlock:                   common.Big0,</span>
<span class="term-fg32">+		ArrowGlacierBlock:             common.Big0,</span>
<span class="term-fg32">+		GrayGlacierBlock:              common.Big0,</span>
<span class="term-fg32">+		MergeNetsplitBlock:            common.Big0,</span>
<span class="term-fg32">+		ShanghaiTime:                  chConfig.CanyonTime,  &#47;&#47; Shanghai activates with Canyon</span>
<span class="term-fg32">+		CancunTime:                    chConfig.EcotoneTime, &#47;&#47; Cancun activates with Ecotone</span>
<span class="term-fg32">+		PragueTime:                    nil,</span>
<span class="term-fg32">+		BedrockBlock:                  common.Big0,</span>
<span class="term-fg32">+		RegolithTime:                  &amp;genesisActivation,</span>
<span class="term-fg32">+		CanyonTime:                    chConfig.CanyonTime,</span>
<span class="term-fg32">+		EcotoneTime:                   chConfig.EcotoneTime,</span>
<span class="term-fg32">+		TerminalTotalDifficulty:       common.Big0,</span>
<span class="term-fg32">+		TerminalTotalDifficultyPassed: true,</span>
<span class="term-fg32">+		Ethash:                        nil,</span>
<span class="term-fg32">+		Clique:                        nil,</span>
<span class="term-fg32">+		Optimism: &amp;OptimismConfig{</span>
<span class="term-fg32">+			EIP1559Elasticity:        6,</span>
<span class="term-fg32">+			EIP1559Denominator:       50,</span>
<span class="term-fg32">+			EIP1559DenominatorCanyon: 250,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; special overrides for OP-Stack chains with pre-Regolith upgrade history</span>
<span class="term-fg32">+	switch chainID {</span>
<span class="term-fg32">+	case OPGoerliChainID:</span>
<span class="term-fg32">+		out.LondonBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.ArrowGlacierBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.GrayGlacierBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.MergeNetsplitBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.BedrockBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.RegolithTime = &amp;OptimismGoerliRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case OPMainnetChainID:</span>
<span class="term-fg32">+		out.BerlinBlock = big.NewInt(3950000)</span>
<span class="term-fg32">+		out.LondonBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.ArrowGlacierBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.GrayGlacierBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.MergeNetsplitBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.BedrockBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+	case BaseGoerliChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;BaseGoerliRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case baseSepoliaChainID:</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case baseGoerliDevnetChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;baseGoerliDevnetRegolithTime</span>
<span class="term-fg32">+	case pgnSepoliaChainID:</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 2</span>
<span class="term-fg32">+		out.Optimism.EIP1559Denominator = 8</span>
<span class="term-fg32">+	case devnetChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;devnetRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case chaosnetChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;chaosnetRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return out, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ProtocolVersion encodes the OP-Stack protocol version. See OP-Stack superchain-upgrade specification.</span>
<span class="term-fg32">+type ProtocolVersion [32]byte</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) MarshalText() ([]byte, error) {</span>
<span class="term-fg32">+	return common.Hash(p).MarshalText()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p *ProtocolVersion) UnmarshalText(input []byte) error {</span>
<span class="term-fg32">+	return (*common.Hash)(p).UnmarshalText(input)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) Parse() (versionType uint8, build [8]byte, major, minor, patch, preRelease uint32) {</span>
<span class="term-fg32">+	versionType = p[0]</span>
<span class="term-fg32">+	if versionType != 0 {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; bytes 1:8 reserved for future use</span>
<span class="term-fg32">+	copy(build[:], p[8:16])                        &#47;&#47; differentiates forks and custom-builds of standard protocol</span>
<span class="term-fg32">+	major = binary.BigEndian.Uint32(p[16:20])      &#47;&#47; incompatible API changes</span>
<span class="term-fg32">+	minor = binary.BigEndian.Uint32(p[20:24])      &#47;&#47; identifies additional functionality in backwards compatible manner</span>
<span class="term-fg32">+	patch = binary.BigEndian.Uint32(p[24:28])      &#47;&#47; identifies backward-compatible bug-fixes</span>
<span class="term-fg32">+	preRelease = binary.BigEndian.Uint32(p[28:32]) &#47;&#47; identifies unstable versions that may not satisfy the above</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) String() string {</span>
<span class="term-fg32">+	versionType, build, major, minor, patch, preRelease := p.Parse()</span>
<span class="term-fg32">+	if versionType != 0 {</span>
<span class="term-fg32">+		return &quot;v0.0.0-unknown.&quot; + common.Hash(p).String()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	ver := fmt.Sprintf(&quot;v%d.%d.%d&quot;, major, minor, patch)</span>
<span class="term-fg32">+	if preRelease != 0 {</span>
<span class="term-fg32">+		ver += fmt.Sprintf(&quot;-%d&quot;, preRelease)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if build != ([8]byte{}) {</span>
<span class="term-fg32">+		if humanBuildTag(build) {</span>
<span class="term-fg32">+			ver += fmt.Sprintf(&quot;+%s&quot;, strings.TrimRight(string(build[:]), &quot;\x00&quot;))</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			ver += fmt.Sprintf(&quot;+0x%x&quot;, build)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return ver</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; humanBuildTag identifies which build tag we can stringify for human-readable versions</span>
<span class="term-fg32">+func humanBuildTag(v [8]byte) bool {</span>
<span class="term-fg32">+	for i, c := range v { &#47;&#47; following semver.org advertised regex, alphanumeric with &#39;-&#39; and &#39;.&#39;, except leading &#39;.&#39;.</span>
<span class="term-fg32">+		if c == 0 { &#47;&#47; trailing zeroed are allowed</span>
<span class="term-fg32">+			for _, d := range v[i:] {</span>
<span class="term-fg32">+				if d != 0 {</span>
<span class="term-fg32">+					return false</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return true</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !((c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;Z&#39;) || (c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;z&#39;) || (c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39;) || c == &#39;-&#39; || (c == &#39;.&#39; &amp;&amp; i &gt; 0)) {</span>
<span class="term-fg32">+			return false</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return true</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ProtocolVersionComparison is used to identify how far ahead&#47;outdated a protocol version is relative to another.</span>
<span class="term-fg32">+&#47;&#47; This value is used in metrics and switch comparisons, to easily identify each type of version difference.</span>
<span class="term-fg32">+&#47;&#47; Negative values mean the version is outdated.</span>
<span class="term-fg32">+&#47;&#47; Positive values mean the version is up-to-date.</span>
<span class="term-fg32">+&#47;&#47; Matching versions have a 0.</span>
<span class="term-fg32">+type ProtocolVersionComparison int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	AheadMajor         ProtocolVersionComparison = 4</span>
<span class="term-fg32">+	OutdatedMajor      ProtocolVersionComparison = -4</span>
<span class="term-fg32">+	AheadMinor         ProtocolVersionComparison = 3</span>
<span class="term-fg32">+	OutdatedMinor      ProtocolVersionComparison = -3</span>
<span class="term-fg32">+	AheadPatch         ProtocolVersionComparison = 2</span>
<span class="term-fg32">+	OutdatedPatch      ProtocolVersionComparison = -2</span>
<span class="term-fg32">+	AheadPrerelease    ProtocolVersionComparison = 1</span>
<span class="term-fg32">+	OutdatedPrerelease ProtocolVersionComparison = -1</span>
<span class="term-fg32">+	Matching           ProtocolVersionComparison = 0</span>
<span class="term-fg32">+	DiffVersionType    ProtocolVersionComparison = 100</span>
<span class="term-fg32">+	DiffBuild          ProtocolVersionComparison = 101</span>
<span class="term-fg32">+	EmptyVersion       ProtocolVersionComparison = 102</span>
<span class="term-fg32">+	InvalidVersion     ProtocolVersionComparison = 103</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) Compare(other ProtocolVersion) (cmp ProtocolVersionComparison) {</span>
<span class="term-fg32">+	if p == (ProtocolVersion{}) || (other == (ProtocolVersion{})) {</span>
<span class="term-fg32">+		return EmptyVersion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	aVersionType, aBuild, aMajor, aMinor, aPatch, aPreRelease := p.Parse()</span>
<span class="term-fg32">+	bVersionType, bBuild, bMajor, bMinor, bPatch, bPreRelease := other.Parse()</span>
<span class="term-fg32">+	if aVersionType != bVersionType {</span>
<span class="term-fg32">+		return DiffVersionType</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if aBuild != bBuild {</span>
<span class="term-fg32">+		return DiffBuild</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; max values are reserved, consider versions with these values invalid</span>
<span class="term-fg32">+	if aMajor == ^uint32(0) || aMinor == ^uint32(0) || aPatch == ^uint32(0) || aPreRelease == ^uint32(0) ||</span>
<span class="term-fg32">+		bMajor == ^uint32(0) || bMinor == ^uint32(0) || bPatch == ^uint32(0) || bPreRelease == ^uint32(0) {</span>
<span class="term-fg32">+		return InvalidVersion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	fn := func(a, b uint32, ahead, outdated ProtocolVersionComparison) ProtocolVersionComparison {</span>
<span class="term-fg32">+		if a == b {</span>
<span class="term-fg32">+			return Matching</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if a &gt; b {</span>
<span class="term-fg32">+			return ahead</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return outdated</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if aPreRelease != 0 { &#47;&#47; if A is a pre-release, then decrement the version before comparison</span>
<span class="term-fg32">+		if aPatch != 0 {</span>
<span class="term-fg32">+			aPatch -= 1</span>
<span class="term-fg32">+		} else if aMinor != 0 {</span>
<span class="term-fg32">+			aMinor -= 1</span>
<span class="term-fg32">+			aPatch = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		} else if aMajor != 0 {</span>
<span class="term-fg32">+			aMajor -= 1</span>
<span class="term-fg32">+			aMinor = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if bPreRelease != 0 { &#47;&#47; if B is a pre-release, then decrement the version before comparison</span>
<span class="term-fg32">+		if bPatch != 0 {</span>
<span class="term-fg32">+			bPatch -= 1</span>
<span class="term-fg32">+		} else if bMinor != 0 {</span>
<span class="term-fg32">+			bMinor -= 1</span>
<span class="term-fg32">+			bPatch = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		} else if bMajor != 0 {</span>
<span class="term-fg32">+			bMajor -= 1</span>
<span class="term-fg32">+			bMinor = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aMajor, bMajor, AheadMajor, OutdatedMajor); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aMinor, bMinor, AheadMinor, OutdatedMinor); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aPatch, bPatch, AheadPatch, OutdatedPatch); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return fn(aPreRelease, bPreRelease, AheadPrerelease, OutdatedPrerelease)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type ProtocolVersionV0 struct {</span>
<span class="term-fg32">+	Build                           [8]byte</span>
<span class="term-fg32">+	Major, Minor, Patch, PreRelease uint32</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (v ProtocolVersionV0) Encode() (out ProtocolVersion) {</span>
<span class="term-fg32">+	copy(out[8:16], v.Build[:])</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[16:20], v.Major)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[20:24], v.Minor)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[24:28], v.Patch)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[28:32], v.PreRelease)</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4f370b6574626c37d752fc13"role="button" aria-expanded="false" aria-controls="id-4f370b6574626c37d752fc13">
        
            <div class="col-12 col-sm-9 text-start"><h2>Node modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+659</span></div>
                <div class="text-start"><span class="text-danger">-101</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4f370b6574626c37d752fc13">
        <div><p>Changes to the node configuration and services.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-726a531a73185626ad41043f"role="button" aria-expanded="false" aria-controls="id-726a531a73185626ad41043f">
        
            <div class="col-12 col-sm-9 text-start"><h3>CLI</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+234</span></div>
                <div class="text-start"><span class="text-danger">-10</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-726a531a73185626ad41043f">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-271dc8912ef56aadb7ac9cf3"role="button" aria-expanded="false" aria-controls="id-271dc8912ef56aadb7ac9cf3">
        
            <div class="col-12 col-sm-9 text-start"><h4>Flags</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+180</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-271dc8912ef56aadb7ac9cf3">
        <div><p>Flag changes:
  - Transactions can be forwarded to an RPC for sequencing.
  - Historical calls can be forwarded to a legacy node.
  - The tx pool propagation can be enabled/disabled.
  - The Optimism bedrock fork activation can be changed for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b966cdb9ad94dd1b481fa4c5" role="button"
                   aria-expanded="false" aria-controls="id-b966cdb9ad94dd1b481fa4c5">
                    <code>cmd/utils/flags.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/cmd/utils/flags.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/cmd/utils/flags.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+140</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b966cdb9ad94dd1b481fa4c5"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;utils&#47;flags.go op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">index 159c47ca019165e8c0eee0bd640ccb089437e57f..fdf65e7e262e9c5db4b3e679126115f6bc201511 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg36">@@ -155,6 +155,15 @@</span> 		Name:     &quot;holesky&quot;,
 		Usage:    &quot;Holesky network: pre-configured proof-of-stake test network&quot;,
 		Category: flags.EthCategory,
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	OPNetworkFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:    &quot;op-network&quot;,</span>
<span class="term-fg32">+		Aliases: []string{&quot;beta.op-network&quot;},</span>
<span class="term-fg32">+		Usage: &quot;Select a pre-configured OP-Stack network (warning: op-mainnet and op-goerli require special sync,&quot; +</span>
<span class="term-fg32">+			&quot; datadir is recommended), options: &quot; + strings.Join(params.OPStackChainNames(), &quot;, &quot;),</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Dev mode
 	DeveloperFlag = &amp;cli.BoolFlag{
 		Name:     &quot;dev&quot;,
<span class="term-fg36">@@ -252,6 +261,21 @@</span> 		Name:     &quot;override.verkle&quot;,
 		Usage:    &quot;Manually specify the Verkle fork timestamp, overriding the bundled setting&quot;,
 		Category: flags.EthCategory,
 	}
<span class="term-fg32">+	OverrideOptimismCanyon = &amp;cli.Uint64Flag{</span>
<span class="term-fg32">+		Name:     &quot;override.canyon&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify the Optimism Canyon fork timestamp, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimismEcotone = &amp;cli.Uint64Flag{</span>
<span class="term-fg32">+		Name:     &quot;override.ecotone&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify the Optimism Ecotone fork timestamp, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimismInterop = &amp;cli.Uint64Flag{</span>
<span class="term-fg32">+		Name:     &quot;override.interop&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify the Optimsim Interop feature-set fork timestamp, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
 	SyncModeFlag = &amp;flags.TextMarshalerFlag{
 		Name:     &quot;syncmode&quot;,
 		Usage:    `Blockchain sync mode (&quot;snap&quot; or &quot;full&quot;)`,
<span class="term-fg36">@@ -296,6 +320,11 @@</span> 	TxPoolJournalFlag = &amp;cli.StringFlag{
 		Name:     &quot;txpool.journal&quot;,
 		Usage:    &quot;Disk journal for local transaction to survive node restarts&quot;,
 		Value:    ethconfig.Defaults.TxPool.Journal,
<span class="term-fg32">+		Category: flags.TxPoolCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	TxPoolJournalRemotesFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;txpool.journalremotes&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Includes remote transactions in the journal&quot;,</span>
 		Category: flags.TxPoolCategory,
 	}
 	TxPoolRejournalFlag = &amp;cli.DurationFlag{
<span class="term-fg36">@@ -749,13 +778,14 @@</span> 		Name:     &quot;discovery.v4&quot;,
 		Aliases:  []string{&quot;discv4&quot;},
 		Usage:    &quot;Enables the V4 discovery mechanism&quot;,
 		Category: flags.NetworkingCategory,
<span class="term-fg31">-		Value:    true,</span>
<span class="term-fg32">+		Value:    false,</span>
 	}
 	DiscoveryV5Flag = &amp;cli.BoolFlag{
 		Name:     &quot;discovery.v5&quot;,
 		Aliases:  []string{&quot;discv5&quot;},
 		Usage:    &quot;Enables the experimental RLPx V5 (Topic Discovery) mechanism&quot;,
 		Category: flags.NetworkingCategory,
<span class="term-fg32">+		Value:    true,</span>
 	}
 	NetrestrictFlag = &amp;cli.StringFlag{
 		Name:     &quot;netrestrict&quot;,
<span class="term-fg36">@@ -813,6 +843,60 @@</span> 		Usage:    &quot;Gas price below which gpo will ignore transactions&quot;,
 		Value:    ethconfig.Defaults.GPO.IgnorePrice.Int64(),
 		Category: flags.GasPriceCategory,
 	}
<span class="term-fg32">+	GpoMinSuggestedPriorityFeeFlag = &amp;cli.Int64Flag{</span>
<span class="term-fg32">+		Name:     &quot;gpo.minsuggestedpriorityfee&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Minimum transaction priority fee to suggest. Used on OP chains when blocks are not full.&quot;,</span>
<span class="term-fg32">+		Value:    ethconfig.Defaults.GPO.MinSuggestedPriorityFee.Int64(),</span>
<span class="term-fg32">+		Category: flags.GasPriceCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Rollup Flags</span>
<span class="term-fg32">+	RollupSequencerHTTPFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.sequencerhttp&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;HTTP endpoint for the sequencer mempool&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpc&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;RPC endpoint for historical data.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeoutFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpctimeout&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Timeout for historical RPC requests.&quot;,</span>
<span class="term-fg32">+		Value:    &quot;5s&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupDisableTxPoolGossipFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.disabletxpoolgossip&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Disable transaction pool gossip.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupEnableTxPoolAdmissionFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.enabletxpooladmission&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Add RPC-submitted transactions to the txpool (on by default if --rollup.sequencerhttp is not set).&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupComputePendingBlock = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.computependingblock&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;By default the pending block equals the latest block to save resources and not leak txs from the tx-pool, this flag enables computing of the pending block from the tx-pool instead.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupHaltOnIncompatibleProtocolVersionFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.halt&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Opt-in option to halt on incompatible protocol version requirements of the given level (major&#47;minor&#47;patch&#47;none), as signaled through the Engine API by the rollup node&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupSuperchainUpgradesFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.superchain-upgrades&quot;,</span>
<span class="term-fg32">+		Aliases:  []string{&quot;beta.rollup.superchain-upgrades&quot;},</span>
<span class="term-fg32">+		Usage:    &quot;Apply superchain-registry config changes to the local chain-configuration&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+		Value:    true,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Metrics flags
 	MetricsEnabledFlag = &amp;cli.BoolFlag{
<span class="term-fg36">@@ -918,7 +1002,7 @@</span> 		SepoliaFlag,
 		HoleskyFlag,
 	}
 	&#47;&#47; NetworkFlags is the flag group of all built-in supported networks.
<span class="term-fg31">-	NetworkFlags = append([]cli.Flag{MainnetFlag}, TestnetFlags...)</span>
<span class="term-fg32">+	NetworkFlags = append([]cli.Flag{MainnetFlag, OPNetworkFlag}, TestnetFlags...)</span>
&nbsp;
 	&#47;&#47; DatabaseFlags is the flag group of all database flags.
 	DatabaseFlags = []cli.Flag{
<span class="term-fg36">@@ -944,6 +1028,9 @@</span> 			return filepath.Join(path, &quot;sepolia&quot;)
 		}
 		if ctx.Bool(HoleskyFlag.Name) {
 			return filepath.Join(path, &quot;holesky&quot;)
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if ctx.IsSet(OPNetworkFlag.Name) {</span>
<span class="term-fg32">+			return filepath.Join(path, ctx.String(OPNetworkFlag.Name))</span>
 		}
 		return path
 	}
<span class="term-fg36">@@ -1036,6 +1123,13 @@</span> 	case ctx.IsSet(BootnodesFlag.Name):
 		urls = SplitAndTrim(ctx.String(BootnodesFlag.Name))
 	case cfg.BootstrapNodesV5 != nil:
 		return &#47;&#47; already set, don&#39;t apply defaults.
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name):</span>
<span class="term-fg32">+		network := ctx.String(OPNetworkFlag.Name)</span>
<span class="term-fg32">+		if strings.Contains(strings.ToLower(network), &quot;mainnet&quot;) {</span>
<span class="term-fg32">+			urls = params.V5OPBootnodes</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			urls = params.V5OPTestnetBootnodes</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	cfg.BootstrapNodesV5 = make([]*enode.Node, 0, len(urls))
<span class="term-fg36">@@ -1434,6 +1528,8 @@</span> 	case ctx.Bool(SepoliaFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():
 		cfg.DataDir = filepath.Join(node.DefaultDataDir(), &quot;sepolia&quot;)
 	case ctx.Bool(HoleskyFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():
 		cfg.DataDir = filepath.Join(node.DefaultDataDir(), &quot;holesky&quot;)
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():</span>
<span class="term-fg32">+		cfg.DataDir = filepath.Join(node.DefaultDataDir(), ctx.String(OPNetworkFlag.Name))</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1450,6 +1546,9 @@</span> 	}
 	if ctx.IsSet(GpoIgnoreGasPriceFlag.Name) {
 		cfg.IgnorePrice = big.NewInt(ctx.Int64(GpoIgnoreGasPriceFlag.Name))
 	}
<span class="term-fg32">+	if ctx.IsSet(GpoMinSuggestedPriorityFeeFlag.Name) {</span>
<span class="term-fg32">+		cfg.MinSuggestedPriorityFee = big.NewInt(ctx.Int64(GpoMinSuggestedPriorityFeeFlag.Name))</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 func setTxPool(ctx *cli.Context, cfg *legacypool.Config) {
<span class="term-fg36">@@ -1469,6 +1568,9 @@</span> 	}
 	if ctx.IsSet(TxPoolJournalFlag.Name) {
 		cfg.Journal = ctx.String(TxPoolJournalFlag.Name)
 	}
<span class="term-fg32">+	if ctx.IsSet(TxPoolJournalRemotesFlag.Name) {</span>
<span class="term-fg32">+		cfg.JournalRemote = ctx.Bool(TxPoolJournalRemotesFlag.Name)</span>
<span class="term-fg32">+	}</span>
 	if ctx.IsSet(TxPoolRejournalFlag.Name) {
 		cfg.Rejournal = ctx.Duration(TxPoolRejournalFlag.Name)
 	}
<span class="term-fg36">@@ -1510,6 +1612,9 @@</span> 		cfg.Recommit = ctx.Duration(MinerRecommitIntervalFlag.Name)
 	}
 	if ctx.IsSet(MinerNewPayloadTimeout.Name) {
 		cfg.NewPayloadTimeout = ctx.Duration(MinerNewPayloadTimeout.Name)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupComputePendingBlock.Name) {</span>
<span class="term-fg32">+		cfg.RollupComputePendingBlock = ctx.Bool(RollupComputePendingBlock.Name)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1585,7 +1690,7 @@</span>
 &#47;&#47; SetEthConfig applies eth-related command line flags to the config.
 func SetEthConfig(ctx *cli.Context, stack *node.Node, cfg *ethconfig.Config) {
 	&#47;&#47; Avoid conflicting network flags
<span class="term-fg31">-	CheckExclusive(ctx, MainnetFlag, DeveloperFlag, GoerliFlag, SepoliaFlag, HoleskyFlag)</span>
<span class="term-fg32">+	CheckExclusive(ctx, MainnetFlag, DeveloperFlag, GoerliFlag, SepoliaFlag, HoleskyFlag, OPNetworkFlag)</span>
 	CheckExclusive(ctx, DeveloperFlag, ExternalSignerFlag) &#47;&#47; Can&#39;t use both ephemeral unlocked and external signer
&nbsp;
 	&#47;&#47; Set configurations from CLI flags
<span class="term-fg36">@@ -1728,6 +1833,20 @@</span> 		} else {
 			cfg.EthDiscoveryURLs = SplitAndTrim(urls)
 		}
 	}
<span class="term-fg32">+	&#47;&#47; Only configure sequencer http flag if we&#39;re running in verifier mode i.e. --mine is disabled.</span>
<span class="term-fg32">+	if ctx.IsSet(RollupSequencerHTTPFlag.Name) &amp;&amp; !ctx.IsSet(MiningEnabledFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupSequencerHTTP = ctx.String(RollupSequencerHTTPFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPC = ctx.String(RollupHistoricalRPCFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCTimeoutFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPCTimeout = ctx.Duration(RollupHistoricalRPCTimeoutFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolGossip = ctx.Bool(RollupDisableTxPoolGossipFlag.Name)</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolAdmission = cfg.RollupSequencerHTTP != &quot;&quot; &amp;&amp; !ctx.Bool(RollupEnableTxPoolAdmissionFlag.Name)</span>
<span class="term-fg32">+	cfg.RollupHaltOnIncompatibleProtocolVersion = ctx.String(RollupHaltOnIncompatibleProtocolVersionFlag.Name)</span>
<span class="term-fg32">+	cfg.ApplySuperchainUpgrades = ctx.Bool(RollupSuperchainUpgradesFlag.Name)</span>
 	&#47;&#47; Override any default configs for hard coded networks.
 	switch {
 	case ctx.Bool(MainnetFlag.Name):
<span class="term-fg36">@@ -1829,6 +1948,12 @@</span> 		}
 		if !ctx.IsSet(MinerGasPriceFlag.Name) {
 			cfg.Miner.GasPrice = big.NewInt(1)
 		}
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name):</span>
<span class="term-fg32">+		genesis := MakeGenesis(ctx)</span>
<span class="term-fg32">+		if !ctx.IsSet(NetworkIdFlag.Name) {</span>
<span class="term-fg32">+			cfg.NetworkId = genesis.Config.ChainID.Uint64()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		cfg.Genesis = genesis</span>
 	default:
 		if cfg.NetworkId == 1 {
 			SetDNSDiscoveryDefaults(cfg, params.MainnetGenesisHash)
<span class="term-fg36">@@ -2020,8 +2145,7 @@</span> }
&nbsp;
 func IsNetworkPreset(ctx *cli.Context) bool {
 	for _, flag := range NetworkFlags {
<span class="term-fg31">-		bFlag, _ := flag.(*cli.BoolFlag)</span>
<span class="term-fg31">-		if ctx.IsSet(bFlag.Name) {</span>
<span class="term-fg32">+		if ctx.IsSet(flag.Names()[0]) {</span>
 			return true
 		}
 	}
<span class="term-fg36">@@ -2063,6 +2187,17 @@</span> 	case ctx.Bool(SepoliaFlag.Name):
 		genesis = core.DefaultSepoliaGenesisBlock()
 	case ctx.Bool(GoerliFlag.Name):
 		genesis = core.DefaultGoerliGenesisBlock()
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name):</span>
<span class="term-fg32">+		name := ctx.String(OPNetworkFlag.Name)</span>
<span class="term-fg32">+		ch, err := params.OPStackChainIDByName(name)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			Fatalf(&quot;failed to load OP-Stack chain %q: %v&quot;, name, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis, err := core.LoadOPStackGenesis(ch)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			Fatalf(&quot;failed to load genesis for OP-Stack chain %q (%d): %v&quot;, name, ch, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return genesis</span>
 	case ctx.Bool(DeveloperFlag.Name):
 		Fatalf(&quot;Developer chains are ephemeral&quot;)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e7e6e6eeabbe3758cba5df0c" role="button"
                   aria-expanded="false" aria-controls="id-e7e6e6eeabbe3758cba5df0c">
                    <code>cmd/geth/main.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/cmd/geth/main.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/cmd/geth/main.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e7e6e6eeabbe3758cba5df0c"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;main.go op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">index 0fd0cc20995b9a26a06cdfd3545e2cd73e4283bb..031fbd62210a102cd2b295b521cd8cd7e6d69451 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg36">@@ -67,10 +67,14 @@</span> 		utils.USBFlag,
 		utils.SmartCardDaemonPathFlag,
 		utils.OverrideCancun,
 		utils.OverrideVerkle,
<span class="term-fg32">+		utils.OverrideOptimismCanyon,</span>
<span class="term-fg32">+		utils.OverrideOptimismEcotone,</span>
<span class="term-fg32">+		utils.OverrideOptimismInterop,</span>
 		utils.EnablePersonal,
 		utils.TxPoolLocalsFlag,
 		utils.TxPoolNoLocalsFlag,
 		utils.TxPoolJournalFlag,
<span class="term-fg32">+		utils.TxPoolJournalRemotesFlag,</span>
 		utils.TxPoolRejournalFlag,
 		utils.TxPoolPriceLimitFlag,
 		utils.TxPoolPriceBumpFlag,
<span class="term-fg36">@@ -143,6 +147,14 @@</span> 		utils.GpoBlocksFlag,
 		utils.GpoPercentileFlag,
 		utils.GpoMaxGasPriceFlag,
 		utils.GpoIgnoreGasPriceFlag,
<span class="term-fg32">+		utils.GpoMinSuggestedPriorityFeeFlag,</span>
<span class="term-fg32">+		utils.RollupSequencerHTTPFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCTimeoutFlag,</span>
<span class="term-fg32">+		utils.RollupDisableTxPoolGossipFlag,</span>
<span class="term-fg32">+		utils.RollupComputePendingBlock,</span>
<span class="term-fg32">+		utils.RollupHaltOnIncompatibleProtocolVersionFlag,</span>
<span class="term-fg32">+		utils.RollupSuperchainUpgradesFlag,</span>
 		configFileFlag,
 		utils.LogDebugFlag,
 		utils.LogBacktraceAtFlag,
<span class="term-fg36">@@ -303,6 +315,9 @@</span>   5. Networking is disabled; there is no listen-address, the maximum number of peers is set
      to 0, and discovery is disabled.
 `)
&nbsp;
<span class="term-fg32">+	case ctx.IsSet(utils.OPNetworkFlag.Name):</span>
<span class="term-fg32">+		log.Info(&quot;Starting geth on an OP network...&quot;, &quot;network&quot;, ctx.String(utils.OPNetworkFlag.Name))</span>
<span class="term-fg32">+</span>
 	case !ctx.IsSet(utils.NetworkIdFlag.Name):
 		log.Info(&quot;Starting Geth on Ethereum mainnet...&quot;)
 	}
<span class="term-fg36">@@ -314,7 +329,14 @@</span> 			!ctx.IsSet(utils.SepoliaFlag.Name) &amp;&amp;
 			!ctx.IsSet(utils.GoerliFlag.Name) &amp;&amp;
 			!ctx.IsSet(utils.DeveloperFlag.Name) {
 			&#47;&#47; Nope, we&#39;re really on mainnet. Bump that cache up!
<span class="term-fg32">+			&#47;&#47; Note: If we don&#39;t set the OPNetworkFlag and have already initialized the database, we may hit this case.</span>
 			log.Info(&quot;Bumping default cache on mainnet&quot;, &quot;provided&quot;, ctx.Int(utils.CacheFlag.Name), &quot;updated&quot;, 4096)
<span class="term-fg32">+			ctx.Set(utils.CacheFlag.Name, strconv.Itoa(4096))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else if ctx.String(utils.SyncModeFlag.Name) != &quot;light&quot; &amp;&amp; !ctx.IsSet(utils.CacheFlag.Name) &amp;&amp; ctx.IsSet(utils.OPNetworkFlag.Name) {</span>
<span class="term-fg32">+		&#47;&#47; We haven&#39;t set the cache, but may used the OP network flag we may be on an OP stack mainnet.</span>
<span class="term-fg32">+		if strings.Contains(ctx.String(utils.OPNetworkFlag.Name), &quot;mainnet&quot;) {</span>
<span class="term-fg32">+			log.Info(&quot;Bumping default cache on mainnet&quot;, &quot;provided&quot;, ctx.Int(utils.CacheFlag.Name), &quot;updated&quot;, 4096, &quot;network&quot;, ctx.String(utils.OPNetworkFlag.Name))</span>
 			ctx.Set(utils.CacheFlag.Name, strconv.Itoa(4096))
 		}
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fa8b2c600c6e4f12ceb05fb1" role="button"
                   aria-expanded="false" aria-controls="id-fa8b2c600c6e4f12ceb05fb1">
                    <code>internal/flags/categories.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/flags/categories.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/flags/categories.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fa8b2c600c6e4f12ceb05fb1"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;flags&#47;categories.go op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">index 3ff0767921b9f97755b09d818ca7ca55e4f79c8a..fe2e6d29d4583b57ad9fdbb875dfc68e1eb12faa 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg36">@@ -32,6 +32,7 @@</span> 	NetworkingCategory = &quot;NETWORKING&quot;
 	MinerCategory      = &quot;MINER&quot;
 	GasPriceCategory   = &quot;GAS PRICE ORACLE&quot;
 	VMCategory         = &quot;VIRTUAL MACHINE&quot;
<span class="term-fg32">+	RollupCategory     = &quot;ROLLUP NODE&quot;</span>
 	LoggingCategory    = &quot;LOGGING AND DEBUGGING&quot;
 	MetricsCategory    = &quot;METRICS AND STATS&quot;
 	MiscCategory       = &quot;MISC&quot;</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-88c2b19067b99e5160e034da" role="button"
                   aria-expanded="false" aria-controls="id-88c2b19067b99e5160e034da">
                    <code>cmd/geth/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/cmd/geth/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/cmd/geth/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-88c2b19067b99e5160e034da"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;config.go op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">index 5f52f1df54423289b352083d1fcd672296d79571..7e5cf5edfb31b7f8fc6e65539240768638dd11d5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg36">@@ -173,10 +173,27 @@</span> 	if ctx.IsSet(utils.OverrideCancun.Name) {
 		v := ctx.Uint64(utils.OverrideCancun.Name)
 		cfg.Eth.OverrideCancun = &amp;v
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismCanyon.Name) {</span>
<span class="term-fg32">+		v := ctx.Uint64(utils.OverrideOptimismCanyon.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismCanyon = &amp;v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismEcotone.Name) {</span>
<span class="term-fg32">+		v := ctx.Uint64(utils.OverrideOptimismEcotone.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismEcotone = &amp;v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismInterop.Name) {</span>
<span class="term-fg32">+		v := ctx.Uint64(utils.OverrideOptimismInterop.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismInterop = &amp;v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	if ctx.IsSet(utils.OverrideVerkle.Name) {
 		v := ctx.Uint64(utils.OverrideVerkle.Name)
 		cfg.Eth.OverrideVerkle = &amp;v
 	}
<span class="term-fg32">+</span>
 	backend, eth := utils.RegisterEthService(stack, &amp;cfg.Eth)
&nbsp;
 	&#47;&#47; Create gauge with geth system and build information</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-008bee0d1b69f1b44b7507d9"role="button" aria-expanded="false" aria-controls="id-008bee0d1b69f1b44b7507d9">
        
            <div class="col-12 col-sm-9 text-start"><h4>Versioning</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+54</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-008bee0d1b69f1b44b7507d9">
        <div><p>List the op-geth and upstream go-ethereum versions.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7c084e7a43e6d4cad15182e2" role="button"
                   aria-expanded="false" aria-controls="id-7c084e7a43e6d4cad15182e2">
                    <code>cmd/geth/misccmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/cmd/geth/misccmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/cmd/geth/misccmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7c084e7a43e6d4cad15182e2"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;misccmd.go op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">index f3530c30fb69fe08024d9f62a1a377d416c684d9..e7fb108ebfb6a065eb1232ced8fcdf1c49eee4c5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg36">@@ -80,6 +80,7 @@</span> 	}
 	if git.Date != &quot;&quot; {
 		fmt.Println(&quot;Git Commit Date:&quot;, git.Date)
 	}
<span class="term-fg32">+	fmt.Println(&quot;Upstream Version:&quot;, params.GethVersionWithMeta)</span>
 	fmt.Println(&quot;Architecture:&quot;, runtime.GOARCH)
 	fmt.Println(&quot;Go Version:&quot;, runtime.Version())
 	fmt.Println(&quot;Operating System:&quot;, runtime.GOOS)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1c89e51bdfa7d40566519561" role="button"
                   aria-expanded="false" aria-controls="id-1c89e51bdfa7d40566519561">
                    <code>params/version.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/params/version.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/version.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+49</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1c89e51bdfa7d40566519561"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;version.go op-geth&#47;params&#47;version.go</span>
<span class="term-fg1">index d93c5f737849f7ad7dc5b454d043fd30c7d965d7..bf50a9fa1f01f64f11ef9794360f46d46c5aaddf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;version.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;version.go</span>
<span class="term-fg36">@@ -18,8 +18,11 @@</span> package params
&nbsp;
 import (
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;regexp&quot;</span>
<span class="term-fg32">+	&quot;strconv&quot;</span>
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; Version is the version of upstream geth</span>
 const (
 	VersionMajor = 1        &#47;&#47; Major version component of the current release
 	VersionMinor = 13       &#47;&#47; Minor version component of the current release
<span class="term-fg36">@@ -27,14 +30,56 @@</span> 	VersionPatch = 11       &#47;&#47; Patch version component of the current release
 	VersionMeta  = &quot;stable&quot; &#47;&#47; Version metadata to append to the version string
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; OPVersion is the version of op-geth</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	OPVersionMajor = 0          &#47;&#47; Major version component of the current release</span>
<span class="term-fg32">+	OPVersionMinor = 1          &#47;&#47; Minor version component of the current release</span>
<span class="term-fg32">+	OPVersionPatch = 0          &#47;&#47; Patch version component of the current release</span>
<span class="term-fg32">+	OPVersionMeta  = &quot;unstable&quot; &#47;&#47; Version metadata to append to the version string</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; This is set at build-time by the linker when the build is done by build&#47;ci.go.</span>
<span class="term-fg32">+var gitTag string</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Override the version variables if the gitTag was set at build time.</span>
<span class="term-fg32">+var _ = func() (_ string) {</span>
<span class="term-fg32">+	semver := regexp.MustCompile(`^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$`)</span>
<span class="term-fg32">+	version := semver.FindStringSubmatch(gitTag)</span>
<span class="term-fg32">+	if version == nil {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if version[4] == &quot;&quot; {</span>
<span class="term-fg32">+		version[4] = &quot;stable&quot;</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OPVersionMajor, _ = strconv.Atoi(version[1])</span>
<span class="term-fg32">+	OPVersionMinor, _ = strconv.Atoi(version[2])</span>
<span class="term-fg32">+	OPVersionPatch, _ = strconv.Atoi(version[3])</span>
<span class="term-fg32">+	OPVersionMeta = version[4]</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
 &#47;&#47; Version holds the textual version string.
 var Version = func() string {
<span class="term-fg31">-	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, OPVersionMajor, OPVersionMinor, OPVersionPatch)</span>
 }()
&nbsp;
 &#47;&#47; VersionWithMeta holds the textual version string including the metadata.
 var VersionWithMeta = func() string {
 	v := Version
<span class="term-fg32">+	if OPVersionMeta != &quot;&quot; {</span>
<span class="term-fg32">+		v += &quot;-&quot; + OPVersionMeta</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return v</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersion holds the textual geth version string.</span>
<span class="term-fg32">+var GethVersion = func() string {</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersionWithMeta holds the textual geth version string including the metadata.</span>
<span class="term-fg32">+var GethVersionWithMeta = func() string {</span>
<span class="term-fg32">+	v := GethVersion</span>
 	if VersionMeta != &quot;&quot; {
 		v += &quot;-&quot; + VersionMeta
 	}
<span class="term-fg36">@@ -46,8 +91,8 @@</span> &#47;&#47; &quot;1.8.11-dea1ce05&quot; for stable releases, or &quot;1.8.13-unstable-21c059b6&quot; for unstable
 &#47;&#47; releases.
 func ArchiveVersion(gitCommit string) string {
 	vsn := Version
<span class="term-fg31">-	if VersionMeta != &quot;stable&quot; {</span>
<span class="term-fg31">-		vsn += &quot;-&quot; + VersionMeta</span>
<span class="term-fg32">+	if OPVersionMeta != &quot;stable&quot; {</span>
<span class="term-fg32">+		vsn += &quot;-&quot; + OPVersionMeta</span>
 	}
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
<span class="term-fg36">@@ -60,7 +105,7 @@</span> 	vsn := VersionWithMeta
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
 	}
<span class="term-fg31">-	if (VersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
<span class="term-fg32">+	if (OPVersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
 		vsn += &quot;-&quot; + gitDate
 	}
 	return vsn</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8d6f7e8fad5c879e569a33cc" role="button"
                   aria-expanded="false" aria-controls="id-8d6f7e8fad5c879e569a33cc">
                    <code>build/ci.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/build/ci.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/build/ci.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8d6f7e8fad5c879e569a33cc"><span class="term-fg1">diff --git go-ethereum&#47;build&#47;ci.go op-geth&#47;build&#47;ci.go</span>
<span class="term-fg1">index 1ffbf3074dd7212c99ac469406312d2c1dfc9ac2..efefd4477c75b7f31e51096854dfc0eed71e770e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;build&#47;ci.go</span>
<span class="term-fg1">+++ op-geth&#47;build&#47;ci.go</span>
<span class="term-fg36">@@ -248,6 +248,9 @@</span> 	if env.Commit != &quot;&quot; {
 		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;version.gitCommit=&quot;+env.Commit)
 		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;version.gitDate=&quot;+env.Date)
 	}
<span class="term-fg32">+	if env.Tag != &quot;&quot; {</span>
<span class="term-fg32">+		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;params.gitTag=&quot;+env.Tag)</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Strip DWARF on darwin. This used to be required for certain things,
 	&#47;&#47; and there is no downside to this, so we just keep doing it.
 	if runtime.GOOS == &quot;darwin&quot; {
<span class="term-fg36">@@ -542,7 +545,7 @@</span> 	switch {
 	case env.Branch == &quot;master&quot;:
 		tags = []string{&quot;latest&quot;}
 	case strings.HasPrefix(env.Tag, &quot;v1.&quot;):
<span class="term-fg31">-		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.VersionMinor), &quot;v&quot; + params.Version}</span>
<span class="term-fg32">+		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.OPVersionMinor), &quot;v&quot; + params.Version}</span>
 	}
 	&#47;&#47; If architecture specific image builds are requested, build and push them
 	if *image {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-f8a56d6bcf32d04c91056cd7"role="button" aria-expanded="false" aria-controls="id-f8a56d6bcf32d04c91056cd7">
        
            <div class="col-12 col-sm-9 text-start"><h3>Node config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+26</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-f8a56d6bcf32d04c91056cd7">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-119adab9cdf82392b3286410" role="button"
                   aria-expanded="false" aria-controls="id-119adab9cdf82392b3286410">
                    <code>eth/ethconfig/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/ethconfig/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/ethconfig/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+26</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-119adab9cdf82392b3286410"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;ethconfig&#47;config.go op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">index ad664afb5bd1fa68165f23bfd30ef5c82eb0a7e0..afe26e37a8a3c947394a937ab0222ba9c7f3de11 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg36">@@ -38,12 +38,13 @@</span> )
&nbsp;
 &#47;&#47; FullNodeGPO contains default gasprice oracle settings for full node.
 var FullNodeGPO = gasprice.Config{
<span class="term-fg31">-	Blocks:           20,</span>
<span class="term-fg31">-	Percentile:       60,</span>
<span class="term-fg31">-	MaxHeaderHistory: 1024,</span>
<span class="term-fg31">-	MaxBlockHistory:  1024,</span>
<span class="term-fg31">-	MaxPrice:         gasprice.DefaultMaxPrice,</span>
<span class="term-fg31">-	IgnorePrice:      gasprice.DefaultIgnorePrice,</span>
<span class="term-fg32">+	Blocks:                  20,</span>
<span class="term-fg32">+	Percentile:              60,</span>
<span class="term-fg32">+	MaxHeaderHistory:        1024,</span>
<span class="term-fg32">+	MaxBlockHistory:         1024,</span>
<span class="term-fg32">+	MaxPrice:                gasprice.DefaultMaxPrice,</span>
<span class="term-fg32">+	IgnorePrice:             gasprice.DefaultIgnorePrice,</span>
<span class="term-fg32">+	MinSuggestedPriorityFee: gasprice.DefaultMinSuggestedPriorityFee,</span>
 }
&nbsp;
 &#47;&#47; Defaults contains default settings for use on the Ethereum main net.
<span class="term-fg36">@@ -159,12 +160,31 @@</span> 	OverrideCancun *uint64 `toml:&quot;,omitempty&quot;`
&nbsp;
 	&#47;&#47; OverrideVerkle (TODO: remove after the fork)
 	OverrideVerkle *uint64 `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	OverrideOptimismCanyon *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	OverrideOptimismEcotone *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	OverrideOptimismInterop *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; ApplySuperchainUpgrades requests the node to load chain-configuration from the superchain-registry.</span>
<span class="term-fg32">+	ApplySuperchainUpgrades bool `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupSequencerHTTP                     string</span>
<span class="term-fg32">+	RollupHistoricalRPC                     string</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeout              time.Duration</span>
<span class="term-fg32">+	RollupDisableTxPoolGossip               bool</span>
<span class="term-fg32">+	RollupDisableTxPoolAdmission            bool</span>
<span class="term-fg32">+	RollupHaltOnIncompatibleProtocolVersion string</span>
 }
&nbsp;
 &#47;&#47; CreateConsensusEngine creates a consensus engine for the given chain config.
 &#47;&#47; Clique is allowed for now to live standalone, but ethash is forbidden and can
 &#47;&#47; only exist on already merged networks.
 func CreateConsensusEngine(config *params.ChainConfig, db ethdb.Database) (consensus.Engine, error) {
<span class="term-fg32">+	if config.Optimism != nil {</span>
<span class="term-fg32">+		return beacon.New(&amp;beacon.OpLegacy{}), nil</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; If proof-of-authority is requested, set it up
 	if config.Clique != nil {
 		return beacon.New(clique.New(config.Clique, db)), nil</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-05ab7b6d7bc4a398bea356a4"role="button" aria-expanded="false" aria-controls="id-05ab7b6d7bc4a398bea356a4">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx gossip disable option</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+31</span></div>
                <div class="text-start"><span class="text-danger">-4</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-05ab7b6d7bc4a398bea356a4">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cce139503b1fca39e6c58ebe" role="button"
                   aria-expanded="false" aria-controls="id-cce139503b1fca39e6c58ebe">
                    <code>eth/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cce139503b1fca39e6c58ebe"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler.go op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg1">index a327af61131f45baadaf5ef72c276b539d10eb51..5e4e9dbd0b58cdd87023688056d9b012f8ca1129 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg36">@@ -93,6 +93,7 @@</span> 	Sync           downloader.SyncMode    &#47;&#47; Whether to snap or full sync
 	BloomCache     uint64                 &#47;&#47; Megabytes to alloc for snap sync bloom
 	EventMux       *event.TypeMux         &#47;&#47; Legacy event mux, deprecate for `feed`
 	RequiredBlocks map[uint64]common.Hash &#47;&#47; Hard coded map of required block hashes for sync challenges
<span class="term-fg32">+	NoTxGossip     bool                   &#47;&#47; Disable P2P transaction gossip</span>
 }
&nbsp;
 type handler struct {
<span class="term-fg36">@@ -106,6 +107,8 @@</span> 	database ethdb.Database
 	txpool   txPool
 	chain    *core.BlockChain
 	maxPeers int
<span class="term-fg32">+</span>
<span class="term-fg32">+	noTxGossip bool</span>
&nbsp;
 	downloader   *downloader.Downloader
 	blockFetcher *fetcher.BlockFetcher
<span class="term-fg36">@@ -142,6 +145,7 @@</span> 		forkFilter:     forkid.NewFilter(config.Chain),
 		eventMux:       config.EventMux,
 		database:       config.Database,
 		txpool:         config.TxPool,
<span class="term-fg32">+		noTxGossip:     config.NoTxGossip,</span>
 		chain:          config.Chain,
 		peers:          newPeerSet(),
 		merger:         config.Merger,
<span class="term-fg36">@@ -169,9 +173,10 @@</span> 			log.Warn(&quot;Switch sync mode from full sync to snap sync&quot;, &quot;reason&quot;, &quot;head state missing&quot;)
 		}
 	} else {
 		head := h.chain.CurrentBlock()
<span class="term-fg31">-		if head.Number.Uint64() &gt; 0 &amp;&amp; h.chain.HasState(head.Root) {</span>
<span class="term-fg32">+		if head.Number.Uint64() &gt; 0 &amp;&amp; h.chain.HasState(head.Root) &amp;&amp; (!config.Chain.Config().IsOptimism() || head.Number.Cmp(config.Chain.Config().BedrockBlock) != 0) {</span>
 			&#47;&#47; Print warning log if database is not empty to run snap sync.
<span class="term-fg31">-			log.Warn(&quot;Switch sync mode from snap sync to full sync&quot;, &quot;reason&quot;, &quot;snap sync complete&quot;)</span>
<span class="term-fg32">+			&#47;&#47; For OP chains, snap sync from bedrock block is allowed.</span>
<span class="term-fg32">+			log.Warn(&quot;Switch sync mode from snap sync to full sync&quot;)</span>
 		} else {
 			&#47;&#47; If snap sync was requested and our database is empty, grant it
 			h.snapSync.Store(true)
<span class="term-fg36">@@ -182,8 +187,14 @@</span> 	&#47;&#47; If snap sync is requested but snapshots are disabled, fail loudly
 	if h.snapSync.Load() &amp;&amp; config.Chain.Snapshots() == nil {
 		return nil, errors.New(&quot;snap sync not supported with snapshots disabled&quot;)
 	}
<span class="term-fg32">+	&#47;&#47; if the chainID is set, pass it to the downloader for use in sync</span>
<span class="term-fg32">+	&#47;&#47; this might not be set in tests</span>
<span class="term-fg32">+	var chainID uint64</span>
<span class="term-fg32">+	if cid := h.chain.Config().ChainID; cid != nil {</span>
<span class="term-fg32">+		chainID = cid.Uint64()</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Construct the downloader (long sync)
<span class="term-fg31">-	h.downloader = downloader.New(config.Database, h.eventMux, h.chain, nil, h.removePeer, h.enableSyncedFeatures)</span>
<span class="term-fg32">+	h.downloader = downloader.New(config.Database, h.eventMux, h.chain, nil, h.removePeer, h.enableSyncedFeatures, chainID)</span>
 	if ttd := h.chain.Config().TerminalTotalDifficulty; ttd != nil {
 		if h.chain.Config().TerminalTotalDifficultyPassed {
 			log.Info(&quot;Chain post-merge, sync via beacon client&quot;)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f4415a66aa6f7e6a1b579148" role="button"
                   aria-expanded="false" aria-controls="id-f4415a66aa6f7e6a1b579148">
                    <code>eth/handler_eth.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/handler_eth.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/handler_eth.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f4415a66aa6f7e6a1b579148"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler_eth.go op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">index 2a839f615f63be71674a4a55034c14c50b52ea6e..6dbe03e2140998359201a75f6b7a6a9ca2cb9c75 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg36">@@ -34,7 +34,20 @@</span> &#47;&#47; packets that are sent as replies or broadcasts.
 type ethHandler handler
&nbsp;
 func (h *ethHandler) Chain() *core.BlockChain { return h.chain }
<span class="term-fg31">-func (h *ethHandler) TxPool() eth.TxPool      { return h.txpool }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool satisfies the TxPool interface but does not return any tx in the</span>
<span class="term-fg32">+&#47;&#47; pool. It is used to disable transaction gossip.</span>
<span class="term-fg32">+type NilPool struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool Get always returns nil</span>
<span class="term-fg32">+func (n NilPool) Get(hash common.Hash) *types.Transaction { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (h *ethHandler) TxPool() eth.TxPool {</span>
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return &amp;NilPool{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return h.txpool</span>
<span class="term-fg32">+}</span>
&nbsp;
 &#47;&#47; RunPeer is invoked when a peer joins on the `eth` protocol.
 func (h *ethHandler) RunPeer(peer *eth.Peer, hand eth.Handler) error {
<span class="term-fg36">@@ -52,6 +65,9 @@</span>
 &#47;&#47; AcceptTxs retrieves whether transaction processing is enabled on the node
 &#47;&#47; or if inbound transactions should simply be dropped.
 func (h *ethHandler) AcceptTxs() bool {
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
 	return h.synced.Load()
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-0ac1198dec27a3bde7d03baa"role="button" aria-expanded="false" aria-controls="id-0ac1198dec27a3bde7d03baa">
        
            <div class="col-12 col-sm-9 text-start"><h3>Warn on missing hardfork data</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-0ac1198dec27a3bde7d03baa">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-50f21f98c18ebfadaf1f0566" role="button"
                   aria-expanded="false" aria-controls="id-50f21f98c18ebfadaf1f0566">
                    <code>core/blockchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/blockchain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/blockchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-50f21f98c18ebfadaf1f0566"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain.go op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg1">index 93c40591c6b60be4f890ec7735b5e4271a663e34..4a2f509a8a906b3c1fb0eb12ab0b61609ceea819 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg36">@@ -286,6 +286,10 @@</span> 	}
 	log.Info(strings.Repeat(&quot;-&quot;, 153))
 	log.Info(&quot;&quot;)
&nbsp;
<span class="term-fg32">+	if chainConfig.IsOptimism() &amp;&amp; chainConfig.RegolithTime == nil {</span>
<span class="term-fg32">+		log.Warn(&quot;Optimism RegolithTime has not been set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	bc := &amp;BlockChain{
 		chainConfig:   chainConfig,
 		cacheConfig:   cacheConfig,</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-25c56d66ae07804c4d991b5e"role="button" aria-expanded="false" aria-controls="id-25c56d66ae07804c4d991b5e">
        
            <div class="col-12 col-sm-9 text-start"><h3>Optional Engine API extensions</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+66</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-25c56d66ae07804c4d991b5e">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-306d5e699fa5de7c9565a68a" role="button"
                   aria-expanded="false" aria-controls="id-306d5e699fa5de7c9565a68a">
                    <code>eth/catalyst/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/catalyst/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+66</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-306d5e699fa5de7c9565a68a"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;superchain.go op-geth&#47;eth&#47;catalyst&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..503519889f4f050ad0aa739525022044fa842bc6</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,66 @@</span>
<span class="term-fg32">+package catalyst</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	requiredProtocolDeltaGauge    = metrics.NewRegisteredGauge(&quot;superchain&#47;required&#47;delta&quot;, nil)</span>
<span class="term-fg32">+	recommendedProtocolDeltaGauge = metrics.NewRegisteredGauge(&quot;superchain&#47;recommended&#47;delta&quot;, nil)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type SuperchainSignal struct {</span>
<span class="term-fg32">+	Recommended params.ProtocolVersion `json:&quot;recommended&quot;`</span>
<span class="term-fg32">+	Required    params.ProtocolVersion `json:&quot;required&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (api *ConsensusAPI) SignalSuperchainV1(signal *SuperchainSignal) (params.ProtocolVersion, error) {</span>
<span class="term-fg32">+	if signal == nil {</span>
<span class="term-fg32">+		log.Info(&quot;Received empty superchain version signal&quot;, &quot;local&quot;, params.OPStackSupport)</span>
<span class="term-fg32">+		return params.OPStackSupport, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; update metrics and log any warnings&#47;info</span>
<span class="term-fg32">+	requiredProtocolDeltaGauge.Update(int64(params.OPStackSupport.Compare(signal.Required)))</span>
<span class="term-fg32">+	recommendedProtocolDeltaGauge.Update(int64(params.OPStackSupport.Compare(signal.Recommended)))</span>
<span class="term-fg32">+	logger := log.New(&quot;local&quot;, params.OPStackSupport, &quot;required&quot;, signal.Required, &quot;recommended&quot;, signal.Recommended)</span>
<span class="term-fg32">+	LogProtocolVersionSupport(logger, params.OPStackSupport, signal.Recommended, &quot;recommended&quot;)</span>
<span class="term-fg32">+	LogProtocolVersionSupport(logger, params.OPStackSupport, signal.Required, &quot;required&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if err := api.eth.HandleRequiredProtocolVersion(signal.Required); err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;Failed to handle required protocol version&quot;, &quot;err&quot;, err, &quot;required&quot;, signal.Required)</span>
<span class="term-fg32">+		return params.OPStackSupport, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return params.OPStackSupport, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LogProtocolVersionSupport(logger log.Logger, local, other params.ProtocolVersion, name string) {</span>
<span class="term-fg32">+	switch local.Compare(other) {</span>
<span class="term-fg32">+	case params.AheadMajor:</span>
<span class="term-fg32">+		logger.Info(fmt.Sprintf(&quot;Ahead with major %s protocol version change&quot;, name))</span>
<span class="term-fg32">+	case params.AheadMinor, params.AheadPatch, params.AheadPrerelease:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Ahead with compatible %s protocol version change&quot;, name))</span>
<span class="term-fg32">+	case params.Matching:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Latest %s protocol version is supported&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedMajor:</span>
<span class="term-fg32">+		logger.Error(fmt.Sprintf(&quot;Outdated with major %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedMinor:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Outdated with minor backward-compatible %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedPatch:</span>
<span class="term-fg32">+		logger.Info(fmt.Sprintf(&quot;Outdated with support backward-compatible %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedPrerelease:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;New %s protocol pre-release is available&quot;, name))</span>
<span class="term-fg32">+	case params.DiffBuild:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Ignoring %s protocolversion signal, local build is different&quot;, name))</span>
<span class="term-fg32">+	case params.DiffVersionType:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Failed to recognize %s protocol version signal version-type&quot;, name))</span>
<span class="term-fg32">+	case params.EmptyVersion:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;No %s protocol version available to check&quot;, name))</span>
<span class="term-fg32">+	case params.InvalidVersion:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Invalid protocol version comparison with %s&quot;, name))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-c5f7b5a0deac02a38df5d968"role="button" aria-expanded="false" aria-controls="id-c5f7b5a0deac02a38df5d968">
        
            <div class="col-12 col-sm-9 text-start"><h3>Support legacy DBs when snap-syncing</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+9</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-c5f7b5a0deac02a38df5d968">
        <div><p>Snap-sync does not serve unprefixed code by default.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-050799ab1661df43f8434f54" role="button"
                   aria-expanded="false" aria-controls="id-050799ab1661df43f8434f54">
                    <code>core/blockchain_reader.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/blockchain_reader.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/blockchain_reader.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-050799ab1661df43f8434f54"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain_reader.go op-geth&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg1">index 6fb09abaccb583972306211af3af73297f1d1782..efeea67e0a8403266ccc6cfc36e998611ff242f6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg36">@@ -346,6 +346,14 @@</span> 	&#47;&#47; in Verkle scheme. Fix it once snap-sync is supported for Verkle.
 	return bc.stateCache.(codeReader).ContractCodeWithPrefix(common.Address{}, hash)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; ContractCode retrieves a blob of data associated with a contract hash</span>
<span class="term-fg32">+&#47;&#47; either from ephemeral in-memory cache, or from persistent storage.</span>
<span class="term-fg32">+&#47;&#47; This is a legacy-method, replaced by ContractCodeWithPrefix,</span>
<span class="term-fg32">+&#47;&#47; but required for old databases to serve snap-sync.</span>
<span class="term-fg32">+func (bc *BlockChain) ContractCode(hash common.Hash) ([]byte, error) {</span>
<span class="term-fg32">+	return bc.stateCache.ContractCode(common.Address{}, hash)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; State returns a new mutable state based on the current HEAD block.
 func (bc *BlockChain) State() (*state.StateDB, error) {
 	return bc.StateAt(bc.CurrentBlock().Root)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0b8bbab9d8f30ea3c9c48f71" role="button"
                   aria-expanded="false" aria-controls="id-0b8bbab9d8f30ea3c9c48f71">
                    <code>eth/protocols/snap/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/protocols/snap/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/protocols/snap/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0b8bbab9d8f30ea3c9c48f71"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;snap&#47;handler.go op-geth&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg1">index bd7ce9e71543c944c1a8e1ff2dd2dfcaa95d236f..0d1aac0cefb71a0894099fbdc40ad7cd4f0b204f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg36">@@ -469,7 +469,7 @@</span> 		if hash == types.EmptyCodeHash {
 			&#47;&#47; Peers should not request the empty code, but if they do, at
 			&#47;&#47; least sent them back a correct response without db lookups
 			codes = append(codes, []byte{})
<span class="term-fg31">-		} else if blob, err := chain.ContractCodeWithPrefix(hash); err == nil {</span>
<span class="term-fg32">+		} else if blob, err := chain.ContractCode(hash); err == nil {</span>
 			codes = append(codes, blob)
 			bytes += uint64(len(blob))
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e9c022f0d508445e3f36337d"role="button" aria-expanded="false" aria-controls="id-e9c022f0d508445e3f36337d">
        
            <div class="col-12 col-sm-9 text-start"><h3>Historical data for Snap-sync</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+150</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e9c022f0d508445e3f36337d">
        <div><p>Snap-sync has access to trusted Deposit Transaction Nonce Data.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-07441d426836939eb747cfeb" role="button"
                   aria-expanded="false" aria-controls="id-07441d426836939eb747cfeb">
                    <code>eth/downloader/downloader.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/downloader/downloader.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/downloader.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-07441d426836939eb747cfeb"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;downloader.go op-geth&#47;eth&#47;downloader&#47;downloader.go</span>
<span class="term-fg1">index f1cfa92d5d69092d9ca893b818e987526ad2f9f3..3f39b194856e95e0379a32308116f0eb87082fa0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;downloader.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;downloader.go</span>
<span class="term-fg36">@@ -156,6 +156,9 @@</span> 	&#47;&#47; Progress reporting metrics
 	syncStartBlock uint64    &#47;&#47; Head snap block when Geth was started
 	syncStartTime  time.Time &#47;&#47; Time instance when chain sync started
 	syncLogTime    time.Time &#47;&#47; Time instance when status was last reported
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Chain ID for downloaders to reference</span>
<span class="term-fg32">+	chainID uint64</span>
 }
&nbsp;
 &#47;&#47; LightChain encapsulates functions required to synchronise a light chain.
<span class="term-fg36">@@ -216,7 +219,7 @@</span> 	TrieDB() *trie.Database
 }
&nbsp;
 &#47;&#47; New creates a new downloader to fetch hashes and blocks from remote peers.
<span class="term-fg31">-func New(stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn, success func()) *Downloader {</span>
<span class="term-fg32">+func New(stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn, success func(), chainID uint64) *Downloader {</span>
 	if lightchain == nil {
 		lightchain = chain
 	}
<span class="term-fg36">@@ -233,6 +236,7 @@</span> 		quitCh:         make(chan struct{}),
 		SnapSyncer:     snap.NewSyncer(stateDb, chain.TrieDB().Scheme()),
 		stateSyncStart: make(chan *stateSync),
 		syncStartBlock: chain.CurrentSnapBlock().Number.Uint64(),
<span class="term-fg32">+		chainID:        chainID,</span>
 	}
 	&#47;&#47; Create the post-merge skeleton syncer and start the process
 	dl.skeleton = newSkeleton(stateDb, dl.peers, dropPeer, newBeaconBackfiller(dl, success))
<span class="term-fg36">@@ -1718,7 +1722,7 @@</span> 	blocks := make([]*types.Block, len(results))
 	receipts := make([]types.Receipts, len(results))
 	for i, result := range results {
 		blocks[i] = types.NewBlockWithHeader(result.Header).WithBody(result.Transactions, result.Uncles).WithWithdrawals(result.Withdrawals)
<span class="term-fg31">-		receipts[i] = result.Receipts</span>
<span class="term-fg32">+		receipts[i] = correctReceipts(result.Receipts, result.Transactions, blocks[i].NumberU64(), d.chainID)</span>
 	}
 	if index, err := d.blockchain.InsertReceiptChain(blocks, receipts, d.ancientLimit); err != nil {
 		log.Debug(&quot;Downloaded item processing failed&quot;, &quot;number&quot;, results[index].Header.Number, &quot;hash&quot;, results[index].Header.Hash(), &quot;err&quot;, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0ebe0bcbb6004bb5d22d97f0" role="button"
                   aria-expanded="false" aria-controls="id-0ebe0bcbb6004bb5d22d97f0">
                    <code>eth/downloader/receiptreference.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/receiptreference.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+144</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0ebe0bcbb6004bb5d22d97f0"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;receiptreference.go op-geth&#47;eth&#47;downloader&#47;receiptreference.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..b4c5623ddc9033ac6c03e48710f44e5c00cf1d94</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;receiptreference.go</span>
<span class="term-fg36">@@ -0,0 +1,144 @@</span>
<span class="term-fg32">+package downloader</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;bytes&quot;</span>
<span class="term-fg32">+	&quot;embed&quot;</span>
<span class="term-fg32">+	&quot;encoding&#47;gob&quot;</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;path&quot;</span>
<span class="term-fg32">+	&quot;strings&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; userDepositNonces is a struct to hold the reference data for user deposits</span>
<span class="term-fg32">+&#47;&#47; The reference data is used to correct the deposit nonce in the receipts</span>
<span class="term-fg32">+type userDepositNonces struct {</span>
<span class="term-fg32">+	ChainID uint64</span>
<span class="term-fg32">+	First   uint64</span>
<span class="term-fg32">+	Last    uint64 &#47;&#47; non inclusive</span>
<span class="term-fg32">+	Results map[uint64][]uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	systemAddress        = common.HexToAddress(&quot;0xDeaDDEaDDeAdDeAdDEAdDEaddeAddEAdDEAd0001&quot;)</span>
<span class="term-fg32">+	receiptReferencePath = &quot;userDepositData&quot;</span>
<span class="term-fg32">+	&#47;&#47;go:embed userDepositData&#47;*.gob</span>
<span class="term-fg32">+	receiptReference                 embed.FS</span>
<span class="term-fg32">+	userDepositNoncesAlreadySearched = map[uint64]bool{}</span>
<span class="term-fg32">+	userDepositNoncesReference       = map[uint64]userDepositNonces{}</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; lazy load the reference data for the requested chain</span>
<span class="term-fg32">+&#47;&#47; if this chain data was already requested, returns early</span>
<span class="term-fg32">+func initReceiptReferences(chainID uint64) {</span>
<span class="term-fg32">+	&#47;&#47; if already loaded, return</span>
<span class="term-fg32">+	if userDepositNoncesAlreadySearched[chainID] {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; look for a file prefixed by the chainID</span>
<span class="term-fg32">+	fPrefix := fmt.Sprintf(&quot;%d.&quot;, chainID)</span>
<span class="term-fg32">+	files, err := receiptReference.ReadDir(receiptReferencePath)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		log.Warn(&quot;Receipt Correction: Failed to read reference directory&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; mark as loaded so we don&#39;t try again, even if no files match</span>
<span class="term-fg32">+	userDepositNoncesAlreadySearched[chainID] = true</span>
<span class="term-fg32">+	for _, file := range files {</span>
<span class="term-fg32">+		&#47;&#47; skip files which don&#39;t match the prefix</span>
<span class="term-fg32">+		if !strings.HasPrefix(file.Name(), fPrefix) {</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		fpath := path.Join(receiptReferencePath, file.Name())</span>
<span class="term-fg32">+		bs, err := receiptReference.ReadFile(fpath)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			log.Warn(&quot;Receipt Correction: Failed to read reference data&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		udns := userDepositNonces{}</span>
<span class="term-fg32">+		err = gob.NewDecoder(bytes.NewReader(bs)).Decode(&amp;udns)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			log.Warn(&quot;Receipt Correction: Failed to decode reference data&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		userDepositNoncesReference[udns.ChainID] = udns</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; correctReceipts corrects the deposit nonce in the receipts using the reference data</span>
<span class="term-fg32">+&#47;&#47; prior to Canyon Hard Fork, DepositNonces were not cryptographically verifiable.</span>
<span class="term-fg32">+&#47;&#47; As a consequence, the deposit nonces found during Snap Sync may be incorrect.</span>
<span class="term-fg32">+&#47;&#47; This function inspects transaction data for user deposits, and if it is found to be incorrect, it is corrected.</span>
<span class="term-fg32">+&#47;&#47; The data used to correct the deposit nonce is stored in the userDepositData directory,</span>
<span class="term-fg32">+&#47;&#47; and was generated with the receipt reference tool in the optimism monorepo.</span>
<span class="term-fg32">+func correctReceipts(receipts types.Receipts, transactions types.Transactions, blockNumber uint64, chainID uint64) types.Receipts {</span>
<span class="term-fg32">+	initReceiptReferences(chainID)</span>
<span class="term-fg32">+	&#47;&#47; if there is no data even after initialization, return the receipts as is</span>
<span class="term-fg32">+	depositNoncesForChain, ok := userDepositNoncesReference[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		log.Trace(&quot;Receipt Correction: No data source for chain&quot;, &quot;chainID&quot;, chainID)</span>
<span class="term-fg32">+		return receipts</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; check that the block number being examined is within the range of the reference data</span>
<span class="term-fg32">+	if blockNumber &lt; depositNoncesForChain.First || blockNumber &gt; depositNoncesForChain.Last {</span>
<span class="term-fg32">+		log.Trace(&quot;Receipt Correction: Block is out of range for receipt reference&quot;,</span>
<span class="term-fg32">+			&quot;blockNumber&quot;, blockNumber,</span>
<span class="term-fg32">+			&quot;start&quot;, depositNoncesForChain.First,</span>
<span class="term-fg32">+			&quot;end&quot;, depositNoncesForChain.Last)</span>
<span class="term-fg32">+		return receipts</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; get the block nonces</span>
<span class="term-fg32">+	blockNonces, ok := depositNoncesForChain.Results[blockNumber]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		log.Trace(&quot;Receipt Correction: Block does not contain user deposits&quot;, &quot;blockNumber&quot;, blockNumber)</span>
<span class="term-fg32">+		return receipts</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; iterate through the receipts and transactions to correct the deposit nonce</span>
<span class="term-fg32">+	&#47;&#47; user deposits should always be at the front of the block, but we will check all transactions to be sure</span>
<span class="term-fg32">+	udCount := 0</span>
<span class="term-fg32">+	for i := 0; i &lt; len(receipts); i++ {</span>
<span class="term-fg32">+		r := receipts[i]</span>
<span class="term-fg32">+		tx := transactions[i]</span>
<span class="term-fg32">+		from, err := types.Sender(types.LatestSignerForChainID(tx.ChainId()), tx)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			log.Warn(&quot;Receipt Correction: Failed to determine sender&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; break as soon as a non deposit is found</span>
<span class="term-fg32">+		if r.Type != types.DepositTxType {</span>
<span class="term-fg32">+			break</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; ignore any transactions from the system address</span>
<span class="term-fg32">+		if from != systemAddress {</span>
<span class="term-fg32">+			&#47;&#47; prevent index out of range (indicates a problem with the reference data or the block data)</span>
<span class="term-fg32">+			if udCount &gt;= len(blockNonces) {</span>
<span class="term-fg32">+				log.Warn(&quot;Receipt Correction: More user deposits in block than included in reference data&quot;, &quot;in_reference&quot;, len(blockNonces))</span>
<span class="term-fg32">+				break</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			nonce := blockNonces[udCount]</span>
<span class="term-fg32">+			udCount++</span>
<span class="term-fg32">+			log.Trace(&quot;Receipt Correction: User Deposit detected&quot;, &quot;address&quot;, from, &quot;nonce&quot;, nonce)</span>
<span class="term-fg32">+			if nonce != *r.DepositNonce {</span>
<span class="term-fg32">+				&#47;&#47; correct the deposit nonce</span>
<span class="term-fg32">+				&#47;&#47; warn because this should not happen unless the data was modified by corruption or a malicious peer</span>
<span class="term-fg32">+				&#47;&#47; by correcting the nonce, the entire block is still valid for use</span>
<span class="term-fg32">+				log.Warn(&quot;Receipt Correction: Corrected deposit nonce&quot;, &quot;nonce&quot;, *r.DepositNonce, &quot;corrected&quot;, nonce)</span>
<span class="term-fg32">+				r.DepositNonce = &amp;nonce</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; check for unused reference data (indicates a problem with the reference data or the block data)</span>
<span class="term-fg32">+	if udCount &lt; len(blockNonces) {</span>
<span class="term-fg32">+		log.Warn(&quot;Receipt Correction: More user deposits in reference data than found in block&quot;, &quot;in_reference&quot;, len(blockNonces), &quot;in_block&quot;, udCount)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	log.Trace(&quot;Receipt Correction: Completed&quot;, &quot;blockNumber&quot;, blockNumber, &quot;userDeposits&quot;, udCount, &quot;receipts&quot;, len(receipts), &quot;transactions&quot;, len(transactions))</span>
<span class="term-fg32">+	return receipts</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-b588fb0e32ae744514fc4c9c"role="button" aria-expanded="false" aria-controls="id-b588fb0e32ae744514fc4c9c">
        
            <div class="col-12 col-sm-9 text-start"><h3>Discv5 node discovery</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-b588fb0e32ae744514fc4c9c">
        <div><p>Fix discv5 option to allow discv5 to be an active source for node-discovery.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6ea7e641951f44be5e0c1b4c" role="button"
                   aria-expanded="false" aria-controls="id-6ea7e641951f44be5e0c1b4c">
                    <code>p2p/server.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/p2p/server.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/p2p/server.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6ea7e641951f44be5e0c1b4c"><span class="term-fg1">diff --git go-ethereum&#47;p2p&#47;server.go op-geth&#47;p2p&#47;server.go</span>
<span class="term-fg1">index 8f42765a8c263fbfacacddd1bac8f331db67ad11..7975b787bd7dad63981ec1022b7d32477ace2e7c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;p2p&#47;server.go</span>
<span class="term-fg1">+++ op-geth&#47;p2p&#47;server.go</span>
<span class="term-fg36">@@ -579,6 +579,7 @@</span> 		srv.DiscV5, err = discover.ListenV5(sconn, srv.localnode, cfg)
 		if err != nil {
 			return err
 		}
<span class="term-fg32">+		srv.discmix.AddSource(srv.DiscV5.RandomNodes())</span>
 	}
&nbsp;
 	&#47;&#47; Add protocol-specific discovery sources.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-7e6b9bdb18ad426a5e72b53c"role="button" aria-expanded="false" aria-controls="id-7e6b9bdb18ad426a5e72b53c">
        
            <div class="col-12 col-sm-9 text-start"><h3>Generated TOML config update</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+138</span></div>
                <div class="text-start"><span class="text-danger">-78</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-7e6b9bdb18ad426a5e72b53c">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a02fb428ecebb50555bc6ce0" role="button"
                   aria-expanded="false" aria-controls="id-a02fb428ecebb50555bc6ce0">
                    <code>eth/ethconfig/gen_config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/ethconfig/gen_config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/ethconfig/gen_config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+138</span></div>
                        <div class="text-start"><span class="text-danger">-78</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a02fb428ecebb50555bc6ce0"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;ethconfig&#47;gen_config.go op-geth&#47;eth&#47;ethconfig&#47;gen_config.go</span>
<span class="term-fg1">index 2abddc9e0d3878344f5ac547a0ac369db0d4a985..92a714739604536e46d3a421731e809b9ded68cd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;ethconfig&#47;gen_config.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;ethconfig&#47;gen_config.go</span>
<span class="term-fg36">@@ -17,45 +17,55 @@</span>
 &#47;&#47; MarshalTOML marshals as TOML.
 func (c Config) MarshalTOML() (interface{}, error) {
 	type Config struct {
<span class="term-fg31">-		Genesis                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		NetworkId               uint64</span>
<span class="term-fg31">-		SyncMode                downloader.SyncMode</span>
<span class="term-fg31">-		EthDiscoveryURLs        []string</span>
<span class="term-fg31">-		SnapDiscoveryURLs       []string</span>
<span class="term-fg31">-		NoPruning               bool</span>
<span class="term-fg31">-		NoPrefetch              bool</span>
<span class="term-fg31">-		TxLookupLimit           uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		TransactionHistory      uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateHistory            uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateScheme             string                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		RequiredBlocks          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		LightServ               int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightIngress            int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightEgress             int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightPeers              int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoPrune            bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoSyncServe        bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		SkipBcVersionCheck      bool                   `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseHandles         int                    `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseCache           int</span>
<span class="term-fg31">-		DatabaseFreezer         string</span>
<span class="term-fg31">-		TrieCleanCache          int</span>
<span class="term-fg31">-		TrieDirtyCache          int</span>
<span class="term-fg31">-		TrieTimeout             time.Duration</span>
<span class="term-fg31">-		SnapshotCache           int</span>
<span class="term-fg31">-		Preimages               bool</span>
<span class="term-fg31">-		FilterLogCacheSize      int</span>
<span class="term-fg31">-		Miner                   miner.Config</span>
<span class="term-fg31">-		TxPool                  legacypool.Config</span>
<span class="term-fg31">-		BlobPool                blobpool.Config</span>
<span class="term-fg31">-		GPO                     gasprice.Config</span>
<span class="term-fg31">-		EnablePreimageRecording bool</span>
<span class="term-fg31">-		DocRoot                 string `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		RPCGasCap               uint64</span>
<span class="term-fg31">-		RPCEVMTimeout           time.Duration</span>
<span class="term-fg31">-		RPCTxFeeCap             float64</span>
<span class="term-fg31">-		OverrideCancun          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		OverrideVerkle          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		Genesis                                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		NetworkId                               uint64</span>
<span class="term-fg32">+		SyncMode                                downloader.SyncMode</span>
<span class="term-fg32">+		EthDiscoveryURLs                        []string</span>
<span class="term-fg32">+		SnapDiscoveryURLs                       []string</span>
<span class="term-fg32">+		NoPruning                               bool</span>
<span class="term-fg32">+		NoPrefetch                              bool</span>
<span class="term-fg32">+		TxLookupLimit                           uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		TransactionHistory                      uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateHistory                            uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateScheme                             string                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RequiredBlocks                          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		LightServ                               int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightIngress                            int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightEgress                             int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightPeers                              int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoPrune                            bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoSyncServe                        bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		SkipBcVersionCheck                      bool                   `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseHandles                         int                    `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseCache                           int</span>
<span class="term-fg32">+		DatabaseFreezer                         string</span>
<span class="term-fg32">+		TrieCleanCache                          int</span>
<span class="term-fg32">+		TrieDirtyCache                          int</span>
<span class="term-fg32">+		TrieTimeout                             time.Duration</span>
<span class="term-fg32">+		SnapshotCache                           int</span>
<span class="term-fg32">+		Preimages                               bool</span>
<span class="term-fg32">+		FilterLogCacheSize                      int</span>
<span class="term-fg32">+		Miner                                   miner.Config</span>
<span class="term-fg32">+		TxPool                                  legacypool.Config</span>
<span class="term-fg32">+		BlobPool                                blobpool.Config</span>
<span class="term-fg32">+		GPO                                     gasprice.Config</span>
<span class="term-fg32">+		EnablePreimageRecording                 bool</span>
<span class="term-fg32">+		DocRoot                                 string `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		RPCGasCap                               uint64</span>
<span class="term-fg32">+		RPCEVMTimeout                           time.Duration</span>
<span class="term-fg32">+		RPCTxFeeCap                             float64</span>
<span class="term-fg32">+		OverrideCancun                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideVerkle                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismCanyon                  *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismEcotone                 *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismInterop                 *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		ApplySuperchainUpgrades                 bool    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RollupSequencerHTTP                     string</span>
<span class="term-fg32">+		RollupHistoricalRPC                     string</span>
<span class="term-fg32">+		RollupHistoricalRPCTimeout              time.Duration</span>
<span class="term-fg32">+		RollupDisableTxPoolGossip               bool</span>
<span class="term-fg32">+		RollupDisableTxPoolAdmission            bool</span>
<span class="term-fg32">+		RollupHaltOnIncompatibleProtocolVersion string</span>
 	}
 	var enc Config
 	enc.Genesis = c.Genesis
<span class="term-fg36">@@ -97,51 +107,71 @@</span> 	enc.RPCEVMTimeout = c.RPCEVMTimeout
 	enc.RPCTxFeeCap = c.RPCTxFeeCap
 	enc.OverrideCancun = c.OverrideCancun
 	enc.OverrideVerkle = c.OverrideVerkle
<span class="term-fg32">+	enc.OverrideOptimismCanyon = c.OverrideOptimismCanyon</span>
<span class="term-fg32">+	enc.OverrideOptimismEcotone = c.OverrideOptimismEcotone</span>
<span class="term-fg32">+	enc.OverrideOptimismInterop = c.OverrideOptimismInterop</span>
<span class="term-fg32">+	enc.ApplySuperchainUpgrades = c.ApplySuperchainUpgrades</span>
<span class="term-fg32">+	enc.RollupSequencerHTTP = c.RollupSequencerHTTP</span>
<span class="term-fg32">+	enc.RollupHistoricalRPC = c.RollupHistoricalRPC</span>
<span class="term-fg32">+	enc.RollupHistoricalRPCTimeout = c.RollupHistoricalRPCTimeout</span>
<span class="term-fg32">+	enc.RollupDisableTxPoolGossip = c.RollupDisableTxPoolGossip</span>
<span class="term-fg32">+	enc.RollupDisableTxPoolAdmission = c.RollupDisableTxPoolAdmission</span>
<span class="term-fg32">+	enc.RollupHaltOnIncompatibleProtocolVersion = c.RollupHaltOnIncompatibleProtocolVersion</span>
 	return &amp;enc, nil
 }
&nbsp;
 &#47;&#47; UnmarshalTOML unmarshals from TOML.
 func (c *Config) UnmarshalTOML(unmarshal func(interface{}) error) error {
 	type Config struct {
<span class="term-fg31">-		Genesis                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		NetworkId               *uint64</span>
<span class="term-fg31">-		SyncMode                *downloader.SyncMode</span>
<span class="term-fg31">-		EthDiscoveryURLs        []string</span>
<span class="term-fg31">-		SnapDiscoveryURLs       []string</span>
<span class="term-fg31">-		NoPruning               *bool</span>
<span class="term-fg31">-		NoPrefetch              *bool</span>
<span class="term-fg31">-		TxLookupLimit           *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		TransactionHistory      *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateHistory            *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateScheme             *string                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		RequiredBlocks          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		LightServ               *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightIngress            *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightEgress             *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightPeers              *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoPrune            *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoSyncServe        *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		SkipBcVersionCheck      *bool                  `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseHandles         *int                   `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseCache           *int</span>
<span class="term-fg31">-		DatabaseFreezer         *string</span>
<span class="term-fg31">-		TrieCleanCache          *int</span>
<span class="term-fg31">-		TrieDirtyCache          *int</span>
<span class="term-fg31">-		TrieTimeout             *time.Duration</span>
<span class="term-fg31">-		SnapshotCache           *int</span>
<span class="term-fg31">-		Preimages               *bool</span>
<span class="term-fg31">-		FilterLogCacheSize      *int</span>
<span class="term-fg31">-		Miner                   *miner.Config</span>
<span class="term-fg31">-		TxPool                  *legacypool.Config</span>
<span class="term-fg31">-		BlobPool                *blobpool.Config</span>
<span class="term-fg31">-		GPO                     *gasprice.Config</span>
<span class="term-fg31">-		EnablePreimageRecording *bool</span>
<span class="term-fg31">-		DocRoot                 *string `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		RPCGasCap               *uint64</span>
<span class="term-fg31">-		RPCEVMTimeout           *time.Duration</span>
<span class="term-fg31">-		RPCTxFeeCap             *float64</span>
<span class="term-fg31">-		OverrideCancun          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		OverrideVerkle          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		Genesis                                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		NetworkId                               *uint64</span>
<span class="term-fg32">+		SyncMode                                *downloader.SyncMode</span>
<span class="term-fg32">+		EthDiscoveryURLs                        []string</span>
<span class="term-fg32">+		SnapDiscoveryURLs                       []string</span>
<span class="term-fg32">+		NoPruning                               *bool</span>
<span class="term-fg32">+		NoPrefetch                              *bool</span>
<span class="term-fg32">+		TxLookupLimit                           *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		TransactionHistory                      *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateHistory                            *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateScheme                             *string                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RequiredBlocks                          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		LightServ                               *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightIngress                            *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightEgress                             *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightPeers                              *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoPrune                            *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoSyncServe                        *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		SkipBcVersionCheck                      *bool                  `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseHandles                         *int                   `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseCache                           *int</span>
<span class="term-fg32">+		DatabaseFreezer                         *string</span>
<span class="term-fg32">+		TrieCleanCache                          *int</span>
<span class="term-fg32">+		TrieDirtyCache                          *int</span>
<span class="term-fg32">+		TrieTimeout                             *time.Duration</span>
<span class="term-fg32">+		SnapshotCache                           *int</span>
<span class="term-fg32">+		Preimages                               *bool</span>
<span class="term-fg32">+		FilterLogCacheSize                      *int</span>
<span class="term-fg32">+		Miner                                   *miner.Config</span>
<span class="term-fg32">+		TxPool                                  *legacypool.Config</span>
<span class="term-fg32">+		BlobPool                                *blobpool.Config</span>
<span class="term-fg32">+		GPO                                     *gasprice.Config</span>
<span class="term-fg32">+		EnablePreimageRecording                 *bool</span>
<span class="term-fg32">+		DocRoot                                 *string `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		RPCGasCap                               *uint64</span>
<span class="term-fg32">+		RPCEVMTimeout                           *time.Duration</span>
<span class="term-fg32">+		RPCTxFeeCap                             *float64</span>
<span class="term-fg32">+		OverrideCancun                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideVerkle                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismCanyon                  *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismEcotone                 *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismInterop                 *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		ApplySuperchainUpgrades                 *bool   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RollupSequencerHTTP                     *string</span>
<span class="term-fg32">+		RollupHistoricalRPC                     *string</span>
<span class="term-fg32">+		RollupHistoricalRPCTimeout              *time.Duration</span>
<span class="term-fg32">+		RollupDisableTxPoolGossip               *bool</span>
<span class="term-fg32">+		RollupDisableTxPoolAdmission            *bool</span>
<span class="term-fg32">+		RollupHaltOnIncompatibleProtocolVersion *string</span>
 	}
 	var dec Config
 	if err := unmarshal(&amp;dec); err != nil {
<span class="term-fg36">@@ -263,6 +293,36 @@</span> 		c.OverrideCancun = dec.OverrideCancun
 	}
 	if dec.OverrideVerkle != nil {
 		c.OverrideVerkle = dec.OverrideVerkle
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.OverrideOptimismCanyon != nil {</span>
<span class="term-fg32">+		c.OverrideOptimismCanyon = dec.OverrideOptimismCanyon</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.OverrideOptimismEcotone != nil {</span>
<span class="term-fg32">+		c.OverrideOptimismEcotone = dec.OverrideOptimismEcotone</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.OverrideOptimismInterop != nil {</span>
<span class="term-fg32">+		c.OverrideOptimismInterop = dec.OverrideOptimismInterop</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.ApplySuperchainUpgrades != nil {</span>
<span class="term-fg32">+		c.ApplySuperchainUpgrades = *dec.ApplySuperchainUpgrades</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupSequencerHTTP != nil {</span>
<span class="term-fg32">+		c.RollupSequencerHTTP = *dec.RollupSequencerHTTP</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupHistoricalRPC != nil {</span>
<span class="term-fg32">+		c.RollupHistoricalRPC = *dec.RollupHistoricalRPC</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupHistoricalRPCTimeout != nil {</span>
<span class="term-fg32">+		c.RollupHistoricalRPCTimeout = *dec.RollupHistoricalRPCTimeout</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupDisableTxPoolGossip != nil {</span>
<span class="term-fg32">+		c.RollupDisableTxPoolGossip = *dec.RollupDisableTxPoolGossip</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupDisableTxPoolAdmission != nil {</span>
<span class="term-fg32">+		c.RollupDisableTxPoolAdmission = *dec.RollupDisableTxPoolAdmission</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupHaltOnIncompatibleProtocolVersion != nil {</span>
<span class="term-fg32">+		c.RollupHaltOnIncompatibleProtocolVersion = *dec.RollupHaltOnIncompatibleProtocolVersion</span>
 	}
 	return nil
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-8a7d83da4a380758ceab15b8"role="button" aria-expanded="false" aria-controls="id-8a7d83da4a380758ceab15b8">
        
            <div class="col-12 col-sm-9 text-start"><h2>User API enhancements</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1253</span></div>
                <div class="text-start"><span class="text-danger">-99</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-8a7d83da4a380758ceab15b8">
        <div><p>Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-cc85af246fdb49169909e7d1"role="button" aria-expanded="false" aria-controls="id-cc85af246fdb49169909e7d1">
        
            <div class="col-12 col-sm-9 text-start"><h3>Receipts metadata</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+291</span></div>
                <div class="text-start"><span class="text-danger">-37</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-cc85af246fdb49169909e7d1">
        <div><p>Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost
metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7874325320323fcd4272bba7" role="button"
                   aria-expanded="false" aria-controls="id-7874325320323fcd4272bba7">
                    <code>core/types/receipt.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/receipt.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/receipt.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+216</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7874325320323fcd4272bba7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt.go op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">index 4f96fde59c44278beee06e9846e158c2501644e6..1b7d03459a32ff01a6ff6d27d32a02b6b49fb5c2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg36">@@ -46,6 +46,9 @@</span> 	ReceiptStatusFailed = uint64(0)
&nbsp;
 	&#47;&#47; ReceiptStatusSuccessful is the status code of a transaction if execution succeeded.
 	ReceiptStatusSuccessful = uint64(1)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; The version number for post-canyon deposit receipts.</span>
<span class="term-fg32">+	CanyonDepositReceiptVersion = uint64(1)</span>
 )
&nbsp;
 &#47;&#47; Receipt represents the results of a transaction.
<span class="term-fg36">@@ -58,19 +61,34 @@</span> 	CumulativeGasUsed uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`
 	Bloom             Bloom  `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`
 	Logs              []*Log `json:&quot;logs&quot;              gencodec:&quot;required&quot;`
&nbsp;
<span class="term-fg31">-	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction.</span>
<span class="term-fg32">+	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction or retrieving a receipt.</span>
<span class="term-fg32">+	&#47;&#47; gencodec annotated fields: these are stored in the chain database.</span>
 	TxHash            common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`
 	ContractAddress   common.Address `json:&quot;contractAddress&quot;`
 	GasUsed           uint64         `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`
 	EffectiveGasPrice *big.Int       `json:&quot;effectiveGasPrice&quot;` &#47;&#47; required, but tag omitted for backwards compatibility
 	BlobGasUsed       uint64         `json:&quot;blobGasUsed,omitempty&quot;`
 	BlobGasPrice      *big.Int       `json:&quot;blobGasPrice,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions</span>
<span class="term-fg32">+	&#47;&#47; The state transition process ensures this is only set for Regolith deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
<span class="term-fg32">+	&#47;&#47; DepositReceiptVersion was introduced in Canyon to indicate an update to how receipt hashes</span>
<span class="term-fg32">+	&#47;&#47; should be computed when set. The state transition process ensures this is only set for</span>
<span class="term-fg32">+	&#47;&#47; post-Canyon deposit transactions.</span>
<span class="term-fg32">+	DepositReceiptVersion *uint64 `json:&quot;depositReceiptVersion,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Inclusion information: These fields provide information about the inclusion of the
 	&#47;&#47; transaction corresponding to this receipt.
 	BlockHash        common.Hash `json:&quot;blockHash,omitempty&quot;`
 	BlockNumber      *big.Int    `json:&quot;blockNumber,omitempty&quot;`
 	TransactionIndex uint        `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; OVM legacy: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *big.Int   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+	L1GasUsed  *big.Int   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+	L1Fee      *big.Int   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+	FeeScalar  *big.Float `json:&quot;l1FeeScalar,omitempty&quot;` &#47;&#47; always nil after Ecotone hardfork</span>
 }
&nbsp;
 type receiptMarshaling struct {
<span class="term-fg36">@@ -84,6 +102,14 @@</span> 	BlobGasUsed       hexutil.Uint64
 	BlobGasPrice      *hexutil.Big
 	BlockNumber       *hexutil.Big
 	TransactionIndex  hexutil.Uint
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism</span>
<span class="term-fg32">+	L1GasPrice            *hexutil.Big</span>
<span class="term-fg32">+	L1GasUsed             *hexutil.Big</span>
<span class="term-fg32">+	L1Fee                 *hexutil.Big</span>
<span class="term-fg32">+	FeeScalar             *big.Float</span>
<span class="term-fg32">+	DepositNonce          *hexutil.Uint64</span>
<span class="term-fg32">+	DepositReceiptVersion *hexutil.Uint64</span>
 }
&nbsp;
 &#47;&#47; receiptRLP is the consensus encoding of a receipt.
<span class="term-fg36">@@ -94,11 +120,98 @@</span> 	Bloom             Bloom
 	Logs              []*Log
 }
&nbsp;
<span class="term-fg32">+type depositReceiptRLP struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Bloom             Bloom</span>
<span class="term-fg32">+	Logs              []*Log</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Receipt hash post-Regolith but pre-Canyon inadvertently did not include the above</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce. Post Canyon, receipts will have a non-empty DepositReceiptVersion indicating</span>
<span class="term-fg32">+	&#47;&#47; which post-Canyon receipt hash function to invoke.</span>
<span class="term-fg32">+	DepositReceiptVersion *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; storedReceiptRLP is the storage encoding of a receipt.
 type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*Log
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Receipt hash post-Regolith but pre-Canyon inadvertently did not include the above</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce. Post Canyon, receipts will have a non-empty DepositReceiptVersion indicating</span>
<span class="term-fg32">+	&#47;&#47; which post-Canyon receipt hash function to invoke.</span>
<span class="term-fg32">+	DepositReceiptVersion *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LegacyOptimismStoredReceiptRLP is the pre bedrock storage encoding of a</span>
<span class="term-fg32">+&#47;&#47; receipt. It will only exist in the database if it was migrated using the</span>
<span class="term-fg32">+&#47;&#47; migration tool. Nodes that sync using snap-sync will not have any of these</span>
<span class="term-fg32">+&#47;&#47; entries.</span>
<span class="term-fg32">+type LegacyOptimismStoredReceiptRLP struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Logs              []*LogForStorage</span>
<span class="term-fg32">+	L1GasUsed         *big.Int</span>
<span class="term-fg32">+	L1GasPrice        *big.Int</span>
<span class="term-fg32">+	L1Fee             *big.Int</span>
<span class="term-fg32">+	FeeScalar         string</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LogForStorage is a wrapper around a Log that handles</span>
<span class="term-fg32">+&#47;&#47; backward compatibility with prior storage formats.</span>
<span class="term-fg32">+type LogForStorage Log</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP implements rlp.Encoder.</span>
<span class="term-fg32">+func (l *LogForStorage) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	rl := Log{Address: l.Address, Topics: l.Topics, Data: l.Data}</span>
<span class="term-fg32">+	return rlp.Encode(w, &amp;rl)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type legacyRlpStorageLog struct {</span>
<span class="term-fg32">+	Address     common.Address</span>
<span class="term-fg32">+	Topics      []common.Hash</span>
<span class="term-fg32">+	Data        []byte</span>
<span class="term-fg32">+	BlockNumber uint64</span>
<span class="term-fg32">+	TxHash      common.Hash</span>
<span class="term-fg32">+	TxIndex     uint</span>
<span class="term-fg32">+	BlockHash   common.Hash</span>
<span class="term-fg32">+	Index       uint</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; DecodeRLP implements rlp.Decoder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Note some redundant fields(e.g. block number, tx hash etc) will be assembled later.</span>
<span class="term-fg32">+func (l *LogForStorage) DecodeRLP(s *rlp.Stream) error {</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var dec Log</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+	if err == nil {</span>
<span class="term-fg32">+		*l = LogForStorage{</span>
<span class="term-fg32">+			Address: dec.Address,</span>
<span class="term-fg32">+			Topics:  dec.Topics,</span>
<span class="term-fg32">+			Data:    dec.Data,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		&#47;&#47; Try to decode log with previous definition.</span>
<span class="term-fg32">+		var dec legacyRlpStorageLog</span>
<span class="term-fg32">+		err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			*l = LogForStorage{</span>
<span class="term-fg32">+				Address: dec.Address,</span>
<span class="term-fg32">+				Topics:  dec.Topics,</span>
<span class="term-fg32">+				Data:    dec.Data,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return err</span>
 }
&nbsp;
 &#47;&#47; NewReceipt creates a barebone transaction receipt, copying the init fields.
<span class="term-fg36">@@ -136,7 +249,13 @@</span>
 &#47;&#47; encodeTyped writes the canonical encoding of a typed receipt to w.
 func (r *Receipt) encodeTyped(data *receiptRLP, w *bytes.Buffer) error {
 	w.WriteByte(r.Type)
<span class="term-fg31">-	return rlp.Encode(w, data)</span>
<span class="term-fg32">+	switch r.Type {</span>
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		withNonce := &amp;depositReceiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs, r.DepositNonce, r.DepositReceiptVersion}</span>
<span class="term-fg32">+		return rlp.Encode(w, withNonce)</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return rlp.Encode(w, data)</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; MarshalBinary returns the consensus encoding of the receipt.
<span class="term-fg36">@@ -212,6 +331,16 @@</span> 			return err
 		}
 		r.Type = b[0]
 		return r.setFromRLP(data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		var data depositReceiptRLP</span>
<span class="term-fg32">+		err := rlp.DecodeBytes(b[1:], &amp;data)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		r.Type = b[0]</span>
<span class="term-fg32">+		r.DepositNonce = data.DepositNonce</span>
<span class="term-fg32">+		r.DepositReceiptVersion = data.DepositReceiptVersion</span>
<span class="term-fg32">+		return r.setFromRLP(receiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs})</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -275,6 +404,12 @@</span> 			return err
 		}
 	}
 	w.ListEnd(logList)
<span class="term-fg32">+	if r.DepositNonce != nil {</span>
<span class="term-fg32">+		w.WriteUint64(*r.DepositNonce)</span>
<span class="term-fg32">+		if r.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+			w.WriteUint64(*r.DepositReceiptVersion)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	w.ListEnd(outerList)
 	return w.Flush()
 }
<span class="term-fg36">@@ -282,8 +417,51 @@</span>
 &#47;&#47; DecodeRLP implements rlp.Decoder, and loads both consensus and implementation
 &#47;&#47; fields of a receipt from an RLP stream.
 func (r *ReceiptForStorage) DecodeRLP(s *rlp.Stream) error {
<span class="term-fg32">+	&#47;&#47; Retrieve the entire receipt blob as we need to try multiple decoders</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; First try to decode the latest receipt database format, try the pre-bedrock Optimism legacy format otherwise.</span>
<span class="term-fg32">+	if err := decodeStoredReceiptRLP(r, blob); err == nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return decodeLegacyOptimismReceiptRLP(r, blob)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeLegacyOptimismReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
<span class="term-fg32">+	var stored LegacyOptimismStoredReceiptRLP</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.CumulativeGasUsed = stored.CumulativeGasUsed</span>
<span class="term-fg32">+	r.Logs = make([]*Log, len(stored.Logs))</span>
<span class="term-fg32">+	for i, log := range stored.Logs {</span>
<span class="term-fg32">+		r.Logs[i] = (*Log)(log)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})</span>
<span class="term-fg32">+	&#47;&#47; UsingOVM</span>
<span class="term-fg32">+	scalar := new(big.Float)</span>
<span class="term-fg32">+	if stored.FeeScalar != &quot;&quot; {</span>
<span class="term-fg32">+		var ok bool</span>
<span class="term-fg32">+		scalar, ok = scalar.SetString(stored.FeeScalar)</span>
<span class="term-fg32">+		if !ok {</span>
<span class="term-fg32">+			return errors.New(&quot;cannot parse fee scalar&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.L1GasUsed = stored.L1GasUsed</span>
<span class="term-fg32">+	r.L1GasPrice = stored.L1GasPrice</span>
<span class="term-fg32">+	r.L1Fee = stored.L1Fee</span>
<span class="term-fg32">+	r.FeeScalar = scalar</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeStoredReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
 	var stored storedReceiptRLP
<span class="term-fg31">-	if err := s.Decode(&amp;stored); err != nil {</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
 		return err
 	}
 	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {
<span class="term-fg36">@@ -292,7 +470,10 @@</span> 	}
 	r.CumulativeGasUsed = stored.CumulativeGasUsed
 	r.Logs = stored.Logs
 	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})
<span class="term-fg31">-</span>
<span class="term-fg32">+	if stored.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = stored.DepositNonce</span>
<span class="term-fg32">+		r.DepositReceiptVersion = stored.DepositReceiptVersion</span>
<span class="term-fg32">+	}</span>
 	return nil
 }
&nbsp;
<span class="term-fg36">@@ -302,7 +483,10 @@</span>
 &#47;&#47; Len returns the number of receipts in this list.
 func (rs Receipts) Len() int { return len(rs) }
&nbsp;
<span class="term-fg31">-&#47;&#47; EncodeIndex encodes the i&#39;th receipt to w.</span>
<span class="term-fg32">+&#47;&#47; EncodeIndex encodes the i&#39;th receipt to w. For DepositTxType receipts with non-nil DepositNonce</span>
<span class="term-fg32">+&#47;&#47; but nil DepositReceiptVersion, the output will differ than calling r.MarshalBinary(); this</span>
<span class="term-fg32">+&#47;&#47; behavior difference should not be changed to preserve backwards compatibility of receipt-root</span>
<span class="term-fg32">+&#47;&#47; hash computation.</span>
 func (rs Receipts) EncodeIndex(i int, w *bytes.Buffer) {
 	r := rs[i]
 	data := &amp;receiptRLP{r.statusEncoding(), r.CumulativeGasUsed, r.Bloom, r.Logs}
<span class="term-fg36">@@ -314,6 +498,14 @@</span> 	w.WriteByte(r.Type)
 	switch r.Type {
 	case AccessListTxType, DynamicFeeTxType, BlobTxType:
 		rlp.Encode(w, data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		if r.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+			&#47;&#47; post-canyon receipt hash computation update</span>
<span class="term-fg32">+			depositData := &amp;depositReceiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, r.Bloom, r.Logs, r.DepositNonce, r.DepositReceiptVersion}</span>
<span class="term-fg32">+			rlp.Encode(w, depositData)</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			rlp.Encode(w, data)</span>
<span class="term-fg32">+		}</span>
 	default:
 		&#47;&#47; For unsupported types, write nothing. Since this is for
 		&#47;&#47; DeriveSha, the error will be caught matching the derived hash
<span class="term-fg36">@@ -351,7 +543,11 @@</span> 		&#47;&#47; The contract address can be derived from the transaction itself
 		if txs[i].To() == nil {
 			&#47;&#47; Deriving the signer is expensive, only do if it&#39;s actually needed
 			from, _ := Sender(signer, txs[i])
<span class="term-fg31">-			rs[i].ContractAddress = crypto.CreateAddress(from, txs[i].Nonce())</span>
<span class="term-fg32">+			nonce := txs[i].Nonce()</span>
<span class="term-fg32">+			if rs[i].DepositNonce != nil {</span>
<span class="term-fg32">+				nonce = *rs[i].DepositNonce</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			rs[i].ContractAddress = crypto.CreateAddress(from, nonce)</span>
 		} else {
 			rs[i].ContractAddress = common.Address{}
 		}
<span class="term-fg36">@@ -371,6 +567,20 @@</span> 			rs[i].Logs[j].TxHash = rs[i].TxHash
 			rs[i].Logs[j].TxIndex = uint(i)
 			rs[i].Logs[j].Index = logIndex
 			logIndex++
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.Optimism != nil &amp;&amp; len(txs) &gt;= 2 &amp;&amp; config.IsBedrock(new(big.Int).SetUint64(number)) { &#47;&#47; need at least an info tx and a non-info tx</span>
<span class="term-fg32">+		l1BaseFee, costFunc, feeScalar, err := extractL1GasParams(config, time, txs[0].Data())</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		for i := 0; i &lt; len(rs); i++ {</span>
<span class="term-fg32">+			if txs[i].IsDepositTx() {</span>
<span class="term-fg32">+				continue</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			rs[i].L1GasPrice = l1BaseFee</span>
<span class="term-fg32">+			rs[i].L1Fee, rs[i].L1GasUsed = costFunc(txs[i].RollupCostData())</span>
<span class="term-fg32">+			rs[i].FeeScalar = feeScalar</span>
 		}
 	}
 	return nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3162b61334e2cc1bd416e695" role="button"
                   aria-expanded="false" aria-controls="id-3162b61334e2cc1bd416e695">
                    <code>core/types/gen_receipt_json.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/gen_receipt_json.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/gen_receipt_json.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+66</span></div>
                        <div class="text-start"><span class="text-danger">-30</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3162b61334e2cc1bd416e695"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">index 4c641a972795f70ce27e98baf1b3c2e032fe89c2..14a074b2ba2d14f46976dffb76200724e3cf916e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg36">@@ -16,21 +16,27 @@</span>
 &#47;&#47; MarshalJSON marshals as JSON.
 func (r Receipt) MarshalJSON() ([]byte, error) {
 	type Receipt struct {
<span class="term-fg31">-		Type              hexutil.Uint64 `json:&quot;type,omitempty&quot;`</span>
<span class="term-fg31">-		PostState         hexutil.Bytes  `json:&quot;root&quot;`</span>
<span class="term-fg31">-		Status            hexutil.Uint64 `json:&quot;status&quot;`</span>
<span class="term-fg31">-		CumulativeGasUsed hexutil.Uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		Bloom             Bloom          `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		Logs              []*Log         `json:&quot;logs&quot;              gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		TxHash            common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		ContractAddress   common.Address `json:&quot;contractAddress&quot;`</span>
<span class="term-fg31">-		GasUsed           hexutil.Uint64 `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		EffectiveGasPrice *hexutil.Big   `json:&quot;effectiveGasPrice&quot;`</span>
<span class="term-fg31">-		BlobGasUsed       hexutil.Uint64 `json:&quot;blobGasUsed,omitempty&quot;`</span>
<span class="term-fg31">-		BlobGasPrice      *hexutil.Big   `json:&quot;blobGasPrice,omitempty&quot;`</span>
<span class="term-fg31">-		BlockHash         common.Hash    `json:&quot;blockHash,omitempty&quot;`</span>
<span class="term-fg31">-		BlockNumber       *hexutil.Big   `json:&quot;blockNumber,omitempty&quot;`</span>
<span class="term-fg31">-		TransactionIndex  hexutil.Uint   `json:&quot;transactionIndex&quot;`</span>
<span class="term-fg32">+		Type                  hexutil.Uint64  `json:&quot;type,omitempty&quot;`</span>
<span class="term-fg32">+		PostState             hexutil.Bytes   `json:&quot;root&quot;`</span>
<span class="term-fg32">+		Status                hexutil.Uint64  `json:&quot;status&quot;`</span>
<span class="term-fg32">+		CumulativeGasUsed     hexutil.Uint64  `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		Bloom                 Bloom           `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		Logs                  []*Log          `json:&quot;logs&quot;              gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		TxHash                common.Hash     `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		ContractAddress       common.Address  `json:&quot;contractAddress&quot;`</span>
<span class="term-fg32">+		GasUsed               hexutil.Uint64  `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		EffectiveGasPrice     *hexutil.Big    `json:&quot;effectiveGasPrice&quot;`</span>
<span class="term-fg32">+		BlobGasUsed           hexutil.Uint64  `json:&quot;blobGasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		BlobGasPrice          *hexutil.Big    `json:&quot;blobGasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		DepositNonce          *hexutil.Uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
<span class="term-fg32">+		DepositReceiptVersion *hexutil.Uint64 `json:&quot;depositReceiptVersion,omitempty&quot;`</span>
<span class="term-fg32">+		BlockHash             common.Hash     `json:&quot;blockHash,omitempty&quot;`</span>
<span class="term-fg32">+		BlockNumber           *hexutil.Big    `json:&quot;blockNumber,omitempty&quot;`</span>
<span class="term-fg32">+		TransactionIndex      hexutil.Uint    `json:&quot;transactionIndex&quot;`</span>
<span class="term-fg32">+		L1GasPrice            *hexutil.Big    `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed             *hexutil.Big    `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee                 *hexutil.Big    `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar             *big.Float      `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 	}
 	var enc Receipt
 	enc.Type = hexutil.Uint64(r.Type)
<span class="term-fg36">@@ -45,30 +51,42 @@</span> 	enc.GasUsed = hexutil.Uint64(r.GasUsed)
 	enc.EffectiveGasPrice = (*hexutil.Big)(r.EffectiveGasPrice)
 	enc.BlobGasUsed = hexutil.Uint64(r.BlobGasUsed)
 	enc.BlobGasPrice = (*hexutil.Big)(r.BlobGasPrice)
<span class="term-fg32">+	enc.DepositNonce = (*hexutil.Uint64)(r.DepositNonce)</span>
<span class="term-fg32">+	enc.DepositReceiptVersion = (*hexutil.Uint64)(r.DepositReceiptVersion)</span>
 	enc.BlockHash = r.BlockHash
 	enc.BlockNumber = (*hexutil.Big)(r.BlockNumber)
 	enc.TransactionIndex = hexutil.Uint(r.TransactionIndex)
<span class="term-fg32">+	enc.L1GasPrice = (*hexutil.Big)(r.L1GasPrice)</span>
<span class="term-fg32">+	enc.L1GasUsed = (*hexutil.Big)(r.L1GasUsed)</span>
<span class="term-fg32">+	enc.L1Fee = (*hexutil.Big)(r.L1Fee)</span>
<span class="term-fg32">+	enc.FeeScalar = r.FeeScalar</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
 &#47;&#47; UnmarshalJSON unmarshals from JSON.
 func (r *Receipt) UnmarshalJSON(input []byte) error {
 	type Receipt struct {
<span class="term-fg31">-		Type              *hexutil.Uint64 `json:&quot;type,omitempty&quot;`</span>
<span class="term-fg31">-		PostState         *hexutil.Bytes  `json:&quot;root&quot;`</span>
<span class="term-fg31">-		Status            *hexutil.Uint64 `json:&quot;status&quot;`</span>
<span class="term-fg31">-		CumulativeGasUsed *hexutil.Uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		Bloom             *Bloom          `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		Logs              []*Log          `json:&quot;logs&quot;              gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		TxHash            *common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		ContractAddress   *common.Address `json:&quot;contractAddress&quot;`</span>
<span class="term-fg31">-		GasUsed           *hexutil.Uint64 `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		EffectiveGasPrice *hexutil.Big    `json:&quot;effectiveGasPrice&quot;`</span>
<span class="term-fg31">-		BlobGasUsed       *hexutil.Uint64 `json:&quot;blobGasUsed,omitempty&quot;`</span>
<span class="term-fg31">-		BlobGasPrice      *hexutil.Big    `json:&quot;blobGasPrice,omitempty&quot;`</span>
<span class="term-fg31">-		BlockHash         *common.Hash    `json:&quot;blockHash,omitempty&quot;`</span>
<span class="term-fg31">-		BlockNumber       *hexutil.Big    `json:&quot;blockNumber,omitempty&quot;`</span>
<span class="term-fg31">-		TransactionIndex  *hexutil.Uint   `json:&quot;transactionIndex&quot;`</span>
<span class="term-fg32">+		Type                  *hexutil.Uint64 `json:&quot;type,omitempty&quot;`</span>
<span class="term-fg32">+		PostState             *hexutil.Bytes  `json:&quot;root&quot;`</span>
<span class="term-fg32">+		Status                *hexutil.Uint64 `json:&quot;status&quot;`</span>
<span class="term-fg32">+		CumulativeGasUsed     *hexutil.Uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		Bloom                 *Bloom          `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		Logs                  []*Log          `json:&quot;logs&quot;              gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		TxHash                *common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		ContractAddress       *common.Address `json:&quot;contractAddress&quot;`</span>
<span class="term-fg32">+		GasUsed               *hexutil.Uint64 `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		EffectiveGasPrice     *hexutil.Big    `json:&quot;effectiveGasPrice&quot;`</span>
<span class="term-fg32">+		BlobGasUsed           *hexutil.Uint64 `json:&quot;blobGasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		BlobGasPrice          *hexutil.Big    `json:&quot;blobGasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		DepositNonce          *hexutil.Uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
<span class="term-fg32">+		DepositReceiptVersion *hexutil.Uint64 `json:&quot;depositReceiptVersion,omitempty&quot;`</span>
<span class="term-fg32">+		BlockHash             *common.Hash    `json:&quot;blockHash,omitempty&quot;`</span>
<span class="term-fg32">+		BlockNumber           *hexutil.Big    `json:&quot;blockNumber,omitempty&quot;`</span>
<span class="term-fg32">+		TransactionIndex      *hexutil.Uint   `json:&quot;transactionIndex&quot;`</span>
<span class="term-fg32">+		L1GasPrice            *hexutil.Big    `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed             *hexutil.Big    `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee                 *hexutil.Big    `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar             *big.Float      `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 	}
 	var dec Receipt
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -115,6 +133,12 @@</span> 	}
 	if dec.BlobGasPrice != nil {
 		r.BlobGasPrice = (*big.Int)(dec.BlobGasPrice)
 	}
<span class="term-fg32">+	if dec.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = (*uint64)(dec.DepositNonce)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+		r.DepositReceiptVersion = (*uint64)(dec.DepositReceiptVersion)</span>
<span class="term-fg32">+	}</span>
 	if dec.BlockHash != nil {
 		r.BlockHash = *dec.BlockHash
 	}
<span class="term-fg36">@@ -123,6 +147,18 @@</span> 		r.BlockNumber = (*big.Int)(dec.BlockNumber)
 	}
 	if dec.TransactionIndex != nil {
 		r.TransactionIndex = uint(*dec.TransactionIndex)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasPrice != nil {</span>
<span class="term-fg32">+		r.L1GasPrice = (*big.Int)(dec.L1GasPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasUsed != nil {</span>
<span class="term-fg32">+		r.L1GasUsed = (*big.Int)(dec.L1GasUsed)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1Fee != nil {</span>
<span class="term-fg32">+		r.L1Fee = (*big.Int)(dec.L1Fee)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.FeeScalar != nil {</span>
<span class="term-fg32">+		r.FeeScalar = dec.FeeScalar</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4e38e1a794422b573e3bda8e" role="button"
                   aria-expanded="false" aria-controls="id-4e38e1a794422b573e3bda8e">
                    <code>core/rawdb/accessors_chain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/rawdb/accessors_chain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/rawdb/accessors_chain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4e38e1a794422b573e3bda8e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">index 964b3a311de5901be3e8f27a4b68ceee7a340d80..6a1a2eae8f60b380d29030266b3e947d97231ec8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg36">@@ -626,7 +626,6 @@</span> 		log.Error(&quot;Missing body but have receipt&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number)
 		return nil
 	}
 	header := ReadHeader(db, hash, number)
<span class="term-fg31">-</span>
 	var baseFee *big.Int
 	if header == nil {
 		baseFee = big.NewInt(0)
<span class="term-fg36">@@ -676,6 +675,15 @@</span> type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*types.Log
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Remaining fields are declared to allow the receipt RLP to be parsed without errors.</span>
<span class="term-fg32">+	&#47;&#47; However, they must not be used as they may not be populated correctly due to multiple receipt formats</span>
<span class="term-fg32">+	&#47;&#47; being combined into a single list of optional fields which can be mistaken for each other.</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce (*uint64) from Regolith deposit tx receipts will be parsed into L1GasUsed</span>
<span class="term-fg32">+	L1GasUsed  *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1GasPrice *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1Fee      *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	FeeScalar  string   `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
 }
&nbsp;
 &#47;&#47; ReceiptLogs is a barebone version of ReceiptForStorage which only keeps</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-3150484c70c51900a5a2fd11"role="button" aria-expanded="false" aria-controls="id-3150484c70c51900a5a2fd11">
        
            <div class="col-12 col-sm-9 text-start"><h3>API Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+138</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-3150484c70c51900a5a2fd11">
        <div><p>Forward transactions to the sequencer if configured.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7153da5e29eae0e57cfd0f7a" role="button"
                   aria-expanded="false" aria-controls="id-7153da5e29eae0e57cfd0f7a">
                    <code>eth/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7153da5e29eae0e57cfd0f7a"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api_backend.go op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">index 0edcce5c8789f73c302ba955b40b7519d3f471eb..80afee92cd966434c596f9b120af88fff4d75410 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg36">@@ -19,12 +19,14 @@</span>
 import (
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -37,6 +39,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;gasprice&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;miner&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg36">@@ -46,6 +49,7 @@</span> &#47;&#47; EthAPIBackend implements ethapi.Backend and tracers.Backend for full nodes
 type EthAPIBackend struct {
 	extRPCEnabled       bool
 	allowUnprotectedTxs bool
<span class="term-fg32">+	disableTxPool       bool</span>
 	eth                 *Ethereum
 	gpo                 *gasprice.Oracle
 }
<span class="term-fg36">@@ -190,10 +194,11 @@</span> func (b *EthAPIBackend) StateAndHeaderByNumber(ctx context.Context, number rpc.BlockNumber) (*state.StateDB, *types.Header, error) {
 	&#47;&#47; Pending state is only known by the miner
 	if number == rpc.PendingBlockNumber {
 		block, state := b.eth.miner.Pending()
<span class="term-fg31">-		if block == nil || state == nil {</span>
<span class="term-fg31">-			return nil, nil, errors.New(&quot;pending state is not available&quot;)</span>
<span class="term-fg32">+		if block != nil &amp;&amp; state != nil {</span>
<span class="term-fg32">+			return state, block.Header(), nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			number = rpc.LatestBlockNumber &#47;&#47; fall back to latest state</span>
 		}
<span class="term-fg31">-		return state, block.Header(), nil</span>
 	}
 	&#47;&#47; Otherwise resolve the block number and return its state
 	header, err := b.HeaderByNumber(ctx, number)
<span class="term-fg36">@@ -201,7 +206,7 @@</span> 	if err != nil {
 		return nil, nil, err
 	}
 	if header == nil {
<span class="term-fg31">-		return nil, nil, errors.New(&quot;header not found&quot;)</span>
<span class="term-fg32">+		return nil, nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
 	}
 	stateDb, err := b.eth.BlockChain().StateAt(header.Root)
 	if err != nil {
<span class="term-fg36">@@ -220,7 +225,7 @@</span> 		if err != nil {
 			return nil, nil, err
 		}
 		if header == nil {
<span class="term-fg31">-			return nil, nil, errors.New(&quot;header for hash not found&quot;)</span>
<span class="term-fg32">+			return nil, nil, fmt.Errorf(&quot;header for hash %w&quot;, ethereum.NotFound)</span>
 		}
 		if blockNrOrHash.RequireCanonical &amp;&amp; b.eth.blockchain.GetCanonicalHash(header.Number.Uint64()) != hash {
 			return nil, nil, errors.New(&quot;hash is not currently canonical&quot;)
<span class="term-fg36">@@ -258,7 +263,7 @@</span> 	var context vm.BlockContext
 	if blockCtx != nil {
 		context = *blockCtx
 	} else {
<span class="term-fg31">-		context = core.NewEVMBlockContext(header, b.eth.BlockChain(), nil)</span>
<span class="term-fg32">+		context = core.NewEVMBlockContext(header, b.eth.BlockChain(), nil, b.eth.blockchain.Config(), state)</span>
 	}
 	return vm.NewEVM(context, txContext, state, b.ChainConfig(), *vmConfig)
 }
<span class="term-fg36">@@ -288,6 +293,29 @@</span> 	return b.eth.BlockChain().SubscribeLogsEvent(ch)
 }
&nbsp;
 func (b *EthAPIBackend) SendTx(ctx context.Context, signedTx *types.Transaction) error {
<span class="term-fg32">+	if b.ChainConfig().IsOptimism() &amp;&amp; signedTx.Type() == types.BlobTxType {</span>
<span class="term-fg32">+		return types.ErrTxTypeNotSupported</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if b.eth.seqRPCService != nil {</span>
<span class="term-fg32">+		data, err := signedTx.MarshalBinary()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := b.eth.seqRPCService.CallContext(ctx, nil, &quot;eth_sendRawTransaction&quot;, hexutil.Encode(data)); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if b.disableTxPool {</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Retain tx in local tx pool after forwarding, for local RPC usage.</span>
<span class="term-fg32">+		if err := b.eth.txPool.Add([]*types.Transaction{signedTx}, true, false)[0]; err != nil {</span>
<span class="term-fg32">+			log.Warn(&quot;successfully sent tx to sequencer, but failed to persist in local tx pool&quot;, &quot;err&quot;, err, &quot;tx&quot;, signedTx.Hash())</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if b.disableTxPool {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
 	return b.eth.txPool.Add([]*types.Transaction{signedTx}, true, false)[0]
 }
&nbsp;
<span class="term-fg36">@@ -436,3 +464,11 @@</span>
 func (b *EthAPIBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c09cb3ccb7942e6e4211ad8b" role="button"
                   aria-expanded="false" aria-controls="id-c09cb3ccb7942e6e4211ad8b">
                    <code>eth/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+94</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c09cb3ccb7942e6e4211ad8b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;backend.go op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg1">index aff23a910bcbfa914440c3d349851aa6798ad349..4d427b583cbcda5416f6716cb34218f3157e2959 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg36">@@ -18,11 +18,13 @@</span> &#47;&#47; Package eth implements the Ethereum protocol.
 package eth
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg32">+	&quot;time&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -76,6 +78,9 @@</span> 	ethDialCandidates  enode.Iterator
 	snapDialCandidates enode.Iterator
 	merger             *consensus.Merger
&nbsp;
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
<span class="term-fg32">+</span>
 	&#47;&#47; DB interfaces
 	chainDb ethdb.Database &#47;&#47; Block chain database
&nbsp;
<span class="term-fg36">@@ -101,6 +106,8 @@</span>
 	lock sync.RWMutex &#47;&#47; Protects the variadic fields (e.g. gas price and etherbase)
&nbsp;
 	shutdownTracker *shutdowncheck.ShutdownTracker &#47;&#47; Tracks if and when the node has shutdown ungracefully
<span class="term-fg32">+</span>
<span class="term-fg32">+	nodeCloser func() error</span>
 }
&nbsp;
 &#47;&#47; New creates a new Ethereum object (including the
<span class="term-fg36">@@ -171,13 +178,13 @@</span> 		bloomRequests:     make(chan chan *bloombits.Retrieval),
 		bloomIndexer:      core.NewBloomIndexer(chainDb, params.BloomBitsBlocks, params.BloomConfirms),
 		p2pServer:         stack.Server(),
 		shutdownTracker:   shutdowncheck.NewShutdownTracker(chainDb),
<span class="term-fg32">+		nodeCloser:        stack.Close,</span>
 	}
 	bcVersion := rawdb.ReadDatabaseVersion(chainDb)
<span class="term-fg31">-	var dbVer = &quot;&lt;nil&gt;&quot;</span>
<span class="term-fg32">+	dbVer := &quot;&lt;nil&gt;&quot;</span>
 	if bcVersion != nil {
 		dbVer = fmt.Sprintf(&quot;%d&quot;, *bcVersion)
 	}
<span class="term-fg31">-	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, networkID, &quot;dbversion&quot;, dbVer)</span>
&nbsp;
 	if !config.SkipBcVersionCheck {
 		if bcVersion != nil &amp;&amp; *bcVersion &gt; core.BlockChainVersion {
<span class="term-fg36">@@ -213,23 +220,47 @@</span> 	}
 	if config.OverrideVerkle != nil {
 		overrides.OverrideVerkle = config.OverrideVerkle
 	}
<span class="term-fg32">+	if config.OverrideOptimismCanyon != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismCanyon = config.OverrideOptimismCanyon</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.OverrideOptimismEcotone != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismEcotone = config.OverrideOptimismEcotone</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.OverrideOptimismInterop != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismInterop = config.OverrideOptimismInterop</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	overrides.ApplySuperchainUpgrades = config.ApplySuperchainUpgrades</span>
 	eth.blockchain, err = core.NewBlockChain(chainDb, cacheConfig, config.Genesis, &amp;overrides, eth.engine, vmConfig, eth.shouldPreserve, &amp;config.TransactionHistory)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+	if chainConfig := eth.blockchain.Config(); chainConfig.Optimism != nil { &#47;&#47; config.Genesis.Config.ChainID cannot be used because it&#39;s based on CLI flags only, thus default to mainnet L1</span>
<span class="term-fg32">+		config.NetworkId = chainConfig.ChainID.Uint64() &#47;&#47; optimism defaults eth network ID to chain ID</span>
<span class="term-fg32">+		eth.networkID = config.NetworkId</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if eth.blockchain.Config().Optimism != nil { &#47;&#47; Optimism Bedrock depends on Merge functionality</span>
<span class="term-fg32">+		eth.merger.FinalizePoS()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	eth.bloomIndexer.Start(eth.blockchain)
&nbsp;
 	if config.BlobPool.Datadir != &quot;&quot; {
 		config.BlobPool.Datadir = stack.ResolvePath(config.BlobPool.Datadir)
 	}
<span class="term-fg31">-	blobPool := blobpool.New(config.BlobPool, eth.blockchain)</span>
&nbsp;
 	if config.TxPool.Journal != &quot;&quot; {
 		config.TxPool.Journal = stack.ResolvePath(config.TxPool.Journal)
 	}
 	legacyPool := legacypool.New(config.TxPool, eth.blockchain)
&nbsp;
<span class="term-fg31">-	eth.txPool, err = txpool.New(new(big.Int).SetUint64(config.TxPool.PriceLimit), eth.blockchain, []txpool.SubPool{legacyPool, blobPool})</span>
<span class="term-fg32">+	txPools := []txpool.SubPool{legacyPool}</span>
<span class="term-fg32">+	if !eth.BlockChain().Config().IsOptimism() {</span>
<span class="term-fg32">+		blobPool := blobpool.New(config.BlobPool, eth.blockchain)</span>
<span class="term-fg32">+		txPools = append(txPools, blobPool)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	eth.txPool, err = txpool.New(new(big.Int).SetUint64(config.TxPool.PriceLimit), eth.blockchain, txPools)</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -245,6 +276,7 @@</span> 		Sync:           config.SyncMode,
 		BloomCache:     uint64(cacheLimit),
 		EventMux:       eth.eventMux,
 		RequiredBlocks: config.RequiredBlocks,
<span class="term-fg32">+		NoTxGossip:     config.RollupDisableTxPoolGossip,</span>
 	}); err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -252,7 +284,7 @@</span>
 	eth.miner = miner.New(eth, &amp;config.Miner, eth.blockchain.Config(), eth.EventMux(), eth.engine, eth.isLocalBlock)
 	eth.miner.SetExtra(makeExtraData(config.Miner.ExtraData))
&nbsp;
<span class="term-fg31">-	eth.APIBackend = &amp;EthAPIBackend{stack.Config().ExtRPCEnabled(), stack.Config().AllowUnprotectedTxs, eth, nil}</span>
<span class="term-fg32">+	eth.APIBackend = &amp;EthAPIBackend{stack.Config().ExtRPCEnabled(), stack.Config().AllowUnprotectedTxs, config.RollupDisableTxPoolAdmission, eth, nil}</span>
 	if eth.APIBackend.allowUnprotectedTxs {
 		log.Info(&quot;Unprotected transactions allowed&quot;)
 	}
<span class="term-fg36">@@ -273,6 +305,26 @@</span> 	if err != nil {
 		return nil, err
 	}
&nbsp;
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.historicalRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Start the RPC service
 	eth.netRPCService = ethapi.NewNetAPI(eth.p2pServer, networkID)
&nbsp;
<span class="term-fg36">@@ -291,7 +343,7 @@</span> func makeExtraData(extra []byte) []byte {
 	if len(extra) == 0 {
 		&#47;&#47; create default extradata
 		extra, _ = rlp.EncodeToBytes([]interface{}{
<span class="term-fg31">-			uint(params.VersionMajor&lt;&lt;16 | params.VersionMinor&lt;&lt;8 | params.VersionPatch),</span>
<span class="term-fg32">+			uint(params.OPVersionMajor&lt;&lt;16 | params.OPVersionMinor&lt;&lt;8 | params.OPVersionPatch),</span>
 			&quot;geth&quot;,
 			runtime.Version(),
 			runtime.GOOS,
<span class="term-fg36">@@ -541,6 +593,12 @@</span> 	s.txPool.Close()
 	s.miner.Close()
 	s.blockchain.Stop()
 	s.engine.Close()
<span class="term-fg32">+	if s.seqRPCService != nil {</span>
<span class="term-fg32">+		s.seqRPCService.Close()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.historicalRPCService != nil {</span>
<span class="term-fg32">+		s.historicalRPCService.Close()</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Clean shutdown marker as the last thing before closing db
 	s.shutdownTracker.Stop()
<span class="term-fg36">@@ -550,3 +608,33 @@</span> 	s.eventMux.Stop()
&nbsp;
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; HandleRequiredProtocolVersion handles the protocol version signal. This implements opt-in halting,</span>
<span class="term-fg32">+&#47;&#47; the protocol version data is already logged and metered when signaled through the Engine API.</span>
<span class="term-fg32">+func (s *Ethereum) HandleRequiredProtocolVersion(required params.ProtocolVersion) error {</span>
<span class="term-fg32">+	var needLevel int</span>
<span class="term-fg32">+	switch s.config.RollupHaltOnIncompatibleProtocolVersion {</span>
<span class="term-fg32">+	case &quot;major&quot;:</span>
<span class="term-fg32">+		needLevel = 3</span>
<span class="term-fg32">+	case &quot;minor&quot;:</span>
<span class="term-fg32">+		needLevel = 2</span>
<span class="term-fg32">+	case &quot;patch&quot;:</span>
<span class="term-fg32">+		needLevel = 1</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return nil &#47;&#47; do not consider halting if not configured to</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	haveLevel := 0</span>
<span class="term-fg32">+	switch params.OPStackSupport.Compare(required) {</span>
<span class="term-fg32">+	case params.OutdatedMajor:</span>
<span class="term-fg32">+		haveLevel = 3</span>
<span class="term-fg32">+	case params.OutdatedMinor:</span>
<span class="term-fg32">+		haveLevel = 2</span>
<span class="term-fg32">+	case params.OutdatedPatch:</span>
<span class="term-fg32">+		haveLevel = 1</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if haveLevel &gt;= needLevel { &#47;&#47; halt if we opted in to do so at this granularity</span>
<span class="term-fg32">+		log.Error(&quot;Opted to halt, unprepared for protocol change&quot;, &quot;required&quot;, required, &quot;local&quot;, params.OPStackSupport)</span>
<span class="term-fg32">+		return s.nodeCloser()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-80b7947b5215cc27c1af82c9" role="button"
                   aria-expanded="false" aria-controls="id-80b7947b5215cc27c1af82c9">
                    <code>internal/ethapi/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/ethapi/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/ethapi/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-80b7947b5215cc27c1af82c9"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;backend.go op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">index 5f408ba20ba57faf14254a11577f4855a61ad2bf..7c0e655d205c7e7d2faf92a5ef39b8a76d0439c8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg36">@@ -86,6 +86,8 @@</span> 	SubscribeNewTxsEvent(chan&lt;- core.NewTxsEvent) event.Subscription
&nbsp;
 	ChainConfig() *params.ChainConfig
 	Engine() consensus.Engine
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
<span class="term-fg32">+	Genesis() *types.Block</span>
&nbsp;
 	&#47;&#47; This is copied from filters.Backend
 	&#47;&#47; eth&#47;filters needs to be initialized from this backend type, so methods needed by</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-2baf37dd659df971e58c14b9"role="button" aria-expanded="false" aria-controls="id-2baf37dd659df971e58c14b9">
        
            <div class="col-12 col-sm-9 text-start"><h3>Apply L1 cost in API responses</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-2baf37dd659df971e58c14b9">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9f499765b5b4d32a103ecafe" role="button"
                   aria-expanded="false" aria-controls="id-9f499765b5b4d32a103ecafe">
                    <code>eth/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9f499765b5b4d32a103ecafe"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;state_accessor.go op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">index 24694df66c36cd814d2d631368bf29d75cf6d9f6..19128d12b19a038f0a70d58564e179b06970f281 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg36">@@ -241,7 +241,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil, eth.blockchain.Config(), statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-6c7287388955541ddcf67ced"role="button" aria-expanded="false" aria-controls="id-6c7287388955541ddcf67ced">
        
            <div class="col-12 col-sm-9 text-start"><h3>API frontend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+251</span></div>
                <div class="text-start"><span class="text-danger">-18</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-6c7287388955541ddcf67ced">
        <div><p>Format deposit and L1-cost data in transaction responses. Add <code>debug_chainConfig</code> API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-911a9c37fbf9a983b7bef709" role="button"
                   aria-expanded="false" aria-controls="id-911a9c37fbf9a983b7bef709">
                    <code>internal/ethapi/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/ethapi/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/ethapi/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+241</span></div>
                        <div class="text-start"><span class="text-danger">-18</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-911a9c37fbf9a983b7bef709"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api.go op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">index 3bc9bc51f077385d3dd715f0fde3b2735dba2675..3734028d351c45440bbada81abd660d8cefa21bb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg36">@@ -26,6 +26,7 @@</span> 	&quot;strings&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;scwallet&quot;
<span class="term-fg36">@@ -647,6 +648,24 @@</span> &#47;&#47; GetBalance returns the amount of wei for the given address in the state of the
 &#47;&#47; given block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta
 &#47;&#47; block numbers are also allowed.
 func (s *BlockChainAPI) GetBalance(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (*hexutil.Big, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Big</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getBalance&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
<span class="term-fg36">@@ -687,6 +706,22 @@</span> }
&nbsp;
 &#47;&#47; GetProof returns the Merkle-proof for a given account and optionally some storage keys.
 func (s *BlockChainAPI) GetProof(ctx context.Context, address common.Address, storageKeys []string, blockNrOrHash rpc.BlockNumberOrHash) (*AccountResult, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res AccountResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getProof&quot;, address, storageKeys, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	var (
 		keys         = make([]common.Hash, len(storageKeys))
 		keyLengths   = make([]int, len(storageKeys))
<span class="term-fg36">@@ -790,7 +825,7 @@</span> func (s *BlockChainAPI) GetHeaderByNumber(ctx context.Context, number rpc.BlockNumber) (map[string]interface{}, error) {
 	header, err := s.b.HeaderByNumber(ctx, number)
 	if header != nil &amp;&amp; err == nil {
 		response := s.rpcMarshalHeader(ctx, header)
<span class="term-fg31">-		if number == rpc.PendingBlockNumber {</span>
<span class="term-fg32">+		if number == rpc.PendingBlockNumber &amp;&amp; s.b.ChainConfig().Optimism == nil { &#47;&#47; don&#39;t remove info if optimism</span>
 			&#47;&#47; Pending header need to nil out a few fields
 			for _, field := range []string{&quot;hash&quot;, &quot;nonce&quot;, &quot;miner&quot;} {
 				response[field] = nil
<span class="term-fg36">@@ -821,7 +856,7 @@</span> func (s *BlockChainAPI) GetBlockByNumber(ctx context.Context, number rpc.BlockNumber, fullTx bool) (map[string]interface{}, error) {
 	block, err := s.b.BlockByNumber(ctx, number)
 	if block != nil &amp;&amp; err == nil {
 		response, err := s.rpcMarshalBlock(ctx, block, true, fullTx)
<span class="term-fg31">-		if err == nil &amp;&amp; number == rpc.PendingBlockNumber {</span>
<span class="term-fg32">+		if err == nil &amp;&amp; number == rpc.PendingBlockNumber &amp;&amp; s.b.ChainConfig().Optimism == nil { &#47;&#47; don&#39;t remove info if optimism</span>
 			&#47;&#47; Pending blocks need to nil out a few fields
 			for _, field := range []string{&quot;hash&quot;, &quot;nonce&quot;, &quot;miner&quot;} {
 				response[field] = nil
<span class="term-fg36">@@ -892,10 +927,29 @@</span> }
&nbsp;
 &#47;&#47; GetCode returns the code stored at the given address in the state for the given block number.
 func (s *BlockChainAPI) GetCode(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getCode&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	code := state.GetCode(address)
 	return code, state.Error()
 }
<span class="term-fg36">@@ -904,10 +958,29 @@</span> &#47;&#47; GetStorageAt returns the storage from the state at the given address, key and
 &#47;&#47; block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta block
 &#47;&#47; numbers are also allowed.
 func (s *BlockChainAPI) GetStorageAt(ctx context.Context, address common.Address, hexKey string, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getStorageAt&quot;, address, hexKey, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	key, _, err := decodeHash(hexKey)
 	if err != nil {
 		return nil, fmt.Errorf(&quot;unable to decode storage key: %s&quot;, err)
<span class="term-fg36">@@ -916,6 +989,18 @@</span> 	res := state.GetState(address, key)
 	return res[:], state.Error()
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; The HeaderByNumberOrHash method returns a nil error and nil header</span>
<span class="term-fg32">+&#47;&#47; if the header is not found, but only for nonexistent block numbers. This is</span>
<span class="term-fg32">+&#47;&#47; different from StateAndHeaderByNumberOrHash. To account for this discrepancy,</span>
<span class="term-fg32">+&#47;&#47; headerOrNumberByHash will properly convert the error into an ethereum.NotFound.</span>
<span class="term-fg32">+func headerByNumberOrHash(ctx context.Context, b Backend, blockNrOrHash rpc.BlockNumberOrHash) (*types.Header, error) {</span>
<span class="term-fg32">+	header, err := b.HeaderByNumberOrHash(ctx, blockNrOrHash)</span>
<span class="term-fg32">+	if header == nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return header, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; GetBlockReceipts returns the block receipts for the given block hash or number or tag.
 func (s *BlockChainAPI) GetBlockReceipts(ctx context.Context, blockNrOrHash rpc.BlockNumberOrHash) ([]map[string]interface{}, error) {
 	block, err := s.b.BlockByNumberOrHash(ctx, blockNrOrHash)
<span class="term-fg36">@@ -938,7 +1023,7 @@</span> 	signer := types.MakeSigner(s.b.ChainConfig(), block.Number(), block.Time())
&nbsp;
 	result := make([]map[string]interface{}, len(receipts))
 	for i, receipt := range receipts {
<span class="term-fg31">-		result[i] = marshalReceipt(receipt, block.Hash(), block.NumberU64(), signer, txs[i], i)</span>
<span class="term-fg32">+		result[i] = marshalReceipt(receipt, block.Hash(), block.NumberU64(), signer, txs[i], i, s.b.ChainConfig())</span>
 	}
&nbsp;
 	return result, nil
<span class="term-fg36">@@ -1097,7 +1182,7 @@</span> 	msg, err := args.ToMessage(globalGasCap, header.BaseFee)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	blockCtx := core.NewEVMBlockContext(header, NewChainContext(ctx, b), nil)</span>
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(header, NewChainContext(ctx, b), nil, b.ChainConfig(), state)</span>
 	if blockOverrides != nil {
 		blockOverrides.Apply(&amp;blockCtx)
 	}
<span class="term-fg36">@@ -1149,6 +1234,25 @@</span> 	if blockNrOrHash == nil {
 		latest := rpc.BlockNumberOrHashWithNumber(rpc.LatestBlockNumber)
 		blockNrOrHash = &amp;latest
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, *blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_call&quot;, args, blockNrOrHash, overrides)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	result, err := DoCall(ctx, s.b, args, *blockNrOrHash, overrides, blockOverrides, s.b.RPCEVMTimeout(), s.b.RPCGasCap())
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1207,6 +1311,25 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.LatestBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return 0, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_estimateGas&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return 0, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return 0, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return DoEstimateGas(ctx, s.b, args, bNrOrHash, overrides, s.b.RPCGasCap())
 }
&nbsp;
<span class="term-fg36">@@ -1251,7 +1374,7 @@</span>
 &#47;&#47; RPCMarshalBlock converts the given block to the RPC output which depends on fullTx. If inclTx is true transactions are
 &#47;&#47; returned. When fullTx is true the returned block contains full transaction details, otherwise it will only contain
 &#47;&#47; transaction hashes.
<span class="term-fg31">-func RPCMarshalBlock(block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig) map[string]interface{} {</span>
<span class="term-fg32">+func RPCMarshalBlock(ctx context.Context, block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig, backend Backend) (map[string]interface{}, error) {</span>
 	fields := RPCMarshalHeader(block.Header())
 	fields[&quot;size&quot;] = hexutil.Uint64(block.Size())
&nbsp;
<span class="term-fg36">@@ -1261,7 +1384,7 @@</span> 			return tx.Hash()
 		}
 		if fullTx {
 			formatTx = func(idx int, tx *types.Transaction) interface{} {
<span class="term-fg31">-				return newRPCTransactionFromBlockIndex(block, uint64(idx), config)</span>
<span class="term-fg32">+				return newRPCTransactionFromBlockIndex(ctx, block, uint64(idx), config, backend)</span>
 			}
 		}
 		txs := block.Transactions()
<span class="term-fg36">@@ -1280,7 +1403,7 @@</span> 	fields[&quot;uncles&quot;] = uncleHashes
 	if block.Header().WithdrawalsHash != nil {
 		fields[&quot;withdrawals&quot;] = block.Withdrawals()
 	}
<span class="term-fg31">-	return fields</span>
<span class="term-fg32">+	return fields, nil</span>
 }
&nbsp;
 &#47;&#47; rpcMarshalHeader uses the generalized output filler, then adds the total difficulty field, which requires
<span class="term-fg36">@@ -1294,7 +1417,10 @@</span>
 &#47;&#47; rpcMarshalBlock uses the generalized output filler, then adds the total difficulty field, which requires
 &#47;&#47; a `BlockchainAPI`.
 func (s *BlockChainAPI) rpcMarshalBlock(ctx context.Context, b *types.Block, inclTx bool, fullTx bool) (map[string]interface{}, error) {
<span class="term-fg31">-	fields := RPCMarshalBlock(b, inclTx, fullTx, s.b.ChainConfig())</span>
<span class="term-fg32">+	fields, err := RPCMarshalBlock(ctx, b, inclTx, fullTx, s.b.ChainConfig(), s.b)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
 	if inclTx {
 		fields[&quot;totalDifficulty&quot;] = (*hexutil.Big)(s.b.GetTd(ctx, b.Hash()))
 	}
<span class="term-fg36">@@ -1325,11 +1451,18 @@</span> 	V                   *hexutil.Big      `json:&quot;v&quot;`
 	R                   *hexutil.Big      `json:&quot;r&quot;`
 	S                   *hexutil.Big      `json:&quot;s&quot;`
 	YParity             *hexutil.Uint64   `json:&quot;yParity,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; deposit-tx only</span>
<span class="term-fg32">+	SourceHash *common.Hash `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool        `json:&quot;isSystemTx,omitempty&quot;`</span>
<span class="term-fg32">+	&#47;&#47; deposit-tx post-Canyon only</span>
<span class="term-fg32">+	DepositReceiptVersion *hexutil.Uint64 `json:&quot;depositReceiptVersion,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; newRPCTransaction returns a transaction that will serialize to the RPC
 &#47;&#47; representation, with the given location metadata set (if available).
<span class="term-fg31">-func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, blockTime uint64, index uint64, baseFee *big.Int, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, blockTime uint64, index uint64, baseFee *big.Int, config *params.ChainConfig, receipt *types.Receipt) *RPCTransaction {</span>
 	signer := types.MakeSigner(config, new(big.Int).SetUint64(blockNumber), blockTime)
 	from, _ := types.Sender(signer, tx)
 	v, r, s := tx.RawSignatureValues()
<span class="term-fg36">@@ -1354,7 +1487,27 @@</span> 		result.TransactionIndex = (*hexutil.Uint64)(&amp;index)
 	}
&nbsp;
 	switch tx.Type() {
<span class="term-fg32">+	case types.DepositTxType:</span>
<span class="term-fg32">+		srcHash := tx.SourceHash()</span>
<span class="term-fg32">+		isSystemTx := tx.IsSystemTx()</span>
<span class="term-fg32">+		result.SourceHash = &amp;srcHash</span>
<span class="term-fg32">+		if isSystemTx {</span>
<span class="term-fg32">+			&#47;&#47; Only include IsSystemTx when true</span>
<span class="term-fg32">+			result.IsSystemTx = &amp;isSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result.Mint = (*hexutil.Big)(tx.Mint())</span>
<span class="term-fg32">+		if receipt != nil &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+			result.Nonce = hexutil.Uint64(*receipt.DepositNonce)</span>
<span class="term-fg32">+			if receipt.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+				result.DepositReceiptVersion = new(hexutil.Uint64)</span>
<span class="term-fg32">+				*result.DepositReceiptVersion = hexutil.Uint64(*receipt.DepositReceiptVersion)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 	case types.LegacyTxType:
<span class="term-fg32">+		if v.Sign() == 0 &amp;&amp; r.Sign() == 0 &amp;&amp; s.Sign() == 0 { &#47;&#47; pre-bedrock relayed tx does not have a signature</span>
<span class="term-fg32">+			result.ChainID = (*hexutil.Big)(new(big.Int).Set(config.ChainID))</span>
<span class="term-fg32">+			break</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; if a legacy transaction has an EIP-155 chain id, include it explicitly
 		if id := tx.ChainId(); id.Sign() != 0 {
 			result.ChainID = (*hexutil.Big)(id)
<span class="term-fg36">@@ -1423,20 +1576,36 @@</span> 		blockNumber = uint64(0)
 		blockTime   = uint64(0)
 	)
 	if current != nil {
<span class="term-fg31">-		baseFee = eip1559.CalcBaseFee(config, current)</span>
<span class="term-fg32">+		baseFee = eip1559.CalcBaseFee(config, current, current.Time+1)</span>
 		blockNumber = current.Number.Uint64()
 		blockTime = current.Time
 	}
<span class="term-fg31">-	return newRPCTransaction(tx, common.Hash{}, blockNumber, blockTime, 0, baseFee, config)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, common.Hash{}, blockNumber, blockTime, 0, baseFee, config, nil)</span>
 }
&nbsp;
 &#47;&#47; newRPCTransactionFromBlockIndex returns a transaction that will serialize to the RPC representation.
<span class="term-fg31">-func newRPCTransactionFromBlockIndex(b *types.Block, index uint64, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransactionFromBlockIndex(ctx context.Context, b *types.Block, index uint64, config *params.ChainConfig, backend Backend) *RPCTransaction {</span>
 	txs := b.Transactions()
 	if index &gt;= uint64(len(txs)) {
 		return nil
 	}
<span class="term-fg31">-	return newRPCTransaction(txs[index], b.Hash(), b.NumberU64(), b.Time(), index, b.BaseFee(), config)</span>
<span class="term-fg32">+	tx := txs[index]</span>
<span class="term-fg32">+	rcpt := depositTxReceipt(ctx, b.Hash(), index, backend, tx)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, b.Hash(), b.NumberU64(), b.Time(), index, b.BaseFee(), config, rcpt)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func depositTxReceipt(ctx context.Context, blockHash common.Hash, index uint64, backend Backend, tx *types.Transaction) *types.Receipt {</span>
<span class="term-fg32">+	if tx.Type() != types.DepositTxType {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	receipts, err := backend.GetReceipts(ctx, blockHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if index &gt;= uint64(len(receipts)) {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return receipts[index]</span>
 }
&nbsp;
 &#47;&#47; newRPCRawTransactionFromBlockIndex returns the bytes of a transaction given a block and a transaction index.
<span class="term-fg36">@@ -1465,6 +1634,21 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.LatestBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err == nil &amp;&amp; header != nil &amp;&amp; s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res accessListResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_createAccessList&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	acl, gasUsed, vmerr, err := AccessList(ctx, s.b, bNrOrHash, args)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1575,7 +1759,7 @@</span>
 &#47;&#47; GetTransactionByBlockNumberAndIndex returns the transaction for the given block number and index.
 func (s *TransactionAPI) GetTransactionByBlockNumberAndIndex(ctx context.Context, blockNr rpc.BlockNumber, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByNumber(ctx, blockNr); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b.ChainConfig(), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1583,7 +1767,7 @@</span>
 &#47;&#47; GetTransactionByBlockHashAndIndex returns the transaction for the given block hash and index.
 func (s *TransactionAPI) GetTransactionByBlockHashAndIndex(ctx context.Context, blockHash common.Hash, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByHash(ctx, blockHash); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b.ChainConfig(), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1615,10 +1799,29 @@</span> 		}
 		return (*hexutil.Uint64)(&amp;nonce), nil
 	}
 	&#47;&#47; Resolve block number and use its state to ask for the nonce
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getTransactionCount&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	nonce := state.GetNonce(address)
 	return (*hexutil.Uint64)(&amp;nonce), state.Error()
 }
<span class="term-fg36">@@ -1641,7 +1844,8 @@</span> 	header, err := s.b.HeaderByHash(ctx, blockHash)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	return newRPCTransaction(tx, blockHash, blockNumber, header.Time, index, header.BaseFee, s.b.ChainConfig()), nil</span>
<span class="term-fg32">+	rcpt := depositTxReceipt(ctx, blockHash, index, s.b, tx)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, blockHash, blockNumber, header.Time, index, header.BaseFee, s.b.ChainConfig(), rcpt), nil</span>
 }
&nbsp;
 &#47;&#47; GetRawTransactionByHash returns the bytes of the transaction for the given hash.
<span class="term-fg36">@@ -1684,11 +1888,11 @@</span> 	receipt := receipts[index]
&nbsp;
 	&#47;&#47; Derive the sender.
 	signer := types.MakeSigner(s.b.ChainConfig(), header.Number, header.Time)
<span class="term-fg31">-	return marshalReceipt(receipt, blockHash, blockNumber, signer, tx, int(index)), nil</span>
<span class="term-fg32">+	return marshalReceipt(receipt, blockHash, blockNumber, signer, tx, int(index), s.b.ChainConfig()), nil</span>
 }
&nbsp;
 &#47;&#47; marshalReceipt marshals a transaction receipt into a JSON object.
<span class="term-fg31">-func marshalReceipt(receipt *types.Receipt, blockHash common.Hash, blockNumber uint64, signer types.Signer, tx *types.Transaction, txIndex int) map[string]interface{} {</span>
<span class="term-fg32">+func marshalReceipt(receipt *types.Receipt, blockHash common.Hash, blockNumber uint64, signer types.Signer, tx *types.Transaction, txIndex int, chainConfig *params.ChainConfig) map[string]interface{} {</span>
 	from, _ := types.Sender(signer, tx)
&nbsp;
 	fields := map[string]interface{}{
<span class="term-fg36">@@ -1705,6 +1909,21 @@</span> 		&quot;logs&quot;:              receipt.Logs,
 		&quot;logsBloom&quot;:         receipt.Bloom,
 		&quot;type&quot;:              hexutil.Uint(tx.Type()),
 		&quot;effectiveGasPrice&quot;: (*hexutil.Big)(receipt.EffectiveGasPrice),
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if chainConfig.Optimism != nil &amp;&amp; !tx.IsDepositTx() {</span>
<span class="term-fg32">+		fields[&quot;l1GasPrice&quot;] = (*hexutil.Big)(receipt.L1GasPrice)</span>
<span class="term-fg32">+		fields[&quot;l1GasUsed&quot;] = (*hexutil.Big)(receipt.L1GasUsed)</span>
<span class="term-fg32">+		fields[&quot;l1Fee&quot;] = (*hexutil.Big)(receipt.L1Fee)</span>
<span class="term-fg32">+		if receipt.FeeScalar != nil { &#47;&#47; removed in Ecotone</span>
<span class="term-fg32">+			fields[&quot;l1FeeScalar&quot;] = receipt.FeeScalar.String()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if chainConfig.Optimism != nil &amp;&amp; tx.IsDepositTx() &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+		fields[&quot;depositNonce&quot;] = hexutil.Uint64(*receipt.DepositNonce)</span>
<span class="term-fg32">+		if receipt.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+			fields[&quot;depositReceiptVersion&quot;] = hexutil.Uint64(*receipt.DepositReceiptVersion)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	&#47;&#47; Assign receipt status or post state.
<span class="term-fg36">@@ -2108,6 +2327,10 @@</span>
 &#47;&#47; SetHead rewinds the head of the blockchain to a previous block.
 func (api *DebugAPI) SetHead(number hexutil.Uint64) {
 	api.b.SetHead(uint64(number))
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (api *DebugAPI) ChainConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	return api.b.ChainConfig()</span>
 }
&nbsp;
 &#47;&#47; NetAPI offers network related RPC methods</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ab8a03782e8c89f28e24dae9" role="button"
                   aria-expanded="false" aria-controls="id-ab8a03782e8c89f28e24dae9">
                    <code>rpc/errors.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/rpc/errors.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/rpc/errors.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ab8a03782e8c89f28e24dae9"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;errors.go op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg1">index 438aff218c2e306d322160d8be8dcac16dd0dfa2..67c523d11a36294e4448988dc4c906f38541ec04 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;errors.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg36">@@ -73,6 +73,16 @@</span> 	errMsgResponseTooLarge = &quot;response too large&quot;
 	errMsgBatchTooLarge    = &quot;batch too large&quot;
 )
&nbsp;
<span class="term-fg32">+var ErrNoHistoricalFallback = NoHistoricalFallbackError{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type NoHistoricalFallbackError struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) ErrorCode() int { return -32801 }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) Error() string {</span>
<span class="term-fg32">+	return &quot;no historical RPC is available for this historical (pre-bedrock) execution request&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type methodNotFoundError struct{ method string }
&nbsp;
 func (e *methodNotFoundError) ErrorCode() int { return -32601 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-052f592687d0f17d30e532df"role="button" aria-expanded="false" aria-controls="id-052f592687d0f17d30e532df">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tracer RPC daisy-chain</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+59</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-052f592687d0f17d30e532df">
        <div><p>Forward pre-bedrock tracing calls to legacy node.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-393aaf7c825b0c64836b330c" role="button"
                   aria-expanded="false" aria-controls="id-393aaf7c825b0c64836b330c">
                    <code>eth/tracers/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/tracers/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+59</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-393aaf7c825b0c64836b330c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api.go op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">index 4d4428f6c63b7846dad9f5b6cfd94febf2bb4dc6..1a181e4618bb1cfaf3ed60fcd41eedc5fabdbbce 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg36">@@ -22,6 +22,7 @@</span> 	&quot;context&quot;
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;os&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -67,8 +68,6 @@</span> 	&#47;&#47; trace states exceed this limit.
 	maximumPendingTraceStates = 128
 )
&nbsp;
<span class="term-fg31">-var errTxNotFound = errors.New(&quot;transaction not found&quot;)</span>
<span class="term-fg31">-</span>
 &#47;&#47; StateReleaseFunc is used to deallocate resources held by constructing a
 &#47;&#47; historical state for tracing purposes.
 type StateReleaseFunc func()
<span class="term-fg36">@@ -87,6 +86,7 @@</span> 	Engine() consensus.Engine
 	ChainDb() ethdb.Database
 	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, StateReleaseFunc, error)
 	StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, StateReleaseFunc, error)
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
 }
&nbsp;
 &#47;&#47; API is the collection of tracing APIs exposed over the private debugging endpoint.
<span class="term-fg36">@@ -208,6 +208,7 @@</span>
 &#47;&#47; TraceChain returns the structured logs created during the execution of EVM
 &#47;&#47; between two blocks (excluding start) and returns them as a JSON object.
 func (api *API) TraceChain(ctx context.Context, start, end rpc.BlockNumber, config *TraceConfig) (*rpc.Subscription, error) { &#47;&#47; Fetch the block interval that we want to trace
<span class="term-fg32">+	&#47;&#47; TODO: Need to implement a fallback for this</span>
 	from, err := api.blockByNumber(ctx, start)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -266,7 +267,7 @@</span> 			&#47;&#47; Fetch and execute the block trace taskCh
 			for task := range taskCh {
 				var (
 					signer   = types.MakeSigner(api.backend.ChainConfig(), task.block.Number(), task.block.Time())
<span class="term-fg31">-					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				)
 				&#47;&#47; Trace all the transactions contained within
 				for i, tx := range task.block.Transactions() {
<span class="term-fg36">@@ -436,6 +437,20 @@</span> 	block, err := api.blockByNumber(ctx, number)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -446,6 +461,20 @@</span> 	block, err := api.blockByHash(ctx, hash)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByHash&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -495,6 +524,7 @@</span> &#47;&#47; IntermediateRoots executes a block (bad- or canon- or side-), and returns a list
 &#47;&#47; of intermediate roots: the stateroot after each transaction.
 func (api *API) IntermediateRoots(ctx context.Context, hash common.Hash, config *TraceConfig) ([]common.Hash, error) {
 	block, _ := api.blockByHash(ctx, hash)
<span class="term-fg32">+	&#47;&#47; TODO: Cannot get intermediate roots for pre-bedrock block without daisy chain</span>
 	if block == nil {
 		&#47;&#47; Check in the bad blocks
 		block = rawdb.ReadBadBlock(api.backend.ChainDb(), hash)
<span class="term-fg36">@@ -523,7 +553,7 @@</span> 	var (
 		roots              []common.Hash
 		signer             = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		chainConfig        = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		deleteEmptyObjects = chainConfig.IsEIP158(block.Number())
 	)
 	for i, tx := range block.Transactions() {
<span class="term-fg36">@@ -599,7 +629,7 @@</span> 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
 		is158     = api.backend.ChainConfig().IsEIP158(block.Number())
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		results   = make([]*txTraceResult, len(txs))
 	)
<span class="term-fg36">@@ -632,7 +662,6 @@</span> 	&#47;&#47; Execute all the transaction contained within the block concurrently
 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		results   = make([]*txTraceResult, len(txs))
 		pend      sync.WaitGroup
<span class="term-fg36">@@ -648,6 +677,7 @@</span> 		go func() {
 			defer pend.Done()
 			&#47;&#47; Fetch and execute the next transaction trace tasks
 			for task := range jobs {
<span class="term-fg32">+				blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				msg, _ := core.TransactionToMessage(txs[task.index], signer, block.BaseFee())
 				txctx := &amp;Context{
 					BlockHash:   blockHash,
<span class="term-fg36">@@ -667,6 +697,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Feed the transactions into the tracers and return
 	var failed error
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 txloop:
 	for i, tx := range txs {
 		&#47;&#47; Send the trace task over for execution
<span class="term-fg36">@@ -744,7 +775,7 @@</span> 	var (
 		dumps       []string
 		signer      = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		chainConfig = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		canon       = true
 	)
 	&#47;&#47; Check if there are any overrides: the caller may wish to enable a future
<span class="term-fg36">@@ -826,18 +857,29 @@</span>
 &#47;&#47; TraceTransaction returns the structured logs created during the execution of EVM
 &#47;&#47; and returns them as a JSON object.
 func (api *API) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {
<span class="term-fg31">-	found, _, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
<span class="term-fg32">+	_, _, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
 	if err != nil {
 		return nil, ethapi.NewTxIndexingError()
 	}
<span class="term-fg31">-	&#47;&#47; Only mined txes are supported</span>
<span class="term-fg31">-	if !found {</span>
<span class="term-fg31">-		return nil, errTxNotFound</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(new(big.Int).SetUint64(blockNumber)) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult json.RawMessage</span>
<span class="term-fg32">+			err := api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg32">+</span>
 	&#47;&#47; It shouldn&#39;t happen in practice.
 	if blockNumber == 0 {
 		return nil, errors.New(&quot;genesis is not traceable&quot;)
 	}
<span class="term-fg32">+</span>
 	reexec := defaultTraceReexec
 	if config != nil &amp;&amp; config.Reexec != nil {
 		reexec = *config.Reexec
<span class="term-fg36">@@ -894,6 +936,11 @@</span> 	}
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		return nil, errors.New(&quot;l2geth does not have a debug_traceCall method&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; try to recompute the state
 	reexec := defaultTraceReexec
 	if config != nil &amp;&amp; config.Reexec != nil {
<span class="term-fg36">@@ -910,7 +957,7 @@</span> 		return nil, err
 	}
 	defer release()
&nbsp;
<span class="term-fg31">-	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 	&#47;&#47; Apply the customization rules if required.
 	if config != nil {
 		if err := config.StateOverrides.Apply(statedb); err != nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-c30ca0d702400f36cde80337"role="button" aria-expanded="false" aria-controls="id-c30ca0d702400f36cde80337">
        
            <div class="col-12 col-sm-9 text-start"><h3>Daisy Chain tests</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+369</span></div>
                <div class="text-start"><span class="text-danger">-16</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-c30ca0d702400f36cde80337">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-38a5ca02d76b944b38d95b74" role="button"
                   aria-expanded="false" aria-controls="id-38a5ca02d76b944b38d95b74">
                    <code>internal/ethapi/transaction_args_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/ethapi/transaction_args_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/ethapi/transaction_args_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-38a5ca02d76b944b38d95b74"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">index f0fdb6d8ee2d4e3b3f3165ae5ef6d2ff676e00e7..5248546e3a5eb06c665040c1b7052da6dbd22ba5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg36">@@ -405,4 +405,6 @@</span> func (b *backendMock) SubscribeRemovedLogsEvent(ch chan&lt;- core.RemovedLogsEvent) event.Subscription {
 	return nil
 }
&nbsp;
<span class="term-fg31">-func (b *backendMock) Engine() consensus.Engine { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Engine() consensus.Engine          { return nil }</span>
<span class="term-fg32">+func (b *backendMock) HistoricalRPCService() *rpc.Client { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Genesis() *types.Block             { return nil }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f36a8260a8464497a67c4462" role="button"
                   aria-expanded="false" aria-controls="id-f36a8260a8464497a67c4462">
                    <code>ethclient/ethclient_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/ethclient/ethclient_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/ethclient/ethclient_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+176</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f36a8260a8464497a67c4462"><span class="term-fg1">diff --git go-ethereum&#47;ethclient&#47;ethclient_test.go op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">index fd053c1d73d66ea2decfd27c8b8295c98a535402..84ae79a8df8f1e20656b585a48f39ec608739963 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">+++ op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg36">@@ -20,10 +20,18 @@</span> import (
 	&quot;bytes&quot;
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;beacon&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -193,6 +201,21 @@</span> 	Timestamp: 9000,
 	BaseFee:   big.NewInt(params.InitialBaseFee),
 }
&nbsp;
<span class="term-fg32">+var genesisForHistorical = &amp;core.Genesis{</span>
<span class="term-fg32">+	Config:    params.OptimismTestConfig,</span>
<span class="term-fg32">+	Alloc:     core.GenesisAlloc{testAddr: {Balance: testBalance}},</span>
<span class="term-fg32">+	ExtraData: []byte(&quot;test genesis&quot;),</span>
<span class="term-fg32">+	Timestamp: 9000,</span>
<span class="term-fg32">+	BaseFee:   big.NewInt(params.InitialBaseFee),</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var depositTx = types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+	Value: big.NewInt(12),</span>
<span class="term-fg32">+	Gas:   params.TxGas + 2000,</span>
<span class="term-fg32">+	To:    &amp;common.Address{2},</span>
<span class="term-fg32">+	Data:  make([]byte, 500),</span>
<span class="term-fg32">+})</span>
<span class="term-fg32">+</span>
 var testTx1 = types.MustSignNewTx(testKey, types.LatestSigner(genesis.Config), &amp;types.LegacyTx{
 	Nonce:    0,
 	Value:    big.NewInt(12),
<span class="term-fg36">@@ -209,9 +232,77 @@</span> 	Gas:      params.TxGas,
 	To:       &amp;common.Address{2},
 })
&nbsp;
<span class="term-fg31">-func newTestBackend(t *testing.T) (*node.Node, []*types.Block) {</span>
<span class="term-fg31">-	&#47;&#47; Generate test chain.</span>
<span class="term-fg31">-	blocks := generateTestChain()</span>
<span class="term-fg32">+type mockHistoricalBackend struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) Call(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *ethapi.StateOverride) (hexutil.Bytes, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Bytes(&quot;test&quot;), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) EstimateGas(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash *rpc.BlockNumberOrHash) (hexutil.Uint64, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Uint64(12345), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;eth&quot;,</span>
<span class="term-fg32">+			Service:       new(mockHistoricalBackend),</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newTestBackend(t *testing.T, enableHistoricalState bool) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+	histAddr := newMockHistoricalBackend(t)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var consensusEngine consensus.Engine</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	var chainLength int</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+		consensusEngine = beacon.New(ethash.NewFaker())</span>
<span class="term-fg32">+		chainLength = 10</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+		consensusEngine = ethash.NewFaker()</span>
<span class="term-fg32">+		chainLength = 2</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Generate test chain</span>
<span class="term-fg32">+	blocks := generateTestChain(consensusEngine, actualGenesis, chainLength)</span>
&nbsp;
 	&#47;&#47; Create node
 	n, err := node.New(&amp;node.Config{})
<span class="term-fg36">@@ -219,11 +310,18 @@</span> 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new node: %v&quot;, err)
 	}
 	&#47;&#47; Create Ethereum Service
<span class="term-fg31">-	config := &amp;ethconfig.Config{Genesis: genesis}</span>
<span class="term-fg32">+	config := &amp;ethconfig.Config{Genesis: actualGenesis}</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		config.RollupHistoricalRPC = histAddr</span>
<span class="term-fg32">+		config.RollupHistoricalRPCTimeout = time.Second * 5</span>
<span class="term-fg32">+	}</span>
 	ethservice, err := eth.New(n, config)
 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new ethereum service: %v&quot;, err)
 	}
<span class="term-fg32">+	if enableHistoricalState { &#47;&#47; swap to the pre-bedrock consensus-engine that we used to generate the historical blocks</span>
<span class="term-fg32">+		ethservice.BlockChain().Engine().(*beacon.Beacon).SwapInner(ethash.NewFaker())</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Import the test chain.
 	if err := n.Start(); err != nil {
 		t.Fatalf(&quot;can&#39;t start test node: %v&quot;, err)
<span class="term-fg36">@@ -231,6 +329,7 @@</span> 	}
 	if _, err := ethservice.BlockChain().InsertChain(blocks[1:]); err != nil {
 		t.Fatalf(&quot;can&#39;t import test blocks: %v&quot;, err)
 	}
<span class="term-fg32">+</span>
 	&#47;&#47; Ensure the tx indexing is fully generated
 	for ; ; time.Sleep(time.Millisecond * 100) {
 		progress, err := ethservice.BlockChain().TxIndexProgress()
<span class="term-fg36">@@ -238,25 +337,44 @@</span> 		if err == nil &amp;&amp; progress.Done() {
 			break
 		}
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		&#47;&#47; Now that we have a filled DB, swap the pre-Bedrock consensus to OpLegacy,</span>
<span class="term-fg32">+		&#47;&#47; which does not support re-processing of pre-bedrock data.</span>
<span class="term-fg32">+		ethservice.Engine().(*beacon.Beacon).SwapInner(&amp;beacon.OpLegacy{})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return n, blocks
 }
&nbsp;
<span class="term-fg31">-func generateTestChain() []*types.Block {</span>
<span class="term-fg32">+func generateTestChain(consensusEngine consensus.Engine, genesis *core.Genesis, length int) []*types.Block {</span>
 	generate := func(i int, g *core.BlockGen) {
 		g.OffsetTime(5)
 		g.SetExtra([]byte(&quot;test&quot;))
 		if i == 1 {
 			&#47;&#47; Test transactions are included in block #2.
<span class="term-fg32">+			if genesis.Config.Optimism != nil &amp;&amp; genesis.Config.IsBedrock(big.NewInt(1)) {</span>
<span class="term-fg32">+				g.AddTx(depositTx)</span>
<span class="term-fg32">+			}</span>
 			g.AddTx(testTx1)
 			g.AddTx(testTx2)
 		}
 	}
<span class="term-fg31">-	_, blocks, _ := core.GenerateChainWithGenesis(genesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg32">+	_, blocks, _ := core.GenerateChainWithGenesis(genesis, consensusEngine, length, generate)</span>
 	return append([]*types.Block{genesis.ToBlock()}, blocks...)
 }
&nbsp;
<span class="term-fg32">+func TestEthClientHistoricalBackend(t *testing.T) {</span>
<span class="term-fg32">+	backend, _ := newTestBackend(t, true)</span>
<span class="term-fg32">+	client := backend.Attach()</span>
<span class="term-fg32">+	defer backend.Close()</span>
<span class="term-fg32">+	defer client.Close()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	testHistoricalRPC(t, client)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func TestEthClient(t *testing.T) {
<span class="term-fg31">-	backend, chain := newTestBackend(t)</span>
<span class="term-fg32">+	backend, chain := newTestBackend(t, false)</span>
 	client := backend.Attach()
 	defer backend.Close()
 	defer client.Close()
<span class="term-fg36">@@ -293,6 +411,9 @@</span> 			func(t *testing.T) { testAtFunctions(t, client) },
 		},
 		&quot;TransactionSender&quot;: {
 			func(t *testing.T) { testTransactionSender(t, client) },
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&quot;EstimateGas&quot;: {</span>
<span class="term-fg32">+			func(t *testing.T) { testEstimateGas(t, client) },</span>
 		},
 	}
&nbsp;
<span class="term-fg36">@@ -729,6 +850,54 @@</span> 		t.Fatal(err)
 	}
 	if sender2 != testAddr {
 		t.Fatal(&quot;wrong sender:&quot;, sender2)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testEstimateGas(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; EstimateGas</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	gas, err := ec.EstimateGas(context.Background(), msg)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gas != 21000 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected gas price: %v&quot;, gas)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testHistoricalRPC(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Estimate Gas RPC</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var res hexutil.Uint64</span>
<span class="term-fg32">+	err := client.CallContext(context.Background(), &amp;res, &quot;eth_estimateGas&quot;, toCallArg(msg), rpc.BlockNumberOrHashWithNumber(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if res != 12345 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;invalid result: %d&quot;, res)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Call Contract RPC</span>
<span class="term-fg32">+	histVal, err := ec.CallContract(context.Background(), msg, big.NewInt(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if string(histVal) != &quot;test&quot; {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected %s to equal test&quot;, string(histVal))</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-846d6b2d4275c039b83022d4" role="button"
                   aria-expanded="false" aria-controls="id-846d6b2d4275c039b83022d4">
                    <code>eth/tracers/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/tracers/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+190</span></div>
                        <div class="text-start"><span class="text-danger">-8</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-846d6b2d4275c039b83022d4"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api_test.go op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">index 8aaa20fce536865a7acc9caa13661999cb37de06..7e8551afdb16341b60cacb943143a3721024ff44 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg36">@@ -23,11 +23,14 @@</span> 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg36">@@ -41,8 +44,10 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;mock&quot;</span>
 	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;
 )
&nbsp;
<span class="term-fg36">@@ -51,6 +56,66 @@</span> 	errStateNotFound = errors.New(&quot;state not found&quot;)
 	errBlockNotFound = errors.New(&quot;block not found&quot;)
 )
&nbsp;
<span class="term-fg32">+type mockHistoricalBackend struct {</span>
<span class="term-fg32">+	mock.Mock</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; mockHistoricalBackend does not have a TraceCall, because pre-bedrock there is no debug_traceCall available</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceBlockByNumber(ctx context.Context, number rpc.BlockNumber, config *TraceConfig) ([]*txTraceResult, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+	return ret[0].([]*txTraceResult), *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceBlockByNumber(number rpc.BlockNumber, config *TraceConfig, out []*txTraceResult, err error) {</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceBlockByNumber&quot;, number, config).Once().Return(out, &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+	return ret[0], *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceTransaction(hash common.Hash, config *TraceConfig, out interface{}, err error) {</span>
<span class="term-fg32">+	jsonOut, _ := json.Marshal(out)</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceTransaction&quot;, hash, config).Once().Return(json.RawMessage(jsonOut), &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T, backend *mockHistoricalBackend) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;debug&quot;,</span>
<span class="term-fg32">+			Service:       backend,</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type testBackend struct {
 	chainConfig *params.ChainConfig
 	engine      consensus.Engine
<span class="term-fg36">@@ -59,15 +124,28 @@</span> 	chain       *core.BlockChain
&nbsp;
 	refHook func() &#47;&#47; Hook is invoked when the requested state is referenced
 	relHook func() &#47;&#47; Hook is invoked when the requested state is released
<span class="term-fg32">+</span>
<span class="term-fg32">+	historical     *rpc.Client</span>
<span class="term-fg32">+	mockHistorical *mockHistoricalBackend</span>
 }
&nbsp;
 &#47;&#47; testBackend creates a new test backend. OBS: After test is done, teardown must be
 &#47;&#47; invoked in order to release associated resources.
 func newTestBackend(t *testing.T, n int, gspec *core.Genesis, generator func(i int, b *core.BlockGen)) *testBackend {
<span class="term-fg32">+	mock := new(mockHistoricalBackend)</span>
<span class="term-fg32">+	historicalAddr := newMockHistoricalBackend(t, mock)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	historicalClient, err := rpc.Dial(historicalAddr)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error making historical client: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	backend := &amp;testBackend{
<span class="term-fg31">-		chainConfig: gspec.Config,</span>
<span class="term-fg31">-		engine:      ethash.NewFaker(),</span>
<span class="term-fg31">-		chaindb:     rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		chainConfig:    gspec.Config,</span>
<span class="term-fg32">+		engine:         ethash.NewFaker(),</span>
<span class="term-fg32">+		chaindb:        rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		historical:     historicalClient,</span>
<span class="term-fg32">+		mockHistorical: mock,</span>
 	}
 	&#47;&#47; Generate blocks for testing
 	_, blocks, _ := core.GenerateChainWithGenesis(gspec, backend.engine, n, generator)
<span class="term-fg36">@@ -172,7 +250,7 @@</span> 	signer := types.MakeSigner(b.chainConfig, block.Number(), block.Time())
 	for idx, tx := range block.Transactions() {
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), b.chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), b.chain, nil, b.chainConfig, statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}
<span class="term-fg36">@@ -183,6 +261,10 @@</span> 		}
 		statedb.Finalise(vmenv.ChainConfig().IsEIP158(block.Number()))
 	}
 	return nil, vm.BlockContext{}, nil, nil, fmt.Errorf(&quot;transaction index %d out of range for block %#x&quot;, txIndex, block.Hash())
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.historical</span>
 }
&nbsp;
 func TestTraceCall(t *testing.T) {
<span class="term-fg36">@@ -450,11 +532,58 @@</span> 		StructLogs:  []logger.StructLogRes{},
 	}) {
 		t.Error(&quot;Transaction tracing result is different&quot;)
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestTraceTransactionHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; Test non-existent transaction</span>
<span class="term-fg31">-	_, err = api.TraceTransaction(context.Background(), common.Hash{42}, nil)</span>
<span class="term-fg31">-	if !errors.Is(err, errTxNotFound) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;want %v, have %v&quot;, errTxNotFound, err)</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(2)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	target := common.Hash{}</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, 1, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+		target = tx.Hash()</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceTransaction(</span>
<span class="term-fg32">+		target,</span>
<span class="term-fg32">+		nil,</span>
<span class="term-fg32">+		logger.ExecutionResult{</span>
<span class="term-fg32">+			Gas:         params.TxGas,</span>
<span class="term-fg32">+			Failed:      false,</span>
<span class="term-fg32">+			ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+			StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		nil)</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+	result, err := api.TraceTransaction(context.Background(), target, nil)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;Failed to trace transaction %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var have *logger.ExecutionResult</span>
<span class="term-fg32">+	spew.Dump(result)</span>
<span class="term-fg32">+	if err := json.Unmarshal(result.(json.RawMessage), &amp;have); err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;failed to unmarshal result %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if !reflect.DeepEqual(have, &amp;logger.ExecutionResult{</span>
<span class="term-fg32">+		Gas:         params.TxGas,</span>
<span class="term-fg32">+		Failed:      false,</span>
<span class="term-fg32">+		ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+		StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+	}) {</span>
<span class="term-fg32">+		t.Error(&quot;Transaction tracing result is different&quot;)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -545,6 +674,59 @@</span> 		want := tc.want
 		if string(have) != want {
 			t.Errorf(&quot;test %d, result mismatch, have\n%v\n, want\n%v\n&quot;, i, string(have), want)
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTraceBlockHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(3)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[2].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	genBlocks := 10</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, genBlocks, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var expectErr error</span>
<span class="term-fg32">+	var config *TraceConfig</span>
<span class="term-fg32">+	blockNumber := rpc.BlockNumber(3)</span>
<span class="term-fg32">+	want := `[{&quot;txHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;result&quot;:{&quot;failed&quot;:false,&quot;gas&quot;:21000,&quot;returnValue&quot;:&quot;&quot;,&quot;structLogs&quot;:[]}}]`</span>
<span class="term-fg32">+	var ret []*txTraceResult</span>
<span class="term-fg32">+	_ = json.Unmarshal([]byte(want), &amp;ret)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceBlockByNumber(blockNumber, config, ret, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := api.TraceBlockByNumber(context.Background(), blockNumber, config)</span>
<span class="term-fg32">+	if expectErr != nil {</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			t.Errorf(&quot;want error %v&quot;, expectErr)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !reflect.DeepEqual(err, expectErr) {</span>
<span class="term-fg32">+			t.Errorf(&quot;error mismatch, want %v, get %v&quot;, expectErr, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;want no error, have %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	have, _ := json.Marshal(result)</span>
<span class="term-fg32">+	if string(have) != want {</span>
<span class="term-fg32">+		t.Errorf(&quot;result mismatch, have\n%v\n, want\n%v\n&quot;, string(have), want)</span>
 	}
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-ae92fd7d9cb90307bbf7c06e"role="button" aria-expanded="false" aria-controls="id-ae92fd7d9cb90307bbf7c06e">
        
            <div class="col-12 col-sm-9 text-start"><h3>Debug API</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-ae92fd7d9cb90307bbf7c06e">
        <div><p>Fix Debug API block marshaling to include deposits</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-91ca39587e60a67fce3755e6" role="button"
                   aria-expanded="false" aria-controls="id-91ca39587e60a67fce3755e6">
                    <code>eth/api_debug.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/api_debug.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/api_debug.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-91ca39587e60a67fce3755e6"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api_debug.go op-geth&#47;eth&#47;api_debug.go</span>
<span class="term-fg1">index 05010a3969c61befb62d4bc2f413ddd72609851f..7d98e1f98f47860d3443f608c2921f1a00e6bbc5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api_debug.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api_debug.go</span>
<span class="term-fg36">@@ -119,7 +119,10 @@</span> 			blockRlp = err.Error() &#47;&#47; Hacky, but hey, it works
 		} else {
 			blockRlp = fmt.Sprintf(&quot;%#x&quot;, rlpBytes)
 		}
<span class="term-fg31">-		blockJSON = ethapi.RPCMarshalBlock(block, true, true, api.eth.APIBackend.ChainConfig())</span>
<span class="term-fg32">+		var err error</span>
<span class="term-fg32">+		if blockJSON, err = ethapi.RPCMarshalBlock(ctx, block, true, true, api.eth.APIBackend.ChainConfig(), api.eth.APIBackend); err != nil {</span>
<span class="term-fg32">+			blockJSON = map[string]interface{}{&quot;error&quot;: err.Error()}</span>
<span class="term-fg32">+		}</span>
 		results = append(results, &amp;BadBlockArgs{
 			Hash:  block.Hash(),
 			RLP:   blockRlp,</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-9fef19082e47f77730727209"role="button" aria-expanded="false" aria-controls="id-9fef19082e47f77730727209">
        
            <div class="col-12 col-sm-9 text-start"><h3>Eth gasprice suggestions</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+139</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-9fef19082e47f77730727209">
        <div><p>gasprice suggestion adjustments to accommodate faster L2 blocks and lower fees.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a1010b509a71322356d34cd8" role="button"
                   aria-expanded="false" aria-controls="id-a1010b509a71322356d34cd8">
                    <code>eth/gasprice/gasprice.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/gasprice/gasprice.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/gasprice/gasprice.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+29</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a1010b509a71322356d34cd8"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;gasprice.go op-geth&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg1">index b71964981145fa58b7894a2be4637d8a7e2a6c9a..e8ef6c7459ecd92841f902d54f9bf124930053df 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg36">@@ -37,6 +37,8 @@</span>
 var (
 	DefaultMaxPrice    = big.NewInt(500 * params.GWei)
 	DefaultIgnorePrice = big.NewInt(2 * params.Wei)
<span class="term-fg32">+</span>
<span class="term-fg32">+	DefaultMinSuggestedPriorityFee = big.NewInt(1e6 * params.Wei) &#47;&#47; 0.001 gwei, for Optimism fee suggestion</span>
 )
&nbsp;
 type Config struct {
<span class="term-fg36">@@ -47,6 +49,8 @@</span> 	MaxBlockHistory  uint64
 	Default          *big.Int `toml:&quot;,omitempty&quot;`
 	MaxPrice         *big.Int `toml:&quot;,omitempty&quot;`
 	IgnorePrice      *big.Int `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	MinSuggestedPriorityFee *big.Int `toml:&quot;,omitempty&quot;` &#47;&#47; for Optimism fee suggestion</span>
 }
&nbsp;
 &#47;&#47; OracleBackend includes all necessary background APIs for oracle.
<span class="term-fg36">@@ -74,6 +78,8 @@</span> 	checkBlocks, percentile           int
 	maxHeaderHistory, maxBlockHistory uint64
&nbsp;
 	historyCache *lru.Cache[cacheKey, processedFees]
<span class="term-fg32">+</span>
<span class="term-fg32">+	minSuggestedPriorityFee *big.Int &#47;&#47; for Optimism fee suggestion</span>
 }
&nbsp;
 &#47;&#47; NewOracle returns a new gasprice oracle which can recommend suitable
<span class="term-fg36">@@ -128,7 +134,7 @@</span> 			lastHead = ev.Block.Hash()
 		}
 	}()
&nbsp;
<span class="term-fg31">-	return &amp;Oracle{</span>
<span class="term-fg32">+	r := &amp;Oracle{</span>
 		backend:          backend,
 		lastPrice:        params.Default,
 		maxPrice:         maxPrice,
<span class="term-fg36">@@ -139,6 +145,17 @@</span> 		maxHeaderHistory: maxHeaderHistory,
 		maxBlockHistory:  maxBlockHistory,
 		historyCache:     cache,
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if backend.ChainConfig().IsOptimism() {</span>
<span class="term-fg32">+		r.minSuggestedPriorityFee = params.MinSuggestedPriorityFee</span>
<span class="term-fg32">+		if r.minSuggestedPriorityFee == nil || r.minSuggestedPriorityFee.Int64() &lt;= 0 {</span>
<span class="term-fg32">+			r.minSuggestedPriorityFee = DefaultMinSuggestedPriorityFee</span>
<span class="term-fg32">+			log.Warn(&quot;Sanitizing invalid optimism gasprice oracle min priority fee suggestion&quot;,</span>
<span class="term-fg32">+				&quot;provided&quot;, params.MinSuggestedPriorityFee,</span>
<span class="term-fg32">+				&quot;updated&quot;, r.minSuggestedPriorityFee)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return r</span>
 }
&nbsp;
 &#47;&#47; SuggestTipCap returns a tip cap so that newly created transaction can have a
<span class="term-fg36">@@ -168,6 +185,11 @@</span> 	oracle.cacheLock.RUnlock()
 	if headHash == lastHead {
 		return new(big.Int).Set(lastPrice), nil
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if oracle.backend.ChainConfig().IsOptimism() {</span>
<span class="term-fg32">+		return oracle.SuggestOptimismPriorityFee(ctx, head, headHash), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var (
 		sent, exp int
 		number    = head.Number.Uint64()
<span class="term-fg36">@@ -274,3 +296,9 @@</span> 	case result &lt;- results{prices, nil}:
 	case &lt;-quit:
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+type bigIntArray []*big.Int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (s bigIntArray) Len() int           { return len(s) }</span>
<span class="term-fg32">+func (s bigIntArray) Less(i, j int) bool { return s[i].Cmp(s[j]) &lt; 0 }</span>
<span class="term-fg32">+func (s bigIntArray) Swap(i, j int)      { s[i], s[j] = s[j], s[i] }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-55dd7bc560eedc7940ea8b88" role="button"
                   aria-expanded="false" aria-controls="id-55dd7bc560eedc7940ea8b88">
                    <code>eth/gasprice/optimism-gasprice.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/gasprice/optimism-gasprice.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+110</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-55dd7bc560eedc7940ea8b88"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;optimism-gasprice.go op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..71cd021f637f92e4b6d99ec5fc337d27edf547e5</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice.go</span>
<span class="term-fg36">@@ -0,0 +1,110 @@</span>
<span class="term-fg32">+package gasprice</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;context&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;sort&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; SuggestOptimismPriorityFee returns a max priority fee value that can be used such that newly</span>
<span class="term-fg32">+&#47;&#47; created transactions have a very high chance to be included in the following blocks, using a</span>
<span class="term-fg32">+&#47;&#47; simplified and more predictable algorithm appropriate for chains like Optimism with a single</span>
<span class="term-fg32">+&#47;&#47; known block builder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; In the typical case, which results whenever the last block had room for more transactions, this</span>
<span class="term-fg32">+&#47;&#47; function returns a minimum suggested priority fee value. Otherwise it returns the higher of this</span>
<span class="term-fg32">+&#47;&#47; minimum suggestion or 10% over the median effective priority fee from the last block.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Rationale: For a chain such as Optimism where there is a single block builder whose behavior is</span>
<span class="term-fg32">+&#47;&#47; known, we know priority fee (as long as it is non-zero) has no impact on the probability for tx</span>
<span class="term-fg32">+&#47;&#47; inclusion as long as there is capacity for it in the block. In this case then, there&#39;s no reason</span>
<span class="term-fg32">+&#47;&#47; to return any value higher than some fixed minimum. Blocks typically reach capacity only under</span>
<span class="term-fg32">+&#47;&#47; extreme events such as airdrops, meaning predicting whether the next block is going to be at</span>
<span class="term-fg32">+&#47;&#47; capacity is difficult *except* in the case where we&#39;re already experiencing the increased demand</span>
<span class="term-fg32">+&#47;&#47; from such an event. We therefore expect whether the last known block is at capacity to be one of</span>
<span class="term-fg32">+&#47;&#47; the best predictors of whether the next block is likely to be at capacity. (An even better</span>
<span class="term-fg32">+&#47;&#47; predictor is to look at the state of the transaction pool, but we want an algorithm that works</span>
<span class="term-fg32">+&#47;&#47; even if the txpool is private or unavailable.)</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; In the event the next block may be at capacity, the algorithm should allow for average fees to</span>
<span class="term-fg32">+&#47;&#47; rise in order to reach a market price that appropriately reflects demand. We accomplish this by</span>
<span class="term-fg32">+&#47;&#47; returning a suggestion that is a significant amount (10%) higher than the median effective</span>
<span class="term-fg32">+&#47;&#47; priority fee from the previous block.</span>
<span class="term-fg32">+func (oracle *Oracle) SuggestOptimismPriorityFee(ctx context.Context, h *types.Header, headHash common.Hash) *big.Int {</span>
<span class="term-fg32">+	suggestion := new(big.Int).Set(oracle.minSuggestedPriorityFee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; find the maximum gas used by any of the transactions in the block to use as the capacity</span>
<span class="term-fg32">+	&#47;&#47; margin</span>
<span class="term-fg32">+	receipts, err := oracle.backend.GetReceipts(ctx, headHash)</span>
<span class="term-fg32">+	if receipts == nil || err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;failed to get block receipts&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		return suggestion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var maxTxGasUsed uint64</span>
<span class="term-fg32">+	for i := range receipts {</span>
<span class="term-fg32">+		gu := receipts[i].GasUsed</span>
<span class="term-fg32">+		if gu &gt; maxTxGasUsed {</span>
<span class="term-fg32">+			maxTxGasUsed = gu</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; sanity check the max gas used value</span>
<span class="term-fg32">+	if maxTxGasUsed &gt; h.GasLimit {</span>
<span class="term-fg32">+		log.Error(&quot;found tx consuming more gas than the block limit&quot;, &quot;gas&quot;, maxTxGasUsed)</span>
<span class="term-fg32">+		return suggestion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if h.GasUsed+maxTxGasUsed &gt; h.GasLimit {</span>
<span class="term-fg32">+		&#47;&#47; A block is &quot;at capacity&quot; if, when it is built, there is a pending tx in the txpool that</span>
<span class="term-fg32">+		&#47;&#47; could not be included because the block&#39;s gas limit would be exceeded. Since we don&#39;t</span>
<span class="term-fg32">+		&#47;&#47; have access to the txpool, we instead adopt the following heuristic: consider a block as</span>
<span class="term-fg32">+		&#47;&#47; at capacity if the total gas consumed by its transactions is within max-tx-gas-used of</span>
<span class="term-fg32">+		&#47;&#47; the block limit, where max-tx-gas-used is the most gas used by any one transaction</span>
<span class="term-fg32">+		&#47;&#47; within the block. This heuristic is almost perfectly accurate when transactions always</span>
<span class="term-fg32">+		&#47;&#47; consume the same amount of gas, but becomes less accurate as tx gas consumption begins</span>
<span class="term-fg32">+		&#47;&#47; to vary. The typical error is we assume a block is at capacity when it was not because</span>
<span class="term-fg32">+		&#47;&#47; max-tx-gas-used will in most cases over-estimate the &quot;capacity margin&quot;. But it&#39;s better</span>
<span class="term-fg32">+		&#47;&#47; to err on the side of returning a higher-than-needed suggestion than a lower-than-needed</span>
<span class="term-fg32">+		&#47;&#47; one in order to satisfy our desire for high chance of inclusion and rising fees under</span>
<span class="term-fg32">+		&#47;&#47; high demand.</span>
<span class="term-fg32">+		block, err := oracle.backend.BlockByNumber(ctx, rpc.BlockNumber(h.Number.Int64()))</span>
<span class="term-fg32">+		if block == nil || err != nil {</span>
<span class="term-fg32">+			log.Error(&quot;failed to get last block&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+			return suggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		baseFee := block.BaseFee()</span>
<span class="term-fg32">+		txs := block.Transactions()</span>
<span class="term-fg32">+		if len(txs) == 0 {</span>
<span class="term-fg32">+			log.Error(&quot;block was at capacity but doesn&#39;t have transactions&quot;)</span>
<span class="term-fg32">+			return suggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		tips := bigIntArray(make([]*big.Int, len(txs)))</span>
<span class="term-fg32">+		for i := range txs {</span>
<span class="term-fg32">+			tips[i] = txs[i].EffectiveGasTipValue(baseFee)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		sort.Sort(tips)</span>
<span class="term-fg32">+		median := tips[len(tips)&#47;2]</span>
<span class="term-fg32">+		newSuggestion := new(big.Int).Add(median, new(big.Int).Div(median, big.NewInt(10)))</span>
<span class="term-fg32">+		&#47;&#47; use the new suggestion only if it&#39;s bigger than the minimum</span>
<span class="term-fg32">+		if newSuggestion.Cmp(suggestion) &gt; 0 {</span>
<span class="term-fg32">+			suggestion = newSuggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; the suggestion should be capped by oracle.maxPrice</span>
<span class="term-fg32">+	if suggestion.Cmp(oracle.maxPrice) &gt; 0 {</span>
<span class="term-fg32">+		suggestion.Set(oracle.maxPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	oracle.cacheLock.Lock()</span>
<span class="term-fg32">+	oracle.lastHead = headHash</span>
<span class="term-fg32">+	oracle.lastPrice = suggestion</span>
<span class="term-fg32">+	oracle.cacheLock.Unlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return new(big.Int).Set(suggestion)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-dfbbfffb77c73c78f33bb038"role="button" aria-expanded="false" aria-controls="id-dfbbfffb77c73c78f33bb038">
        
            <div class="col-12 col-sm-9 text-start"><h3>API testvector fix</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-dfbbfffb77c73c78f33bb038">
        <div><p>Upstream test of broken behavior; in Optimism, a zero signature is valid (pre-bedrock for deposit-txs),
and the chain ID formula on signature data must not be used, or an underflow happens.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-31d57e3101c5c06ee59285a0" role="button"
                   aria-expanded="false" aria-controls="id-31d57e3101c5c06ee59285a0">
                    <code>internal/ethapi/testdata/eth_getBlockByNumber-tag-pending-fullTx.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/ethapi/testdata/eth_getBlockByNumber-tag-pending-fullTx.json" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/ethapi/testdata/eth_getBlockByNumber-tag-pending-fullTx.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-31d57e3101c5c06ee59285a0"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json op-geth&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json</span>
<span class="term-fg1">index 1d524d6eced19249ab7f1d7beeb04863087e81c1..7087932286ea7facdae1e56caf15e618b5307e71 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json</span>
<span class="term-fg36">@@ -30,7 +30,7 @@</span>       &quot;to&quot;: &quot;0x0d3ab14bbad3d99f4203bd7a11acb94882050e7e&quot;,
       &quot;transactionIndex&quot;: &quot;0x0&quot;,
       &quot;value&quot;: &quot;0x6f&quot;,
       &quot;type&quot;: &quot;0x0&quot;,
<span class="term-fg31">-      &quot;chainId&quot;: &quot;0x7fffffffffffffee&quot;,</span>
<span class="term-fg32">+      &quot;chainId&quot;: &quot;0x1&quot;,</span>
       &quot;v&quot;: &quot;0x0&quot;,
       &quot;r&quot;: &quot;0x0&quot;,
       &quot;s&quot;: &quot;0x0&quot;</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4f1b5dcfc05f89920d2f0277"role="button" aria-expanded="false" aria-controls="id-4f1b5dcfc05f89920d2f0277">
        
            <div class="col-12 col-sm-9 text-start"><h2>Geth extras</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+40</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4f1b5dcfc05f89920d2f0277">
        <div><p>Extend the tools available in geth to improve external testing and tooling.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-07436f02353acad00d4cc1e0"role="button" aria-expanded="false" aria-controls="id-07436f02353acad00d4cc1e0">
        
            <div class="col-12 col-sm-9 text-start"><h3>Simulated Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+40</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-07436f02353acad00d4cc1e0">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-231e26e44e1efd2542a68608" role="button"
                   aria-expanded="false" aria-controls="id-231e26e44e1efd2542a68608">
                    <code>accounts/abi/bind/backends/simulated.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/accounts/abi/bind/backends/simulated.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/accounts/abi/bind/backends/simulated.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-231e26e44e1efd2542a68608"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">index 756a9d355264e48bc78fa35c28f85dcc56f683b3..cbfd27b0a75c92ac21623863564e6f6138b63f59 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg36">@@ -21,6 +21,7 @@</span> 	&quot;context&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;ethconfig&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethclient&#47;simulated&quot;
 )
&nbsp;
<span class="term-fg36">@@ -50,3 +51,11 @@</span> 		Backend: b,
 		Client:  b.Client(),
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func NewSimulatedBackendFromConfig(cfg ethconfig.Config) *SimulatedBackend {</span>
<span class="term-fg32">+	b := simulated.NewBackendFromConfig(cfg)</span>
<span class="term-fg32">+	return &amp;SimulatedBackend{</span>
<span class="term-fg32">+		Backend: b,</span>
<span class="term-fg32">+		Client:  b.Client(),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b6cc5678425c0f25259b2b4e" role="button"
                   aria-expanded="false" aria-controls="id-b6cc5678425c0f25259b2b4e">
                    <code>ethclient/simulated/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/ethclient/simulated/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/ethclient/simulated/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+31</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b6cc5678425c0f25259b2b4e"><span class="term-fg1">diff --git go-ethereum&#47;ethclient&#47;simulated&#47;backend.go op-geth&#47;ethclient&#47;simulated&#47;backend.go</span>
<span class="term-fg1">index 6169dde61b4ccc231b0cd9d149dfd7bb40adf191..ed7a85cc8be6cc9c23a9bdb887b6af8b94b07350 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethclient&#47;simulated&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;ethclient&#47;simulated&#47;backend.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package simulated
&nbsp;
 import (
<span class="term-fg32">+	&quot;errors&quot;</span>
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
<span class="term-fg36">@@ -61,7 +62,7 @@</span>
 &#47;&#47; Backend is a simulated blockchain. You can use it to test your contracts or
 &#47;&#47; other code that interacts with the Ethereum chain.
 type Backend struct {
<span class="term-fg31">-	eth    *eth.Ethereum</span>
<span class="term-fg32">+	node   *node.Node</span>
 	beacon *catalyst.SimulatedBeacon
 	client simClient
 }
<span class="term-fg36">@@ -101,6 +102,27 @@</span> 	}
 	return sim
 }
&nbsp;
<span class="term-fg32">+func NewBackendFromConfig(conf ethconfig.Config) *Backend {</span>
<span class="term-fg32">+	&#47;&#47; Setup the node object</span>
<span class="term-fg32">+	nodeConf := node.DefaultConfig</span>
<span class="term-fg32">+	nodeConf.DataDir = &quot;&quot;</span>
<span class="term-fg32">+	nodeConf.P2P = p2p.Config{NoDiscovery: true}</span>
<span class="term-fg32">+	stack, err := node.New(&amp;nodeConf)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		&#47;&#47; This should never happen, if it does, please open an issue</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	conf.SyncMode = downloader.FullSync</span>
<span class="term-fg32">+	conf.TxPool.NoLocals = true</span>
<span class="term-fg32">+	sim, err := newWithNode(stack, &amp;conf, 0)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		&#47;&#47; This should never happen, if it does, please open an issue</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return sim</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; newWithNode sets up a simulated backend on an existing node. The provided node
 &#47;&#47; must not be started and will be started by this method.
 func newWithNode(stack *node.Node, conf *eth.Config, blockPeriod uint64) (*Backend, error) {
<span class="term-fg36">@@ -128,7 +150,7 @@</span> 	if err := beacon.Fork(backend.BlockChain().GetCanonicalHash(0)); err != nil {
 		return nil, err
 	}
 	return &amp;Backend{
<span class="term-fg31">-		eth:    backend,</span>
<span class="term-fg32">+		node:   stack,</span>
 		beacon: beacon,
 		client: simClient{ethclient.NewClient(stack.Attach())},
 	}, nil
<span class="term-fg36">@@ -141,12 +163,16 @@</span> 	if n.client.Client != nil {
 		n.client.Close()
 		n.client = simClient{}
 	}
<span class="term-fg32">+	var err error</span>
 	if n.beacon != nil {
<span class="term-fg31">-		err := n.beacon.Stop()</span>
<span class="term-fg32">+		err = n.beacon.Stop()</span>
 		n.beacon = nil
<span class="term-fg31">-		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if n.node != nil {</span>
<span class="term-fg32">+		err = errors.Join(err, n.node.Close())</span>
<span class="term-fg32">+		n.node = nil</span>
 	}
<span class="term-fg31">-	return nil</span>
<span class="term-fg32">+	return err</span>
 }
&nbsp;
 &#47;&#47; Commit seals a block and moves the chain forward to a new empty block.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-bb267c27af1aa319769862bc"role="button" aria-expanded="false" aria-controls="id-bb267c27af1aa319769862bc">
        
            <div class="col-12 col-sm-9 text-start"><h2>Hardware wallet support</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+11</span></div>
                <div class="text-start"><span class="text-danger">-7</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-bb267c27af1aa319769862bc">
        <div><p>Extend Ledger wallet support for newer devices on Macos</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-04b858689e27e8166508c51c"role="button" aria-expanded="false" aria-controls="id-04b858689e27e8166508c51c">
        
            <div class="col-12 col-sm-9 text-start"><h3>Fix Ledger discoverability</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+11</span></div>
                <div class="text-start"><span class="text-danger">-7</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-04b858689e27e8166508c51c">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-40f5b561a194d25faf84cdad" role="button"
                   aria-expanded="false" aria-controls="id-40f5b561a194d25faf84cdad">
                    <code>accounts/usbwallet/hub.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/accounts/usbwallet/hub.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/accounts/usbwallet/hub.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+11</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-40f5b561a194d25faf84cdad"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;usbwallet&#47;hub.go op-geth&#47;accounts&#47;usbwallet&#47;hub.go</span>
<span class="term-fg1">index e67942dbc1072ea952c204c1f30f3803dbf8e567..0682310867b2bd3c44788b158b8a4a716759c865 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;usbwallet&#47;hub.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;usbwallet&#47;hub.go</span>
<span class="term-fg36">@@ -23,6 +23,8 @@</span> 	&quot;sync&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
<span class="term-fg36">@@ -48,7 +50,7 @@</span> type Hub struct {
 	scheme     string                  &#47;&#47; Protocol scheme prefixing account and wallet URLs.
 	vendorID   uint16                  &#47;&#47; USB vendor identifier used for device discovery
 	productIDs []uint16                &#47;&#47; USB product identifiers used for device discovery
<span class="term-fg31">-	usageID    uint16                  &#47;&#47; USB usage page identifier used for macOS device discovery</span>
<span class="term-fg32">+	usageIDs   []uint16                &#47;&#47; USB usage page identifier used for macOS device discovery</span>
 	endpointID int                     &#47;&#47; USB endpoint identifier used for non-macOS device discovery
 	makeDriver func(log.Logger) driver &#47;&#47; Factory method to construct a vendor specific driver
&nbsp;
<span class="term-fg36">@@ -93,22 +95,22 @@</span> 		0x1011, &#47;* HID + WebUSB Ledger Nano S *&#47;
 		0x4011, &#47;* HID + WebUSB Ledger Nano X *&#47;
 		0x5011, &#47;* HID + WebUSB Ledger Nano S Plus *&#47;
 		0x6011, &#47;* HID + WebUSB Ledger Nano FTS *&#47;
<span class="term-fg31">-	}, 0xffa0, 0, newLedgerDriver)</span>
<span class="term-fg32">+	}, []uint16{0xffa0, 0}, 2, newLedgerDriver)</span>
 }
&nbsp;
 &#47;&#47; NewTrezorHubWithHID creates a new hardware wallet manager for Trezor devices.
 func NewTrezorHubWithHID() (*Hub, error) {
<span class="term-fg31">-	return newHub(TrezorScheme, 0x534c, []uint16{0x0001 &#47;* Trezor HID *&#47;}, 0xff00, 0, newTrezorDriver)</span>
<span class="term-fg32">+	return newHub(TrezorScheme, 0x534c, []uint16{0x0001 &#47;* Trezor HID *&#47;}, []uint16{0xff00}, 0, newTrezorDriver)</span>
 }
&nbsp;
 &#47;&#47; NewTrezorHubWithWebUSB creates a new hardware wallet manager for Trezor devices with
 &#47;&#47; firmware version &gt; 1.8.0
 func NewTrezorHubWithWebUSB() (*Hub, error) {
<span class="term-fg31">-	return newHub(TrezorScheme, 0x1209, []uint16{0x53c1 &#47;* Trezor WebUSB *&#47;}, 0xffff &#47;* No usage id on webusb, don&#39;t match unset (0) *&#47;, 0, newTrezorDriver)</span>
<span class="term-fg32">+	return newHub(TrezorScheme, 0x1209, []uint16{0x53c1 &#47;* Trezor WebUSB *&#47;}, []uint16{0xffff} &#47;* No usage id on webusb, don&#39;t match unset (0) *&#47;, 0, newTrezorDriver)</span>
 }
&nbsp;
 &#47;&#47; newHub creates a new hardware wallet manager for generic USB devices.
<span class="term-fg31">-func newHub(scheme string, vendorID uint16, productIDs []uint16, usageID uint16, endpointID int, makeDriver func(log.Logger) driver) (*Hub, error) {</span>
<span class="term-fg32">+func newHub(scheme string, vendorID uint16, productIDs []uint16, usageIDs []uint16, endpointID int, makeDriver func(log.Logger) driver) (*Hub, error) {</span>
 	if !usb.Supported() {
 		return nil, errors.New(&quot;unsupported platform&quot;)
 	}
<span class="term-fg36">@@ -116,7 +118,7 @@</span> 	hub := &amp;Hub{
 		scheme:     scheme,
 		vendorID:   vendorID,
 		productIDs: productIDs,
<span class="term-fg31">-		usageID:    usageID,</span>
<span class="term-fg32">+		usageIDs:   usageIDs,</span>
 		endpointID: endpointID,
 		makeDriver: makeDriver,
 		quit:       make(chan chan error),
<span class="term-fg36">@@ -186,7 +188,9 @@</span>
 	for _, info := range infos {
 		for _, id := range hub.productIDs {
 			&#47;&#47; Windows and Macos use UsageID matching, Linux uses Interface matching
<span class="term-fg31">-			if info.ProductID == id &amp;&amp; (info.UsagePage == hub.usageID || info.Interface == hub.endpointID) {</span>
<span class="term-fg32">+			if info.ProductID == id &amp;&amp;</span>
<span class="term-fg32">+				info.Path != &quot;&quot; &amp;&amp;</span>
<span class="term-fg32">+				(slices.Contains(hub.usageIDs, info.UsagePage) || info.Interface == hub.endpointID) {</span>
 				devices = append(devices, info)
 				break
 			}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-7f1f83f8411cc0e7526d4032"role="button" aria-expanded="false" aria-controls="id-7f1f83f8411cc0e7526d4032">
        
            <div class="col-12 col-sm-9 text-start"><h2>Other changes</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+2472</span></div>
                <div class="text-start"><span class="text-danger">-112</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-7f1f83f8411cc0e7526d4032">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-12df00d5c3c51caeac96cba9" role="button"
                   aria-expanded="false" aria-controls="id-12df00d5c3c51caeac96cba9">
                    <code>.github/workflows/go.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/.github/workflows/go.yml" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <span class="text-muted">(deleted)</span>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-23</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-12df00d5c3c51caeac96cba9"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;workflows&#47;go.yml op-geth&#47;.github&#47;workflows&#47;go.yml</span>
<span class="term-fg1">deleted file mode 100644</span>
<span class="term-fg1">index 0c673d15f16851ad2a633860fc4cec8a0346aee5..0000000000000000000000000000000000000000</span>
<span class="term-fg1">--- go-ethereum&#47;.github&#47;workflows&#47;go.yml</span>
<span class="term-fg1">+++ &#47;dev&#47;null</span>
<span class="term-fg36">@@ -1,23 +0,0 @@</span>
<span class="term-fg31">-name: i386 linux tests</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-on:</span>
<span class="term-fg31">-  push:</span>
<span class="term-fg31">-    branches: [ master ]</span>
<span class="term-fg31">-  pull_request:</span>
<span class="term-fg31">-    branches: [ master ]</span>
<span class="term-fg31">-  workflow_dispatch:</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-jobs:</span>
<span class="term-fg31">-  build:</span>
<span class="term-fg31">-    runs-on: self-hosted</span>
<span class="term-fg31">-    steps:</span>
<span class="term-fg31">-      - uses: actions&#47;checkout@v2</span>
<span class="term-fg31">-      - name: Set up Go</span>
<span class="term-fg31">-        uses: actions&#47;setup-go@v2</span>
<span class="term-fg31">-        with:</span>
<span class="term-fg31">-          go-version: 1.21.4</span>
<span class="term-fg31">-      - name: Run tests</span>
<span class="term-fg31">-        run: go test -short .&#47;...</span>
<span class="term-fg31">-        env:</span>
<span class="term-fg31">-          GOOS: linux</span>
<span class="term-fg31">-          GOARCH: 386</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6ade332c2dbc1ccb494e3ecb" role="button"
                   aria-expanded="false" aria-controls="id-6ade332c2dbc1ccb494e3ecb">
                    <code>.github/workflows/pages.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/.github/workflows/pages.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+36</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6ade332c2dbc1ccb494e3ecb"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;workflows&#47;pages.yaml op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..6973b227ce779be6138ee2084e71bb5a5cdd57de</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg36">@@ -0,0 +1,36 @@</span>
<span class="term-fg32">+name: Build and publish forkdiff github-pages</span>
<span class="term-fg32">+permissions:</span>
<span class="term-fg32">+  contents: write</span>
<span class="term-fg32">+on:</span>
<span class="term-fg32">+  push:</span>
<span class="term-fg32">+    branches:</span>
<span class="term-fg32">+      - optimism</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  deploy:</span>
<span class="term-fg32">+    concurrency: ci-${{ github.ref }}</span>
<span class="term-fg32">+    runs-on: ubuntu-latest</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - name: Checkout</span>
<span class="term-fg32">+        uses: actions&#47;checkout@v3</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          fetch-depth: 1000  # make sure to fetch the old commit we diff against</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build forkdiff</span>
<span class="term-fg32">+        uses: &quot;docker:&#47;&#47;protolambda&#47;forkdiff:latest&quot;</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          args: -repo=&#47;github&#47;workspace -fork=&#47;github&#47;workspace&#47;fork.yaml -out=&#47;github&#47;workspace&#47;index.html</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build pages</span>
<span class="term-fg32">+        run: |</span>
<span class="term-fg32">+          mkdir -p tmp&#47;pages</span>
<span class="term-fg32">+          mv index.html tmp&#47;pages&#47;index.html</span>
<span class="term-fg32">+          touch tmp&#47;pages&#47;.nojekyll</span>
<span class="term-fg32">+          if [ &quot;$GITHUB_REPOSITORY&quot; == &quot;ethereum-optimism&#47;op-geth&quot; ]; then</span>
<span class="term-fg32">+              echo &quot;op-geth.optimism.io&quot; &gt; tmp&#47;pages&#47;CNAME</span>
<span class="term-fg32">+          fi;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Deploy</span>
<span class="term-fg32">+        uses: JamesIves&#47;github-pages-deploy-action@v4</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          folder: tmp&#47;pages</span>
<span class="term-fg32">+          clean: true</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-39ce7e2023b647d23b4b4cd5" role="button"
                   aria-expanded="false" aria-controls="id-39ce7e2023b647d23b4b4cd5">
                    <code>.golangci.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/.golangci.yml" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/.golangci.yml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-39ce7e2023b647d23b4b4cd5"><span class="term-fg1">diff --git go-ethereum&#47;.golangci.yml op-geth&#47;.golangci.yml</span>
<span class="term-fg1">index 0343c4b4ebf2eec8adc0a473a2892a4100b3a86a..10dee809c249bf41d9f894b72c6eb9c4a4998d41 100644</span>
<span class="term-fg1">--- go-ethereum&#47;.golangci.yml</span>
<span class="term-fg1">+++ op-geth&#47;.golangci.yml</span>
<span class="term-fg36">@@ -58,3 +58,4 @@</span>     - &#39;SA1019: event.TypeMux is deprecated: use Feed&#39;
     - &#39;SA1019: strings.Title is deprecated&#39;
     - &#39;SA1019: strings.Title has been deprecated since Go 1.18 and an alternative has been available since Go 1.0: The rule Title uses for word boundaries does not handle Unicode punctuation properly. Use golang.org&#47;x&#47;text&#47;cases instead.&#39;
     - &#39;SA1029: should not use built-in type string as key for value&#39;
<span class="term-fg32">+    - &#39;SA1019:&#39; # temporary, until fully updated to Go 1.21</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f8a3412c75bacce822aee1a0" role="button"
                   aria-expanded="false" aria-controls="id-f8a3412c75bacce822aee1a0">
                    <code>Makefile</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/Makefile" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/Makefile" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f8a3412c75bacce822aee1a0"><span class="term-fg1">diff --git go-ethereum&#47;Makefile op-geth&#47;Makefile</span>
<span class="term-fg1">index d736ef61c001ec02581a6867982291cdf684b3ab..226bac2d1e1b87b26dd70989b37e32117a1837fe 100644</span>
<span class="term-fg1">--- go-ethereum&#47;Makefile</span>
<span class="term-fg1">+++ op-geth&#47;Makefile</span>
<span class="term-fg36">@@ -36,3 +36,9 @@</span> 	env GOBIN= go install github.com&#47;golang&#47;protobuf&#47;protoc-gen-go@latest
 	env GOBIN= go install .&#47;cmd&#47;abigen
 	@type &quot;solc&quot; 2&gt; &#47;dev&#47;null || echo &#39;Please install solc&#39;
 	@type &quot;protoc&quot; 2&gt; &#47;dev&#47;null || echo &#39;Please install protoc&#39;
<span class="term-fg32">+</span>
<span class="term-fg32">+forkdiff:</span>
<span class="term-fg32">+	docker run --rm \</span>
<span class="term-fg32">+		--mount src=$(shell pwd),target=&#47;host-pwd,type=bind \</span>
<span class="term-fg32">+		protolambda&#47;forkdiff:latest \</span>
<span class="term-fg32">+		-repo &#47;host-pwd&#47; -fork &#47;host-pwd&#47;fork.yaml -out &#47;host-pwd&#47;forkdiff.html</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-45d62e878aac8e120a56b35c" role="button"
                   aria-expanded="false" aria-controls="id-45d62e878aac8e120a56b35c">
                    <code>accounts/abi/packing_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/accounts/abi/packing_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/accounts/abi/packing_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-45d62e878aac8e120a56b35c"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;abi&#47;packing_test.go op-geth&#47;accounts&#47;abi&#47;packing_test.go</span>
<span class="term-fg1">index eae3b0df20562372b4e739ba0e72559c0d19bd96..9ed52a475eb900f5be20dfe9441ba25ac330defd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;abi&#47;packing_test.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;abi&#47;packing_test.go</span>
<span class="term-fg36">@@ -375,7 +375,7 @@</span> 	{
 		def: `[{&quot;type&quot;: &quot;bytes&quot;}]`,
 		packed: &quot;0000000000000000000000000000000000000000000000000000000000000020&quot; +
 			&quot;0000000000000000000000000000000000000000000000000000000000000020&quot; +
<span class="term-fg31">-			&quot;0100000000000000000000000000000000000000000000000000000000000000&quot;,</span>
<span class="term-fg32">+			&quot;0100000000000000000000000000000000000000000000000000000000000000&quot;, &#47;&#47;nolint:all</span>
 		unpacked: common.Hex2Bytes(&quot;0100000000000000000000000000000000000000000000000000000000000000&quot;),
 	},
 	{
<span class="term-fg36">@@ -476,7 +476,7 @@</span> 	{
 		def: `[{&quot;type&quot;: &quot;int256[3]&quot;}]`,
 		packed: &quot;0000000000000000000000000000000000000000000000000000000000000001&quot; +
 			&quot;0000000000000000000000000000000000000000000000000000000000000002&quot; +
<span class="term-fg31">-			&quot;0000000000000000000000000000000000000000000000000000000000000003&quot;,</span>
<span class="term-fg32">+			&quot;0000000000000000000000000000000000000000000000000000000000000003&quot;, &#47;&#47;nolint:all</span>
 		unpacked: [3]*big.Int{big.NewInt(1), big.NewInt(2), big.NewInt(3)},
 	},
 	&#47;&#47; multi dimensional, if these pass, all types that don&#39;t require length prefix should pass
<span class="term-fg36">@@ -536,7 +536,7 @@</span> 	{
 		def: `[{&quot;type&quot;: &quot;uint8[][2]&quot;}]`,
 		packed: &quot;0000000000000000000000000000000000000000000000000000000000000020&quot; +
 			&quot;0000000000000000000000000000000000000000000000000000000000000040&quot; +
<span class="term-fg31">-			&quot;0000000000000000000000000000000000000000000000000000000000000080&quot; +</span>
<span class="term-fg32">+			&quot;0000000000000000000000000000000000000000000000000000000000000080&quot; + &#47;&#47;nolint:all</span>
 			&quot;0000000000000000000000000000000000000000000000000000000000000001&quot; +
 			&quot;0000000000000000000000000000000000000000000000000000000000000001&quot; +
 			&quot;0000000000000000000000000000000000000000000000000000000000000001&quot; +
<span class="term-fg36">@@ -801,7 +801,7 @@</span> 			&quot;0000000000000000000000000000000000000000000000000000000000000002&quot; + &#47;&#47; len(array[0]) = 2
 			&quot;0100000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47; array[0][0]
 			&quot;0200000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47; array[0][1]
 			&quot;0000000000000000000000000000000000000000000000000000000000000003&quot; + &#47;&#47; len(array[1]) = 3
<span class="term-fg31">-			&quot;0300000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47; array[1][0]</span>
<span class="term-fg32">+			&quot;0300000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47;nolint:all  &#47;&#47; array[1][0]</span>
 			&quot;0400000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47; array[1][1]
 			&quot;0500000000000000000000000000000000000000000000000000000000000000&quot;, &#47;&#47; array[1][2]
 	},
<span class="term-fg36">@@ -845,7 +845,7 @@</span> 			E [2][3][32]byte
 		}{1, big.NewInt(1), big.NewInt(-1), true, [2][3][32]byte{{{1}, {2}, {3}}, {{3}, {4}, {5}}}},
 		packed: &quot;0000000000000000000000000000000000000000000000000000000000000001&quot; + &#47;&#47; struct[a]
 			&quot;0000000000000000000000000000000000000000000000000000000000000001&quot; + &#47;&#47; struct[b]
<span class="term-fg31">-			&quot;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot; + &#47;&#47; struct[c]</span>
<span class="term-fg32">+			&quot;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot; + &#47;&#47;nolint:all  &#47;&#47; struct[c]</span>
 			&quot;0000000000000000000000000000000000000000000000000000000000000001&quot; + &#47;&#47; struct[d]
 			&quot;0100000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47; struct[e] array[0][0]
 			&quot;0200000000000000000000000000000000000000000000000000000000000000&quot; + &#47;&#47; struct[e] array[0][1]</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8fd2eb9a50bada055d46c23a" role="button"
                   aria-expanded="false" aria-controls="id-8fd2eb9a50bada055d46c23a">
                    <code>beacon/engine/gen_epe.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/beacon/engine/gen_epe.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/beacon/engine/gen_epe.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+15</span></div>
                        <div class="text-start"><span class="text-danger">-8</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8fd2eb9a50bada055d46c23a"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;gen_epe.go op-geth&#47;beacon&#47;engine&#47;gen_epe.go</span>
<span class="term-fg1">index e69f9a5951a28deeaa9ad51f1b2d9e8733b2feca..3529bbd66141dcf34643f03ee03c5dbe2a67f1d5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;gen_epe.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;gen_epe.go</span>
<span class="term-fg36">@@ -7,6 +7,7 @@</span> 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;math&#47;big&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 )
&nbsp;
<span class="term-fg36">@@ -15,26 +16,29 @@</span>
 &#47;&#47; MarshalJSON marshals as JSON.
 func (e ExecutionPayloadEnvelope) MarshalJSON() ([]byte, error) {
 	type ExecutionPayloadEnvelope struct {
<span class="term-fg31">-		ExecutionPayload *ExecutableData `json:&quot;executionPayload&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		BlockValue       *hexutil.Big    `json:&quot;blockValue&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		BlobsBundle      *BlobsBundleV1  `json:&quot;blobsBundle&quot;`</span>
<span class="term-fg31">-		Override         bool            `json:&quot;shouldOverrideBuilder&quot;`</span>
<span class="term-fg32">+		ExecutionPayload      *ExecutableData `json:&quot;executionPayload&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		BlockValue            *hexutil.Big    `json:&quot;blockValue&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		BlobsBundle           *BlobsBundleV1  `json:&quot;blobsBundle&quot;`</span>
<span class="term-fg32">+		Override              bool            `json:&quot;shouldOverrideBuilder&quot;`</span>
<span class="term-fg32">+		ParentBeaconBlockRoot *common.Hash    `json:&quot;parentBeaconBlockRoot,omitempty&quot;`</span>
 	}
 	var enc ExecutionPayloadEnvelope
 	enc.ExecutionPayload = e.ExecutionPayload
 	enc.BlockValue = (*hexutil.Big)(e.BlockValue)
 	enc.BlobsBundle = e.BlobsBundle
 	enc.Override = e.Override
<span class="term-fg32">+	enc.ParentBeaconBlockRoot = e.ParentBeaconBlockRoot</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
 &#47;&#47; UnmarshalJSON unmarshals from JSON.
 func (e *ExecutionPayloadEnvelope) UnmarshalJSON(input []byte) error {
 	type ExecutionPayloadEnvelope struct {
<span class="term-fg31">-		ExecutionPayload *ExecutableData `json:&quot;executionPayload&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		BlockValue       *hexutil.Big    `json:&quot;blockValue&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		BlobsBundle      *BlobsBundleV1  `json:&quot;blobsBundle&quot;`</span>
<span class="term-fg31">-		Override         *bool           `json:&quot;shouldOverrideBuilder&quot;`</span>
<span class="term-fg32">+		ExecutionPayload      *ExecutableData `json:&quot;executionPayload&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		BlockValue            *hexutil.Big    `json:&quot;blockValue&quot;  gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		BlobsBundle           *BlobsBundleV1  `json:&quot;blobsBundle&quot;`</span>
<span class="term-fg32">+		Override              *bool           `json:&quot;shouldOverrideBuilder&quot;`</span>
<span class="term-fg32">+		ParentBeaconBlockRoot *common.Hash    `json:&quot;parentBeaconBlockRoot,omitempty&quot;`</span>
 	}
 	var dec ExecutionPayloadEnvelope
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -53,6 +57,9 @@</span> 		e.BlobsBundle = dec.BlobsBundle
 	}
 	if dec.Override != nil {
 		e.Override = *dec.Override
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.ParentBeaconBlockRoot != nil {</span>
<span class="term-fg32">+		e.ParentBeaconBlockRoot = dec.ParentBeaconBlockRoot</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4eeebd57eaa2d41e98395b63" role="button"
                   aria-expanded="false" aria-controls="id-4eeebd57eaa2d41e98395b63">
                    <code>cmd/devp2p/internal/ethtest/snap.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/cmd/devp2p/internal/ethtest/snap.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/cmd/devp2p/internal/ethtest/snap.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4eeebd57eaa2d41e98395b63"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg1">index 64e063358545ee8fd2cb0fbf9d8c6ae2ead74f0c..83844b1e9d6a09737db340a70f48242294e8dbd3 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg36">@@ -470,13 +470,13 @@</span> 		{
 			desc:      `Here we request state roots as code hashes. The server should deliver an empty response with no items.`,
 			nBytes:    10000,
 			hashes:    []common.Hash{genesisRoot, headRoot},
<span class="term-fg31">-			expHashes: 0,</span>
<span class="term-fg32">+			expHashes: 1, &#47;&#47; 32-byte keys are detected as code, even if not code (like genesis hash), in legacy lookups.</span>
 		},
 		{
 			desc:      `Here we request the genesis state root (which is not an existing code hash) two times. The server should deliver an empty response with no items.`,
 			nBytes:    10000,
 			hashes:    []common.Hash{genesisRoot, genesisRoot},
<span class="term-fg31">-			expHashes: 0,</span>
<span class="term-fg32">+			expHashes: 2, &#47;&#47; 32-byte keys are detected as code, even if not code (like genesis hash), in legacy lookups.</span>
 		},
 		&#47;&#47; Empties
 		{</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-66478126254a1e23fc7d9f40" role="button"
                   aria-expanded="false" aria-controls="id-66478126254a1e23fc7d9f40">
                    <code>cmd/evm/internal/t8ntool/transition.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/cmd/evm/internal/t8ntool/transition.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/cmd/evm/internal/t8ntool/transition.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-66478126254a1e23fc7d9f40"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go</span>
<span class="term-fg1">index 31e96894dd22b2d91c86644b88537c9758454f69..78fb97d00da87b9e99b37c2415489b9f9a150c35 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go</span>
<span class="term-fg36">@@ -211,7 +211,7 @@</span> 		Number:   new(big.Int).SetUint64(env.Number - 1),
 		BaseFee:  env.ParentBaseFee,
 		GasUsed:  env.ParentGasUsed,
 		GasLimit: env.ParentGasLimit,
<span class="term-fg31">-	})</span>
<span class="term-fg32">+	}, env.Timestamp)</span>
 	return nil
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1de707982f54c0ce44397443" role="button"
                   aria-expanded="false" aria-controls="id-1de707982f54c0ce44397443">
                    <code>common/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/common/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/common/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1de707982f54c0ce44397443"><span class="term-fg1">diff --git go-ethereum&#47;common&#47;types.go op-geth&#47;common&#47;types.go</span>
<span class="term-fg1">index aadca87f82af89543de3387e24a90cba5fe1846f..7d9c85f2895ee5e0db99f242baf5e1c78c6d00cc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;common&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;common&#47;types.go</span>
<span class="term-fg36">@@ -212,6 +212,10 @@</span>
 &#47;&#47; Address represents the 20 byte address of an Ethereum account.
 type Address [AddressLength]byte
&nbsp;
<span class="term-fg32">+func (a Address) Hash() Hash {</span>
<span class="term-fg32">+  return BytesToHash(a.Bytes())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; BytesToAddress returns Address with value b.
 &#47;&#47; If b is larger than len(h), b will be cropped from the left.
 func BytesToAddress(b []byte) Address {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3641d34115a548bc622e1a22" role="button"
                   aria-expanded="false" aria-controls="id-3641d34115a548bc622e1a22">
                    <code>consensus/misc/create2deployer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/consensus/misc/create2deployer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+37</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3641d34115a548bc622e1a22"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;create2deployer.go op-geth&#47;consensus&#47;misc&#47;create2deployer.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..27c87a4a8c45b1e859719e8d4f8e5775ff3da0ca</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;create2deployer.go</span>
<span class="term-fg36">@@ -0,0 +1,37 @@</span>
<span class="term-fg32">+package misc</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; The original create2deployer contract could not be deployed to Base mainnet at</span>
<span class="term-fg32">+&#47;&#47; the canonical address of 0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2 due to</span>
<span class="term-fg32">+&#47;&#47; an accidental nonce increment from a deposit transaction. See</span>
<span class="term-fg32">+&#47;&#47; https:&#47;&#47;github.com&#47;pcaversaccio&#47;create2deployer&#47;issues&#47;128 for context. This</span>
<span class="term-fg32">+&#47;&#47; file applies the contract code to the canonical address manually in the Canyon</span>
<span class="term-fg32">+&#47;&#47; hardfork.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var create2DeployerAddress = common.HexToAddress(&quot;0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2&quot;)</span>
<span class="term-fg32">+var create2DeployerCodeHash = common.HexToHash(&quot;0xb0550b5b431e30d38000efb7107aaa0ade03d48a7198a140edda9d27134468b2&quot;)</span>
<span class="term-fg32">+var create2DeployerCode []byte</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func init() {</span>
<span class="term-fg32">+	code, err := superchain.LoadContractBytecode(superchain.Hash(create2DeployerCodeHash))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	create2DeployerCode = code</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func EnsureCreate2Deployer(c *params.ChainConfig, timestamp uint64, db vm.StateDB) {</span>
<span class="term-fg32">+	if !c.IsOptimism() || c.CanyonTime == nil || *c.CanyonTime != timestamp {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Info(&quot;Setting Create2Deployer code&quot;, &quot;address&quot;, create2DeployerAddress, &quot;codeHash&quot;, create2DeployerCodeHash)</span>
<span class="term-fg32">+	db.SetCode(create2DeployerAddress, create2DeployerCode)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-675aa261fc16c6d6e7d60dd8" role="button"
                   aria-expanded="false" aria-controls="id-675aa261fc16c6d6e7d60dd8">
                    <code>consensus/misc/create2deployer_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/consensus/misc/create2deployer_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+95</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-675aa261fc16c6d6e7d60dd8"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;create2deployer_test.go op-geth&#47;consensus&#47;misc&#47;create2deployer_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..fc0ef79fd7739d92431085d515481be8621e8fcb</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;create2deployer_test.go</span>
<span class="term-fg36">@@ -0,0 +1,95 @@</span>
<span class="term-fg32">+package misc</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;assert&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestEnsureCreate2Deployer(t *testing.T) {</span>
<span class="term-fg32">+	canyonTime := uint64(1000)</span>
<span class="term-fg32">+	var tests = []struct {</span>
<span class="term-fg32">+		name       string</span>
<span class="term-fg32">+		override   func(cfg *params.ChainConfig)</span>
<span class="term-fg32">+		timestamp  uint64</span>
<span class="term-fg32">+		codeExists bool</span>
<span class="term-fg32">+		applied    bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:      &quot;at hardfork&quot;,</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;another chain ID&quot;,</span>
<span class="term-fg32">+			override: func(cfg *params.ChainConfig) {</span>
<span class="term-fg32">+				cfg.ChainID = big.NewInt(params.OPMainnetChainID)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:       &quot;code already exists&quot;,</span>
<span class="term-fg32">+			timestamp:  canyonTime,</span>
<span class="term-fg32">+			codeExists: true,</span>
<span class="term-fg32">+			applied:    true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:      &quot;pre canyon&quot;,</span>
<span class="term-fg32">+			timestamp: canyonTime - 1,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:      &quot;post hardfork&quot;,</span>
<span class="term-fg32">+			timestamp: canyonTime + 1,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;canyon not configured&quot;,</span>
<span class="term-fg32">+			override: func(cfg *params.ChainConfig) {</span>
<span class="term-fg32">+				cfg.CanyonTime = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tt := range tests {</span>
<span class="term-fg32">+		t.Run(tt.name, func(t *testing.T) {</span>
<span class="term-fg32">+			cfg := params.ChainConfig{</span>
<span class="term-fg32">+				ChainID:    big.NewInt(params.BaseMainnetChainID),</span>
<span class="term-fg32">+				Optimism:   &amp;params.OptimismConfig{},</span>
<span class="term-fg32">+				CanyonTime: &amp;canyonTime,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if tt.override != nil {</span>
<span class="term-fg32">+				tt.override(&amp;cfg)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			state := &amp;stateDb{</span>
<span class="term-fg32">+				codeExists: tt.codeExists,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			EnsureCreate2Deployer(&amp;cfg, tt.timestamp, state)</span>
<span class="term-fg32">+			assert.Equal(t, tt.applied, state.codeSet)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type stateDb struct {</span>
<span class="term-fg32">+	vm.StateDB</span>
<span class="term-fg32">+	codeExists bool</span>
<span class="term-fg32">+	codeSet    bool</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (s *stateDb) GetCodeSize(_ common.Address) int {</span>
<span class="term-fg32">+	if s.codeExists {</span>
<span class="term-fg32">+		return 1</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (s *stateDb) SetCode(_ common.Address, _ []byte) {</span>
<span class="term-fg32">+	s.codeSet = true</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2f4ed5f894a9a5367bf6d80f" role="button"
                   aria-expanded="false" aria-controls="id-2f4ed5f894a9a5367bf6d80f">
                    <code>consensus/misc/eip1559/eip1559_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/consensus/misc/eip1559/eip1559_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/consensus/misc/eip1559/eip1559_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+47</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2f4ed5f894a9a5367bf6d80f"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;eip1559&#47;eip1559_test.go op-geth&#47;consensus&#47;misc&#47;eip1559&#47;eip1559_test.go</span>
<span class="term-fg1">index b5afdf0fe5e56ca6ced6031be233c6aafb17dcdd..d34da8fd8bbb21a6a649384435c3926a6735083d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;misc&#47;eip1559&#47;eip1559_test.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;eip1559&#47;eip1559_test.go</span>
<span class="term-fg36">@@ -55,6 +55,19 @@</span> 	config.LondonBlock = big.NewInt(5)
 	return config
 }
&nbsp;
<span class="term-fg32">+func opConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	config := copyConfig(params.TestChainConfig)</span>
<span class="term-fg32">+	config.LondonBlock = big.NewInt(5)</span>
<span class="term-fg32">+	ct := uint64(10)</span>
<span class="term-fg32">+	config.CanyonTime = &amp;ct</span>
<span class="term-fg32">+	config.Optimism = &amp;params.OptimismConfig{</span>
<span class="term-fg32">+		EIP1559Elasticity:        6,</span>
<span class="term-fg32">+		EIP1559Denominator:       50,</span>
<span class="term-fg32">+		EIP1559DenominatorCanyon: 250,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return config</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; TestBlockGasLimits tests the gasLimit checks for blocks both across
 &#47;&#47; the EIP-1559 boundary and post-1559 blocks
 func TestBlockGasLimits(t *testing.T) {
<span class="term-fg36">@@ -124,7 +137,40 @@</span> 			GasLimit: test.parentGasLimit,
 			GasUsed:  test.parentGasUsed,
 			BaseFee:  big.NewInt(test.parentBaseFee),
 		}
<span class="term-fg31">-		if have, want := CalcBaseFee(config(), parent), big.NewInt(test.expectedBaseFee); have.Cmp(want) != 0 {</span>
<span class="term-fg32">+		if have, want := CalcBaseFee(config(), parent, 0), big.NewInt(test.expectedBaseFee); have.Cmp(want) != 0 {</span>
<span class="term-fg32">+			t.Errorf(&quot;test %d: have %d  want %d, &quot;, i, have, want)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; TestCalcBaseFeeOptimism assumes all blocks are 1559-blocks but tests the Canyon activation</span>
<span class="term-fg32">+func TestCalcBaseFeeOptimism(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		parentBaseFee   int64</span>
<span class="term-fg32">+		parentGasLimit  uint64</span>
<span class="term-fg32">+		parentGasUsed   uint64</span>
<span class="term-fg32">+		expectedBaseFee int64</span>
<span class="term-fg32">+		postCanyon      bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{params.InitialBaseFee, 30_000_000, 5_000_000, params.InitialBaseFee, false}, &#47;&#47; usage == target</span>
<span class="term-fg32">+		{params.InitialBaseFee, 30_000_000, 4_000_000, 996000000, false},             &#47;&#47; usage below target</span>
<span class="term-fg32">+		{params.InitialBaseFee, 30_000_000, 10_000_000, 1020000000, false},           &#47;&#47; usage above target</span>
<span class="term-fg32">+		{params.InitialBaseFee, 30_000_000, 5_000_000, params.InitialBaseFee, true},  &#47;&#47; usage == target</span>
<span class="term-fg32">+		{params.InitialBaseFee, 30_000_000, 4_000_000, 999200000, true},              &#47;&#47; usage below target</span>
<span class="term-fg32">+		{params.InitialBaseFee, 30_000_000, 10_000_000, 1004000000, true},            &#47;&#47; usage above target</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, test := range tests {</span>
<span class="term-fg32">+		parent := &amp;types.Header{</span>
<span class="term-fg32">+			Number:   common.Big32,</span>
<span class="term-fg32">+			GasLimit: test.parentGasLimit,</span>
<span class="term-fg32">+			GasUsed:  test.parentGasUsed,</span>
<span class="term-fg32">+			BaseFee:  big.NewInt(test.parentBaseFee),</span>
<span class="term-fg32">+			Time:     6,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if test.postCanyon {</span>
<span class="term-fg32">+			parent.Time = 8</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if have, want := CalcBaseFee(opConfig(), parent, parent.Time+2), big.NewInt(test.expectedBaseFee); have.Cmp(want) != 0 {</span>
 			t.Errorf(&quot;test %d: have %d  want %d, &quot;, i, have, want)
 		}
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-beed589818565bcdcc921ef9" role="button"
                   aria-expanded="false" aria-controls="id-beed589818565bcdcc921ef9">
                    <code>core/chain_makers.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/chain_makers.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/chain_makers.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-beed589818565bcdcc921ef9"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;chain_makers.go op-geth&#47;core&#47;chain_makers.go</span>
<span class="term-fg1">index 05c97a43eea48cfe264ceafeddd7633e55a7defb..e9836f289e48e6b02ae0e34c78b4c701cd97a5b6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;chain_makers.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;chain_makers.go</span>
<span class="term-fg36">@@ -98,7 +98,7 @@</span> &#47;&#47; block.
 func (b *BlockGen) SetParentBeaconRoot(root common.Hash) {
 	b.header.ParentBeaconRoot = &amp;root
 	var (
<span class="term-fg31">-		blockContext = NewEVMBlockContext(b.header, b.cm, &amp;b.header.Coinbase)</span>
<span class="term-fg32">+		blockContext = NewEVMBlockContext(b.header, b.cm, &amp;b.header.Coinbase, b.cm.config, b.statedb)</span>
 		vmenv        = vm.NewEVM(blockContext, vm.TxContext{}, b.statedb, b.cm.config, vm.Config{})
 	)
 	ProcessBeaconBlockRoot(root, vmenv, b.statedb)
<span class="term-fg36">@@ -230,7 +230,7 @@</span>
 	&#47;&#47; The gas limit and price should be derived from the parent
 	h.GasLimit = parent.GasLimit
 	if b.cm.config.IsLondon(h.Number) {
<span class="term-fg31">-		h.BaseFee = eip1559.CalcBaseFee(b.cm.config, parent)</span>
<span class="term-fg32">+		h.BaseFee = eip1559.CalcBaseFee(b.cm.config, parent, h.Time)</span>
 		if !b.cm.config.IsLondon(parent.Number) {
 			parentGasLimit := parent.GasLimit * b.cm.config.ElasticityMultiplier()
 			h.GasLimit = CalcGasLimit(parentGasLimit, parentGasLimit)
<span class="term-fg36">@@ -320,7 +320,7 @@</span> 		&#47;&#47; Set the difficulty for clique block. The chain maker doesn&#39;t have access
 		&#47;&#47; to a chain, so the difficulty will be left unset (nil). Set it here to the
 		&#47;&#47; correct value.
 		if b.header.Difficulty == nil {
<span class="term-fg31">-			if config.TerminalTotalDifficulty == nil {</span>
<span class="term-fg32">+			if config.TerminalTotalDifficulty == nil &amp;&amp; !config.IsOptimismBedrock(b.header.Number) {</span>
 				&#47;&#47; Clique chain
 				b.header.Difficulty = big.NewInt(2)
 			} else {
<span class="term-fg36">@@ -430,7 +430,7 @@</span> 		Time:       time,
 	}
&nbsp;
 	if cm.config.IsLondon(header.Number) {
<span class="term-fg31">-		header.BaseFee = eip1559.CalcBaseFee(cm.config, parent.Header())</span>
<span class="term-fg32">+		header.BaseFee = eip1559.CalcBaseFee(cm.config, parent.Header(), header.Time)</span>
 		if !cm.config.IsLondon(parent.Number()) {
 			parentGasLimit := parent.GasLimit() * cm.config.ElasticityMultiplier()
 			header.GasLimit = CalcGasLimit(parentGasLimit, parentGasLimit)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-65f4835a29cfd17101c91be1" role="button"
                   aria-expanded="false" aria-controls="id-65f4835a29cfd17101c91be1">
                    <code>core/rawdb/accessors_chain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/rawdb/accessors_chain_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/rawdb/accessors_chain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+79</span></div>
                        <div class="text-start"><span class="text-danger">-22</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-65f4835a29cfd17101c91be1"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">index a7ceb72998a115653130a19932f443dfda3f7cc4..3340c7f15c8200a11b2831abb90dd4a052b2b6f8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg36">@@ -27,10 +27,12 @@</span> 	&quot;reflect&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg36">@@ -347,6 +349,9 @@</span> 	&#47;&#47; Create a live block since we need metadata to reconstruct the receipt
 	tx1 := types.NewTransaction(1, common.HexToAddress(&quot;0x1&quot;), big.NewInt(1), 1, big.NewInt(1), nil)
 	tx2 := types.NewTransaction(2, common.HexToAddress(&quot;0x2&quot;), big.NewInt(2), 2, big.NewInt(2), nil)
&nbsp;
<span class="term-fg32">+	header := &amp;types.Header{</span>
<span class="term-fg32">+		Number: big.NewInt(0),</span>
<span class="term-fg32">+	}</span>
 	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}
&nbsp;
 	&#47;&#47; Create the two receipts to manage afterwards
<span class="term-fg36">@@ -378,13 +383,16 @@</span> 	receipt2.Bloom = types.CreateBloom(types.Receipts{receipt2})
 	receipts := []*types.Receipt{receipt1, receipt2}
&nbsp;
 	&#47;&#47; Check that no receipt entries are in a pristine database
<span class="term-fg31">-	hash := common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	hash := header.Hash()</span>
 	if rs := ReadReceipts(db, hash, 0, 0, params.TestChainConfig); len(rs) != 0 {
 		t.Fatalf(&quot;non existent receipts returned: %v&quot;, rs)
 	}
 	&#47;&#47; Insert the body that corresponds to the receipts
 	WriteBody(db, hash, 0, body)
&nbsp;
<span class="term-fg32">+	&#47;&#47; Insert the header that corresponds to the receipts</span>
<span class="term-fg32">+	WriteHeader(db, header)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Insert the receipt slice into the database and check presence
 	WriteReceipts(db, hash, 0, receipts)
 	if rs := ReadReceipts(db, hash, 0, 0, params.TestChainConfig); len(rs) == 0 {
<span class="term-fg36">@@ -694,36 +702,56 @@</span>
 	&#47;&#47; Create a live block since we need metadata to reconstruct the receipt
 	tx1 := types.NewTransaction(1, common.HexToAddress(&quot;0x1&quot;), big.NewInt(1), 1, big.NewInt(1), nil)
 	tx2 := types.NewTransaction(2, common.HexToAddress(&quot;0x2&quot;), big.NewInt(2), 2, big.NewInt(2), nil)
<span class="term-fg32">+	tx3 := types.NewTransaction(3, common.HexToAddress(&quot;0x3&quot;), big.NewInt(3), 3, big.NewInt(3), nil)</span>
&nbsp;
<span class="term-fg31">-	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}</span>
<span class="term-fg32">+	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2, tx3}}</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; Create the two receipts to manage afterwards</span>
<span class="term-fg31">-	receipt1 := &amp;types.Receipt{</span>
<span class="term-fg32">+	&#47;&#47; Create the three receipts to manage afterwards</span>
<span class="term-fg32">+	depositNonce := uint64(math.MaxUint64)</span>
<span class="term-fg32">+	depositReceipt := types.Receipt{</span>
 		Status:            types.ReceiptStatusFailed,
 		CumulativeGasUsed: 1,
 		Logs: []*types.Log{
 			{Address: common.BytesToAddress([]byte{0x11})},
 			{Address: common.BytesToAddress([]byte{0x01, 0x11})},
 		},
<span class="term-fg31">-		TxHash:          tx1.Hash(),</span>
<span class="term-fg31">-		ContractAddress: common.BytesToAddress([]byte{0x01, 0x11, 0x11}),</span>
<span class="term-fg31">-		GasUsed:         111111,</span>
<span class="term-fg32">+		TxHash:                tx1.Hash(),</span>
<span class="term-fg32">+		ContractAddress:       common.BytesToAddress([]byte{0x01, 0x11, 0x11}),</span>
<span class="term-fg32">+		GasUsed:               111111,</span>
<span class="term-fg32">+		DepositNonce:          &amp;depositNonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: nil,</span>
 	}
<span class="term-fg31">-	receipt1.Bloom = types.CreateBloom(types.Receipts{receipt1})</span>
<span class="term-fg32">+	depositReceipt.Bloom = types.CreateBloom(types.Receipts{&amp;depositReceipt})</span>
&nbsp;
<span class="term-fg31">-	receipt2 := &amp;types.Receipt{</span>
<span class="term-fg31">-		PostState:         common.Hash{2}.Bytes(),</span>
<span class="term-fg32">+	receiptVersion := types.CanyonDepositReceiptVersion</span>
<span class="term-fg32">+	versionedDepositReceipt := types.Receipt{</span>
<span class="term-fg32">+		Status:            types.ReceiptStatusFailed,</span>
 		CumulativeGasUsed: 2,
 		Logs: []*types.Log{
 			{Address: common.BytesToAddress([]byte{0x22})},
<span class="term-fg31">-			{Address: common.BytesToAddress([]byte{0x02, 0x22})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x01, 0x11})},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		TxHash:                tx2.Hash(),</span>
<span class="term-fg32">+		ContractAddress:       common.BytesToAddress([]byte{0x02, 0x22, 0x22}),</span>
<span class="term-fg32">+		GasUsed:               222222,</span>
<span class="term-fg32">+		DepositNonce:          &amp;depositNonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: &amp;receiptVersion,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	versionedDepositReceipt.Bloom = types.CreateBloom(types.Receipts{&amp;versionedDepositReceipt})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	receipt := types.Receipt{</span>
<span class="term-fg32">+		PostState:         common.Hash{3}.Bytes(),</span>
<span class="term-fg32">+		CumulativeGasUsed: 3,</span>
<span class="term-fg32">+		Logs: []*types.Log{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x33})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x03, 0x33})},</span>
 		},
<span class="term-fg31">-		TxHash:          tx2.Hash(),</span>
<span class="term-fg31">-		ContractAddress: common.BytesToAddress([]byte{0x02, 0x22, 0x22}),</span>
<span class="term-fg31">-		GasUsed:         222222,</span>
<span class="term-fg32">+		TxHash:          tx3.Hash(),</span>
<span class="term-fg32">+		ContractAddress: common.BytesToAddress([]byte{0x03, 0x33, 0x33}),</span>
<span class="term-fg32">+		GasUsed:         333333,</span>
 	}
<span class="term-fg31">-	receipt2.Bloom = types.CreateBloom(types.Receipts{receipt2})</span>
<span class="term-fg31">-	receipts := []*types.Receipt{receipt1, receipt2}</span>
<span class="term-fg32">+	receipt.Bloom = types.CreateBloom(types.Receipts{&amp;receipt})</span>
<span class="term-fg32">+	receipts := []*types.Receipt{&amp;receipt, &amp;depositReceipt, &amp;versionedDepositReceipt}</span>
&nbsp;
 	hash := common.BytesToHash([]byte{0x03, 0x14})
 	&#47;&#47; Check that no receipt entries are in a pristine database
<span class="term-fg36">@@ -740,14 +768,13 @@</span> 	logs := ReadLogs(db, hash, 0)
 	if len(logs) == 0 {
 		t.Fatalf(&quot;no logs returned&quot;)
 	}
<span class="term-fg31">-	if have, want := len(logs), 2; have != want {</span>
<span class="term-fg32">+	if have, want := len(logs), 3; have != want {</span>
 		t.Fatalf(&quot;unexpected number of logs returned, have %d want %d&quot;, have, want)
 	}
<span class="term-fg31">-	if have, want := len(logs[0]), 2; have != want {</span>
<span class="term-fg31">-		t.Fatalf(&quot;unexpected number of logs[0] returned, have %d want %d&quot;, have, want)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if have, want := len(logs[1]), 2; have != want {</span>
<span class="term-fg31">-		t.Fatalf(&quot;unexpected number of logs[1] returned, have %d want %d&quot;, have, want)</span>
<span class="term-fg32">+	for i := range logs {</span>
<span class="term-fg32">+		if have, want := len(logs[i]), 2; have != want {</span>
<span class="term-fg32">+			t.Fatalf(&quot;unexpected number of logs[%d] returned, have %d want %d&quot;, i, have, want)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	for i, pr := range receipts {
<span class="term-fg36">@@ -765,6 +792,36 @@</span> 				t.Fatalf(&quot;receipt #%d: receipt mismatch: have %s, want %s&quot;, i, hex.EncodeToString(rlpHave), hex.EncodeToString(rlpWant))
 			}
 		}
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestParseLegacyReceiptRLP(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Create a gasUsed value greater than a uint64 can represent</span>
<span class="term-fg32">+	gasUsed := big.NewInt(0)</span>
<span class="term-fg32">+	gasUsed = gasUsed.SetUint64(math.MaxUint64)</span>
<span class="term-fg32">+	gasUsed = gasUsed.Add(gasUsed, big.NewInt(math.MaxInt64))</span>
<span class="term-fg32">+	sanityCheck := (&amp;big.Int{}).SetUint64(gasUsed.Uint64())</span>
<span class="term-fg32">+	require.NotEqual(t, gasUsed, sanityCheck)</span>
<span class="term-fg32">+	receipt := types.LegacyOptimismStoredReceiptRLP{</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*types.LogForStorage{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x11})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x01, 0x11})},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		L1GasUsed:  gasUsed,</span>
<span class="term-fg32">+		L1GasPrice: gasUsed,</span>
<span class="term-fg32">+		L1Fee:      gasUsed,</span>
<span class="term-fg32">+		FeeScalar:  &quot;6&quot;,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data, err := rlp.EncodeToBytes(receipt)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	var result storedReceiptRLP</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(data, &amp;result)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasUsed, result.L1GasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasPrice, result.L1GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1Fee, result.L1Fee)</span>
<span class="term-fg32">+	require.Equal(t, receipt.FeeScalar, result.FeeScalar)</span>
 }
&nbsp;
 func TestDeriveLogFields(t *testing.T) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-df8cf15a60e7d736c993c2c9" role="button"
                   aria-expanded="false" aria-controls="id-df8cf15a60e7d736c993c2c9">
                    <code>core/state/statedb.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/state/statedb.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/state/statedb.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-df8cf15a60e7d736c993c2c9"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;statedb.go op-geth&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg1">index a4b8cf93e2d264d07925435eb8c917a8b1e4589f..e9328d0aefda9b85051f1199932a87cfb25fd2ed 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg36">@@ -1388,6 +1388,12 @@</span> 	}
 	return ret
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; OpenStorageTrie opens the storage trie for the storage root of the provided address.</span>
<span class="term-fg32">+func (s *StateDB) OpenStorageTrie(addr common.Address) (Trie, error) {</span>
<span class="term-fg32">+	storageRoot := s.GetStorageRoot(addr)</span>
<span class="term-fg32">+	return s.db.OpenStorageTrie(s.originalRoot, addr, storageRoot, s.trie)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; copySet returns a deep-copied set.
 func copySet[k comparable](set map[k][]byte) map[k][]byte {
 	copied := make(map[k][]byte, len(set))</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7062357122269be85065f454" role="button"
                   aria-expanded="false" aria-controls="id-7062357122269be85065f454">
                    <code>core/state_processor_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/state_processor_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/state_processor_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7062357122269be85065f454"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_processor_test.go op-geth&#47;core&#47;state_processor_test.go</span>
<span class="term-fg1">index 2f5f0dc02b52d640dc8d534a5fe0204e99055ba6..5685e856f0d4e3f58bc2ce44032bff0b146f2d42 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_processor_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_processor_test.go</span>
<span class="term-fg36">@@ -379,7 +379,7 @@</span> 		Time:       parent.Time() + 10,
 		UncleHash:  types.EmptyUncleHash,
 	}
 	if config.IsLondon(header.Number) {
<span class="term-fg31">-		header.BaseFee = eip1559.CalcBaseFee(config, parent.Header())</span>
<span class="term-fg32">+		header.BaseFee = eip1559.CalcBaseFee(config, parent.Header(), header.Time)</span>
 	}
 	if config.IsShanghai(header.Number, header.Time) {
 		header.WithdrawalsHash = &amp;types.EmptyWithdrawalsHash</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bc70deec063973875499c66b" role="button"
                   aria-expanded="false" aria-controls="id-bc70deec063973875499c66b">
                    <code>core/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+54</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bc70deec063973875499c66b"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;superchain_test.go op-geth&#47;core&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..9959374bddc1e87dd95e5995811054c581068d71</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,54 @@</span>
<span class="term-fg32">+package core</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestOPStackGenesis(t *testing.T) {</span>
<span class="term-fg32">+	for id := range superchain.OPChains {</span>
<span class="term-fg32">+		gen, err := LoadOPStackGenesis(id)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatal(err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		t.Logf(&quot;chain: %d, genesis block hash: %s&quot;, id, gen.ToBlock().Hash())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRegistryChainConfigOverride(t *testing.T) {</span>
<span class="term-fg32">+	db := rawdb.NewMemoryDatabase()</span>
<span class="term-fg32">+	genesis, err := LoadOPStackGenesis(10)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if genesis.Config.RegolithTime == nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;expected non-nil regolith time&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	expectedRegolithTime := *genesis.Config.RegolithTime</span>
<span class="term-fg32">+	genesis.Config.RegolithTime = nil</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; initialize the DB</span>
<span class="term-fg32">+	tdb := trie.NewDatabase(db, newDbConfig(rawdb.PathScheme))</span>
<span class="term-fg32">+	genesis.MustCommit(db, tdb)</span>
<span class="term-fg32">+	bl := genesis.ToBlock()</span>
<span class="term-fg32">+	rawdb.WriteCanonicalHash(db, bl.Hash(), 0)</span>
<span class="term-fg32">+	rawdb.WriteBlock(db, bl)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; create chain config, even with incomplete genesis input: the chain config should be corrected</span>
<span class="term-fg32">+	chainConfig, _, err := SetupGenesisBlockWithOverride(db, tdb, genesis, &amp;ChainOverrides{</span>
<span class="term-fg32">+		ApplySuperchainUpgrades: true,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; check if we have a corrected chain config</span>
<span class="term-fg32">+	if chainConfig.RegolithTime == nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;expected regolith time to be corrected, but time is still nil&quot;)</span>
<span class="term-fg32">+	} else if *chainConfig.RegolithTime != expectedRegolithTime {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected regolith time to be %d, but got %d&quot;, expectedRegolithTime, *chainConfig.RegolithTime)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9a0b7014fe80cb1e524a2b60" role="button"
                   aria-expanded="false" aria-controls="id-9a0b7014fe80cb1e524a2b60">
                    <code>core/txpool/blobpool/blobpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/blobpool/blobpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/blobpool/blobpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9a0b7014fe80cb1e524a2b60"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go op-geth&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go</span>
<span class="term-fg1">index f4162acac354f11d1a51ca2c2a498ddd047a957a..cb224e8d681ffc5a976e11c9df182efcf9357ebe 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go</span>
<span class="term-fg36">@@ -399,7 +399,7 @@</span> 	for addr := range p.index {
 		p.recheck(addr, nil)
 	}
 	var (
<span class="term-fg31">-		basefee = uint256.MustFromBig(eip1559.CalcBaseFee(p.chain.Config(), p.head))</span>
<span class="term-fg32">+		basefee = uint256.MustFromBig(eip1559.CalcBaseFee(p.chain.Config(), p.head, p.head.Time+1))</span>
 		blobfee = uint256.MustFromBig(big.NewInt(params.BlobTxMinBlobGasprice))
 	)
 	if p.head.ExcessBlobGas != nil {
<span class="term-fg36">@@ -782,7 +782,7 @@</span> 		p.limbo.finalize(p.chain.CurrentFinalBlock())
 	}
 	&#47;&#47; Reset the price heap for the new set of basefee&#47;blobfee pairs
 	var (
<span class="term-fg31">-		basefee = uint256.MustFromBig(eip1559.CalcBaseFee(p.chain.Config(), newHead))</span>
<span class="term-fg32">+		basefee = uint256.MustFromBig(eip1559.CalcBaseFee(p.chain.Config(), newHead, newHead.Time+1))</span>
 		blobfee = uint256.MustFromBig(big.NewInt(params.BlobTxMinBlobGasprice))
 	)
 	if newHead.ExcessBlobGas != nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3683e6d427ff14287116c5ce" role="button"
                   aria-expanded="false" aria-controls="id-3683e6d427ff14287116c5ce">
                    <code>core/txpool/blobpool/blobpool_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/txpool/blobpool/blobpool_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/txpool/blobpool/blobpool_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3683e6d427ff14287116c5ce"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;blobpool_test.go op-geth&#47;core&#47;txpool&#47;blobpool&#47;blobpool_test.go</span>
<span class="term-fg1">index 7dd5ad4b26a0cd908973c85f867d4d7b05349295..d661c08b4664f46a1a81d7b2dba4322b33135722 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;blobpool_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;blobpool&#47;blobpool_test.go</span>
<span class="term-fg36">@@ -102,7 +102,7 @@</span> 			Number:   blockNumber,
 			GasLimit: gasLimit,
 			GasUsed:  0,
 			BaseFee:  mid,
<span class="term-fg31">-		}).Cmp(bc.basefee.ToBig()) &gt; 0 {</span>
<span class="term-fg32">+		}, blockTime).Cmp(bc.basefee.ToBig()) &gt; 0 {</span>
 			hi = mid
 		} else {
 			lo = mid</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ef604be18294ad4290ee7263" role="button"
                   aria-expanded="false" aria-controls="id-ef604be18294ad4290ee7263">
                    <code>core/types/receipt_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/types/receipt_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/receipt_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+472</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ef604be18294ad4290ee7263"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt_test.go op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">index a7b26444712fe8c669ea732fa423588a58497f32..8eaae910575aa5bc74adbfdb53d544c6e5b2ab3a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span>
 import (
 	&quot;bytes&quot;
 	&quot;encoding&#47;json&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&quot;
 	&quot;math&#47;big&quot;
 	&quot;reflect&quot;
<span class="term-fg36">@@ -29,9 +30,25 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 	&quot;github.com&#47;kylelemons&#47;godebug&#47;diff&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg32">+	bedrockGenesisTestConfig = func() *params.ChainConfig {</span>
<span class="term-fg32">+		conf := *params.AllCliqueProtocolChanges &#47;&#47; copy the config</span>
<span class="term-fg32">+		conf.Clique = nil</span>
<span class="term-fg32">+		conf.TerminalTotalDifficultyPassed = true</span>
<span class="term-fg32">+		conf.BedrockBlock = big.NewInt(0)</span>
<span class="term-fg32">+		conf.Optimism = &amp;params.OptimismConfig{EIP1559Elasticity: 50, EIP1559Denominator: 10}</span>
<span class="term-fg32">+		return &amp;conf</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+	ecotoneTestConfig = func() *params.ChainConfig {</span>
<span class="term-fg32">+		conf := *bedrockGenesisTestConfig &#47;&#47; copy the config</span>
<span class="term-fg32">+		time := uint64(0)</span>
<span class="term-fg32">+		conf.EcotoneTime = &amp;time</span>
<span class="term-fg32">+		return &amp;conf</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
 	legacyReceipt = &amp;Receipt{
 		Status:            ReceiptStatusFailed,
 		CumulativeGasUsed: 1,
<span class="term-fg36">@@ -82,6 +99,63 @@</span> 			},
 		},
 		Type: DynamicFeeTxType,
 	}
<span class="term-fg32">+	depositReceiptNoNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:            ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce                   = uint64(1234)</span>
<span class="term-fg32">+	depositReceiptWithNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:                ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed:     1,</span>
<span class="term-fg32">+		DepositNonce:          &amp;nonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: nil,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	version                           = CanyonDepositReceiptVersion</span>
<span class="term-fg32">+	depositReceiptWithNonceAndVersion = &amp;Receipt{</span>
<span class="term-fg32">+		Status:                ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed:     1,</span>
<span class="term-fg32">+		DepositNonce:          &amp;nonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: &amp;version,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Create a few transactions to have receipts for
 	to2 = common.HexToAddress(&quot;0x2&quot;)
<span class="term-fg36">@@ -149,11 +223,23 @@</span> 			GasFeeCap:  uint256.NewInt(1077),
 			BlobFeeCap: uint256.NewInt(100077),
 			BlobHashes: []common.Hash{{}, {}, {}},
 		}),
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   60,</span>
<span class="term-fg32">+		}),</span>
 	}
<span class="term-fg31">-</span>
<span class="term-fg31">-	blockNumber = big.NewInt(1)</span>
<span class="term-fg31">-	blockTime   = uint64(2)</span>
<span class="term-fg31">-	blockHash   = common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	depNonce1                   = uint64(7)</span>
<span class="term-fg32">+	depNonce2                   = uint64(8)</span>
<span class="term-fg32">+	blockNumber                 = big.NewInt(1)</span>
<span class="term-fg32">+	blockTime                   = uint64(2)</span>
<span class="term-fg32">+	blockHash                   = common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	canyonDepositReceiptVersion = CanyonDepositReceiptVersion</span>
&nbsp;
 	&#47;&#47; Create the corresponding receipts
 	receipts = Receipts{
<span class="term-fg36">@@ -293,6 +379,78 @@</span> 			BlockHash:         blockHash,
 			BlockNumber:       blockNumber,
 			TransactionIndex:  6,
 		},
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 28,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[7].Hash(),</span>
<span class="term-fg32">+					TxIndex:     7,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       4,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[7].Hash(),</span>
<span class="term-fg32">+					TxIndex:     7,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       5,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:                txs[7].Hash(),</span>
<span class="term-fg32">+			ContractAddress:       common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:               50,</span>
<span class="term-fg32">+			EffectiveGasPrice:     big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:             blockHash,</span>
<span class="term-fg32">+			BlockNumber:           blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:      7,</span>
<span class="term-fg32">+			DepositNonce:          &amp;depNonce1,</span>
<span class="term-fg32">+			DepositReceiptVersion: nil,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 60 + 50 + 28,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[8].Hash(),</span>
<span class="term-fg32">+					TxIndex:     8,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       6,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[8].Hash(),</span>
<span class="term-fg32">+					TxIndex:     8,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       7,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:                txs[8].Hash(),</span>
<span class="term-fg32">+			ContractAddress:       common.HexToAddress(&quot;0x117814af22cb83d8ad6e8489e9477d28265bc105&quot;),</span>
<span class="term-fg32">+			GasUsed:               60,</span>
<span class="term-fg32">+			EffectiveGasPrice:     big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:             blockHash,</span>
<span class="term-fg32">+			BlockNumber:           blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:      8,</span>
<span class="term-fg32">+			DepositNonce:          &amp;depNonce2,</span>
<span class="term-fg32">+			DepositReceiptVersion: &amp;canyonDepositReceiptVersion,</span>
<span class="term-fg32">+		},</span>
 	}
 )
&nbsp;
<span class="term-fg36">@@ -308,10 +466,10 @@</span>
 &#47;&#47; Tests that receipt data can be correctly derived from the contextual infos
 func TestDeriveFields(t *testing.T) {
 	&#47;&#47; Re-derive receipts.
<span class="term-fg31">-	basefee := big.NewInt(1000)</span>
<span class="term-fg32">+	baseFee := big.NewInt(1000)</span>
 	blobGasPrice := big.NewInt(920)
 	derivedReceipts := clearComputedFieldsOnReceipts(receipts)
<span class="term-fg31">-	err := Receipts(derivedReceipts).DeriveFields(params.TestChainConfig, blockHash, blockNumber.Uint64(), blockTime, basefee, blobGasPrice, txs)</span>
<span class="term-fg32">+	err := Receipts(derivedReceipts).DeriveFields(params.TestChainConfig, blockHash, blockNumber.Uint64(), blockTime, baseFee, blobGasPrice, txs)</span>
 	if err != nil {
 		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)
 	}
<span class="term-fg36">@@ -344,6 +502,18 @@</span> 		r := Receipt{}
 		err = r.UnmarshalJSON(b)
 		if err != nil {
 			t.Fatal(&quot;error unmarshaling receipt from json:&quot;, err)
<span class="term-fg32">+		}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		&#47;&#47; Make sure marshal&#47;unmarshal doesn&#39;t affect receipt hash root computation by comparing</span>
<span class="term-fg32">+		&#47;&#47; the output of EncodeIndex</span>
<span class="term-fg32">+		rsBefore := Receipts([]*Receipt{receipts[i]})</span>
<span class="term-fg32">+		rsAfter := Receipts([]*Receipt{&amp;r})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		encBefore, encAfter := bytes.Buffer{}, bytes.Buffer{}</span>
<span class="term-fg32">+		rsBefore.EncodeIndex(0, &amp;encBefore)</span>
<span class="term-fg32">+		rsAfter.EncodeIndex(0, &amp;encAfter)</span>
<span class="term-fg32">+		if !bytes.Equal(encBefore.Bytes(), encAfter.Bytes()) {</span>
<span class="term-fg32">+			t.Errorf(&quot;%v: EncodeIndex differs after JSON marshal&#47;unmarshal&quot;, i)</span>
 		}
 	}
 }
<span class="term-fg36">@@ -527,3 +697,299 @@</span> 		l[i] = &amp;cpy
 	}
 	return l
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func getOptimismTxReceipts(</span>
<span class="term-fg32">+	t *testing.T, l1AttributesPayload []byte,</span>
<span class="term-fg32">+	l1GasPrice, l1GasUsed *big.Int, feeScalar *big.Float, l1Fee *big.Int) ([]*Transaction, []*Receipt) {</span>
<span class="term-fg32">+	&#47;&#47;to4 := common.HexToAddress(&quot;0x4&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Create a few transactions to have receipts for</span>
<span class="term-fg32">+	txs := Transactions{</span>
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+			Data:  l1AttributesPayload,</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+		emptyTx,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Create the corresponding receipts</span>
<span class="term-fg32">+	receipts := Receipts{</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 15,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[0].Hash(),</span>
<span class="term-fg32">+					TxIndex:     0,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       0,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[0].Hash(),</span>
<span class="term-fg32">+					TxIndex:     0,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       1,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:            txs[0].Hash(),</span>
<span class="term-fg32">+			ContractAddress:   common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:           65,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  0,</span>
<span class="term-fg32">+			DepositNonce:      &amp;depNonce1,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              LegacyTxType,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(0),</span>
<span class="term-fg32">+			PostState:         common.Hash{4}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 10,</span>
<span class="term-fg32">+			Logs:              []*Log{},</span>
<span class="term-fg32">+			&#47;&#47; derived fields:</span>
<span class="term-fg32">+			TxHash:           txs[1].Hash(),</span>
<span class="term-fg32">+			GasUsed:          18446744073709551561,</span>
<span class="term-fg32">+			BlockHash:        blockHash,</span>
<span class="term-fg32">+			BlockNumber:      blockNumber,</span>
<span class="term-fg32">+			TransactionIndex: 1,</span>
<span class="term-fg32">+			L1GasPrice:       l1GasPrice,</span>
<span class="term-fg32">+			L1GasUsed:        l1GasUsed,</span>
<span class="term-fg32">+			L1Fee:            l1Fee,</span>
<span class="term-fg32">+			FeeScalar:        feeScalar,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return txs, receipts</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestDeriveOptimismBedrockTxReceipts(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Bedrock style l1 attributes with L1Scalar=7_000_000 (becomes 7 after division), L1Overhead=50, L1BaseFee=1000*1e6</span>
<span class="term-fg32">+	payload := common.Hex2Bytes(&quot;015d8eb900000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d2000000000000000000000000000000000000000000000000000000003b9aca0000000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d2000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000006acfc0015d8eb900000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d2000000000000000000000000000000000000000000000000000000003b9aca0000000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d2000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000006acfc0&quot;)</span>
<span class="term-fg32">+	&#47;&#47; the parameters we use below are defined in rollup_test.go</span>
<span class="term-fg32">+	l1GasPrice := baseFee</span>
<span class="term-fg32">+	l1GasUsed := bedrockGas</span>
<span class="term-fg32">+	feeScalar := big.NewFloat(float64(scalar.Uint64() &#47; 1e6))</span>
<span class="term-fg32">+	l1Fee := bedrockFee</span>
<span class="term-fg32">+	txs, receipts := getOptimismTxReceipts(t, payload, l1GasPrice, l1GasUsed, feeScalar, l1Fee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Re-derive receipts.</span>
<span class="term-fg32">+	baseFee := big.NewInt(1000)</span>
<span class="term-fg32">+	derivedReceipts := clearComputedFieldsOnReceipts(receipts)</span>
<span class="term-fg32">+	err := Receipts(derivedReceipts).DeriveFields(bedrockGenesisTestConfig, blockHash, blockNumber.Uint64(), 0, baseFee, nil, txs)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	checkBedrockReceipts(t, receipts, derivedReceipts)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should get same result with the Ecotone config because it will assume this is &quot;first ecotone block&quot;</span>
<span class="term-fg32">+	&#47;&#47; if it sees the bedrock style L1 attributes.</span>
<span class="term-fg32">+	err = Receipts(derivedReceipts).DeriveFields(ecotoneTestConfig, blockHash, blockNumber.Uint64(), 0, baseFee, nil, txs)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	checkBedrockReceipts(t, receipts, derivedReceipts)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestDeriveOptimismEcotoneTxReceipts(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Ecotone style l1 attributes with baseFeeScalar=2, blobBaseFeeScalar=3, baseFee=1000*1e6, blobBaseFee=10*1e6</span>
<span class="term-fg32">+	payload := common.Hex2Bytes(&quot;440a5e20000000020000000300000000000004d200000000000004d200000000000004d2000000000000000000000000000000000000000000000000000000003b9aca00000000000000000000000000000000000000000000000000000000000098968000000000000000000000000000000000000000000000000000000000000004d200000000000000000000000000000000000000000000000000000000000004d2&quot;)</span>
<span class="term-fg32">+	&#47;&#47; the parameters we use below are defined in rollup_test.go</span>
<span class="term-fg32">+	l1GasPrice := baseFee</span>
<span class="term-fg32">+	l1GasUsed := ecotoneGas</span>
<span class="term-fg32">+	l1Fee := ecotoneFee</span>
<span class="term-fg32">+	txs, receipts := getOptimismTxReceipts(t, payload, l1GasPrice, l1GasUsed, nil &#47;*feeScalar*&#47;, l1Fee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Re-derive receipts.</span>
<span class="term-fg32">+	baseFee := big.NewInt(1000)</span>
<span class="term-fg32">+	derivedReceipts := clearComputedFieldsOnReceipts(receipts)</span>
<span class="term-fg32">+	&#47;&#47; Should error out if we try to process this with a pre-Ecotone config</span>
<span class="term-fg32">+	err := Receipts(derivedReceipts).DeriveFields(bedrockGenesisTestConfig, blockHash, blockNumber.Uint64(), 0, baseFee, nil, txs)</span>
<span class="term-fg32">+	if err == nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected error from deriving ecotone receipts with pre-ecotone config, got none&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	err = Receipts(derivedReceipts).DeriveFields(ecotoneTestConfig, blockHash, blockNumber.Uint64(), 0, baseFee, nil, txs)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	diffReceipts(t, receipts, derivedReceipts)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func diffReceipts(t *testing.T, receipts, derivedReceipts []*Receipt) {</span>
<span class="term-fg32">+	&#47;&#47; Check diff of receipts against derivedReceipts.</span>
<span class="term-fg32">+	r1, err := json.MarshalIndent(receipts, &quot;&quot;, &quot;  &quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;error marshaling input receipts:&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r2, err := json.MarshalIndent(derivedReceipts, &quot;&quot;, &quot;  &quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;error marshaling derived receipts:&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	d := diff.Diff(string(r1), string(r2))</span>
<span class="term-fg32">+	if d != &quot;&quot; {</span>
<span class="term-fg32">+		t.Fatal(&quot;receipts differ:&quot;, d)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func checkBedrockReceipts(t *testing.T, receipts, derivedReceipts []*Receipt) {</span>
<span class="term-fg32">+	diffReceipts(t, receipts, derivedReceipts)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we preserved the invariant: l1Fee = l1GasPrice * l1GasUsed * l1FeeScalar</span>
<span class="term-fg32">+	&#47;&#47; but with more difficult int math...</span>
<span class="term-fg32">+	l2Rcpt := derivedReceipts[1]</span>
<span class="term-fg32">+	l1GasCost := new(big.Int).Mul(l2Rcpt.L1GasPrice, l2Rcpt.L1GasUsed)</span>
<span class="term-fg32">+	l1Fee := new(big.Float).Mul(new(big.Float).SetInt(l1GasCost), l2Rcpt.FeeScalar)</span>
<span class="term-fg32">+	require.Equal(t, new(big.Float).SetInt(l2Rcpt.L1Fee), l1Fee)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestBedrockDepositReceiptUnchanged(t *testing.T) {</span>
<span class="term-fg32">+	expectedRlp := common.FromHex(&quot;7EF90156A003000000000000000000000000000000000000000000000000000000000000000AB9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0D7940000000000000000000000000000000000000033C001D7940000000000000000000000000000000000000333C002&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Deposit receipt with no nonce</span>
<span class="term-fg32">+	receipt := &amp;Receipt{</span>
<span class="term-fg32">+		Type:              DepositTxType,</span>
<span class="term-fg32">+		PostState:         common.Hash{3}.Bytes(),</span>
<span class="term-fg32">+		CumulativeGasUsed: 10,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x33}), Data: []byte{1}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x03, 0x33}), Data: []byte{2}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		TxHash:          common.Hash{},</span>
<span class="term-fg32">+		ContractAddress: common.BytesToAddress([]byte{0x03, 0x33, 0x33}),</span>
<span class="term-fg32">+		GasUsed:         4,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rlp, err := receipt.MarshalBinary()</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, expectedRlp, rlp)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Consensus values should be unchanged after reparsing</span>
<span class="term-fg32">+	parsed := new(Receipt)</span>
<span class="term-fg32">+	err = parsed.UnmarshalBinary(rlp)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Status, parsed.Status)</span>
<span class="term-fg32">+	require.Equal(t, receipt.CumulativeGasUsed, parsed.CumulativeGasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Bloom, parsed.Bloom)</span>
<span class="term-fg32">+	require.EqualValues(t, receipt.Logs, parsed.Logs)</span>
<span class="term-fg32">+	&#47;&#47; And still shouldn&#39;t have a nonce</span>
<span class="term-fg32">+	require.Nil(t, parsed.DepositNonce)</span>
<span class="term-fg32">+	&#47;&#47; ..or a deposit nonce</span>
<span class="term-fg32">+	require.Nil(t, parsed.DepositReceiptVersion)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Regolith introduced an inconsistency in behavior between EncodeIndex and MarshalBinary for a</span>
<span class="term-fg32">+&#47;&#47; deposit transaction receipt. TestReceiptEncodeIndexBugIsEnshrined makes sure this difference is</span>
<span class="term-fg32">+&#47;&#47; preserved for backwards compatibility purposes, but also that there is no discrepancy for the</span>
<span class="term-fg32">+&#47;&#47; post-Canyon encoding.</span>
<span class="term-fg32">+func TestReceiptEncodeIndexBugIsEnshrined(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Check that a post-Regolith, pre-Canyon receipt produces the expected difference between</span>
<span class="term-fg32">+	&#47;&#47; EncodeIndex and MarshalBinary.</span>
<span class="term-fg32">+	buf := new(bytes.Buffer)</span>
<span class="term-fg32">+	receipts := Receipts{depositReceiptWithNonce}</span>
<span class="term-fg32">+	receipts.EncodeIndex(0, buf)</span>
<span class="term-fg32">+	indexBytes := buf.Bytes()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	regularBytes, _ := receipts[0].MarshalBinary()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.NotEqual(t, indexBytes, regularBytes)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Confirm the buggy encoding is as expected, which means it should encode as if it had no</span>
<span class="term-fg32">+	&#47;&#47; nonce specified (like that of a non-deposit receipt, whose encoding would differ only in the</span>
<span class="term-fg32">+	&#47;&#47; type byte).</span>
<span class="term-fg32">+	buf.Reset()</span>
<span class="term-fg32">+	tempReceipt := *depositReceiptWithNonce</span>
<span class="term-fg32">+	tempReceipt.Type = eip1559Receipt.Type</span>
<span class="term-fg32">+	buggyBytes, _ := tempReceipt.MarshalBinary()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, indexBytes[1:], buggyBytes[1:])</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; check that the post-Canyon encoding has no differences between EncodeIndex and</span>
<span class="term-fg32">+	&#47;&#47; MarshalBinary.</span>
<span class="term-fg32">+	buf.Reset()</span>
<span class="term-fg32">+	receipts = Receipts{depositReceiptWithNonceAndVersion}</span>
<span class="term-fg32">+	receipts.EncodeIndex(0, buf)</span>
<span class="term-fg32">+	indexBytes = buf.Bytes()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	regularBytes, _ = receipts[0].MarshalBinary()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, indexBytes, regularBytes)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that bumping the nonce post-canyon changes the hash</span>
<span class="term-fg32">+	bumpedReceipt := *depositReceiptWithNonceAndVersion</span>
<span class="term-fg32">+	bumpedNonce := nonce + 1</span>
<span class="term-fg32">+	bumpedReceipt.DepositNonce = &amp;bumpedNonce</span>
<span class="term-fg32">+	bumpedBytes, _ := bumpedReceipt.MarshalBinary()</span>
<span class="term-fg32">+	require.NotEqual(t, regularBytes, bumpedBytes)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceipt(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonceAndVersion&quot;, rcpt: depositReceiptWithNonceAndVersion},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt, d)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositNonce, d.DepositNonce)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositReceiptVersion, d.DepositReceiptVersion)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;%sRejectExtraData&quot;, test.name), func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			data = append(data, 1, 2, 3, 4)</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.Error(t, err)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceiptForStorage(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonceAndVersion&quot;, rcpt: depositReceiptWithNonceAndVersion},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := rlp.EncodeToBytes((*ReceiptForStorage)(test.rcpt))</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;ReceiptForStorage{}</span>
<span class="term-fg32">+			err = rlp.DecodeBytes(data, d)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			&#47;&#47; Only check the stored fields - the others are derived later</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Status, d.Status)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.CumulativeGasUsed, d.CumulativeGasUsed)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Logs, d.Logs)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositNonce, d.DepositNonce)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositReceiptVersion, d.DepositReceiptVersion)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5951913f217eac641ad7f3bf" role="button"
                   aria-expanded="false" aria-controls="id-5951913f217eac641ad7f3bf">
                    <code>core/types/rollup_cost.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/rollup_cost.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+285</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5951913f217eac641ad7f3bf"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_cost.go op-geth&#47;core&#47;types&#47;rollup_cost.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..c40b24db942326bd949d4743b548c302348aea89</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_cost.go</span>
<span class="term-fg36">@@ -0,0 +1,285 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;bytes&quot;</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	&#47;&#47; The two 4-byte Ecotone fee scalar values are packed into the same storage slot as the 8-byte</span>
<span class="term-fg32">+	&#47;&#47; sequence number and have the following Solidity offsets within the slot. Note that Solidity</span>
<span class="term-fg32">+	&#47;&#47; offsets correspond to the last byte of the value in the slot, counting backwards from the</span>
<span class="term-fg32">+	&#47;&#47; end of the slot. For example, The 8-byte sequence number has offset 0, and is therefore</span>
<span class="term-fg32">+	&#47;&#47; stored as big-endian format in bytes [24:32] of the slot.</span>
<span class="term-fg32">+	BaseFeeScalarSlotOffset     = 12 &#47;&#47; bytes [16:20] of the slot</span>
<span class="term-fg32">+	BlobBaseFeeScalarSlotOffset = 8  &#47;&#47; bytes [20:24] of the slot</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; scalarSectionStart is the beginning of the scalar values segment in the slot</span>
<span class="term-fg32">+	&#47;&#47; array. baseFeeScalar is in the first four bytes of the segment, blobBaseFeeScalar the next</span>
<span class="term-fg32">+	&#47;&#47; four.</span>
<span class="term-fg32">+	scalarSectionStart = 32 - BaseFeeScalarSlotOffset - 4</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func init() {</span>
<span class="term-fg32">+	if BlobBaseFeeScalarSlotOffset != BaseFeeScalarSlotOffset-4 {</span>
<span class="term-fg32">+		panic(&quot;this code assumes the scalars are at adjacent positions in the scalars slot&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; BedrockL1AttributesSelector is the function selector indicating Bedrock style L1 gas</span>
<span class="term-fg32">+	&#47;&#47; attributes.</span>
<span class="term-fg32">+	BedrockL1AttributesSelector = []byte{0x01, 0x5d, 0x8e, 0xb9}</span>
<span class="term-fg32">+	&#47;&#47; EcotoneL1AttributesSelector is the selector indicating Ecotone style L1 gas attributes.</span>
<span class="term-fg32">+	EcotoneL1AttributesSelector = []byte{0x44, 0x0a, 0x5e, 0x20}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; L1BlockAddr is the address of the L1Block contract which stores the L1 gas attributes.</span>
<span class="term-fg32">+	L1BlockAddr = common.HexToAddress(&quot;0x4200000000000000000000000000000000000015&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	L1BaseFeeSlot = common.BigToHash(big.NewInt(1))</span>
<span class="term-fg32">+	OverheadSlot  = common.BigToHash(big.NewInt(5))</span>
<span class="term-fg32">+	ScalarSlot    = common.BigToHash(big.NewInt(6))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; L2BlobBaseFeeSlot was added with the Ecotone upgrade and stores the blobBaseFee L1 gas</span>
<span class="term-fg32">+	&#47;&#47; attribute.</span>
<span class="term-fg32">+	L1BlobBaseFeeSlot = common.BigToHash(big.NewInt(7))</span>
<span class="term-fg32">+	&#47;&#47; L1FeeScalarsSlot as of the Ecotone upgrade stores the 32-bit basefeeScalar and</span>
<span class="term-fg32">+	&#47;&#47; blobBaseFeeScalar L1 gas attributes at offsets `BaseFeeScalarSlotOffset` and</span>
<span class="term-fg32">+	&#47;&#47; `BlobBaseFeeScalarSlotOffset` respectively.</span>
<span class="term-fg32">+	L1FeeScalarsSlot = common.BigToHash(big.NewInt(3))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	oneMillion     = big.NewInt(1_000_000)</span>
<span class="term-fg32">+	ecotoneDivisor = big.NewInt(1_000_000 * 16)</span>
<span class="term-fg32">+	sixteen        = big.NewInt(16)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	emptyScalars = make([]byte, 8)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; RollupCostData is a transaction structure that caches data for quickly computing the data</span>
<span class="term-fg32">+&#47;&#47; availablility costs for the transaction.</span>
<span class="term-fg32">+type RollupCostData struct {</span>
<span class="term-fg32">+	zeroes, ones uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type StateGetter interface {</span>
<span class="term-fg32">+	GetState(common.Address, common.Hash) common.Hash</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; L1CostFunc is used in the state transition to determine the data availability fee charged to the</span>
<span class="term-fg32">+&#47;&#47; sender of non-Deposit transactions.  It returns nil if no data availability fee is charged.</span>
<span class="term-fg32">+type L1CostFunc func(rcd RollupCostData, blockTime uint64) *big.Int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; l1CostFunc is an internal version of L1CostFunc that also returns the gasUsed for use in</span>
<span class="term-fg32">+&#47;&#47; receipts.</span>
<span class="term-fg32">+type l1CostFunc func(rcd RollupCostData) (fee, gasUsed *big.Int)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func NewRollupCostData(data []byte) (out RollupCostData) {</span>
<span class="term-fg32">+	for _, b := range data {</span>
<span class="term-fg32">+		if b == 0 {</span>
<span class="term-fg32">+			out.zeroes++</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			out.ones++</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return out</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewL1CostFunc returns a function used for calculating data availability fees, or nil if this is</span>
<span class="term-fg32">+&#47;&#47; not an op-stack chain.</span>
<span class="term-fg32">+func NewL1CostFunc(config *params.ChainConfig, statedb StateGetter) L1CostFunc {</span>
<span class="term-fg32">+	if config.Optimism == nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	forBlock := ^uint64(0)</span>
<span class="term-fg32">+	var cachedFunc l1CostFunc</span>
<span class="term-fg32">+	return func(rollupCostData RollupCostData, blockTime uint64) *big.Int {</span>
<span class="term-fg32">+		if rollupCostData == (RollupCostData{}) {</span>
<span class="term-fg32">+			return nil &#47;&#47; Do not charge if there is no rollup cost-data (e.g. RPC call or deposit).</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if forBlock != blockTime {</span>
<span class="term-fg32">+			if forBlock != ^uint64(0) {</span>
<span class="term-fg32">+				&#47;&#47; best practice is not to re-use l1 cost funcs across different blocks, but we</span>
<span class="term-fg32">+				&#47;&#47; make it work just in case.</span>
<span class="term-fg32">+				log.Info(&quot;l1 cost func re-used for different L1 block&quot;, &quot;oldTime&quot;, forBlock, &quot;newTime&quot;, blockTime)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			forBlock = blockTime</span>
<span class="term-fg32">+			&#47;&#47; Note: the various state variables below are not initialized from the DB until this</span>
<span class="term-fg32">+			&#47;&#47; point to allow deposit transactions from the block to be processed first by state</span>
<span class="term-fg32">+			&#47;&#47; transition.  This behavior is consensus critical!</span>
<span class="term-fg32">+			if !config.IsOptimismEcotone(blockTime) {</span>
<span class="term-fg32">+				cachedFunc = newL1CostFuncBedrock(config, statedb, blockTime)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				l1BlobBaseFee := statedb.GetState(L1BlockAddr, L1BlobBaseFeeSlot).Big()</span>
<span class="term-fg32">+				l1FeeScalars := statedb.GetState(L1BlockAddr, L1FeeScalarsSlot).Bytes()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+				&#47;&#47; Edge case: the very first Ecotone block requires we use the Bedrock cost</span>
<span class="term-fg32">+				&#47;&#47; function. We detect this scenario by checking if the Ecotone parameters are</span>
<span class="term-fg32">+				&#47;&#47; unset.  Not here we rely on assumption that the scalar parameters are adjacent</span>
<span class="term-fg32">+				&#47;&#47; in the buffer and basefeeScalar comes first.</span>
<span class="term-fg32">+				if l1BlobBaseFee.BitLen() == 0 &amp;&amp;</span>
<span class="term-fg32">+					bytes.Equal(emptyScalars, l1FeeScalars[scalarSectionStart:scalarSectionStart+8]) {</span>
<span class="term-fg32">+					log.Info(&quot;using bedrock l1 cost func for first Ecotone block&quot;, &quot;time&quot;, blockTime)</span>
<span class="term-fg32">+					cachedFunc = newL1CostFuncBedrock(config, statedb, blockTime)</span>
<span class="term-fg32">+				} else {</span>
<span class="term-fg32">+					l1BaseFee := statedb.GetState(L1BlockAddr, L1BaseFeeSlot).Big()</span>
<span class="term-fg32">+					offset := scalarSectionStart</span>
<span class="term-fg32">+					l1BaseFeeScalar := new(big.Int).SetBytes(l1FeeScalars[offset : offset+4])</span>
<span class="term-fg32">+					l1BlobBaseFeeScalar := new(big.Int).SetBytes(l1FeeScalars[offset+4 : offset+8])</span>
<span class="term-fg32">+					cachedFunc = newL1CostFuncEcotone(l1BaseFee, l1BlobBaseFee, l1BaseFeeScalar, l1BlobBaseFeeScalar)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		fee, _ := cachedFunc(rollupCostData)</span>
<span class="term-fg32">+		return fee</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; newL1CostFuncBedrock returns an L1 cost function suitable for Bedrock, Regolith, and the first</span>
<span class="term-fg32">+&#47;&#47; block only of the Ecotone upgrade.</span>
<span class="term-fg32">+func newL1CostFuncBedrock(config *params.ChainConfig, statedb StateGetter, blockTime uint64) l1CostFunc {</span>
<span class="term-fg32">+	l1BaseFee := statedb.GetState(L1BlockAddr, L1BaseFeeSlot).Big()</span>
<span class="term-fg32">+	overhead := statedb.GetState(L1BlockAddr, OverheadSlot).Big()</span>
<span class="term-fg32">+	scalar := statedb.GetState(L1BlockAddr, ScalarSlot).Big()</span>
<span class="term-fg32">+	isRegolith := config.IsRegolith(blockTime)</span>
<span class="term-fg32">+	return newL1CostFuncBedrockHelper(l1BaseFee, overhead, scalar, isRegolith)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; newL1CostFuncBedrockHelper is lower level version of newL1CostFuncBedrock that expects already</span>
<span class="term-fg32">+&#47;&#47; extracted parameters</span>
<span class="term-fg32">+func newL1CostFuncBedrockHelper(l1BaseFee, overhead, scalar *big.Int, isRegolith bool) l1CostFunc {</span>
<span class="term-fg32">+	return func(rollupCostData RollupCostData) (fee, gasUsed *big.Int) {</span>
<span class="term-fg32">+		if rollupCostData == (RollupCostData{}) {</span>
<span class="term-fg32">+			return nil, nil &#47;&#47; Do not charge if there is no rollup cost-data (e.g. RPC call or deposit)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		gas := rollupCostData.zeroes * params.TxDataZeroGas</span>
<span class="term-fg32">+		if isRegolith {</span>
<span class="term-fg32">+			gas += rollupCostData.ones * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			gas += (rollupCostData.ones + 68) * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		gasWithOverhead := new(big.Int).SetUint64(gas)</span>
<span class="term-fg32">+		gasWithOverhead.Add(gasWithOverhead, overhead)</span>
<span class="term-fg32">+		l1Cost := l1CostHelper(gasWithOverhead, l1BaseFee, scalar)</span>
<span class="term-fg32">+		return l1Cost, gasWithOverhead</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; newL1CostFuncEcotone returns an l1 cost function suitable for the Ecotone upgrade except for the</span>
<span class="term-fg32">+&#47;&#47; very first block of the upgrade.</span>
<span class="term-fg32">+func newL1CostFuncEcotone(l1BaseFee, l1BlobBaseFee, l1BaseFeeScalar, l1BlobBaseFeeScalar *big.Int) l1CostFunc {</span>
<span class="term-fg32">+	return func(costData RollupCostData) (fee, calldataGasUsed *big.Int) {</span>
<span class="term-fg32">+		calldataGas := (costData.zeroes * params.TxDataZeroGas) + (costData.ones * params.TxDataNonZeroGasEIP2028)</span>
<span class="term-fg32">+		calldataGasUsed = new(big.Int).SetUint64(calldataGas)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		&#47;&#47; Ecotone L1 cost function:</span>
<span class="term-fg32">+		&#47;&#47;</span>
<span class="term-fg32">+		&#47;&#47;   (calldataGas&#47;16)*(l1BaseFee*16*l1BaseFeeScalar + l1BlobBaseFee*l1BlobBaseFeeScalar)&#47;1e6</span>
<span class="term-fg32">+		&#47;&#47;</span>
<span class="term-fg32">+		&#47;&#47; We divide &quot;calldataGas&quot; by 16 to change from units of calldata gas to &quot;estimated # of bytes when</span>
<span class="term-fg32">+		&#47;&#47; compressed&quot;. Known as &quot;compressedTxSize&quot; in the spec.</span>
<span class="term-fg32">+		&#47;&#47;</span>
<span class="term-fg32">+		&#47;&#47; Function is actually computed as follows for better precision under integer arithmetic:</span>
<span class="term-fg32">+		&#47;&#47;</span>
<span class="term-fg32">+		&#47;&#47;   calldataGas*(l1BaseFee*16*l1BaseFeeScalar + l1BlobBaseFee*l1BlobBaseFeeScalar)&#47;16e6</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		calldataCostPerByte := new(big.Int).Set(l1BaseFee)</span>
<span class="term-fg32">+		calldataCostPerByte = calldataCostPerByte.Mul(calldataCostPerByte, sixteen)</span>
<span class="term-fg32">+		calldataCostPerByte = calldataCostPerByte.Mul(calldataCostPerByte, l1BaseFeeScalar)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		blobCostPerByte := new(big.Int).Set(l1BlobBaseFee)</span>
<span class="term-fg32">+		blobCostPerByte = blobCostPerByte.Mul(blobCostPerByte, l1BlobBaseFeeScalar)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		fee = new(big.Int).Add(calldataCostPerByte, blobCostPerByte)</span>
<span class="term-fg32">+		fee = fee.Mul(fee, calldataGasUsed)</span>
<span class="term-fg32">+		fee = fee.Div(fee, ecotoneDivisor)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		return fee, calldataGasUsed</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; extractL1GasParams extracts the gas parameters necessary to compute gas costs from L1 block info</span>
<span class="term-fg32">+func extractL1GasParams(config *params.ChainConfig, time uint64, data []byte) (l1BaseFee *big.Int, costFunc l1CostFunc, feeScalar *big.Float, err error) {</span>
<span class="term-fg32">+	if config.IsEcotone(time) {</span>
<span class="term-fg32">+		&#47;&#47; edge case: for the very first Ecotone block we still need to use the Bedrock</span>
<span class="term-fg32">+		&#47;&#47; function. We detect this edge case by seeing if the function selector is the old one</span>
<span class="term-fg32">+		if len(data) &gt;= 4 &amp;&amp; !bytes.Equal(data[0:4], BedrockL1AttributesSelector) {</span>
<span class="term-fg32">+			l1BaseFee, costFunc, err = extractL1GasParamsEcotone(data)</span>
<span class="term-fg32">+			return</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; data consists of func selector followed by 7 ABI-encoded parameters (32 bytes each)</span>
<span class="term-fg32">+	if len(data) &lt; 4+32*8 {</span>
<span class="term-fg32">+		return nil, nil, nil, fmt.Errorf(&quot;expected at least %d L1 info bytes, got %d&quot;, 4+32*8, len(data))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	data = data[4:]                                      &#47;&#47; trim function selector</span>
<span class="term-fg32">+	l1BaseFee = new(big.Int).SetBytes(data[32*2 : 32*3]) &#47;&#47; arg index 2</span>
<span class="term-fg32">+	overhead := new(big.Int).SetBytes(data[32*6 : 32*7]) &#47;&#47; arg index 6</span>
<span class="term-fg32">+	scalar := new(big.Int).SetBytes(data[32*7 : 32*8])   &#47;&#47; arg index 7</span>
<span class="term-fg32">+	fscalar := new(big.Float).SetInt(scalar)             &#47;&#47; legacy: format fee scalar as big Float</span>
<span class="term-fg32">+	fdivisor := new(big.Float).SetUint64(1_000_000)      &#47;&#47; 10**6, i.e. 6 decimals</span>
<span class="term-fg32">+	feeScalar = new(big.Float).Quo(fscalar, fdivisor)</span>
<span class="term-fg32">+	costFunc = newL1CostFuncBedrockHelper(l1BaseFee, overhead, scalar, config.IsRegolith(time))</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; extractEcotoneL1GasParams extracts the gas parameters necessary to compute gas from L1 attribute</span>
<span class="term-fg32">+&#47;&#47; info calldata after the Ecotone upgrade, but not for the very first Ecotone block.</span>
<span class="term-fg32">+func extractL1GasParamsEcotone(data []byte) (l1BaseFee *big.Int, costFunc l1CostFunc, err error) {</span>
<span class="term-fg32">+	if len(data) != 164 {</span>
<span class="term-fg32">+		return nil, nil, fmt.Errorf(&quot;expected 164 L1 info bytes, got %d&quot;, len(data))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; data layout assumed for Ecotone:</span>
<span class="term-fg32">+	&#47;&#47; offset type varname</span>
<span class="term-fg32">+	&#47;&#47; 0      &lt;selector&gt;</span>
<span class="term-fg32">+	&#47;&#47; 4     uint32 _basefeeScalar</span>
<span class="term-fg32">+	&#47;&#47; 8     uint32 _blobBaseFeeScalar</span>
<span class="term-fg32">+	&#47;&#47; 12    uint64 _sequenceNumber,</span>
<span class="term-fg32">+	&#47;&#47; 20    uint64 _timestamp,</span>
<span class="term-fg32">+	&#47;&#47; 28    uint64 _l1BlockNumber</span>
<span class="term-fg32">+	&#47;&#47; 36    uint256 _basefee,</span>
<span class="term-fg32">+	&#47;&#47; 68    uint256 _blobBaseFee,</span>
<span class="term-fg32">+	&#47;&#47; 100    bytes32 _hash,</span>
<span class="term-fg32">+	&#47;&#47; 132   bytes32 _batcherHash,</span>
<span class="term-fg32">+	l1BaseFee = new(big.Int).SetBytes(data[36:68])</span>
<span class="term-fg32">+	l1BlobBaseFee := new(big.Int).SetBytes(data[68:100])</span>
<span class="term-fg32">+	l1BaseFeeScalar := new(big.Int).SetBytes(data[4:8])</span>
<span class="term-fg32">+	l1BlobBaseFeeScalar := new(big.Int).SetBytes(data[8:12])</span>
<span class="term-fg32">+	costFunc = newL1CostFuncEcotone(l1BaseFee, l1BlobBaseFee, l1BaseFeeScalar, l1BlobBaseFeeScalar)</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; L1Cost computes the the data availability fee for transactions in blocks prior to the Ecotone</span>
<span class="term-fg32">+&#47;&#47; upgrade. It is used by e2e tests so must remain exported.</span>
<span class="term-fg32">+func L1Cost(rollupDataGas uint64, l1BaseFee, overhead, scalar *big.Int) *big.Int {</span>
<span class="term-fg32">+	l1GasUsed := new(big.Int).SetUint64(rollupDataGas)</span>
<span class="term-fg32">+	l1GasUsed.Add(l1GasUsed, overhead)</span>
<span class="term-fg32">+	return l1CostHelper(l1GasUsed, l1BaseFee, scalar)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func l1CostHelper(gasWithOverhead, l1BaseFee, scalar *big.Int) *big.Int {</span>
<span class="term-fg32">+	fee := new(big.Int).Set(gasWithOverhead)</span>
<span class="term-fg32">+	fee.Mul(fee, l1BaseFee).Mul(fee, scalar).Div(fee, oneMillion)</span>
<span class="term-fg32">+	return fee</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-05d5e14bbac085e5392cd683" role="button"
                   aria-expanded="false" aria-controls="id-05d5e14bbac085e5392cd683">
                    <code>core/types/rollup_cost_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/rollup_cost_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+245</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-05d5e14bbac085e5392cd683"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_cost_test.go op-geth&#47;core&#47;types&#47;rollup_cost_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..d893f4517bbb8427023609cf460a471670b218ae</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_cost_test.go</span>
<span class="term-fg36">@@ -0,0 +1,245 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;binary&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	baseFee  = big.NewInt(1000 * 1e6)</span>
<span class="term-fg32">+	overhead = big.NewInt(50)</span>
<span class="term-fg32">+	scalar   = big.NewInt(7 * 1e6)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	blobBaseFee       = big.NewInt(10 * 1e6)</span>
<span class="term-fg32">+	baseFeeScalar     = big.NewInt(2)</span>
<span class="term-fg32">+	blobBaseFeeScalar = big.NewInt(3)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; below are the expected cost func outcomes for the above parameter settings on the emptyTx</span>
<span class="term-fg32">+	&#47;&#47; which is defined in transaction_test.go</span>
<span class="term-fg32">+	bedrockFee  = big.NewInt(11326000000000)</span>
<span class="term-fg32">+	regolithFee = big.NewInt(3710000000000)</span>
<span class="term-fg32">+	ecotoneFee  = big.NewInt(960900) &#47;&#47; (480&#47;16)*(2*16*1000 + 3*10) == 960900</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	bedrockGas  = big.NewInt(1618)</span>
<span class="term-fg32">+	regolithGas = big.NewInt(530) &#47;&#47; 530  = 1618 - (16*68)</span>
<span class="term-fg32">+	ecotoneGas  = big.NewInt(480)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestBedrockL1CostFunc(t *testing.T) {</span>
<span class="term-fg32">+	costFunc0 := newL1CostFuncBedrockHelper(baseFee, overhead, scalar, false &#47;*isRegolith*&#47;)</span>
<span class="term-fg32">+	costFunc1 := newL1CostFuncBedrockHelper(baseFee, overhead, scalar, true)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c0, g0 := costFunc0(emptyTx.RollupCostData()) &#47;&#47; pre-Regolith</span>
<span class="term-fg32">+	c1, g1 := costFunc1(emptyTx.RollupCostData())</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, bedrockFee, c0)</span>
<span class="term-fg32">+	require.Equal(t, bedrockGas, g0) &#47;&#47; gas-used</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, regolithFee, c1)</span>
<span class="term-fg32">+	require.Equal(t, regolithGas, g1)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestEcotoneL1CostFunc(t *testing.T) {</span>
<span class="term-fg32">+	costFunc := newL1CostFuncEcotone(baseFee, blobBaseFee, baseFeeScalar, blobBaseFeeScalar)</span>
<span class="term-fg32">+	c, g := costFunc(emptyTx.RollupCostData())</span>
<span class="term-fg32">+	require.Equal(t, ecotoneGas, g)</span>
<span class="term-fg32">+	require.Equal(t, ecotoneFee, c)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestExtractBedrockGasParams(t *testing.T) {</span>
<span class="term-fg32">+	regolithTime := uint64(1)</span>
<span class="term-fg32">+	config := &amp;params.ChainConfig{</span>
<span class="term-fg32">+		Optimism:     params.OptimismTestConfig.Optimism,</span>
<span class="term-fg32">+		RegolithTime: &amp;regolithTime,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data := getBedrockL1Attributes(baseFee, overhead, scalar)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	_, costFuncPreRegolith, _, err := extractL1GasParams(config, regolithTime-1, data)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Function should continue to succeed even with extra data (that just gets ignored) since we</span>
<span class="term-fg32">+	&#47;&#47; have been testing the data size is at least the expected number of bytes instead of exactly</span>
<span class="term-fg32">+	&#47;&#47; the expected number of bytes. It&#39;s unclear if this flexibility was intentional, but since</span>
<span class="term-fg32">+	&#47;&#47; it&#39;s been in production we shouldn&#39;t change this behavior.</span>
<span class="term-fg32">+	data = append(data, []byte{0xBE, 0xEE, 0xEE, 0xFF}...) &#47;&#47; tack on garbage data</span>
<span class="term-fg32">+	_, costFuncRegolith, _, err := extractL1GasParams(config, regolithTime, data)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c, _ := costFuncPreRegolith(emptyTx.RollupCostData())</span>
<span class="term-fg32">+	require.Equal(t, bedrockFee, c)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c, _ = costFuncRegolith(emptyTx.RollupCostData())</span>
<span class="term-fg32">+	require.Equal(t, regolithFee, c)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; try to extract from data which has not enough params, should get error.</span>
<span class="term-fg32">+	data = data[:len(data)-4-32]</span>
<span class="term-fg32">+	_, _, _, err = extractL1GasParams(config, regolithTime, data)</span>
<span class="term-fg32">+	require.Error(t, err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestExtractEcotoneGasParams(t *testing.T) {</span>
<span class="term-fg32">+	zeroTime := uint64(0)</span>
<span class="term-fg32">+	&#47;&#47; create a config where ecotone upgrade is active</span>
<span class="term-fg32">+	config := &amp;params.ChainConfig{</span>
<span class="term-fg32">+		Optimism:     params.OptimismTestConfig.Optimism,</span>
<span class="term-fg32">+		RegolithTime: &amp;zeroTime,</span>
<span class="term-fg32">+		EcotoneTime:  &amp;zeroTime,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	require.True(t, config.IsOptimismEcotone(0))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data := getEcotoneL1Attributes(baseFee, blobBaseFee, baseFeeScalar, blobBaseFeeScalar)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	_, costFunc, _, err := extractL1GasParams(config, 0, data)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c, g := costFunc(emptyTx.RollupCostData())</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, ecotoneGas, g)</span>
<span class="term-fg32">+	require.Equal(t, ecotoneFee, c)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; make sure wrong amont of data results in error</span>
<span class="term-fg32">+	data = append(data, 0x00) &#47;&#47; tack on garbage byte</span>
<span class="term-fg32">+	_, _, err = extractL1GasParamsEcotone(data)</span>
<span class="term-fg32">+	require.Error(t, err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; make sure the first block of the ecotone upgrade is properly detected, and invokes the bedrock</span>
<span class="term-fg32">+&#47;&#47; cost function appropriately</span>
<span class="term-fg32">+func TestFirstBlockEcotoneGasParams(t *testing.T) {</span>
<span class="term-fg32">+	zeroTime := uint64(0)</span>
<span class="term-fg32">+	&#47;&#47; create a config where ecotone upgrade is active</span>
<span class="term-fg32">+	config := &amp;params.ChainConfig{</span>
<span class="term-fg32">+		Optimism:     params.OptimismTestConfig.Optimism,</span>
<span class="term-fg32">+		RegolithTime: &amp;zeroTime,</span>
<span class="term-fg32">+		EcotoneTime:  &amp;zeroTime,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	require.True(t, config.IsOptimismEcotone(0))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data := getBedrockL1Attributes(baseFee, overhead, scalar)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	_, oldCostFunc, _, err := extractL1GasParams(config, 0, data)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	c, _ := oldCostFunc(emptyTx.RollupCostData())</span>
<span class="term-fg32">+	require.Equal(t, regolithFee, c)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func getBedrockL1Attributes(baseFee, overhead, scalar *big.Int) []byte {</span>
<span class="term-fg32">+	uint256 := make([]byte, 32)</span>
<span class="term-fg32">+	ignored := big.NewInt(1234)</span>
<span class="term-fg32">+	data := []byte{}</span>
<span class="term-fg32">+	data = append(data, BedrockL1AttributesSelector...)</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)  &#47;&#47; arg 0</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)  &#47;&#47; arg 1</span>
<span class="term-fg32">+	data = append(data, baseFee.FillBytes(uint256)...)  &#47;&#47; arg 2</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)  &#47;&#47; arg 3</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)  &#47;&#47; arg 4</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)  &#47;&#47; arg 5</span>
<span class="term-fg32">+	data = append(data, overhead.FillBytes(uint256)...) &#47;&#47; arg 6</span>
<span class="term-fg32">+	data = append(data, scalar.FillBytes(uint256)...)   &#47;&#47; arg 7</span>
<span class="term-fg32">+	return data</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func getEcotoneL1Attributes(baseFee, blobBaseFee, baseFeeScalar, blobBaseFeeScalar *big.Int) []byte {</span>
<span class="term-fg32">+	ignored := big.NewInt(1234)</span>
<span class="term-fg32">+	data := []byte{}</span>
<span class="term-fg32">+	uint256 := make([]byte, 32)</span>
<span class="term-fg32">+	uint64 := make([]byte, 8)</span>
<span class="term-fg32">+	uint32 := make([]byte, 4)</span>
<span class="term-fg32">+	data = append(data, EcotoneL1AttributesSelector...)</span>
<span class="term-fg32">+	data = append(data, baseFeeScalar.FillBytes(uint32)...)</span>
<span class="term-fg32">+	data = append(data, blobBaseFeeScalar.FillBytes(uint32)...)</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint64)...)</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint64)...)</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint64)...)</span>
<span class="term-fg32">+	data = append(data, baseFee.FillBytes(uint256)...)</span>
<span class="term-fg32">+	data = append(data, blobBaseFee.FillBytes(uint256)...)</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)</span>
<span class="term-fg32">+	data = append(data, ignored.FillBytes(uint256)...)</span>
<span class="term-fg32">+	return data</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type testStateGetter struct {</span>
<span class="term-fg32">+	baseFee, blobBaseFee, overhead, scalar *big.Int</span>
<span class="term-fg32">+	baseFeeScalar, blobBaseFeeScalar       uint32</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (sg *testStateGetter) GetState(addr common.Address, slot common.Hash) common.Hash {</span>
<span class="term-fg32">+	buf := common.Hash{}</span>
<span class="term-fg32">+	switch slot {</span>
<span class="term-fg32">+	case L1BaseFeeSlot:</span>
<span class="term-fg32">+		sg.baseFee.FillBytes(buf[:])</span>
<span class="term-fg32">+	case OverheadSlot:</span>
<span class="term-fg32">+		sg.overhead.FillBytes(buf[:])</span>
<span class="term-fg32">+	case ScalarSlot:</span>
<span class="term-fg32">+		sg.scalar.FillBytes(buf[:])</span>
<span class="term-fg32">+	case L1BlobBaseFeeSlot:</span>
<span class="term-fg32">+		sg.blobBaseFee.FillBytes(buf[:])</span>
<span class="term-fg32">+	case L1FeeScalarsSlot:</span>
<span class="term-fg32">+		offset := scalarSectionStart</span>
<span class="term-fg32">+		binary.BigEndian.PutUint32(buf[offset:offset+4], sg.baseFeeScalar)</span>
<span class="term-fg32">+		binary.BigEndian.PutUint32(buf[offset+4:offset+8], sg.blobBaseFeeScalar)</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		panic(&quot;unknown slot&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return buf</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; TestNewL1CostFunc tests that the appropriate cost function is selected based on the</span>
<span class="term-fg32">+&#47;&#47; configuration and statedb values.</span>
<span class="term-fg32">+func TestNewL1CostFunc(t *testing.T) {</span>
<span class="term-fg32">+	time := uint64(1)</span>
<span class="term-fg32">+	config := &amp;params.ChainConfig{</span>
<span class="term-fg32">+		Optimism: params.OptimismTestConfig.Optimism,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	statedb := &amp;testStateGetter{</span>
<span class="term-fg32">+		baseFee:           baseFee,</span>
<span class="term-fg32">+		overhead:          overhead,</span>
<span class="term-fg32">+		scalar:            scalar,</span>
<span class="term-fg32">+		blobBaseFee:       blobBaseFee,</span>
<span class="term-fg32">+		baseFeeScalar:     uint32(baseFeeScalar.Uint64()),</span>
<span class="term-fg32">+		blobBaseFeeScalar: uint32(blobBaseFeeScalar.Uint64()),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	costFunc := NewL1CostFunc(config, statedb)</span>
<span class="term-fg32">+	require.NotNil(t, costFunc)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; empty cost data should result in nil fee</span>
<span class="term-fg32">+	fee := costFunc(RollupCostData{}, time)</span>
<span class="term-fg32">+	require.Nil(t, fee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; emptyTx fee w&#47; bedrock config should be the bedrock fee</span>
<span class="term-fg32">+	fee = costFunc(emptyTx.RollupCostData(), time)</span>
<span class="term-fg32">+	require.NotNil(t, fee)</span>
<span class="term-fg32">+	require.Equal(t, bedrockFee, fee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; emptyTx fee w&#47; regolith config should be the regolith fee</span>
<span class="term-fg32">+	config.RegolithTime = &amp;time</span>
<span class="term-fg32">+	costFunc = NewL1CostFunc(config, statedb)</span>
<span class="term-fg32">+	require.NotNil(t, costFunc)</span>
<span class="term-fg32">+	fee = costFunc(emptyTx.RollupCostData(), time)</span>
<span class="term-fg32">+	require.NotNil(t, fee)</span>
<span class="term-fg32">+	require.Equal(t, regolithFee, fee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; emptyTx fee w&#47; ecotone config should be the ecotone fee</span>
<span class="term-fg32">+	config.EcotoneTime = &amp;time</span>
<span class="term-fg32">+	costFunc = NewL1CostFunc(config, statedb)</span>
<span class="term-fg32">+	fee = costFunc(emptyTx.RollupCostData(), time)</span>
<span class="term-fg32">+	require.NotNil(t, fee)</span>
<span class="term-fg32">+	require.Equal(t, ecotoneFee, fee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; emptyTx fee w&#47; ecotone config, but simulate first ecotone block by blowing away the ecotone</span>
<span class="term-fg32">+	&#47;&#47; params. Should result in regolith fee.</span>
<span class="term-fg32">+	statedb.baseFeeScalar = 0</span>
<span class="term-fg32">+	statedb.blobBaseFeeScalar = 0</span>
<span class="term-fg32">+	statedb.blobBaseFee = new(big.Int)</span>
<span class="term-fg32">+	costFunc = NewL1CostFunc(config, statedb)</span>
<span class="term-fg32">+	fee = costFunc(emptyTx.RollupCostData(), time)</span>
<span class="term-fg32">+	require.NotNil(t, fee)</span>
<span class="term-fg32">+	require.Equal(t, regolithFee, fee)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-79b83faf87ef60f3edcde18a" role="button"
                   aria-expanded="false" aria-controls="id-79b83faf87ef60f3edcde18a">
                    <code>core/types/transaction_marshalling_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/types/transaction_marshalling_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-79b83faf87ef60f3edcde18a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling_test.go op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4ab93a539d19bbcffa0293738b2e4dcc3ebe7ad2</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg36">@@ -0,0 +1,103 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;json&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJsonDeposit(t *testing.T) {</span>
<span class="term-fg32">+	tx := NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	json, err := tx.MarshalJSON()</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to marshal tx JSON&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	got := &amp;Transaction{}</span>
<span class="term-fg32">+	err = got.UnmarshalJSON(json)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to unmarshal tx JSON&quot;)</span>
<span class="term-fg32">+	require.Equal(t, tx.Hash(), got.Hash())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJSON(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No gas&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;gas&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No value&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;value&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No input&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;input&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No from&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;from&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No sourceHash&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;sourceHash&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No mint&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No IsSystemTx&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			if test.expectedError == &quot;&quot; {</span>
<span class="term-fg32">+				require.NoError(t, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.ErrorContains(t, err, test.expectedError)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	tests = []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Valid deposit sender&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:&quot;0x1&quot;,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			signer := NewLondonSigner(big.NewInt(123))</span>
<span class="term-fg32">+			sender, err := signer.Sender(parsedTx)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, common.HexToAddress(&quot;0x1&quot;), sender)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bbfdd54a52c7c8b19943896e" role="button"
                   aria-expanded="false" aria-controls="id-bbfdd54a52c7c8b19943896e">
                    <code>core/vm/gas_table_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/vm/gas_table_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/vm/gas_table_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bbfdd54a52c7c8b19943896e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;gas_table_test.go op-geth&#47;core&#47;vm&#47;gas_table_test.go</span>
<span class="term-fg1">index 4a2545b6edfaf06795f7015e3b337eef73b4de83..1ee9d691dfd15382bfd7e6f887be449408156896 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;gas_table_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;gas_table_test.go</span>
<span class="term-fg36">@@ -117,7 +117,7 @@</span> 	gasUsed    uint64
 	minimumGas uint64
 }{
 	&#47;&#47; legacy create(0, 0, 0xc000) without 3860 used
<span class="term-fg31">-	{&quot;0x61C00060006000f0&quot; + &quot;600052&quot; + &quot;60206000F3&quot;, false, 41237, 41237},</span>
<span class="term-fg32">+	{&quot;0x61C00060006000f0&quot; + &quot;600052&quot; + &quot;60206000F3&quot;, false, 41237, 41237}, &#47;&#47;nolint:all</span>
 	&#47;&#47; legacy create(0, 0, 0xc000) _with_ 3860
 	{&quot;0x61C00060006000f0&quot; + &quot;600052&quot; + &quot;60206000F3&quot;, true, 44309, 44309},
 	&#47;&#47; create2(0, 0, 0xc001, 0) without 3860</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-abe0d60e695012778acc6427" role="button"
                   aria-expanded="false" aria-controls="id-abe0d60e695012778acc6427">
                    <code>core/vm/interpreter.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/vm/interpreter.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/vm/interpreter.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-abe0d60e695012778acc6427"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;interpreter.go op-geth&#47;core&#47;vm&#47;interpreter.go</span>
<span class="term-fg1">index 28da2e80e60eca0aaec4d7e8199297e35044ba38..60fa8d3d322280ffda08b8e294a0c6fb2167b58e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;interpreter.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;interpreter.go</span>
<span class="term-fg36">@@ -21,14 +21,19 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
 )
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; PrecompileOverrides is a function that can be used to override the default precompiled contracts</span>
<span class="term-fg32">+type PrecompileOverrides func(params.Rules, PrecompiledContract, common.Address) (PrecompiledContract, bool)</span>
&nbsp;
 &#47;&#47; Config are the configuration options for the Interpreter
 type Config struct {
<span class="term-fg31">-	Tracer                  EVMLogger &#47;&#47; Opcode logger</span>
<span class="term-fg31">-	NoBaseFee               bool      &#47;&#47; Forces the EIP-1559 baseFee to 0 (needed for 0 price calls)</span>
<span class="term-fg31">-	EnablePreimageRecording bool      &#47;&#47; Enables recording of SHA3&#47;keccak preimages</span>
<span class="term-fg31">-	ExtraEips               []int     &#47;&#47; Additional EIPS that are to be enabled</span>
<span class="term-fg32">+	Tracer                      EVMLogger           &#47;&#47; Opcode logger</span>
<span class="term-fg32">+	NoBaseFee                   bool                &#47;&#47; Forces the EIP-1559 baseFee to 0 (needed for 0 price calls)</span>
<span class="term-fg32">+	EnablePreimageRecording     bool                &#47;&#47; Enables recording of SHA3&#47;keccak preimages</span>
<span class="term-fg32">+	ExtraEips                   []int               &#47;&#47; Additional EIPS that are to be enabled</span>
<span class="term-fg32">+	OptimismPrecompileOverrides PrecompileOverrides &#47;&#47; Precompile overrides for Optimism</span>
 }
&nbsp;
 &#47;&#47; ScopeContext contains the things that are per-call, such as stack and memory,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7a2eaa7a2e54415024fa2541" role="button"
                   aria-expanded="false" aria-controls="id-7a2eaa7a2e54415024fa2541">
                    <code>core/vm/operations_acl.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/core/vm/operations_acl.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/core/vm/operations_acl.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7a2eaa7a2e54415024fa2541"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;operations_acl.go op-geth&#47;core&#47;vm&#47;operations_acl.go</span>
<span class="term-fg1">index bca6d1e83b88291bec9447c033dd978e072c7c06..f420a241058b2a2904e7e9eca621c73cc0ce4273 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;operations_acl.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;operations_acl.go</span>
<span class="term-fg36">@@ -187,7 +187,12 @@</span> 		&#47;&#47; add it to the returned gas. By adding it to the return, it will be charged
 		&#47;&#47; outside of this function, as part of the dynamic gas, and that will make it
 		&#47;&#47; also become correctly reported to tracers.
 		contract.Gas += coldCost
<span class="term-fg31">-		return gas + coldCost, nil</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		var overflow bool</span>
<span class="term-fg32">+		if gas, overflow = math.SafeAdd(gas, coldCost); overflow {</span>
<span class="term-fg32">+			return 0, ErrGasUintOverflow</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return gas, nil</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-152afd241868fcd7bebc8c0f" role="button"
                   aria-expanded="false" aria-controls="id-152afd241868fcd7bebc8c0f">
                    <code>crypto/signify/signify_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/crypto/signify/signify_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/crypto/signify/signify_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-152afd241868fcd7bebc8c0f"><span class="term-fg1">diff --git go-ethereum&#47;crypto&#47;signify&#47;signify_test.go op-geth&#47;crypto&#47;signify&#47;signify_test.go</span>
<span class="term-fg1">index 9bac2c825f2c844bff70f7566bbe3d953a16f583..56195649dfb3b2ccfcc3e5239bae8bd33d28796a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;crypto&#47;signify&#47;signify_test.go</span>
<span class="term-fg1">+++ op-geth&#47;crypto&#47;signify&#47;signify_test.go</span>
<span class="term-fg36">@@ -48,7 +48,7 @@</span> 	if err = tmpFile.Close(); err != nil {
 		t.Fatal(err)
 	}
&nbsp;
<span class="term-fg31">-	err = SignFile(tmpFile.Name(), tmpFile.Name()+&quot;.sig&quot;, testSecKey, &quot;clé&quot;, &quot;croissants&quot;)</span>
<span class="term-fg32">+	err = SignFile(tmpFile.Name(), tmpFile.Name()+&quot;.sig&quot;, testSecKey, &quot;clé&quot;, &quot;croissants&quot;) &#47;&#47;nolint:all</span>
 	if err != nil {
 		t.Fatal(err)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a3e20f143bae69840fa5911b" role="button"
                   aria-expanded="false" aria-controls="id-a3e20f143bae69840fa5911b">
                    <code>eth/catalyst/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/catalyst/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/catalyst/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+31</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a3e20f143bae69840fa5911b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api_test.go op-geth&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg1">index f1d48d0deafac0484156a85bfba606184eaa2d6e..11f102406c961d28863469bd9880fa813547d665 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg36">@@ -28,6 +28,8 @@</span> 	&quot;sync&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;beacon&#47;engine&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
<span class="term-fg36">@@ -198,12 +200,10 @@</span> 		HeadBlockHash:      blocks[8].Hash(),
 		SafeBlockHash:      common.Hash{},
 		FinalizedBlockHash: common.Hash{},
 	}
<span class="term-fg31">-	_, err := api.ForkchoiceUpdatedV1(fcState, &amp;blockParams)</span>
<span class="term-fg32">+	resp, err := api.ForkchoiceUpdatedV1(fcState, &amp;blockParams)</span>
 	if err != nil {
 		t.Fatalf(&quot;error preparing payload, err=%v&quot;, err)
 	}
<span class="term-fg31">-	&#47;&#47; give the payload some time to be built</span>
<span class="term-fg31">-	time.Sleep(100 * time.Millisecond)</span>
 	payloadID := (&amp;miner.BuildPayloadArgs{
 		Parent:       fcState.HeadBlockHash,
 		Timestamp:    blockParams.Timestamp,
<span class="term-fg36">@@ -212,6 +212,8 @@</span> 		Random:       blockParams.Random,
 		BeaconRoot:   blockParams.BeaconRoot,
 		Version:      engine.PayloadV1,
 	}).Id()
<span class="term-fg32">+	require.Equal(t, payloadID, *resp.PayloadID)</span>
<span class="term-fg32">+	require.NoError(t, waitForApiPayloadToBuild(api, *resp.PayloadID))</span>
 	execData, err := api.GetPayloadV1(payloadID)
 	if err != nil {
 		t.Fatalf(&quot;error getting payload, err=%v&quot;, err)
<span class="term-fg36">@@ -438,6 +440,11 @@</span> }
&nbsp;
 &#47;&#47; startEthService creates a full node instance for testing.
 func startEthService(t *testing.T, genesis *core.Genesis, blocks []*types.Block) (*node.Node, *eth.Ethereum) {
<span class="term-fg32">+	ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+	return startEthServiceWithConfigFn(t, blocks, ethcfg)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func startEthServiceWithConfigFn(t *testing.T, blocks []*types.Block, ethcfg *ethconfig.Config) (*node.Node, *eth.Ethereum) {</span>
 	t.Helper()
&nbsp;
 	n, err := node.New(&amp;node.Config{
<span class="term-fg36">@@ -450,7 +457,7 @@</span> 	if err != nil {
 		t.Fatal(&quot;can&#39;t create node:&quot;, err)
 	}
&nbsp;
<span class="term-fg31">-	ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+	&#47;&#47; default eth config is moved to startEthService</span>
 	ethservice, err := eth.New(n, ethcfg)
 	if err != nil {
 		t.Fatal(&quot;can&#39;t create eth service:&quot;, err)
<span class="term-fg36">@@ -631,8 +638,7 @@</span> 			}
 			if resp.PayloadStatus.Status != engine.VALID {
 				t.Fatalf(&quot;error preparing payload, invalid status: %v&quot;, resp.PayloadStatus.Status)
 			}
<span class="term-fg31">-			&#47;&#47; give the payload some time to be built</span>
<span class="term-fg31">-			time.Sleep(50 * time.Millisecond)</span>
<span class="term-fg32">+			require.NoError(t, waitForApiPayloadToBuild(api, *resp.PayloadID))</span>
 			if payload, err = api.GetPayloadV1(*resp.PayloadID); err != nil {
 				t.Fatalf(&quot;can&#39;t get payload: %v&quot;, err)
 			}
<span class="term-fg36">@@ -680,6 +686,7 @@</span> 	payload, err := api.eth.Miner().BuildPayload(args)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+	waitForPayloadToBuild(payload)</span>
 	return payload.ResolveFull().ExecutionPayload, nil
 }
&nbsp;
<span class="term-fg36">@@ -918,6 +925,7 @@</span> 	payload, err := api.eth.Miner().BuildPayload(args)
 	if err != nil {
 		t.Fatalf(&quot;error preparing payload, err=%v&quot;, err)
 	}
<span class="term-fg32">+	waitForPayloadToBuild(payload)</span>
 	data := *payload.Resolve().ExecutionPayload
 	&#47;&#47; We need to recompute the blockhash, since the miner computes a wrong (correct) blockhash
 	txs, _ := decodeTransactions(data.Transactions)
<span class="term-fg36">@@ -1079,6 +1087,8 @@</span> 		Withdrawals:  blockParams.Withdrawals,
 		BeaconRoot:   blockParams.BeaconRoot,
 		Version:      engine.PayloadV2,
 	}).Id()
<span class="term-fg32">+	require.Equal(t, payloadID, *resp.PayloadID)</span>
<span class="term-fg32">+	require.NoError(t, waitForApiPayloadToBuild(api, payloadID))</span>
 	execData, err := api.GetPayloadV2(payloadID)
 	if err != nil {
 		t.Fatalf(&quot;error getting payload, err=%v&quot;, err)
<span class="term-fg36">@@ -1113,7 +1123,7 @@</span> 			},
 		},
 	}
 	fcState.HeadBlockHash = execData.ExecutionPayload.BlockHash
<span class="term-fg31">-	_, err = api.ForkchoiceUpdatedV2(fcState, &amp;blockParams)</span>
<span class="term-fg32">+	resp, err = api.ForkchoiceUpdatedV2(fcState, &amp;blockParams)</span>
 	if err != nil {
 		t.Fatalf(&quot;error preparing payload, err=%v&quot;, err)
 	}
<span class="term-fg36">@@ -1128,6 +1138,8 @@</span> 		Withdrawals:  blockParams.Withdrawals,
 		BeaconRoot:   blockParams.BeaconRoot,
 		Version:      engine.PayloadV2,
 	}).Id()
<span class="term-fg32">+	require.Equal(t, payloadID, *resp.PayloadID)</span>
<span class="term-fg32">+	require.NoError(t, waitForApiPayloadToBuild(api, payloadID))</span>
 	execData, err = api.GetPayloadV2(payloadID)
 	if err != nil {
 		t.Fatalf(&quot;error getting payload, err=%v&quot;, err)
<span class="term-fg36">@@ -1268,6 +1280,8 @@</span> 			Parent:       fcState.HeadBlockHash,
 			Timestamp:    test.blockParams.Timestamp,
 			FeeRecipient: test.blockParams.SuggestedFeeRecipient,
 			Random:       test.blockParams.Random,
<span class="term-fg32">+			BeaconRoot:   test.blockParams.BeaconRoot,</span>
<span class="term-fg32">+			Withdrawals:  test.blockParams.Withdrawals,</span>
 			Version:      payloadVersion,
 		}).Id()
 		execData, err := api.GetPayloadV2(payloadID)
<span class="term-fg36">@@ -1625,6 +1639,8 @@</span> 		Withdrawals:  blockParams.Withdrawals,
 		BeaconRoot:   blockParams.BeaconRoot,
 		Version:      engine.PayloadV3,
 	}).Id()
<span class="term-fg32">+	require.Equal(t, payloadID, *resp.PayloadID)</span>
<span class="term-fg32">+	require.NoError(t, waitForApiPayloadToBuild(api, *resp.PayloadID))</span>
 	execData, err := api.GetPayloadV3(payloadID)
 	if err != nil {
 		t.Fatalf(&quot;error getting payload, err=%v&quot;, err)
<span class="term-fg36">@@ -1663,3 +1679,11 @@</span> 	if root := db.GetState(params.BeaconRootsStorageAddress, rootIdx); root != *blockParams.BeaconRoot {
 		t.Fatalf(&quot;incorrect root stored: want %s, got %s&quot;, *blockParams.BeaconRoot, root)
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func waitForPayloadToBuild(payload *miner.Payload) {</span>
<span class="term-fg32">+	payload.WaitFull()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func waitForApiPayloadToBuild(api *ConsensusAPI, id engine.PayloadID) error {</span>
<span class="term-fg32">+	return api.localBlocks.waitFull(id)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8938d7808284f9898a0dac2b" role="button"
                   aria-expanded="false" aria-controls="id-8938d7808284f9898a0dac2b">
                    <code>eth/catalyst/queue.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/catalyst/queue.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/catalyst/queue.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8938d7808284f9898a0dac2b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;queue.go op-geth&#47;eth&#47;catalyst&#47;queue.go</span>
<span class="term-fg1">index 634dc1b2e6c2520f02e74f38ba66cba649685c86..d42904843b25fa8bb54a1739a9ff68f6d017f90f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;queue.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;queue.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package catalyst
&nbsp;
 import (
<span class="term-fg32">+	&quot;errors&quot;</span>
 	&quot;sync&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;beacon&#47;engine&quot;
<span class="term-fg36">@@ -89,6 +90,24 @@</span> 			return item.payload.ResolveFull()
 		}
 	}
 	return nil
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; waitFull waits until the first full payload has been built for the specified payload id</span>
<span class="term-fg32">+&#47;&#47; The method returns immediately if the payload is unknown.</span>
<span class="term-fg32">+func (q *payloadQueue) waitFull(id engine.PayloadID) error {</span>
<span class="term-fg32">+	q.lock.RLock()</span>
<span class="term-fg32">+	defer q.lock.RUnlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, item := range q.payloads {</span>
<span class="term-fg32">+		if item == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;unknown payload&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if item.id == id {</span>
<span class="term-fg32">+			item.payload.WaitFull()</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return errors.New(&quot;unknown payload&quot;)</span>
 }
&nbsp;
 &#47;&#47; has checks if a particular payload is already tracked.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0cad442f32c267a4fb187042" role="button"
                   aria-expanded="false" aria-controls="id-0cad442f32c267a4fb187042">
                    <code>eth/catalyst/simulated_beacon.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/catalyst/simulated_beacon.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/catalyst/simulated_beacon.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0cad442f32c267a4fb187042"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;simulated_beacon.go op-geth&#47;eth&#47;catalyst&#47;simulated_beacon.go</span>
<span class="term-fg1">index 5ad50f14c104bbb10cece25b0ebe21645a8f058f..1a744774e97c94b64c5f2878710c8b22b3e94186 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;simulated_beacon.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;simulated_beacon.go</span>
<span class="term-fg36">@@ -168,6 +168,9 @@</span> 	if fcResponse == engine.STATUS_SYNCING {
 		return errors.New(&quot;chain rewind prevented invocation of payload creation&quot;)
 	}
&nbsp;
<span class="term-fg32">+	if err := c.engineAPI.localBlocks.waitFull(*fcResponse.PayloadID); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	envelope, err := c.engineAPI.getPayload(*fcResponse.PayloadID, true)
 	if err != nil {
 		return err</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-88aed06c46352699dcf4e1a7" role="button"
                   aria-expanded="false" aria-controls="id-88aed06c46352699dcf4e1a7">
                    <code>eth/catalyst/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/catalyst/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+120</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-88aed06c46352699dcf4e1a7"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;superchain_test.go op-geth&#47;eth&#47;catalyst&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4fd46a4c1257c38998878071ef618a71849e6d6e</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,120 @@</span>
<span class="term-fg32">+package catalyst</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+	&quot;time&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;ethconfig&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSignalSuperchainV1(t *testing.T) {</span>
<span class="term-fg32">+	genesis, preMergeBlocks := generateMergeChain(2, false)</span>
<span class="term-fg32">+	n, ethservice := startEthService(t, genesis, preMergeBlocks)</span>
<span class="term-fg32">+	defer n.Close()</span>
<span class="term-fg32">+	api := NewConsensusAPI(ethservice)</span>
<span class="term-fg32">+	t.Run(&quot;matching&quot;, func(t *testing.T) {</span>
<span class="term-fg32">+		out, err := api.SignalSuperchainV1(&amp;SuperchainSignal{</span>
<span class="term-fg32">+			Recommended: params.OPStackSupport,</span>
<span class="term-fg32">+			Required:    params.OPStackSupport,</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if out != params.OPStackSupport {</span>
<span class="term-fg32">+			t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	t.Run(&quot;null_arg&quot;, func(t *testing.T) {</span>
<span class="term-fg32">+		out, err := api.SignalSuperchainV1(nil)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if out != params.OPStackSupport {</span>
<span class="term-fg32">+			t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSignalSuperchainV1Halt(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Note: depending on the params.OPStackSupport some types of bumps are not possible with active prerelease</span>
<span class="term-fg32">+	testCases := []struct {</span>
<span class="term-fg32">+		cfg  string</span>
<span class="term-fg32">+		bump string</span>
<span class="term-fg32">+		halt bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{&quot;none&quot;, &quot;major&quot;, false},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;minor&quot;, false},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;minor&quot;, true},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;minor&quot;, true},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;patch&quot;, false},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;patch&quot;, false},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;patch&quot;, true},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tc := range testCases {</span>
<span class="term-fg32">+		tc := tc</span>
<span class="term-fg32">+		t.Run(tc.cfg+&quot;_&quot;+tc.bump, func(t *testing.T) {</span>
<span class="term-fg32">+			genesis, preMergeBlocks := generateMergeChain(2, false)</span>
<span class="term-fg32">+			ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+			ethcfg.RollupHaltOnIncompatibleProtocolVersion = tc.cfg &#47;&#47; opt-in to halting (or not)</span>
<span class="term-fg32">+			n, ethservice := startEthServiceWithConfigFn(t, preMergeBlocks, ethcfg)</span>
<span class="term-fg32">+			defer n.Close() &#47;&#47; close at the end, regardless of any prior (failed) closing</span>
<span class="term-fg32">+			api := NewConsensusAPI(ethservice)</span>
<span class="term-fg32">+			_, build, major, minor, patch, preRelease := params.OPStackSupport.Parse()</span>
<span class="term-fg32">+			if preRelease != 0 { &#47;&#47; transform back from prerelease, so we can do a clean version bump</span>
<span class="term-fg32">+				if patch != 0 {</span>
<span class="term-fg32">+					patch -= 1</span>
<span class="term-fg32">+				} else if minor != 0 {</span>
<span class="term-fg32">+					&#47;&#47; can&#39;t patch-bump e.g. v3.1.0-1, the prerelease forces a minor bump:</span>
<span class="term-fg32">+					&#47;&#47; v3.0.999 is lower than the prerelease, v3.1.1-1 is a prerelease of v3.1.1.</span>
<span class="term-fg32">+					if tc.bump == &quot;patch&quot; {</span>
<span class="term-fg32">+						t.Skip()</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					minor -= 1</span>
<span class="term-fg32">+				} else if major != 0 {</span>
<span class="term-fg32">+					if tc.bump == &quot;minor&quot; || tc.bump == &quot;patch&quot; { &#47;&#47; can&#39;t minor-bump or patch-bump</span>
<span class="term-fg32">+						t.Skip()</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					major -= 1</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+				preRelease = 0</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			majorSignal, minorSignal, patchSignal := major, minor, patch</span>
<span class="term-fg32">+			switch tc.bump {</span>
<span class="term-fg32">+			case &quot;major&quot;:</span>
<span class="term-fg32">+				majorSignal += 1</span>
<span class="term-fg32">+			case &quot;minor&quot;:</span>
<span class="term-fg32">+				minorSignal += 1</span>
<span class="term-fg32">+			case &quot;patch&quot;:</span>
<span class="term-fg32">+				patchSignal += 1</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			out, err := api.SignalSuperchainV1(&amp;SuperchainSignal{</span>
<span class="term-fg32">+				Recommended: params.OPStackSupport, &#47;&#47; required version change should be enough</span>
<span class="term-fg32">+				Required:    params.ProtocolVersionV0{Build: build, Major: majorSignal, Minor: minorSignal, Patch: patchSignal, PreRelease: preRelease}.Encode(),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if out != params.OPStackSupport {</span>
<span class="term-fg32">+				t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			closeErr := n.Close()</span>
<span class="term-fg32">+			if !tc.halt {</span>
<span class="term-fg32">+				&#47;&#47; assert no halt by closing, and not getting any error</span>
<span class="term-fg32">+				if closeErr != nil {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected not to have closed already, but just closed without error&quot;)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				&#47;&#47; assert halt by closing again, and seeing if we are not stopped already</span>
<span class="term-fg32">+				if closeErr != node.ErrNodeStopped {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected to have already closed and get a ErrNodeStopped error, but got %v&quot;, closeErr)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-62aae1a03389755de71dc518" role="button"
                   aria-expanded="false" aria-controls="id-62aae1a03389755de71dc518">
                    <code>eth/downloader/downloader_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/downloader/downloader_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/downloader_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-62aae1a03389755de71dc518"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;downloader_test.go op-geth&#47;eth&#47;downloader&#47;downloader_test.go</span>
<span class="term-fg1">index e4875b959a37707579f0cc78dbf62029e87ecbe0..52feaa327b7a850536488909dff9072498fd96ea 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;downloader_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;downloader_test.go</span>
<span class="term-fg36">@@ -81,7 +81,7 @@</span> 		freezer: freezer,
 		chain:   chain,
 		peers:   make(map[string]*downloadTesterPeer),
 	}
<span class="term-fg31">-	tester.downloader = New(db, new(event.TypeMux), tester.chain, nil, tester.dropPeer, success)</span>
<span class="term-fg32">+	tester.downloader = New(db, new(event.TypeMux), tester.chain, nil, tester.dropPeer, success, 0)</span>
 	return tester
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b7656216cfa856e4e01d0a0b" role="button"
                   aria-expanded="false" aria-controls="id-b7656216cfa856e4e01d0a0b">
                    <code>eth/downloader/receiptreference_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/receiptreference_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+108</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b7656216cfa856e4e01d0a0b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;receiptreference_test.go op-geth&#47;eth&#47;downloader&#47;receiptreference_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..85bc4e1aaa77aa18aafadf64bc41f0147486a455</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;receiptreference_test.go</span>
<span class="term-fg36">@@ -0,0 +1,108 @@</span>
<span class="term-fg32">+package downloader</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;assert&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; makeCorrection is a helper function to create a slice of receipts and a slice of corrected receipts</span>
<span class="term-fg32">+func makeCorrection(bn uint64, cid uint64, ns []uint64, ty []uint8) (types.Receipts, types.Receipts) {</span>
<span class="term-fg32">+	receipts := make(types.Receipts, len(ns))</span>
<span class="term-fg32">+	correctedReceipts := make(types.Receipts, len(ns))</span>
<span class="term-fg32">+	transactions := make(types.Transactions, len(ns))</span>
<span class="term-fg32">+	for i := range ns {</span>
<span class="term-fg32">+		receipts[i] = &amp;types.Receipt{Type: ty[i], DepositNonce: &amp;ns[i]}</span>
<span class="term-fg32">+		correctedReceipts[i] = &amp;types.Receipt{Type: ty[i], DepositNonce: &amp;ns[i]}</span>
<span class="term-fg32">+		transactions[i] = types.NewTx(&amp;types.DepositTx{})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	correctedReceipts = correctReceipts(correctedReceipts, transactions, bn, cid)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return receipts, correctedReceipts</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestCorrectReceipts(t *testing.T) {</span>
<span class="term-fg32">+	type testcase struct {</span>
<span class="term-fg32">+		blockNum uint64</span>
<span class="term-fg32">+		chainID  uint64</span>
<span class="term-fg32">+		nonces   []uint64</span>
<span class="term-fg32">+		txTypes  []uint8</span>
<span class="term-fg32">+		validate func(types.Receipts, types.Receipts)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Tests use the real reference data, so block numbers and chainIDs are selected for different test cases</span>
<span class="term-fg32">+	testcases := []testcase{</span>
<span class="term-fg32">+		&#47;&#47; Test case 1: No receipts</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			blockNum: 6825767,</span>
<span class="term-fg32">+			chainID:  420,</span>
<span class="term-fg32">+			nonces:   []uint64{},</span>
<span class="term-fg32">+			txTypes:  []uint8{},</span>
<span class="term-fg32">+			validate: func(receipts types.Receipts, correctedReceipts types.Receipts) {</span>
<span class="term-fg32">+				assert.Empty(t, correctedReceipts)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&#47;&#47; Test case 2: No deposits</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			blockNum: 6825767,</span>
<span class="term-fg32">+			chainID:  420,</span>
<span class="term-fg32">+			nonces:   []uint64{1, 2, 3},</span>
<span class="term-fg32">+			txTypes:  []uint8{1, 1, 1},</span>
<span class="term-fg32">+			validate: func(receipts types.Receipts, correctedReceipts types.Receipts) {</span>
<span class="term-fg32">+				assert.Equal(t, receipts, correctedReceipts)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&#47;&#47; Test case 3: all deposits with no correction</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			blockNum: 8835769,</span>
<span class="term-fg32">+			chainID:  420,</span>
<span class="term-fg32">+			nonces:   []uint64{78756, 78757, 78758, 78759, 78760, 78761, 78762, 78763, 78764},</span>
<span class="term-fg32">+			txTypes:  []uint8{126, 126, 126, 126, 126, 126, 126, 126, 126},</span>
<span class="term-fg32">+			validate: func(receipts types.Receipts, correctedReceipts types.Receipts) {</span>
<span class="term-fg32">+				assert.Equal(t, receipts, correctedReceipts)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&#47;&#47; Test case 4: all deposits with a correction</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			blockNum: 8835769,</span>
<span class="term-fg32">+			chainID:  420,</span>
<span class="term-fg32">+			nonces:   []uint64{78756, 78757, 78758, 12345, 78760, 78761, 78762, 78763, 78764},</span>
<span class="term-fg32">+			txTypes:  []uint8{126, 126, 126, 126, 126, 126, 126, 126, 126},</span>
<span class="term-fg32">+			validate: func(receipts types.Receipts, correctedReceipts types.Receipts) {</span>
<span class="term-fg32">+				assert.NotEqual(t, receipts[3], correctedReceipts[3])</span>
<span class="term-fg32">+				for i := range receipts {</span>
<span class="term-fg32">+					if i != 3 {</span>
<span class="term-fg32">+						assert.Equal(t, receipts[i], correctedReceipts[i])</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&#47;&#47; Test case 5: deposits with several corrections and non-deposits</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			blockNum: 8835769,</span>
<span class="term-fg32">+			chainID:  420,</span>
<span class="term-fg32">+			nonces:   []uint64{0, 1, 2, 78759, 78760, 78761, 6, 78763, 78764, 9, 10, 11},</span>
<span class="term-fg32">+			txTypes:  []uint8{126, 126, 126, 126, 126, 126, 126, 126, 126, 1, 1, 1},</span>
<span class="term-fg32">+			validate: func(receipts types.Receipts, correctedReceipts types.Receipts) {</span>
<span class="term-fg32">+				&#47;&#47; indexes 0, 1, 2, 6 were modified</span>
<span class="term-fg32">+				&#47;&#47; indexes 9, 10, 11 were added too, but they are not user deposits</span>
<span class="term-fg32">+				assert.NotEqual(t, receipts[0], correctedReceipts[0])</span>
<span class="term-fg32">+				assert.NotEqual(t, receipts[1], correctedReceipts[1])</span>
<span class="term-fg32">+				assert.NotEqual(t, receipts[2], correctedReceipts[2])</span>
<span class="term-fg32">+				assert.NotEqual(t, receipts[6], correctedReceipts[6])</span>
<span class="term-fg32">+				for i := range receipts {</span>
<span class="term-fg32">+					if i != 0 &amp;&amp; i != 1 &amp;&amp; i != 2 &amp;&amp; i != 6 {</span>
<span class="term-fg32">+						assert.Equal(t, receipts[i], correctedReceipts[i])</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, tc := range testcases {</span>
<span class="term-fg32">+		receipts, correctedReceipts := makeCorrection(tc.blockNum, tc.chainID, tc.nonces, tc.txTypes)</span>
<span class="term-fg32">+		tc.validate(receipts, correctedReceipts)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ffacfe513605c045d1928cda" role="button"
                   aria-expanded="false" aria-controls="id-ffacfe513605c045d1928cda">
                    <code>eth/downloader/userDepositData/10.105235063-114696812.gob</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/userDepositData/10.105235063-114696812.gob" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <span class="text-secondary">(binary file)</span>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ffacfe513605c045d1928cda"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;userDepositData&#47;10.105235063-114696812.gob op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;10.105235063-114696812.gob</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..f26643825f272cf945fc71c953265bac6336f40a</span>
<span class="term-fg1">Binary files &#47;dev&#47;null and op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;10.105235063-114696812.gob differ</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3123349ce592497863488562" role="button"
                   aria-expanded="false" aria-controls="id-3123349ce592497863488562">
                    <code>eth/downloader/userDepositData/291.0-4192087.gob</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/userDepositData/291.0-4192087.gob" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <span class="text-secondary">(binary file)</span>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3123349ce592497863488562"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;userDepositData&#47;291.0-4192087.gob op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;291.0-4192087.gob</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0a94e024c6638124ac5af95ef101ff7209516331</span>
<span class="term-fg1">Binary files &#47;dev&#47;null and op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;291.0-4192087.gob differ</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0f1500e736a31ee0194bfb4a" role="button"
                   aria-expanded="false" aria-controls="id-0f1500e736a31ee0194bfb4a">
                    <code>eth/downloader/userDepositData/34443.0-2412409.gob</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/userDepositData/34443.0-2412409.gob" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <span class="text-secondary">(binary file)</span>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0f1500e736a31ee0194bfb4a"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;userDepositData&#47;34443.0-2412409.gob op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;34443.0-2412409.gob</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..750e6669594db72e1ce3d5d779651a56e3166cb2</span>
<span class="term-fg1">Binary files &#47;dev&#47;null and op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;34443.0-2412409.gob differ</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b8cee1bdce35fd2234a3b3c4" role="button"
                   aria-expanded="false" aria-controls="id-b8cee1bdce35fd2234a3b3c4">
                    <code>eth/downloader/userDepositData/420.6825766-17276566.gob</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/userDepositData/420.6825766-17276566.gob" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <span class="text-secondary">(binary file)</span>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b8cee1bdce35fd2234a3b3c4"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;userDepositData&#47;420.6825766-17276566.gob op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;420.6825766-17276566.gob</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..d17871da6e0a732ad24b8186136d3e18d6a53f91</span>
<span class="term-fg1">Binary files &#47;dev&#47;null and op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;420.6825766-17276566.gob differ</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e69abb7cb25d629af86f8b91" role="button"
                   aria-expanded="false" aria-controls="id-e69abb7cb25d629af86f8b91">
                    <code>eth/downloader/userDepositData/7777777.0-9149281.gob</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/userDepositData/7777777.0-9149281.gob" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <span class="text-secondary">(binary file)</span>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e69abb7cb25d629af86f8b91"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;userDepositData&#47;7777777.0-9149281.gob op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;7777777.0-9149281.gob</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..ee63497b9c874cffc6435d680be8dc67958456c9</span>
<span class="term-fg1">Binary files &#47;dev&#47;null and op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;7777777.0-9149281.gob differ</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e63793e943e83a1c26ec9dae" role="button"
                   aria-expanded="false" aria-controls="id-e63793e943e83a1c26ec9dae">
                    <code>eth/downloader/userDepositData/8453.0-9101527.gob</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/downloader/userDepositData/8453.0-9101527.gob" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <span class="text-secondary">(binary file)</span>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e63793e943e83a1c26ec9dae"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;userDepositData&#47;8453.0-9101527.gob op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;8453.0-9101527.gob</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..88f825e01ad52bbb543527b50d88ee5640728a2d</span>
<span class="term-fg1">Binary files &#47;dev&#47;null and op-geth&#47;eth&#47;downloader&#47;userDepositData&#47;8453.0-9101527.gob differ</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6dacd3c7c594a504278eee57" role="button"
                   aria-expanded="false" aria-controls="id-6dacd3c7c594a504278eee57">
                    <code>eth/gasestimator/gasestimator.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/gasestimator/gasestimator.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/gasestimator/gasestimator.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6dacd3c7c594a504278eee57"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasestimator&#47;gasestimator.go op-geth&#47;eth&#47;gasestimator&#47;gasestimator.go</span>
<span class="term-fg1">index f07f98956e3c8a483f14e693569f096837d899a0..a6c9d635d8d87d1b5abedf9fb99c32d236ddcb68 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;gasestimator&#47;gasestimator.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasestimator&#47;gasestimator.go</span>
<span class="term-fg36">@@ -208,7 +208,7 @@</span> func run(ctx context.Context, call *core.Message, opts *Options) (*core.ExecutionResult, error) {
 	&#47;&#47; Assemble the call and the call context
 	var (
 		msgContext = core.NewEVMTxContext(call)
<span class="term-fg31">-		evmContext = core.NewEVMBlockContext(opts.Header, opts.Chain, nil)</span>
<span class="term-fg32">+		evmContext = core.NewEVMBlockContext(opts.Header, opts.Chain, nil, opts.Config, opts.State)</span>
&nbsp;
 		dirtyState = opts.State.Copy()
 		evm        = vm.NewEVM(evmContext, msgContext, dirtyState, opts.Config, vm.Config{NoBaseFee: true})</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2fe9e6d78d3d0cbe98df4871" role="button"
                   aria-expanded="false" aria-controls="id-2fe9e6d78d3d0cbe98df4871">
                    <code>eth/gasprice/feehistory.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/gasprice/feehistory.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/gasprice/feehistory.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2fe9e6d78d3d0cbe98df4871"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;feehistory.go op-geth&#47;eth&#47;gasprice&#47;feehistory.go</span>
<span class="term-fg1">index 226991b24b2c635f2c7708bbcbb828e05676aacb..13f36499d4222a259aa89eef27fa958026d85ab7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;gasprice&#47;feehistory.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;feehistory.go</span>
<span class="term-fg36">@@ -83,7 +83,7 @@</span> 	if bf.results.baseFee = bf.header.BaseFee; bf.results.baseFee == nil {
 		bf.results.baseFee = new(big.Int)
 	}
 	if chainconfig.IsLondon(big.NewInt(int64(bf.blockNumber + 1))) {
<span class="term-fg31">-		bf.results.nextBaseFee = eip1559.CalcBaseFee(chainconfig, bf.header)</span>
<span class="term-fg32">+		bf.results.nextBaseFee = eip1559.CalcBaseFee(chainconfig, bf.header, bf.header.Time+1)</span>
 	} else {
 		bf.results.nextBaseFee = new(big.Int)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-511c167a31c6bc8a0dceff22" role="button"
                   aria-expanded="false" aria-controls="id-511c167a31c6bc8a0dceff22">
                    <code>eth/gasprice/optimism-gasprice_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/gasprice/optimism-gasprice_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+142</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-511c167a31c6bc8a0dceff22"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..dd0140839d91e45be16d06faae9b714ad53265fa</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go</span>
<span class="term-fg36">@@ -0,0 +1,142 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2020 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package gasprice</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;context&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	blockGasLimit = params.TxGas * 3</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type testTxData struct {</span>
<span class="term-fg32">+	priorityFee int64</span>
<span class="term-fg32">+	gasLimit    uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type opTestBackend struct {</span>
<span class="term-fg32">+	block    *types.Block</span>
<span class="term-fg32">+	receipts []*types.Receipt</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) HeaderByNumber(ctx context.Context, number rpc.BlockNumber) (*types.Header, error) {</span>
<span class="term-fg32">+	panic(&quot;not implemented&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) BlockByNumber(ctx context.Context, number rpc.BlockNumber) (*types.Block, error) {</span>
<span class="term-fg32">+	return b.block, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) GetReceipts(ctx context.Context, hash common.Hash) (types.Receipts, error) {</span>
<span class="term-fg32">+	return b.receipts, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) PendingBlockAndReceipts() (*types.Block, types.Receipts) {</span>
<span class="term-fg32">+	panic(&quot;not implemented&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) ChainConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	return params.OptimismTestConfig</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) SubscribeChainHeadEvent(ch chan&lt;- core.ChainHeadEvent) event.Subscription {</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newOpTestBackend(t *testing.T, txs []testTxData) *opTestBackend {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		key, _ = crypto.HexToECDSA(&quot;b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291&quot;)</span>
<span class="term-fg32">+		signer = types.LatestSigner(params.TestChainConfig)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	&#47;&#47; only the most recent block is considered for optimism priority fee suggestions, so this is</span>
<span class="term-fg32">+	&#47;&#47; where we add the test transactions</span>
<span class="term-fg32">+	ts := []*types.Transaction{}</span>
<span class="term-fg32">+	rs := []*types.Receipt{}</span>
<span class="term-fg32">+	header := types.Header{}</span>
<span class="term-fg32">+	header.GasLimit = blockGasLimit</span>
<span class="term-fg32">+	var nonce uint64</span>
<span class="term-fg32">+	for _, tx := range txs {</span>
<span class="term-fg32">+		txdata := &amp;types.DynamicFeeTx{</span>
<span class="term-fg32">+			ChainID:   params.TestChainConfig.ChainID,</span>
<span class="term-fg32">+			Nonce:     nonce,</span>
<span class="term-fg32">+			To:        &amp;common.Address{},</span>
<span class="term-fg32">+			Gas:       params.TxGas,</span>
<span class="term-fg32">+			GasFeeCap: big.NewInt(100 * params.GWei),</span>
<span class="term-fg32">+			GasTipCap: big.NewInt(tx.priorityFee),</span>
<span class="term-fg32">+			Data:      []byte{},</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		t := types.MustSignNewTx(key, signer, txdata)</span>
<span class="term-fg32">+		ts = append(ts, t)</span>
<span class="term-fg32">+		r := types.Receipt{}</span>
<span class="term-fg32">+		r.GasUsed = tx.gasLimit</span>
<span class="term-fg32">+		header.GasUsed += r.GasUsed</span>
<span class="term-fg32">+		rs = append(rs, &amp;r)</span>
<span class="term-fg32">+		nonce++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	hasher := trie.NewStackTrie(nil)</span>
<span class="term-fg32">+	b := types.NewBlock(&amp;header, ts, nil, nil, hasher)</span>
<span class="term-fg32">+	return &amp;opTestBackend{block: b, receipts: rs}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSuggestOptimismPriorityFee(t *testing.T) {</span>
<span class="term-fg32">+	minSuggestion := new(big.Int).SetUint64(1e8 * params.Wei)</span>
<span class="term-fg32">+	var cases = []struct {</span>
<span class="term-fg32">+		txdata []testTxData</span>
<span class="term-fg32">+		want   *big.Int</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; block well under capacity, expect min priority fee suggestion</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   minSuggestion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 2 txs, still under capacity, expect min priority fee suggestion</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}, testTxData{params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   minSuggestion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 2 txs w same priority fee (1 gwei), but second tx puts it right over capacity</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}, testTxData{params.GWei, 21001}},</span>
<span class="term-fg32">+			want:   big.NewInt(1100000000), &#47;&#47; 10 percent over 1 gwei, the median</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 3 txs, full block. return 10% over the median tx (10 gwei * 10% == 11 gwei)</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{10 * params.GWei, 21000}, testTxData{1 * params.GWei, 21000}, testTxData{100 * params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   big.NewInt(11 * params.GWei),</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, c := range cases {</span>
<span class="term-fg32">+		backend := newOpTestBackend(t, c.txdata)</span>
<span class="term-fg32">+		oracle := NewOracle(backend, Config{MinSuggestedPriorityFee: minSuggestion})</span>
<span class="term-fg32">+		got := oracle.SuggestOptimismPriorityFee(context.Background(), backend.block.Header(), backend.block.Hash())</span>
<span class="term-fg32">+		if got.Cmp(c.want) != 0 {</span>
<span class="term-fg32">+			t.Errorf(&quot;Gas price mismatch for test case %d: want %d, got %d&quot;, i, c.want, got)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7c9216030b84e37dc9f51e8b" role="button"
                   aria-expanded="false" aria-controls="id-7c9216030b84e37dc9f51e8b">
                    <code>eth/tracers/internal/tracetest/flat_calltrace_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/tracers/internal/tracetest/flat_calltrace_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/internal/tracetest/flat_calltrace_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7c9216030b84e37dc9f51e8b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;flat_calltrace_test.go op-geth&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;flat_calltrace_test.go</span>
<span class="term-fg1">index b318548bc171c95bc3ad0d8c1f9e50ecae6f78ea..efc4bcee2130c012ec8712dd4c679cc86544bedb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;flat_calltrace_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;flat_calltrace_test.go</span>
<span class="term-fg36">@@ -16,7 +16,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;tests&quot;
&nbsp;
 	&#47;&#47; Force-load the native, to trigger registration
<span class="term-fg36">@@ -82,7 +81,7 @@</span> 		return fmt.Errorf(&quot;failed to parse testcase: %v&quot;, err)
 	}
 	&#47;&#47; Configure a blockchain with the given prestate
 	tx := new(types.Transaction)
<span class="term-fg31">-	if err := rlp.DecodeBytes(common.FromHex(test.Input), tx); err != nil {</span>
<span class="term-fg32">+	if err := tx.UnmarshalBinary(common.FromHex(test.Input)); err != nil {</span>
 		return fmt.Errorf(&quot;failed to parse testcase input: %v&quot;, err)
 	}
 	signer := types.MakeSigner(test.Genesis.Config, new(big.Int).SetUint64(uint64(test.Context.Number)), uint64(test.Context.Time))</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9b208be0282d0e80f5950a5d" role="button"
                   aria-expanded="false" aria-controls="id-9b208be0282d0e80f5950a5d">
                    <code>eth/tracers/internal/tracetest/testdata/call_tracer/failed_deposit.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/internal/tracetest/testdata/call_tracer/failed_deposit.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+47</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9b208be0282d0e80f5950a5d"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;testdata&#47;call_tracer&#47;failed_deposit.json op-geth&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;testdata&#47;call_tracer&#47;failed_deposit.json</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..2c43cdae0f732a4faae29e19cc8df11741d198fa</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;testdata&#47;call_tracer&#47;failed_deposit.json</span>
<span class="term-fg36">@@ -0,0 +1,47 @@</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+  &quot;context&quot;: {</span>
<span class="term-fg32">+    &quot;difficulty&quot;: &quot;3699098917&quot;,</span>
<span class="term-fg32">+    &quot;gasLimit&quot;: &quot;5258985&quot;,</span>
<span class="term-fg32">+    &quot;miner&quot;: &quot;0xd049bfd667cb46aa3ef5df0da3e57db3be39e511&quot;,</span>
<span class="term-fg32">+    &quot;number&quot;: &quot;2294631&quot;,</span>
<span class="term-fg32">+    &quot;timestamp&quot;: &quot;1513675366&quot;</span>
<span class="term-fg32">+  },</span>
<span class="term-fg32">+  &quot;genesis&quot;: {</span>
<span class="term-fg32">+    &quot;alloc&quot;: {},</span>
<span class="term-fg32">+    &quot;config&quot;: {</span>
<span class="term-fg32">+      &quot;chainId&quot;: 3,</span>
<span class="term-fg32">+      &quot;daoForkSupport&quot;: true,</span>
<span class="term-fg32">+      &quot;eip150Hash&quot;: &quot;0x41941023680923e0fe4d74a34bdac8141f2540e3ae90623718e47d66d1ca4a2d&quot;,</span>
<span class="term-fg32">+      &quot;ethash&quot;: {},</span>
<span class="term-fg32">+      &quot;eip150Block&quot;: 0,</span>
<span class="term-fg32">+      &quot;eip155Block&quot;: 0,</span>
<span class="term-fg32">+      &quot;eip158Block&quot;: 0,</span>
<span class="term-fg32">+      &quot;byzantiumBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;constantinopleBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;petersburgBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;istanbulBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;berlinBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;londonBlock&quot;: 0</span>
<span class="term-fg32">+    },</span>
<span class="term-fg32">+    &quot;difficulty&quot;: &quot;3699098917&quot;,</span>
<span class="term-fg32">+    &quot;extraData&quot;: &quot;0x4554482e45544846414e532e4f52472d4641313738394444&quot;,</span>
<span class="term-fg32">+    &quot;gasLimit&quot;: &quot;5263953&quot;,</span>
<span class="term-fg32">+    &quot;hash&quot;: &quot;0x03a0f62a8106793dafcfae7b75fd2654322062d585a19cea568314d7205790dc&quot;,</span>
<span class="term-fg32">+    &quot;miner&quot;: &quot;0xbbf5029fd710d227630c8b7d338051b8e76d50b3&quot;,</span>
<span class="term-fg32">+    &quot;mixHash&quot;: &quot;0x15482cc64b7c00a947f5bf015dfc010db1a6a668c74df61974d6a7848c174408&quot;,</span>
<span class="term-fg32">+    &quot;nonce&quot;: &quot;0xd1bdb150f6fd170e&quot;,</span>
<span class="term-fg32">+    &quot;number&quot;: &quot;2294630&quot;,</span>
<span class="term-fg32">+    &quot;stateRoot&quot;: &quot;0x1ab1a534e84cc787cda1db21e0d5920ab06017948075b759166cfea7274657a1&quot;,</span>
<span class="term-fg32">+    &quot;timestamp&quot;: &quot;1513675347&quot;,</span>
<span class="term-fg32">+    &quot;totalDifficulty&quot;: &quot;7160543502214733&quot;</span>
<span class="term-fg32">+  },</span>
<span class="term-fg32">+  &quot;input&quot;: &quot;0x7ef85aa0b4f9f798a5fe956d1b79c3eff355febf9e1039a7440948845536982cb62aa03194bc339e628e6fe32c39e84392d087567b2743ea3594bc339e628e6fe32c39e84392d087567b2743ea3580871aa535d3d0c00083030d408000&quot;,</span>
<span class="term-fg32">+  &quot;result&quot;: {</span>
<span class="term-fg32">+    &quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,</span>
<span class="term-fg32">+    &quot;gas&quot;:&quot;0x0&quot;,</span>
<span class="term-fg32">+    &quot;gasUsed&quot;:&quot;0x30d40&quot;,</span>
<span class="term-fg32">+    &quot;input&quot;:&quot;0x&quot;,</span>
<span class="term-fg32">+    &quot;error&quot;: &quot;failed deposit transaction&quot;,</span>
<span class="term-fg32">+    &quot;type&quot;:&quot;STOP&quot;</span>
<span class="term-fg32">+  }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-45c94c9022e4646330cc94d1" role="button"
                   aria-expanded="false" aria-controls="id-45c94c9022e4646330cc94d1">
                    <code>eth/tracers/internal/tracetest/testdata/call_tracer_flat/failed_deposit.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/internal/tracetest/testdata/call_tracer_flat/failed_deposit.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+59</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-45c94c9022e4646330cc94d1"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;testdata&#47;call_tracer_flat&#47;failed_deposit.json op-geth&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;testdata&#47;call_tracer_flat&#47;failed_deposit.json</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..540cd53579b1f58a9f72da481d2f86a8572ee430</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;internal&#47;tracetest&#47;testdata&#47;call_tracer_flat&#47;failed_deposit.json</span>
<span class="term-fg36">@@ -0,0 +1,59 @@</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+  &quot;context&quot;: {</span>
<span class="term-fg32">+    &quot;difficulty&quot;: &quot;3699098917&quot;,</span>
<span class="term-fg32">+    &quot;gasLimit&quot;: &quot;5258985&quot;,</span>
<span class="term-fg32">+    &quot;miner&quot;: &quot;0xd049bfd667cb46aa3ef5df0da3e57db3be39e511&quot;,</span>
<span class="term-fg32">+    &quot;number&quot;: &quot;2294631&quot;,</span>
<span class="term-fg32">+    &quot;timestamp&quot;: &quot;1513675366&quot;</span>
<span class="term-fg32">+  },</span>
<span class="term-fg32">+  &quot;genesis&quot;: {</span>
<span class="term-fg32">+    &quot;alloc&quot;: {},</span>
<span class="term-fg32">+    &quot;config&quot;: {</span>
<span class="term-fg32">+      &quot;chainId&quot;: 3,</span>
<span class="term-fg32">+      &quot;daoForkSupport&quot;: true,</span>
<span class="term-fg32">+      &quot;eip150Hash&quot;: &quot;0x41941023680923e0fe4d74a34bdac8141f2540e3ae90623718e47d66d1ca4a2d&quot;,</span>
<span class="term-fg32">+      &quot;ethash&quot;: {},</span>
<span class="term-fg32">+      &quot;eip150Block&quot;: 0,</span>
<span class="term-fg32">+      &quot;eip155Block&quot;: 0,</span>
<span class="term-fg32">+      &quot;eip158Block&quot;: 0,</span>
<span class="term-fg32">+      &quot;byzantiumBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;constantinopleBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;petersburgBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;istanbulBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;berlinBlock&quot;: 0,</span>
<span class="term-fg32">+      &quot;londonBlock&quot;: 0</span>
<span class="term-fg32">+    },</span>
<span class="term-fg32">+    &quot;difficulty&quot;: &quot;3699098917&quot;,</span>
<span class="term-fg32">+    &quot;extraData&quot;: &quot;0x4554482e45544846414e532e4f52472d4641313738394444&quot;,</span>
<span class="term-fg32">+    &quot;gasLimit&quot;: &quot;5263953&quot;,</span>
<span class="term-fg32">+    &quot;hash&quot;: &quot;0x03a0f62a8106793dafcfae7b75fd2654322062d585a19cea568314d7205790dc&quot;,</span>
<span class="term-fg32">+    &quot;miner&quot;: &quot;0xbbf5029fd710d227630c8b7d338051b8e76d50b3&quot;,</span>
<span class="term-fg32">+    &quot;mixHash&quot;: &quot;0x15482cc64b7c00a947f5bf015dfc010db1a6a668c74df61974d6a7848c174408&quot;,</span>
<span class="term-fg32">+    &quot;nonce&quot;: &quot;0xd1bdb150f6fd170e&quot;,</span>
<span class="term-fg32">+    &quot;number&quot;: &quot;2294630&quot;,</span>
<span class="term-fg32">+    &quot;stateRoot&quot;: &quot;0x1ab1a534e84cc787cda1db21e0d5920ab06017948075b759166cfea7274657a1&quot;,</span>
<span class="term-fg32">+    &quot;timestamp&quot;: &quot;1513675347&quot;,</span>
<span class="term-fg32">+    &quot;totalDifficulty&quot;: &quot;7160543502214733&quot;</span>
<span class="term-fg32">+  },</span>
<span class="term-fg32">+  &quot;input&quot;: &quot;0x7ef85aa0b4f9f798a5fe956d1b79c3eff355febf9e1039a7440948845536982cb62aa03194bc339e628e6fe32c39e84392d087567b2743ea3594bc339e628e6fe32c39e84392d087567b2743ea3580871aa535d3d0c00083030d408000&quot;,</span>
<span class="term-fg32">+  &quot;result&quot;: [</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+      &quot;action&quot;: {</span>
<span class="term-fg32">+        &quot;callType&quot;: &quot;stop&quot;,</span>
<span class="term-fg32">+        &quot;from&quot;: &quot;0x0000000000000000000000000000000000000000&quot;,</span>
<span class="term-fg32">+        &quot;gas&quot;: &quot;0x0&quot;,</span>
<span class="term-fg32">+        &quot;input&quot;: &quot;0x&quot;,</span>
<span class="term-fg32">+        &quot;value&quot;: &quot;0x0&quot;</span>
<span class="term-fg32">+      },</span>
<span class="term-fg32">+      &quot;blockNumber&quot;: 0,</span>
<span class="term-fg32">+      &quot;error&quot;: &quot;failed deposit transaction&quot;,</span>
<span class="term-fg32">+      &quot;result&quot;: {</span>
<span class="term-fg32">+        &quot;gasUsed&quot;: &quot;0x0&quot;,</span>
<span class="term-fg32">+        &quot;output&quot;: &quot;0x&quot;</span>
<span class="term-fg32">+      },</span>
<span class="term-fg32">+      &quot;subtraces&quot;: 0,</span>
<span class="term-fg32">+      &quot;traceAddress&quot;: [],</span>
<span class="term-fg32">+      &quot;type&quot;: &quot;call&quot;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+  ]</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4f503837ba9acfa52e4c65be" role="button"
                   aria-expanded="false" aria-controls="id-4f503837ba9acfa52e4c65be">
                    <code>eth/tracers/native/call.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/tracers/native/call.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/native/call.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4f503837ba9acfa52e4c65be"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;native&#47;call.go op-geth&#47;eth&#47;tracers&#47;native&#47;call.go</span>
<span class="term-fg1">index f85cf6206a7228127f8b55fc4c4b83da19b952ec..c120f980673438afc9c94eeb3f8ee93d25400ff7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;native&#47;call.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;native&#47;call.go</span>
<span class="term-fg36">@@ -262,6 +262,10 @@</span> 	if len(t.callstack) != 1 {
 		return nil, errors.New(&quot;incorrect number of top-level calls&quot;)
 	}
&nbsp;
<span class="term-fg32">+	if t.callstack[0].Type == vm.STOP {</span>
<span class="term-fg32">+		t.callstack[0].Error = &quot;failed deposit transaction&quot;</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	res, err := json.Marshal(t.callstack[0])
 	if err != nil {
 		return nil, err</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e7417087d5efc3175463b3a5" role="button"
                   aria-expanded="false" aria-controls="id-e7417087d5efc3175463b3a5">
                    <code>eth/tracers/native/call_flat.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/eth/tracers/native/call_flat.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/eth/tracers/native/call_flat.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e7417087d5efc3175463b3a5"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;native&#47;call_flat.go op-geth&#47;eth&#47;tracers&#47;native&#47;call_flat.go</span>
<span class="term-fg1">index 266ab9900146ca413600888e0238e4c5a3102b77..93f36f84a057e1e225d9df1e0bf146995a1c8c08 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;native&#47;call_flat.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;native&#47;call_flat.go</span>
<span class="term-fg36">@@ -215,6 +215,10 @@</span> 	if len(t.tracer.callstack) &lt; 1 {
 		return nil, errors.New(&quot;invalid number of calls&quot;)
 	}
&nbsp;
<span class="term-fg32">+	if t.tracer.callstack[0].Type == vm.STOP {</span>
<span class="term-fg32">+		t.tracer.callstack[0].Error = &quot;failed deposit transaction&quot;</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	flat, err := flatFromNested(&amp;t.tracer.callstack[0], []int{}, t.config.ConvertParityErrors, t.ctx)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -249,7 +253,7 @@</span> 	case vm.CREATE, vm.CREATE2:
 		frame = newFlatCreate(input)
 	case vm.SELFDESTRUCT:
 		frame = newFlatSelfdestruct(input)
<span class="term-fg31">-	case vm.CALL, vm.STATICCALL, vm.CALLCODE, vm.DELEGATECALL:</span>
<span class="term-fg32">+	case vm.CALL, vm.STATICCALL, vm.CALLCODE, vm.DELEGATECALL, vm.STOP:</span>
 		frame = newFlatCall(input)
 	default:
 		return nil, fmt.Errorf(&quot;unrecognized call frame type: %s&quot;, input.Type)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-057d5ad6a6f9a1db5fea25b3" role="button"
                   aria-expanded="false" aria-controls="id-057d5ad6a6f9a1db5fea25b3">
                    <code>graphql/graphql.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/graphql/graphql.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/graphql/graphql.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-057d5ad6a6f9a1db5fea25b3"><span class="term-fg1">diff --git go-ethereum&#47;graphql&#47;graphql.go op-geth&#47;graphql&#47;graphql.go</span>
<span class="term-fg1">index bac86476b10532037855f92d8196e350700e9440..c2807131d8bf83dd182ffefb63d05d8ea73a9593 100644</span>
<span class="term-fg1">--- go-ethereum&#47;graphql&#47;graphql.go</span>
<span class="term-fg1">+++ op-geth&#47;graphql&#47;graphql.go</span>
<span class="term-fg36">@@ -773,7 +773,7 @@</span> 		if !chaincfg.IsLondon(new(big.Int).Add(header.Number, common.Big1)) {
 			return nil, nil
 		}
 	}
<span class="term-fg31">-	nextBaseFee := eip1559.CalcBaseFee(chaincfg, header)</span>
<span class="term-fg32">+	nextBaseFee := eip1559.CalcBaseFee(chaincfg, header, header.Time+1)</span>
 	return (*hexutil.Big)(nextBaseFee), nil
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-582ee6360064577a2e211dfa" role="button"
                   aria-expanded="false" aria-controls="id-582ee6360064577a2e211dfa">
                    <code>internal/ethapi/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/ethapi/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/ethapi/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+179</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-582ee6360064577a2e211dfa"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api_test.go op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">index 623aa1fe42a7844b79acce1e810eecc756cfb4b9..37477253d135d4cb8bccf002787abf1f4f851a78 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg36">@@ -30,6 +30,10 @@</span> 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
<span class="term-fg36">@@ -50,11 +54,166 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;blocktest&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg31">-	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg31">-	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg31">-	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;</span>
 )
&nbsp;
<span class="term-fg32">+func TestNewRPCTransactionDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	nonce := uint64(7)</span>
<span class="term-fg32">+	receipt := &amp;types.Receipt{</span>
<span class="term-fg32">+		DepositNonce: &amp;nonce,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, receipt)</span>
<span class="term-fg32">+	&#47;&#47; Should provide zero values for unused fields that are required in other transactions</span>
<span class="term-fg32">+	require.Equal(t, got.GasPrice, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().GasPrice = %v, want 0x0&quot;, got.GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, got.V, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().V = %v, want 0x0&quot;, got.V)</span>
<span class="term-fg32">+	require.Equal(t, got.R, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().R = %v, want 0x0&quot;, got.R)</span>
<span class="term-fg32">+	require.Equal(t, got.S, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().S = %v, want 0x0&quot;, got.S)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should include deposit tx specific fields</span>
<span class="term-fg32">+	require.Equal(t, *got.SourceHash, tx.SourceHash(), &quot;newRPCTransaction().SourceHash = %v, want %v&quot;, got.SourceHash, tx.SourceHash())</span>
<span class="term-fg32">+	require.Equal(t, *got.IsSystemTx, tx.IsSystemTx(), &quot;newRPCTransaction().IsSystemTx = %v, want %v&quot;, got.IsSystemTx, tx.IsSystemTx())</span>
<span class="term-fg32">+	require.Equal(t, got.Mint, (*hexutil.Big)(tx.Mint()), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Mint, tx.Mint())</span>
<span class="term-fg32">+	require.Equal(t, got.Nonce, (hexutil.Uint64)(nonce), &quot;newRPCTransaction().Nonce = %v, want %v&quot;, got.Nonce, nonce)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRPCTransactionDepositTxWithVersion(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	nonce := uint64(7)</span>
<span class="term-fg32">+	version := types.CanyonDepositReceiptVersion</span>
<span class="term-fg32">+	receipt := &amp;types.Receipt{</span>
<span class="term-fg32">+		DepositNonce:          &amp;nonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: &amp;version,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, receipt)</span>
<span class="term-fg32">+	&#47;&#47; Should provide zero values for unused fields that are required in other transactions</span>
<span class="term-fg32">+	require.Equal(t, got.GasPrice, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().GasPrice = %v, want 0x0&quot;, got.GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, got.V, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().V = %v, want 0x0&quot;, got.V)</span>
<span class="term-fg32">+	require.Equal(t, got.R, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().R = %v, want 0x0&quot;, got.R)</span>
<span class="term-fg32">+	require.Equal(t, got.S, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().S = %v, want 0x0&quot;, got.S)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should include versioned deposit tx specific fields</span>
<span class="term-fg32">+	require.Equal(t, *got.SourceHash, tx.SourceHash(), &quot;newRPCTransaction().SourceHash = %v, want %v&quot;, got.SourceHash, tx.SourceHash())</span>
<span class="term-fg32">+	require.Equal(t, *got.IsSystemTx, tx.IsSystemTx(), &quot;newRPCTransaction().IsSystemTx = %v, want %v&quot;, got.IsSystemTx, tx.IsSystemTx())</span>
<span class="term-fg32">+	require.Equal(t, got.Mint, (*hexutil.Big)(tx.Mint()), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Mint, tx.Mint())</span>
<span class="term-fg32">+	require.Equal(t, got.Nonce, (hexutil.Uint64)(nonce), &quot;newRPCTransaction().Nonce = %v, want %v&quot;, got.Nonce, nonce)</span>
<span class="term-fg32">+	require.Equal(t, *got.DepositReceiptVersion, (hexutil.Uint64(version)), &quot;newRPCTransaction().DepositReceiptVersion = %v, want %v&quot;, *got.DepositReceiptVersion, version)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Make sure json marshal&#47;unmarshal of the rpc tx preserves the receipt version</span>
<span class="term-fg32">+	b, err := json.Marshal(got)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;marshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+	parsed := make(map[string]interface{})</span>
<span class="term-fg32">+	err = json.Unmarshal(b, &amp;parsed)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;unmarshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+	require.Equal(t, &quot;0x1&quot;, parsed[&quot;depositReceiptVersion&quot;])</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestNewRPCTransactionOmitIsSystemTxFalse(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		IsSystemTransaction: false,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Nil(t, got.IsSystemTx, &quot;should omit IsSystemTx when false&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestUnmarshalRpcDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	version := hexutil.Uint64(types.CanyonDepositReceiptVersion)</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name     string</span>
<span class="term-fg32">+		modifier func(tx *RPCTransaction)</span>
<span class="term-fg32">+		valid    bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:     &quot;Unmodified&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {},</span>
<span class="term-fg32">+			valid:    true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Zero Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Nil Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = nil</span>
<span class="term-fg32">+				tx.R = nil</span>
<span class="term-fg32">+				tx.S = nil</span>
<span class="term-fg32">+				tx.GasPrice = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero GasPrice&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero V&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero R&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero S&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-nil deposit receipt version&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.DepositReceiptVersion = &amp;version</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+				SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+				IsSystemTransaction: true,</span>
<span class="term-fg32">+				Mint:                big.NewInt(34),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			rpcTx := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+			test.modifier(rpcTx)</span>
<span class="term-fg32">+			json, err := json.Marshal(rpcTx)</span>
<span class="term-fg32">+			require.NoError(t, err, &quot;marshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+			parsed := &amp;types.Transaction{}</span>
<span class="term-fg32">+			err = parsed.UnmarshalJSON(json)</span>
<span class="term-fg32">+			if test.valid {</span>
<span class="term-fg32">+				require.NoError(t, err, &quot;unmarshal failed: %w&quot;, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.Error(t, err, &quot;unmarshal should have failed but did not&quot;)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func testTransactionMarshal(t *testing.T, tests []txData, config *params.ChainConfig) {
 	t.Parallel()
 	var (
<span class="term-fg36">@@ -78,7 +237,7 @@</span> 			t.Fatalf(&quot;test %d: stx changed, want %x have %x&quot;, i, want, have)
 		}
&nbsp;
 		&#47;&#47; rpcTransaction
<span class="term-fg31">-		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, 0, nil, config)</span>
<span class="term-fg32">+		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, 0, nil, config, nil)</span>
 		if data, err := json.Marshal(rpcTx); err != nil {
 			t.Fatalf(&quot;test %d: marshalling failed; %v&quot;, i, err)
 		} else if err = tx2.UnmarshalJSON(data); err != nil {
<span class="term-fg36">@@ -565,7 +724,7 @@</span> 	if vmConfig == nil {
 		vmConfig = b.chain.GetVMConfig()
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.chain, nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.chain, nil, b.ChainConfig(), state)</span>
 	if blockContext != nil {
 		context = *blockContext
 	}
<span class="term-fg36">@@ -620,6 +779,12 @@</span> func (b testBackend) BloomStatus() (uint64, uint64) { panic(&quot;implement me&quot;) }
 func (b testBackend) ServiceFilter(ctx context.Context, session *bloombits.MatcherSession) {
 	panic(&quot;implement me&quot;)
 }
<span class="term-fg32">+func (b testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func (b testBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+}</span>
&nbsp;
 func TestEstimateGas(t *testing.T) {
 	t.Parallel()
<span class="term-fg36">@@ -841,7 +1006,7 @@</span> 				From:  &amp;accounts[0].addr,
 				To:    &amp;accounts[1].addr,
 				Value: (*hexutil.Big)(big.NewInt(1000)),
 			},
<span class="term-fg31">-			expectErr: errors.New(&quot;header not found&quot;),</span>
<span class="term-fg32">+			expectErr: ethereum.NotFound,</span>
 		},
 		&#47;&#47; transfer on the latest block
 		{
<span class="term-fg36">@@ -1275,7 +1440,7 @@</span> 						&quot;to&quot;: &quot;0x0000000000000000000000000000000000000011&quot;,
 						&quot;transactionIndex&quot;: &quot;0x1&quot;,
 						&quot;value&quot;: &quot;0x6f&quot;,
 						&quot;type&quot;: &quot;0x0&quot;,
<span class="term-fg31">-						&quot;chainId&quot;: &quot;0x7fffffffffffffee&quot;,</span>
<span class="term-fg32">+						&quot;chainId&quot;: &quot;0x1&quot;,</span>
 						&quot;v&quot;: &quot;0x0&quot;,
 						&quot;r&quot;: &quot;0x0&quot;,
 						&quot;s&quot;: &quot;0x0&quot;
<span class="term-fg36">@@ -1313,7 +1478,7 @@</span> 						&quot;to&quot;: &quot;0x0000000000000000000000000000000000000011&quot;,
 						&quot;transactionIndex&quot;: &quot;0x3&quot;,
 						&quot;value&quot;: &quot;0x6f&quot;,
 						&quot;type&quot;: &quot;0x0&quot;,
<span class="term-fg31">-						&quot;chainId&quot;: &quot;0x7fffffffffffffee&quot;,</span>
<span class="term-fg32">+						&quot;chainId&quot;: &quot;0x1&quot;,</span>
 						&quot;v&quot;: &quot;0x0&quot;,
 						&quot;r&quot;: &quot;0x0&quot;,
 						&quot;s&quot;: &quot;0x0&quot;
<span class="term-fg36">@@ -1326,7 +1491,11 @@</span> 		},
 	}
&nbsp;
 	for i, tc := range testSuite {
<span class="term-fg31">-		resp := RPCMarshalBlock(block, tc.inclTx, tc.fullTx, params.MainnetChainConfig)</span>
<span class="term-fg32">+		resp, err := RPCMarshalBlock(context.Background(), block, tc.inclTx, tc.fullTx, params.MainnetChainConfig, testBackend{})</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Errorf(&quot;test %d: got error %v&quot;, i, err)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
 		out, err := json.Marshal(resp)
 		if err != nil {
 			t.Errorf(&quot;test %d: json marshal error: %v&quot;, i, err)
<span class="term-fg36">@@ -1627,6 +1796,7 @@</span> 		var (
 			tx  *types.Transaction
 			err error
 		)
<span class="term-fg32">+		b.SetPoS()</span>
 		switch i {
 		case 0:
 			&#47;&#47; transfer 1000wei
<span class="term-fg36">@@ -1675,7 +1845,6 @@</span> 		if tx != nil {
 			b.AddTx(tx)
 			txHashes[i] = tx.Hash()
 		}
<span class="term-fg31">-		b.SetPoS()</span>
 	})
 	return backend, txHashes
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0352db143b3adacacd65e44f" role="button"
                   aria-expanded="false" aria-controls="id-0352db143b3adacacd65e44f">
                    <code>internal/testlog/testlog.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/internal/testlog/testlog.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/internal/testlog/testlog.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0352db143b3adacacd65e44f"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;testlog&#47;testlog.go op-geth&#47;internal&#47;testlog&#47;testlog.go</span>
<span class="term-fg1">index 037b7ee9c1206f56203745a224d36abbff3f08f8..3cdbea6e0537659c5fb8b01967565641fb4fd5fc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;testlog&#47;testlog.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;testlog&#47;testlog.go</span>
<span class="term-fg36">@@ -98,6 +98,10 @@</span> 		h:  &amp;bh,
 	}
 }
&nbsp;
<span class="term-fg32">+func (l *logger) Handler() slog.Handler {</span>
<span class="term-fg32">+	return l.l.Handler()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func (l *logger) Write(level slog.Level, msg string, ctx ...interface{}) {}
&nbsp;
 func (l *logger) Enabled(ctx context.Context, level slog.Level) bool {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-80dedf5f0a59a1a4d85397cb" role="button"
                   aria-expanded="false" aria-controls="id-80dedf5f0a59a1a4d85397cb">
                    <code>log/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/log/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/log/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-80dedf5f0a59a1a4d85397cb"><span class="term-fg1">diff --git go-ethereum&#47;log&#47;handler.go op-geth&#47;log&#47;handler.go</span>
<span class="term-fg1">index 7459aad8913b29a491cfa45d1b6ab524dc9c7617..256b57f2d0b2e46e289a3c3d97896113b0672634 100644</span>
<span class="term-fg1">--- go-ethereum&#47;log&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;log&#47;handler.go</span>
<span class="term-fg36">@@ -117,6 +117,7 @@</span> &#47;&#47; JSONHandler returns a handler which prints records in JSON format.
 func JSONHandler(wr io.Writer) slog.Handler {
 	return slog.NewJSONHandler(wr, &amp;slog.HandlerOptions{
 		ReplaceAttr: builtinReplaceJSON,
<span class="term-fg32">+		Level:       &amp;leveler{levelMaxVerbosity},</span>
 	})
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c7bd1718e9a784e5d0f2d90a" role="button"
                   aria-expanded="false" aria-controls="id-c7bd1718e9a784e5d0f2d90a">
                    <code>log/logger.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/log/logger.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/log/logger.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c7bd1718e9a784e5d0f2d90a"><span class="term-fg1">diff --git go-ethereum&#47;log&#47;logger.go op-geth&#47;log&#47;logger.go</span>
<span class="term-fg1">index 75e3643044889295b9076d8c20173b55d4fa7ef4..c28bbde56840e40cf18ca2e364fcbdec8d23847d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;log&#47;logger.go</span>
<span class="term-fg1">+++ op-geth&#47;log&#47;logger.go</span>
<span class="term-fg36">@@ -137,6 +137,9 @@</span> 	Write(level slog.Level, msg string, attrs ...any)
&nbsp;
 	&#47;&#47; Enabled reports whether l emits log records at the given context and level.
 	Enabled(ctx context.Context, level slog.Level) bool
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Handler returns the underlying handler of the inner logger.</span>
<span class="term-fg32">+	Handler() slog.Handler</span>
 }
&nbsp;
 type logger struct {
<span class="term-fg36">@@ -148,6 +151,10 @@</span> func NewLogger(h slog.Handler) Logger {
 	return &amp;logger{
 		slog.New(h),
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (l *logger) Handler() slog.Handler {</span>
<span class="term-fg32">+	return l.inner.Handler()</span>
 }
&nbsp;
 &#47;&#47; write logs a message at the specified level:</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-349633ce0535988344d46de6" role="button"
                   aria-expanded="false" aria-controls="id-349633ce0535988344d46de6">
                    <code>node/node.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/node/node.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/node/node.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-349633ce0535988344d46de6"><span class="term-fg1">diff --git go-ethereum&#47;node&#47;node.go op-geth&#47;node&#47;node.go</span>
<span class="term-fg1">index 41c9971fe8e6de8fccd9d0a2a674957e217e81dd..d10639fe5bbd37bda8952987b7895333855f7883 100644</span>
<span class="term-fg1">--- go-ethereum&#47;node&#47;node.go</span>
<span class="term-fg1">+++ op-geth&#47;node&#47;node.go</span>
<span class="term-fg36">@@ -678,7 +678,7 @@</span>
 &#47;&#47; HTTPEndpoint returns the URL of the HTTP server. Note that this URL does not
 &#47;&#47; contain the JSON-RPC path prefix set by HTTPPathPrefix.
 func (n *Node) HTTPEndpoint() string {
<span class="term-fg31">-	return &quot;http:&#47;&#47;&quot; + n.http.listenAddr()</span>
<span class="term-fg32">+	return &quot;http:&#47;&#47;&quot; + n.http.listenAddr() &#47;&#47;nolint:all</span>
 }
&nbsp;
 &#47;&#47; WSEndpoint returns the current JSON-RPC over WebSocket endpoint.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0b8476ac7c05fb3a1713fb1b" role="button"
                   aria-expanded="false" aria-controls="id-0b8476ac7c05fb3a1713fb1b">
                    <code>params/bootnodes.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/params/bootnodes.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/bootnodes.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+23</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0b8476ac7c05fb3a1713fb1b"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;bootnodes.go op-geth&#47;params&#47;bootnodes.go</span>
<span class="term-fg1">index 5e2c7c21810234011be103fbd4c03b0d1c57adde..df05fc7a2f594a569aac44d6957a81101aca4810 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;bootnodes.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;bootnodes.go</span>
<span class="term-fg36">@@ -87,6 +87,29 @@</span> 	&quot;enr:-LK4QA8FfhaAjlb_BXsXxSfiysR7R52Nhi9JBt4F8SPssu8hdE1BXQQEtVDC3qStCW60LSO7hEsVHv5zm8_6Vnjhcn0Bh2F0dG5ldHOIAAAAAAAAAACEZXRoMpC1MD8qAAAAAP__________gmlkgnY0gmlwhAN4aBKJc2VjcDI1NmsxoQJerDhsJ-KxZ8sHySMOCmTO6sHM3iCFQ6VMvLTe948MyYN0Y3CCI4yDdWRwgiOM&quot;, &#47;&#47; 3.120.104.18 | aws-eu-central-1-frankfurt
 	&quot;enr:-LK4QKWrXTpV9T78hNG6s8AM6IO4XH9kFT91uZtFg1GcsJ6dKovDOr1jtAAFPnS2lvNltkOGA9k29BUN7lFh_sjuc9QBh2F0dG5ldHOIAAAAAAAAAACEZXRoMpC1MD8qAAAAAP__________gmlkgnY0gmlwhANAdd-Jc2VjcDI1NmsxoQLQa6ai7y9PMN5hpLe5HmiJSlYzMuzP7ZhwRiwHvqNXdoN0Y3CCI4yDdWRwgiOM&quot;, &#47;&#47; 3.64.117.223 | aws-eu-central-1-frankfurt}
 }
&nbsp;
<span class="term-fg32">+var V5OPBootnodes = []string{</span>
<span class="term-fg32">+	&#47;&#47; OP Labs</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;ca2774c3c401325850b2477fd7d0f27911efbf79b1e8b335066516e2bd8c4c9e0ba9696a94b1cb030a88eac582305ff55e905e64fb77fe0edcd70a4e5296d3ec@34.65.175.185:30305&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;dd751a9ef8912be1bfa7a5e34e2c3785cc5253110bd929f385e07ba7ac19929fb0e0c5d93f77827291f4da02b2232240fbc47ea7ce04c46e333e452f8656b667@34.65.107.0:30305&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;c5d289b56a77b6a2342ca29956dfd07aadf45364dde8ab20d1dc4efd4d1bc6b4655d902501daea308f4d8950737a4e93a4dfedd17b49cd5760ffd127837ca965@34.65.202.239:30305&quot;,</span>
<span class="term-fg32">+	&#47;&#47; Base</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;87a32fd13bd596b2ffca97020e31aef4ddcc1bbd4b95bb633d16c1329f654f34049ed240a36b449fda5e5225d70fe40bc667f53c304b71f8e68fc9d448690b51@3.231.138.188:30301&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;ca21ea8f176adb2e229ce2d700830c844af0ea941a1d8152a9513b966fe525e809c3a6c73a2c18a12b74ed6ec4380edf91662778fe0b79f6a591236e49e176f9@184.72.129.189:30301&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;acf4507a211ba7c1e52cdf4eef62cdc3c32e7c9c47998954f7ba024026f9a6b2150cd3f0b734d9c78e507ab70d59ba61dfe5c45e1078c7ad0775fb251d7735a2@3.220.145.177:30301&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;8a5a5006159bf079d06a04e5eceab2a1ce6e0f721875b2a9c96905336219dbe14203d38f70f3754686a6324f786c2f9852d8c0dd3adac2d080f4db35efc678c5@3.231.11.52:30301&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;cdadbe835308ad3557f9a1de8db411da1a260a98f8421d62da90e71da66e55e98aaa8e90aa7ce01b408a54e4bd2253d701218081ded3dbe5efbbc7b41d7cef79@54.198.153.150:30301&quot;,</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var V5OPTestnetBootnodes = []string{</span>
<span class="term-fg32">+	&#47;&#47; OP Labs</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;2bd2e657bb3c8efffb8ff6db9071d9eb7be70d7c6d7d980ff80fc93b2629675c5f750bc0a5ef27cd788c2e491b8795a7e9a4a6e72178c14acc6753c0e5d77ae4@34.65.205.244:30305&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;db8e1cab24624cc62fc35dbb9e481b88a9ef0116114cd6e41034c55b5b4f18755983819252333509bd8e25f6b12aadd6465710cd2e956558faf17672cce7551f@34.65.173.88:30305&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;bfda2e0110cfd0f4c9f7aa5bf5ec66e6bd18f71a2db028d36b8bf8b0d6fdb03125c1606a6017b31311d96a36f5ef7e1ad11604d7a166745e6075a715dfa67f8a@34.65.229.245:30305&quot;,</span>
<span class="term-fg32">+	&#47;&#47; Base</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;548f715f3fc388a7c917ba644a2f16270f1ede48a5d88a4d14ea287cc916068363f3092e39936f1a3e7885198bef0e5af951f1d7b1041ce8ba4010917777e71f@18.210.176.114:30301&quot;,</span>
<span class="term-fg32">+	&quot;enode:&#47;&#47;6f10052847a966a725c9f4adf6716f9141155b99a0fb487fea3f51498f4c2a2cb8d534e680ee678f9447db85b93ff7c74562762c3714783a7233ac448603b25f@107.21.251.55:30301&quot;,</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 const dnsPrefix = &quot;enrtree:&#47;&#47;AKA3AM6LPBYEUDMVNU3BSVQJ5AD45Y7YPOHJLEF6W26QOE4VTUDPE@&quot;
&nbsp;
 &#47;&#47; KnownDNSNetwork returns the address of a public DNS-based node list for the given</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cf63d5b622390512e53fe17e" role="button"
                   aria-expanded="false" aria-controls="id-cf63d5b622390512e53fe17e">
                    <code>params/config_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/params/config_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/config_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+20</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cf63d5b622390512e53fe17e"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config_test.go op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg1">index bf8ce2fc5e247242615ff478a455785f9f07f88b..b91befdf71fbe1da4a36d93167cd5d5cb1d8fdfb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config_test.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg36">@@ -137,3 +137,23 @@</span> 	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsShanghai {
 		t.Errorf(&quot;expected %v to be shanghai&quot;, stamp)
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestConfigRulesRegolith(t *testing.T) {</span>
<span class="term-fg32">+	c := &amp;ChainConfig{</span>
<span class="term-fg32">+		LondonBlock:  new(big.Int),</span>
<span class="term-fg32">+		RegolithTime: newUint64(500),</span>
<span class="term-fg32">+		Optimism:     &amp;OptimismConfig{},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var stamp uint64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to not be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = 500</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = math.MaxInt64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b64f0e69c39a23e4d425961b" role="button"
                   aria-expanded="false" aria-controls="id-b64f0e69c39a23e4d425961b">
                    <code>params/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/params/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+172</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b64f0e69c39a23e4d425961b"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;superchain_test.go op-geth&#47;params&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..abb72bbd351f4c0a99ea8b78deac222a816a9ccc</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,172 @@</span>
<span class="term-fg32">+package params</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type HumanProtocolVersion struct {</span>
<span class="term-fg32">+	VersionType         uint8</span>
<span class="term-fg32">+	Major, Minor, Patch uint32</span>
<span class="term-fg32">+	Prerelease          uint32</span>
<span class="term-fg32">+	Build               [8]byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type ComparisonCase struct {</span>
<span class="term-fg32">+	A, B HumanProtocolVersion</span>
<span class="term-fg32">+	Cmp  ProtocolVersionComparison</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestProtocolVersion_Compare(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []ComparisonCase{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 2, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 2, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 2, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 2, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 1, 2, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 1, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 1, 1, 2, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 2, 3, 4, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 3, 4, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: Matching,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 3, 2, 1, 5, [8]byte{3}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{1, 1, 2, 3, 3, [8]byte{6}},</span>
<span class="term-fg32">+			Cmp: DiffVersionType,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 3, 2, 1, 5, [8]byte{3}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 3, 3, [8]byte{6}},</span>
<span class="term-fg32">+			Cmp: DiffBuild,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 0, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 3, 3, 3, [8]byte{3}},</span>
<span class="term-fg32">+			Cmp: EmptyVersion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 1, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 1, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 1, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 0, 2, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 1, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 2, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 5, 0, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 0, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 0, 9, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 0, 1, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 0, 0, 9, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, ^uint32(0), 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 0, 1, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: InvalidVersion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, tc := range testCases {</span>
<span class="term-fg32">+		tc := tc &#47;&#47; not a parallel sub-test, but better than a flake</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;case_%d&quot;, i), func(t *testing.T) {</span>
<span class="term-fg32">+			a := ProtocolVersionV0{tc.A.Build, tc.A.Major, tc.A.Minor, tc.A.Patch, tc.A.Prerelease}.Encode()</span>
<span class="term-fg32">+			a[0] = tc.A.VersionType</span>
<span class="term-fg32">+			b := ProtocolVersionV0{tc.B.Build, tc.B.Major, tc.B.Minor, tc.B.Patch, tc.B.Prerelease}.Encode()</span>
<span class="term-fg32">+			b[0] = tc.B.VersionType</span>
<span class="term-fg32">+			cmp := a.Compare(b)</span>
<span class="term-fg32">+			if cmp != tc.Cmp {</span>
<span class="term-fg32">+				t.Fatalf(&quot;expected %d but got %d&quot;, tc.Cmp, cmp)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			switch tc.Cmp {</span>
<span class="term-fg32">+			case AheadMajor, AheadMinor, AheadPatch, AheadPrerelease:</span>
<span class="term-fg32">+				inv := b.Compare(a)</span>
<span class="term-fg32">+				if inv != -tc.Cmp {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected inverse when reversing the comparison, %d but got %d&quot;, -tc.Cmp, inv)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			case DiffVersionType, DiffBuild, EmptyVersion, Matching:</span>
<span class="term-fg32">+				inv := b.Compare(a)</span>
<span class="term-fg32">+				if inv != tc.Cmp {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected comparison reversed to hold the same, expected %d but got %d&quot;, tc.Cmp, inv)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestProtocolVersion_String(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []struct {</span>
<span class="term-fg32">+		version  ProtocolVersion</span>
<span class="term-fg32">+		expected string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 0, 0}.Encode(), &quot;v0.0.0&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 0, 1}.Encode(), &quot;v0.0.0-1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 1, 0}.Encode(), &quot;v0.0.1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 4, 3, 2, 1}.Encode(), &quot;v4.3.2-1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 100, 2, 0}.Encode(), &quot;v0.100.2&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;O&#39;, &#39;P&#39;, &#39;-&#39;, &#39;m&#39;, &#39;o&#39;, &#39;d&#39;}, 42, 0, 2, 1}.Encode(), &quot;v42.0.2-1+OP-mod&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;b&#39;, &#39;e&#39;, &#39;t&#39;, &#39;a&#39;, &#39;.&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;}, 1, 0, 0, 0}.Encode(), &quot;v1.0.0+beta.123&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;a&#39;, &#39;b&#39;, 1}, 42, 0, 2, 0}.Encode(), &quot;v42.0.2+0x6162010000000000&quot;}, &#47;&#47; do not render invalid alpha numeric</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{1, 2, 3, 4, 5, 6, 7, 8}, 42, 0, 2, 0}.Encode(), &quot;v42.0.2+0x0102030405060708&quot;},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tc := range testCases {</span>
<span class="term-fg32">+		t.Run(tc.expected, func(t *testing.T) {</span>
<span class="term-fg32">+			got := tc.version.String()</span>
<span class="term-fg32">+			if got != tc.expected {</span>
<span class="term-fg32">+				t.Fatalf(&quot;got %q but expected %q&quot;, got, tc.expected)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f880ac37530b316f2294fe1c" role="button"
                   aria-expanded="false" aria-controls="id-f880ac37530b316f2294fe1c">
                    <code>rpc/client_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/rpc/client_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/rpc/client_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f880ac37530b316f2294fe1c"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;client_test.go op-geth&#47;rpc&#47;client_test.go</span>
<span class="term-fg1">index ac02ad33cf6a7a4c389c72ec54e96bdb92bc5bf0..8870ed1cb687638d1f29a268ac75c5faae6190eb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;client_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;client_test.go</span>
<span class="term-fg36">@@ -585,7 +585,7 @@</span>
 	var (
 		srv     = NewServer()
 		httpsrv = httptest.NewServer(srv.WebsocketHandler(nil))
<span class="term-fg31">-		wsURL   = &quot;ws:&quot; + strings.TrimPrefix(httpsrv.URL, &quot;http:&quot;)</span>
<span class="term-fg32">+		wsURL   = &quot;ws:&quot; + strings.TrimPrefix(httpsrv.URL, &quot;http:&quot;) &#47;&#47;nolint:all</span>
 	)
 	defer srv.Stop()
 	defer httpsrv.Close()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-76dc186eecfe440b98e7f063" role="button"
                   aria-expanded="false" aria-controls="id-76dc186eecfe440b98e7f063">
                    <code>rpc/http.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/rpc/http.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/rpc/http.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-76dc186eecfe440b98e7f063"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;http.go op-geth&#47;rpc&#47;http.go</span>
<span class="term-fg1">index 741fa1c0eb4f63ed864dc406685d91b9707dbfe3..19e44a2e8cd2f433e9e939b953a97c18cf1e1806 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;http.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;http.go</span>
<span class="term-fg36">@@ -33,7 +33,7 @@</span> 	&quot;time&quot;
 )
&nbsp;
 const (
<span class="term-fg31">-	maxRequestContentLength = 1024 * 1024 * 5</span>
<span class="term-fg32">+	maxRequestContentLength = 1024 * 1024 * 32</span>
 	contentType             = &quot;application&#47;json&quot;
 )
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ca26eaed854a141b1fcc88df" role="button"
                   aria-expanded="false" aria-controls="id-ca26eaed854a141b1fcc88df">
                    <code>tests/state_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/tests/state_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/tests/state_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ca26eaed854a141b1fcc88df"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test.go op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg1">index 3a7e83ae3dd9b1fbb48c29058924e5af836f0a27..e1c7f229929b10d04969619db69029c9d38ce003 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg36">@@ -258,7 +258,7 @@</span> 			}
&nbsp;
 			&#47;&#47; Prepare the EVM.
 			txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 			context.GetHash = vmTestBlockHash
 			context.BaseFee = baseFee
 			evm := vm.NewEVM(context, txContext, statedb, config, vmconfig)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9f40b40aeeee211f218d679a" role="button"
                   aria-expanded="false" aria-controls="id-9f40b40aeeee211f218d679a">
                    <code>tests/state_test_util.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/tests/state_test_util.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/tests/state_test_util.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9f40b40aeeee211f218d679a"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test_util.go op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">index eb5738242ee1bba73c44e69ea2b62eac127a96eb..3f19d49d98ec94f954f1c55956a69b3faa80b299 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg36">@@ -275,7 +275,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Prepare the EVM.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 	context.GetHash = vmTestBlockHash
 	context.BaseFee = baseFee
 	context.Random = nil</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

                
                    <div class="text-muted">
                        <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a87b30b41a51d599f12df2a2"role="button" aria-expanded="false" aria-controls="id-a87b30b41a51d599f12df2a2">
        
            <div class="col-12 col-sm-9 text-start"><h4>Ignored changes</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+585</span></div>
                <div class="text-start"><span class="text-danger">-31</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a87b30b41a51d599f12df2a2">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e31812f39cb38cd9577800d0" role="button"
                   aria-expanded="false" aria-controls="id-e31812f39cb38cd9577800d0">
                    <code>.circleci/check-releases.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/.circleci/check-releases.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e31812f39cb38cd9577800d0"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;check-releases.sh op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..f3595e1320377bea4b17c13326d87342083071c0</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg36">@@ -0,0 +1,21 @@</span>
<span class="term-fg32">+#!&#47;bin&#47;bash</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+LATEST_RELEASE=$(curl -s --fail -L \</span>
<span class="term-fg32">+  -H &quot;Accept: application&#47;vnd.github+json&quot; \</span>
<span class="term-fg32">+  -H &quot;X-GitHub-Api-Version: 2022-11-28&quot; \</span>
<span class="term-fg32">+  https:&#47;&#47;api.github.com&#47;repos&#47;ethereum&#47;go-ethereum&#47;releases \</span>
<span class="term-fg32">+  | jq -r &#39;(.[] | select(.draft==false) | select(.prerelease==false)).tag_name&#39; | head -n 1)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Detected latest go-ethereum release as ${LATEST_RELEASE}&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+git remote add upstream https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+git fetch upstream &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+if git branch --contains &quot;${LATEST_RELEASE}&quot; 2&gt;&amp;1 | grep -e &#39;^[ *]*optimism$&#39; &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+then</span>
<span class="term-fg32">+  echo &quot;Up to date with latest release.  Great job! 🎉&quot;</span>
<span class="term-fg32">+else</span>
<span class="term-fg32">+  echo &quot;Release has not been merged&quot;</span>
<span class="term-fg32">+  exit 1</span>
<span class="term-fg32">+fi</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0b1a610c40b66628cc344b48" role="button"
                   aria-expanded="false" aria-controls="id-0b1a610c40b66628cc344b48">
                    <code>.circleci/ci-docker-tag-op-geth-release.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/.circleci/ci-docker-tag-op-geth-release.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+38</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0b1a610c40b66628cc344b48"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh op-geth&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..7b66e789a4d7e50699f2d22ff037117c0d7a3a35</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh</span>
<span class="term-fg36">@@ -0,0 +1,38 @@</span>
<span class="term-fg32">+#!&#47;usr&#47;bin&#47;env bash</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+DOCKER_REPO=$1</span>
<span class="term-fg32">+GIT_TAG=$2</span>
<span class="term-fg32">+GIT_SHA=$3</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+IMAGE_NAME=&quot;op-geth&quot;</span>
<span class="term-fg32">+IMAGE_TAG=$GIT_TAG</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+SOURCE_IMAGE_TAG=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:$GIT_SHA&quot;</span>
<span class="term-fg32">+TARGET_IMAGE_TAG=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:$IMAGE_TAG&quot;</span>
<span class="term-fg32">+TARGET_IMAGE_TAG_LATEST=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:latest&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Checking if docker images exist for &#39;$IMAGE_NAME&#39;&quot;</span>
<span class="term-fg32">+echo &quot;&quot;</span>
<span class="term-fg32">+tags=$(gcloud container images list-tags &quot;$DOCKER_REPO&#47;$IMAGE_NAME&quot; --limit 1 --format json)</span>
<span class="term-fg32">+if [ &quot;$tags&quot; = &quot;[]&quot; ]; then</span>
<span class="term-fg32">+  echo &quot;No existing docker images were found for &#39;$IMAGE_NAME&#39;. The code tagged with &#39;$GIT_TAG&#39; may not have an associated dockerfile or docker build job.&quot;</span>
<span class="term-fg32">+  echo &quot;If this service has a dockerfile, add a docker-publish job for it in the circleci config.&quot;</span>
<span class="term-fg32">+  echo &quot;&quot;</span>
<span class="term-fg32">+  echo &quot;Exiting&quot;</span>
<span class="term-fg32">+  exit 0</span>
<span class="term-fg32">+fi</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Tagging $SOURCE_IMAGE_TAG with &#39;$IMAGE_TAG&#39;&quot;</span>
<span class="term-fg32">+gcloud container images add-tag -q &quot;$SOURCE_IMAGE_TAG&quot; &quot;$TARGET_IMAGE_TAG&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# Do not tag with latest if the release is a release candidate.</span>
<span class="term-fg32">+if [[ &quot;$IMAGE_TAG&quot; == *&quot;rc&quot;* ]]; then</span>
<span class="term-fg32">+  echo &quot;Not tagging with &#39;latest&#39; because the release is a release candidate.&quot;</span>
<span class="term-fg32">+  exit 0</span>
<span class="term-fg32">+fi</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Tagging $SOURCE_IMAGE_TAG with &#39;latest&#39;&quot;</span>
<span class="term-fg32">+gcloud container images add-tag -q &quot;$SOURCE_IMAGE_TAG&quot; &quot;$TARGET_IMAGE_TAG_LATEST&quot;</span>
<span class="term-fg32">+</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fd08f70aa5153c98f7f11738" role="button"
                   aria-expanded="false" aria-controls="id-fd08f70aa5153c98f7f11738">
                    <code>.circleci/config.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/.circleci/config.yml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+230</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fd08f70aa5153c98f7f11738"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;config.yml op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..ad9793ad9873c294d4c128d575406fc0710ee20c</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg36">@@ -0,0 +1,230 @@</span>
<span class="term-fg32">+version: 2.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+orbs:</span>
<span class="term-fg32">+  gcp-cli: circleci&#47;gcp-cli@3.0.1</span>
<span class="term-fg32">+  slack: circleci&#47;slack@4.10.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+commands:</span>
<span class="term-fg32">+  gcp-oidc-authenticate:</span>
<span class="term-fg32">+    description: &quot;Authenticate with GCP using a CircleCI OIDC token.&quot;</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      project_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_PROJECT_ID</span>
<span class="term-fg32">+      workload_identity_pool_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_ID</span>
<span class="term-fg32">+      workload_identity_pool_provider_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_PROVIDER_ID</span>
<span class="term-fg32">+      service_account_email:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_SERVICE_ACCOUNT_EMAIL</span>
<span class="term-fg32">+      gcp_cred_config_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;gcp_cred_config.json</span>
<span class="term-fg32">+      oidc_token_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;oidc_token.json</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Create OIDC credential configuration&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Store OIDC token in temp file</span>
<span class="term-fg32">+            echo $CIRCLE_OIDC_TOKEN &gt; &lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+            # Create a credential configuration for the generated OIDC ID Token</span>
<span class="term-fg32">+            gcloud iam workload-identity-pools create-cred-config \</span>
<span class="term-fg32">+                &quot;projects&#47;${&lt;&lt; parameters.project_id &gt;&gt;}&#47;locations&#47;global&#47;workloadIdentityPools&#47;${&lt;&lt; parameters.workload_identity_pool_id &gt;&gt;}&#47;providers&#47;${&lt;&lt; parameters.workload_identity_pool_provider_id &gt;&gt;}&quot;\</span>
<span class="term-fg32">+                --output-file=&quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot; \</span>
<span class="term-fg32">+                --service-account=&quot;${&lt;&lt; parameters.service_account_email &gt;&gt;}&quot; \</span>
<span class="term-fg32">+                --credential-source-file=&lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Authenticate with GCP using OIDC&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Configure gcloud to leverage the generated credential configuration</span>
<span class="term-fg32">+            gcloud auth login --brief --cred-file &quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot;</span>
<span class="term-fg32">+            # Configure ADC</span>
<span class="term-fg32">+            echo &quot;export GOOGLE_APPLICATION_CREDENTIALS=&#39;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&#39;&quot; | tee -a &quot;$BASH_ENV&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  docker-release:</span>
<span class="term-fg32">+    environment:</span>
<span class="term-fg32">+      DOCKER_BUILDKIT: 1</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      docker_name:</span>
<span class="term-fg32">+        description: Docker image name</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;op-geth&quot;</span>
<span class="term-fg32">+      docker_tags:</span>
<span class="term-fg32">+        description: Docker image tags as csv</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+      registry:</span>
<span class="term-fg32">+        description: Docker registry</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;us-docker.pkg.dev&quot;</span>
<span class="term-fg32">+      repo:</span>
<span class="term-fg32">+        description: Docker repo</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;oplabs-tools-artifacts&#47;images&quot;</span>
<span class="term-fg32">+      push_tags:</span>
<span class="term-fg32">+        description: Push release push tags</span>
<span class="term-fg32">+        type: boolean</span>
<span class="term-fg32">+        default: false</span>
<span class="term-fg32">+    machine:</span>
<span class="term-fg32">+      image: default</span>
<span class="term-fg32">+      resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - gcp-cli&#47;install</span>
<span class="term-fg32">+      - gcp-oidc-authenticate</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Configure Docker</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            gcloud auth configure-docker &lt;&lt;parameters.registry&gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Build and push</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            RAW_TAGS=&quot;&lt;&lt;parameters.docker_tags&gt;&gt;&quot;</span>
<span class="term-fg32">+            if [ &quot;$CIRCLE_BRANCH&quot; = &quot;optimism&quot; ]; then</span>
<span class="term-fg32">+              RAW_TAGS=&quot;$RAW_TAGS,optimism&quot;</span>
<span class="term-fg32">+            fi</span>
<span class="term-fg32">+            IMAGE_BASE=&quot;&lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt;&#47;&lt;&lt;parameters.docker_name&gt;&gt;&quot;</span>
<span class="term-fg32">+            DOCKER_TAGS=$(echo -ne &quot;$RAW_TAGS&quot; | sed &quot;s&#47;,&#47;\n&#47;g&quot; | sed &quot;s&#47;[^a-zA-Z0-9\n.]&#47;-&#47;g&quot; | sed -e &quot;s|^|-t ${IMAGE_BASE}:|&quot;)</span>
<span class="term-fg32">+            docker context create buildx-build</span>
<span class="term-fg32">+            docker buildx create --use buildx-build</span>
<span class="term-fg32">+            docker buildx build --push \</span>
<span class="term-fg32">+              $(echo -ne $DOCKER_TAGS | tr &#39;\n&#39; &#39; &#39;) \</span>
<span class="term-fg32">+              --platform=linux&#47;arm64,linux&#47;amd64 \</span>
<span class="term-fg32">+              --build-arg VERSION=$CIRCLE_TAG \</span>
<span class="term-fg32">+              --build-arg COMMIT=$CIRCLE_SHA \</span>
<span class="term-fg32">+              --build-arg BUILDNUM=$CIRCLE_BUILD_NUM \</span>
<span class="term-fg32">+              --progress plain \</span>
<span class="term-fg32">+              -f Dockerfile .</span>
<span class="term-fg32">+      - when:</span>
<span class="term-fg32">+          condition:</span>
<span class="term-fg32">+            equal: [ true, &lt;&lt;parameters.push_tags&gt;&gt; ]</span>
<span class="term-fg32">+          steps:</span>
<span class="term-fg32">+            - run:</span>
<span class="term-fg32">+                name: Tag</span>
<span class="term-fg32">+                command: |</span>
<span class="term-fg32">+                  .&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh &lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt; $CIRCLE_TAG $CIRCLE_SHA1</span>
<span class="term-fg32">+      - when:</span>
<span class="term-fg32">+          condition:</span>
<span class="term-fg32">+            equal: [optimism, &lt;&lt; pipeline.git.branch &gt;&gt;]</span>
<span class="term-fg32">+          steps:</span>
<span class="term-fg32">+            - gcp-oidc-authenticate:</span>
<span class="term-fg32">+                service_account_email: GCP_SERVICE_ATTESTOR_ACCOUNT_EMAIL</span>
<span class="term-fg32">+            - run:</span>
<span class="term-fg32">+                name: Sign</span>
<span class="term-fg32">+                command: |</span>
<span class="term-fg32">+                  git clone --branch v1.0.3 --depth 1 https:&#47;&#47;github.com&#47;ethereum-optimism&#47;binary_signer</span>
<span class="term-fg32">+                  cd binary_signer&#47;signer</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+                  IMAGE_PATH=&quot;&lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt;&#47;&lt;&lt;parameters.docker_name&gt;&gt;:&lt;&lt;pipeline.git.revision&gt;&gt;&quot;</span>
<span class="term-fg32">+                  echo $IMAGE_PATH</span>
<span class="term-fg32">+                  pip3 install -r requirements.txt</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+                  python3 .&#47;sign_image.py --command=&quot;sign&quot;\</span>
<span class="term-fg32">+                      --attestor-project-name=&quot;$ATTESTOR_PROJECT_NAME&quot;\</span>
<span class="term-fg32">+                      --attestor-name=&quot;$ATTESTOR_NAME&quot;\</span>
<span class="term-fg32">+                      --image-path=&quot;$IMAGE_PATH&quot;\</span>
<span class="term-fg32">+                      --signer-logging-level=&quot;INFO&quot;\</span>
<span class="term-fg32">+                      --attestor-key-id=&quot;&#47;&#47;cloudkms.googleapis.com&#47;v1&#47;projects&#47;$ATTESTOR_PROJECT_NAME&#47;locations&#47;global&#47;keyRings&#47;$ATTESTOR_NAME-key-ring&#47;cryptoKeys&#47;$ATTESTOR_NAME-key&#47;cryptoKeyVersions&#47;1&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  build-geth:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.21</span>
<span class="term-fg32">+    resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go install</span>
<span class="term-fg32">+  unit-test:</span>
<span class="term-fg32">+    resource_class: xlarge</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.21</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go test</span>
<span class="term-fg32">+  lint-geth:</span>
<span class="term-fg32">+    resource_class: medium</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.21</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go lint</span>
<span class="term-fg32">+  tidy-geth:</span>
<span class="term-fg32">+    resource_class: small</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.21</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go mod tidy &amp;&amp; git diff --exit-code</span>
<span class="term-fg32">+  check-releases:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.21</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: .circleci&#47;check-releases.sh</span>
<span class="term-fg32">+      - slack&#47;notify:</span>
<span class="term-fg32">+          channel: C03N11M0BBN</span>
<span class="term-fg32">+          branch_pattern: optimism</span>
<span class="term-fg32">+          event: fail</span>
<span class="term-fg32">+          template: basic_fail_1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+workflows:</span>
<span class="term-fg32">+  main:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - build-geth:</span>
<span class="term-fg32">+          name: Build geth</span>
<span class="term-fg32">+      - unit-test:</span>
<span class="term-fg32">+          name: Run unit tests for geth</span>
<span class="term-fg32">+      - lint-geth:</span>
<span class="term-fg32">+          name: Run linter over geth</span>
<span class="term-fg32">+      - tidy-geth:</span>
<span class="term-fg32">+          name: Check geth go.mod file has been tidied</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr</span>
<span class="term-fg32">+  release:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - hold:</span>
<span class="term-fg32">+          type: approval</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker (release)</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;,&lt;&lt;pipeline.git.tag&gt;&gt;</span>
<span class="term-fg32">+          push_tags: true</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr-release</span>
<span class="term-fg32">+          requires:</span>
<span class="term-fg32">+            - hold</span>
<span class="term-fg32">+  scheduled:</span>
<span class="term-fg32">+    triggers:</span>
<span class="term-fg32">+      - schedule:</span>
<span class="term-fg32">+          # run daily</span>
<span class="term-fg32">+          cron: &quot;0 0 * * *&quot;</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              only: [ &quot;optimism&quot; ]</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - check-releases:</span>
<span class="term-fg32">+          name: Check for new upstream releases</span>
<span class="term-fg32">+          context: slack</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-63badd6cbceac686dde5ee9e" role="button"
                   aria-expanded="false" aria-controls="id-63badd6cbceac686dde5ee9e">
                    <code>.github/CODEOWNERS</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/.github/CODEOWNERS" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/.github/CODEOWNERS" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-22</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-63badd6cbceac686dde5ee9e"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;CODEOWNERS op-geth&#47;.github&#47;CODEOWNERS</span>
<span class="term-fg1">index faf922df01613ecabaee93c1153b91476573e914..a52ce4b85b205e9378cd398ffd103616baabda0a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;.github&#47;CODEOWNERS</span>
<span class="term-fg1">+++ op-geth&#47;.github&#47;CODEOWNERS</span>
<span class="term-fg36">@@ -1,22 +1 @@</span>
<span class="term-fg31">-# Lines starting with &#39;#&#39; are comments.</span>
<span class="term-fg31">-# Each line is a file pattern followed by one or more owners.</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-accounts&#47;usbwallet              @karalabe</span>
<span class="term-fg31">-accounts&#47;scwallet               @gballet</span>
<span class="term-fg31">-accounts&#47;abi                    @gballet @MariusVanDerWijden</span>
<span class="term-fg31">-cmd&#47;clef                        @holiman</span>
<span class="term-fg31">-consensus                       @karalabe</span>
<span class="term-fg31">-core&#47;                           @karalabe @holiman @rjl493456442</span>
<span class="term-fg31">-eth&#47;                            @karalabe @holiman @rjl493456442</span>
<span class="term-fg31">-eth&#47;catalyst&#47;                   @gballet</span>
<span class="term-fg31">-eth&#47;tracers&#47;                    @s1na</span>
<span class="term-fg31">-graphql&#47;                        @s1na</span>
<span class="term-fg31">-les&#47;                            @zsfelfoldi @rjl493456442</span>
<span class="term-fg31">-light&#47;                          @zsfelfoldi @rjl493456442</span>
<span class="term-fg31">-node&#47;                           @fjl</span>
<span class="term-fg31">-p2p&#47;                            @fjl @zsfelfoldi</span>
<span class="term-fg31">-rpc&#47;                            @fjl @holiman</span>
<span class="term-fg31">-p2p&#47;simulations                 @fjl</span>
<span class="term-fg31">-p2p&#47;protocols                   @fjl</span>
<span class="term-fg31">-p2p&#47;testing                     @fjl</span>
<span class="term-fg31">-signer&#47;                         @holiman</span>
<span class="term-fg32">+*  @ethereum-optimism&#47;op-geth-maintainers</span>
<span class="term-fg32">\ No newline at end of file</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ae31abbc6e361367cc0c6406" role="button"
                   aria-expanded="false" aria-controls="id-ae31abbc6e361367cc0c6406">
                    <code>fork.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/fork.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+265</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ae31abbc6e361367cc0c6406"><span class="term-fg1">diff --git go-ethereum&#47;fork.yaml op-geth&#47;fork.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0dfa9ab036cb50558d85fc450309c30996f0a7ec</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;fork.yaml</span>
<span class="term-fg36">@@ -0,0 +1,265 @@</span>
<span class="term-fg32">+title: &quot;op-geth - go-ethereum fork diff overview&quot;</span>
<span class="term-fg32">+footer: |</span>
<span class="term-fg32">+  Fork-diff overview of [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth), a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum).</span>
<span class="term-fg32">+  and execution-engine of the [OP-stack](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism).</span>
<span class="term-fg32">+base:</span>
<span class="term-fg32">+  name: go-ethereum</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+  hash: 8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e  # v1.13.11</span>
<span class="term-fg32">+fork:</span>
<span class="term-fg32">+  name: op-geth</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth</span>
<span class="term-fg32">+  ref: refs&#47;heads&#47;optimism</span>
<span class="term-fg32">+def:</span>
<span class="term-fg32">+  title: &quot;op-geth&quot;</span>
<span class="term-fg32">+  description: |</span>
<span class="term-fg32">+    This is an overview of the changes in [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth),</span>
<span class="term-fg32">+    a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum), part of the OP-stack.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    The OP-stack architecture is modular, following the Consensus&#47;Execution split of post-Merge Ethereum L1:</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - [`op-node`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;op-node) implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node. </span>
<span class="term-fg32">+      - [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth) implements the Execution-Layer, with **minimal changes** for a secure Ethereum-equivalent application environment.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    Related [op-stack specifications](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;specs):</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    - [L2 Execution Engine spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md)</span>
<span class="term-fg32">+    - [Deposit Transaction spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md)</span>
<span class="term-fg32">+  sub:</span>
<span class="term-fg32">+    - title: &quot;Core modifications&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;State-transition modifications&quot;</span>
<span class="term-fg32">+          description: &quot;&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Deposit Transaction type&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Bedrock upgrade introduces a `Deposit` transaction-type (`0x7E`) to enable both users and the</span>
<span class="term-fg32">+                rollup system itself to change the L2 state based on L1 events and system rules as</span>
<span class="term-fg32">+                [specified](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md).</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;deposit_tx.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_marshalling.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_signing.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Transaction properties&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The `Transaction` type now exposes the deposit-transaction and L1-cost properties required for the rollup.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_access_list.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_dynamic_fee.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_legacy.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_blob.go&quot;</span>
<span class="term-fg32">+            - title: &quot;L1 cost computation&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,</span>
<span class="term-fg32">+                estimated based on gas-price-oracle information and encoded tx size.&quot;</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;vm&#47;evm.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;evm.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;rollup_l1_cost.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_processor.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_prefetcher.go&quot;</span>
<span class="term-fg32">+            - title: Transaction processing</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Deposit transactions have special processing rules: gas is pre-paid on L1,</span>
<span class="term-fg32">+                and deposits with EVM-failure are included with rolled back changes (except mint).</span>
<span class="term-fg32">+                For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;state_transition.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Core Error definitions&quot;</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;error.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Gaslimit&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the</span>
<span class="term-fg32">+                gaslimit in increments of 1&#47;1024 of the previous gaslimit.</span>
<span class="term-fg32">+                The gaslimit is changed (and limited) through the `SystemConfig` contract.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;misc&#47;eip1559&#47;eip1559.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Consensus tweaks&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).</span>
<span class="term-fg32">+                The rollup starts post-merge, and thus sets the TTD to 0.</span>
<span class="term-fg32">+                The TTD is always &quot;reached&quot; starting at the bedrock block.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;beacon&#47;consensus.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Legacy OP-mainnet &#47; OP-goerli header-verification support&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Pre-Bedrock OP-mainnet and OP-Goerli had differently formatted block-headers, loosely compatible with the geth types (since it was based on Clique).</span>
<span class="term-fg32">+                However, due to differences like the extra-data length (97+ bytes), these legacy block-headers need special verification.</span>
<span class="term-fg32">+                The pre-merge &quot;consensus&quot; fallback is set to this custom but basic verifier, to accept these headers when syncing a pre-bedrock part of the chain,</span>
<span class="term-fg32">+                independent of any clique code or configuration (which may be removed from geth at a later point).</span>
<span class="term-fg32">+                All the custom verifier has to do is accept the headers, as the headers are already verified by block-hash through the reverse-header-sync.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;beacon&#47;oplegacy.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Engine API modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,</span>
<span class="term-fg32">+            to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.</span>
<span class="term-fg32">+            See [L2 execution engine specs](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md).</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;types.go&quot;</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;gen_blockparams.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;catalyst&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Block-building modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The block-building code (in the &quot;miner&quot; package because of Proof-Of-Work legacy of ethereum) implements the</span>
<span class="term-fg32">+            changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;miner&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Tx-pool tx cost updates&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Transaction queueing and inclusion needs to account for the L1 cost component.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;txpool&#47;*&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;txpool&#47;legacypool&#47;*&quot;</span>
<span class="term-fg32">+    - title: &quot;Chain Configuration&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;Chain config&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The rollup functionality is enabled with the `optimism` field in the chain config.</span>
<span class="term-fg32">+            The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.</span>
<span class="term-fg32">+            The parameters can be overriden for testing.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;params&#47;config.go&quot;</span>
<span class="term-fg32">+            - &quot;params&#47;protocol_params.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;genesis.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Chain config cleanup&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The optimism Goerli testnet used clique-config data to make geth internals accept blocks.</span>
<span class="term-fg32">+            Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;rawdb&#47;accessors_metadata.go&quot;</span>
<span class="term-fg32">+        - title: Genesis loading</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;gen_genesis.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Superchain config&quot;</span>
<span class="term-fg32">+          description: Testing of the superchain configuration</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;superchain.go&quot;</span>
<span class="term-fg32">+            - &quot;params&#47;superchain.go&quot;</span>
<span class="term-fg32">+    - title: &quot;Node modifications&quot;</span>
<span class="term-fg32">+      description: Changes to the node configuration and services.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;CLI&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Flags&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Flag changes:</span>
<span class="term-fg32">+                  - Transactions can be forwarded to an RPC for sequencing.</span>
<span class="term-fg32">+                  - Historical calls can be forwarded to a legacy node.</span>
<span class="term-fg32">+                  - The tx pool propagation can be enabled&#47;disabled.</span>
<span class="term-fg32">+                  - The Optimism bedrock fork activation can be changed for testing.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;utils&#47;flags.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;main.go&quot;</span>
<span class="term-fg32">+                - &quot;internal&#47;flags&#47;categories.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;config.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Versioning&quot;</span>
<span class="term-fg32">+              description: List the op-geth and upstream go-ethereum versions.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;misccmd.go&quot;</span>
<span class="term-fg32">+                - &quot;params&#47;version.go&quot;</span>
<span class="term-fg32">+                - &quot;build&#47;ci.go&quot;</span>
<span class="term-fg32">+        - title: Node config</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;ethconfig&#47;config.go&quot;</span>
<span class="term-fg32">+        - title: Tx gossip disable option</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;handler.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;handler_eth.go&quot;</span>
<span class="term-fg32">+        - title: Warn on missing hardfork data</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;blockchain.go&quot;</span>
<span class="term-fg32">+        - title: Optional Engine API extensions</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;catalyst&#47;superchain.go&quot;</span>
<span class="term-fg32">+        - title: Support legacy DBs when snap-syncing</span>
<span class="term-fg32">+          description: Snap-sync does not serve unprefixed code by default.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;blockchain_reader.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;protocols&#47;snap&#47;handler.go&quot;</span>
<span class="term-fg32">+        - title: Historical data for Snap-sync</span>
<span class="term-fg32">+          description: Snap-sync has access to trusted Deposit Transaction Nonce Data.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;downloader&#47;downloader.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;downloader&#47;receiptreference.go&quot;</span>
<span class="term-fg32">+        - title: Discv5 node discovery</span>
<span class="term-fg32">+          description: Fix discv5 option to allow discv5 to be an active source for node-discovery.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;p2p&#47;server.go&quot;</span>
<span class="term-fg32">+        - title: Generated TOML config update</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;ethconfig&#47;gen_config.go&quot;</span>
<span class="term-fg32">+    - title: &quot;User API enhancements&quot;</span>
<span class="term-fg32">+      description: &quot;Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;Receipts metadata&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost </span>
<span class="term-fg32">+            metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;receipt.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;gen_receipt_json.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;rawdb&#47;accessors_chain.go&quot;</span>
<span class="term-fg32">+        - title: &quot;API Backend&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Forward transactions to the sequencer if configured.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;api_backend.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;backend.go&quot;</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;backend.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Apply L1 cost in API responses&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;state_accessor.go&quot;</span>
<span class="term-fg32">+        - title: API frontend</span>
<span class="term-fg32">+          description: Format deposit and L1-cost data in transaction responses. Add `debug_chainConfig` API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;api.go&quot;</span>
<span class="term-fg32">+            - &quot;rpc&#47;errors.go&quot;</span>
<span class="term-fg32">+        - title: Tracer RPC daisy-chain</span>
<span class="term-fg32">+          description: Forward pre-bedrock tracing calls to legacy node.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Daisy Chain tests&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;transaction_args_test.go&quot;</span>
<span class="term-fg32">+            - &quot;ethclient&#47;ethclient_test.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api_test.go&quot;</span>
<span class="term-fg32">+        - title: Debug API</span>
<span class="term-fg32">+          description: Fix Debug API block marshaling to include deposits</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;api_debug.go&quot;</span>
<span class="term-fg32">+        - title: Eth gasprice suggestions</span>
<span class="term-fg32">+          description: gasprice suggestion adjustments to accommodate faster L2 blocks and lower fees.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;gasprice&#47;gasprice.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;gasprice&#47;optimism-gasprice.go&quot;</span>
<span class="term-fg32">+        - title: API testvector fix</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Upstream test of broken behavior; in Optimism, a zero signature is valid (pre-bedrock for deposit-txs),</span>
<span class="term-fg32">+            and the chain ID formula on signature data must not be used, or an underflow happens.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json&quot;</span>
<span class="term-fg32">+    - title: &quot;Geth extras&quot;</span>
<span class="term-fg32">+      description: Extend the tools available in geth to improve external testing and tooling.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: Simulated Backend</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go&quot;</span>
<span class="term-fg32">+            - &quot;ethclient&#47;simulated&#47;backend.go&quot;</span>
<span class="term-fg32">+    - title: &quot;Hardware wallet support&quot;</span>
<span class="term-fg32">+      description: Extend Ledger wallet support for newer devices on Macos</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: Fix Ledger discoverability</span>
<span class="term-fg32">+          # upstream PR: https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum&#47;pull&#47;28863&#47;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;accounts&#47;usbwallet&#47;hub.go&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# ignored globally, does not count towards line count</span>
<span class="term-fg32">+ignore:</span>
<span class="term-fg32">+  - &quot;.circleci&#47;*&quot;</span>
<span class="term-fg32">+  - &quot;*.sum&quot;</span>
<span class="term-fg32">+  - &quot;go.mod&quot;</span>
<span class="term-fg32">+  - &quot;fork.yaml&quot;</span>
<span class="term-fg32">+  - &quot;.github&#47;*&quot;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-936c448a9a09ecab2d527e65" role="button"
                   aria-expanded="false" aria-controls="id-936c448a9a09ecab2d527e65">
                    <code>go.mod</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/go.mod" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/go.mod" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-936c448a9a09ecab2d527e65"><span class="term-fg1">diff --git go-ethereum&#47;go.mod op-geth&#47;go.mod</span>
<span class="term-fg1">index 79bdc2551abe5b9c5f0a9a88857214e3d1a64591..65dc72470d2479513144690dc4d40493c14a037b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.mod</span>
<span class="term-fg1">+++ op-geth&#47;go.mod</span>
<span class="term-fg36">@@ -1,6 +1,8 @@</span>
 module github.com&#47;ethereum&#47;go-ethereum
&nbsp;
<span class="term-fg31">-go 1.20</span>
<span class="term-fg32">+go 1.21</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+toolchain go1.21.6</span>
&nbsp;
 require (
 	github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;storage&#47;azblob v1.2.0
<span class="term-fg36">@@ -20,6 +22,7 @@</span> 	github.com&#47;crate-crypto&#47;go-kzg-4844 v0.7.0
 	github.com&#47;davecgh&#47;go-spew v1.1.1
 	github.com&#47;deckarep&#47;golang-set&#47;v2 v2.1.0
 	github.com&#47;dop251&#47;goja v0.0.0-20230806174421-c933cf95e127
<span class="term-fg32">+	github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20240318114348-52d3dbd1605d</span>
 	github.com&#47;ethereum&#47;c-kzg-4844 v0.4.0
 	github.com&#47;fatih&#47;color v1.13.0
 	github.com&#47;fjl&#47;gencodec v0.0.0-20230517082657-f9840df7b83e
<span class="term-fg36">@@ -62,7 +65,7 @@</span> 	github.com&#47;syndtr&#47;goleveldb v1.0.1-0.20210819022825-2ae1ddf74ef7
 	github.com&#47;tyler-smith&#47;go-bip39 v1.1.0
 	github.com&#47;urfave&#47;cli&#47;v2 v2.25.7
 	go.uber.org&#47;automaxprocs v1.5.2
<span class="term-fg31">-	golang.org&#47;x&#47;crypto v0.17.0</span>
<span class="term-fg32">+	golang.org&#47;x&#47;crypto v0.18.0</span>
 	golang.org&#47;x&#47;exp v0.0.0-20231110203233-9a3e6036ecaa
 	golang.org&#47;x&#47;sync v0.5.0
 	golang.org&#47;x&#47;sys v0.16.0
<span class="term-fg36">@@ -130,8 +133,9 @@</span> 	github.com&#47;prometheus&#47;client_model v0.2.1-0.20210607210712-147c58e9608a &#47;&#47; indirect
 	github.com&#47;prometheus&#47;common v0.32.1 &#47;&#47; indirect
 	github.com&#47;prometheus&#47;procfs v0.7.3 &#47;&#47; indirect
 	github.com&#47;rivo&#47;uniseg v0.2.0 &#47;&#47; indirect
<span class="term-fg31">-	github.com&#47;rogpeppe&#47;go-internal v1.9.0 &#47;&#47; indirect</span>
<span class="term-fg32">+	github.com&#47;rogpeppe&#47;go-internal v1.10.0 &#47;&#47; indirect</span>
 	github.com&#47;russross&#47;blackfriday&#47;v2 v2.1.0 &#47;&#47; indirect
<span class="term-fg32">+	github.com&#47;stretchr&#47;objx v0.5.0 &#47;&#47; indirect</span>
 	github.com&#47;tklauser&#47;go-sysconf v0.3.12 &#47;&#47; indirect
 	github.com&#47;tklauser&#47;numcpus v0.6.1 &#47;&#47; indirect
 	github.com&#47;xrash&#47;smetrics v0.0.0-20201216005158-039620a65673 &#47;&#47; indirect
<span class="term-fg36">@@ -141,3 +145,5 @@</span> 	google.golang.org&#47;protobuf v1.27.1 &#47;&#47; indirect
 	gopkg.in&#47;yaml.v2 v2.4.0 &#47;&#47; indirect
 	rsc.io&#47;tmplfunc v0.0.3 &#47;&#47; indirect
 )
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47;replace github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain =&gt; ..&#47;superchain-registry&#47;superchain</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-04976c7ba546563e3cf68e85" role="button"
                   aria-expanded="false" aria-controls="id-04976c7ba546563e3cf68e85">
                    <code>go.sum</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/8f7eb9ccd99ee47721a7bfde494d6da28de4cd8e/go.sum" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/5ccd3a32f383daa51c5e8881f4ac0873d0ede559/go.sum" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-04976c7ba546563e3cf68e85"><span class="term-fg1">diff --git go-ethereum&#47;go.sum op-geth&#47;go.sum</span>
<span class="term-fg1">index b692629b6b6a1ded3198b14f3bd2f7a1f0eac5e4..3e1dce2cee4b6826bee30225d77833f4902fd0c2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.sum</span>
<span class="term-fg1">+++ op-geth&#47;go.sum</span>
<span class="term-fg36">@@ -35,14 +35,18 @@</span> github.com&#47;AndreasBriese&#47;bbloom v0.0.0-20190306092124-e2d15f34fcf9&#47;go.mod h1:bOvUY6CB00SOBii9&#47;FifXqc0awNKxLFCL&#47;+pkDPuyl8=
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;azcore v1.7.0 h1:8q4SaHjFsClSvuVne0ID&#47;5Ka8u3fcIHyqkLjcFpNRHQ=
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;azcore v1.7.0&#47;go.mod h1:bjGvMhVMb+EEm3VRNQawDMUyMMjo+S5ewNjflkep&#47;0Q=
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;azidentity v1.3.0 h1:vcYCAze6p19qBW7MhZybIsqD8sMV8js0NyQM8JDnVtg=
<span class="term-fg32">+github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;azidentity v1.3.0&#47;go.mod h1:OQeznEEkTZ9OrhHJoDD8ZDq51FHgXjqtP9z6bEwBq9U=</span>
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;internal v1.3.0 h1:sXr+ck84g&#47;ZlZUOZiNELInmMgOsuGwdjjVkEIde0OtY=
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;internal v1.3.0&#47;go.mod h1:okt5dMMTOFjX&#47;aovMlrjvvXoPMBVSPzk9185BT0+eZM=
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;resourcemanager&#47;storage&#47;armstorage v1.2.0 h1:Ma67P&#47;GGprNwsslzEH6+Kb8nybI8jpDTm4Wmzu2ReK8=
<span class="term-fg32">+github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;resourcemanager&#47;storage&#47;armstorage v1.2.0&#47;go.mod h1:c+Lifp3EDEamAkPVzMooRNOK6CZjNSdEnf1A7jsI9u4=</span>
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;storage&#47;azblob v1.2.0 h1:gggzg0SUMs6SQbEw+3LoSsYf9YMjkupeAnHMX8O9mmY=
 github.com&#47;Azure&#47;azure-sdk-for-go&#47;sdk&#47;storage&#47;azblob v1.2.0&#47;go.mod h1:+6KLcKIVgxoBDMqMO&#47;Nvy7bZ9a0nbU3I1DtFQK3YvB4=
 github.com&#47;AzureAD&#47;microsoft-authentication-library-for-go v1.0.0 h1:OBhqkivkhkMqLPymWEppkm7vgPQY2XsHoEkaMQ0AdZY=
<span class="term-fg32">+github.com&#47;AzureAD&#47;microsoft-authentication-library-for-go v1.0.0&#47;go.mod h1:kgDmCTgBzIEPFElEF+FK0SdjAor06dRq2Go927dnQ6o=</span>
 github.com&#47;BurntSushi&#47;toml v0.3.1&#47;go.mod h1:xHWCNGjB5oqiDr8zfno3MHue2Ht5sIBksp03qcyfWMU=
 github.com&#47;BurntSushi&#47;toml v1.3.2 h1:o7IhLm0Msx3BaB+n3Ag7L8EVlByGnpq14C4YWiu&#47;gL8=
<span class="term-fg32">+github.com&#47;BurntSushi&#47;toml v1.3.2&#47;go.mod h1:CxXYINrC8qIiEnFrOxCa7Jy5BFHlXnUU2pbicEuybxQ=</span>
 github.com&#47;BurntSushi&#47;xgb v0.0.0-20160522181843-27f122750802&#47;go.mod h1:IVnqGOEym&#47;WlBOVXweHU+Q+&#47;VP0lqqI8lqeDx9IjBqo=
 github.com&#47;CloudyKit&#47;fastprinter v0.0.0-20170127035650-74b38d55f37a&#47;go.mod h1:EFZQ978U7x8IRnstaskI3IysnWY5Ao3QgZUKOXlsAdw=
 github.com&#47;CloudyKit&#47;jet v2.1.3-0.20180809161101-62edd43e4f88+incompatible&#47;go.mod h1:HPYO+50pSWkPoj9Q&#47;eq0aRGByCL6ScRlUmiEX5Zgm+w=
<span class="term-fg36">@@ -102,6 +106,7 @@</span> github.com&#47;bits-and-blooms&#47;bitset v1.10.0&#47;go.mod h1:7hO7Gc7Pp1vODcmWvKMRA9BNmbv6a&#47;7QIWpPxHddWR8=
 github.com&#47;btcsuite&#47;btcd&#47;btcec&#47;v2 v2.2.0 h1:fzn1qaOt32TuLjFlkzYSsBC35Q3KUjT1SwPxiMSCF5k=
 github.com&#47;btcsuite&#47;btcd&#47;btcec&#47;v2 v2.2.0&#47;go.mod h1:U7MHm051Al6XmscBQ0BoNydpOTsFAn707034b5nY8zU=
 github.com&#47;btcsuite&#47;btcd&#47;chaincfg&#47;chainhash v1.0.1 h1:q0rUy8C&#47;TYNBQS1+CGKw68tLOFYSNEs0TFnxxnS9+4U=
<span class="term-fg32">+github.com&#47;btcsuite&#47;btcd&#47;chaincfg&#47;chainhash v1.0.1&#47;go.mod h1:7SFka0XMvUgj3hfZtydOrQY2mwhPclbT2snogU7SQQc=</span>
 github.com&#47;census-instrumentation&#47;opencensus-proto v0.2.1&#47;go.mod h1:f6KPmirojxKA12rnyqOA5BBL4O983OfeGPqjHWSTneU=
 github.com&#47;cespare&#47;cp v0.1.0 h1:SE+dxFebS7Iik5LK0tsi1k9ZCxEaFX4AjQmoyA+1dJk=
 github.com&#47;cespare&#47;cp v0.1.0&#47;go.mod h1:SOGHArjBr4JWaSDEVpWpo&#47;hNg6RoKrls6Oh40hiwW+s=
<span class="term-fg36">@@ -121,6 +126,7 @@</span> github.com&#47;cloudflare&#47;cloudflare-go v0.79.0&#47;go.mod h1:gkHQf9xEubaQPEuerBuoinR9P8bf8a05Lq0X6WKy1Oc=
 github.com&#47;cncf&#47;udpa&#47;go v0.0.0-20191209042840-269d4d468f6f&#47;go.mod h1:M8M6+tZqaGXZJjfX53e64911xZQV5JYwmTeXPW+k8Sc=
 github.com&#47;cockroachdb&#47;datadriven v1.0.0&#47;go.mod h1:5Ib8Meh+jk1RlHIXej6Pzevx&#47;NLlNvQB9pmSBZErGA4=
 github.com&#47;cockroachdb&#47;datadriven v1.0.3-0.20230413201302-be42291fc80f h1:otljaYPt5hWxV3MUfO5dFPFiOXg9CyG5&#47;kCfayTqsJ4=
<span class="term-fg32">+github.com&#47;cockroachdb&#47;datadriven v1.0.3-0.20230413201302-be42291fc80f&#47;go.mod h1:a9RdTaap04u637JoCzcUoIcDmvwSUtcUFtT&#47;C3kJlTU=</span>
 github.com&#47;cockroachdb&#47;errors v1.6.1&#47;go.mod h1:tm6FTP5G81vwJ5lC0SizQo374JNCOPrHyXGitRJoDqM=
 github.com&#47;cockroachdb&#47;errors v1.8.1 h1:A5+txlVZfOqFBDa4mGz2bUWSp0aHElvHX2bKkdbQu+Y=
 github.com&#47;cockroachdb&#47;errors v1.8.1&#47;go.mod h1:qGwQn6JmZ+oMjuLwjWzUNqblqk0xl4CVV3SQbGwK7Ac=
<span class="term-fg36">@@ -169,6 +175,7 @@</span> github.com&#47;dlclark&#47;regexp2 v1.4.1-0.20201116162257-a2a8dda75c91&#47;go.mod h1:2pZnwuY&#47;m+8K6iRw6wQdMtk+rH5tNGR1i55kozfMjCc=
 github.com&#47;dlclark&#47;regexp2 v1.7.0 h1:7lJfhqlPssTb1WQx4yvTHN0uElPEv52sbaECrAQxjAo=
 github.com&#47;dlclark&#47;regexp2 v1.7.0&#47;go.mod h1:DHkYz0B9wPfa6wondMfaivmHpzrQ3v9q8cnmRbL6yW8=
 github.com&#47;dnaeon&#47;go-vcr v1.2.0 h1:zHCHvJYTMh1N7xnV7zf1m1GPBF9Ad0Jk&#47;whtQ1663qI=
<span class="term-fg32">+github.com&#47;dnaeon&#47;go-vcr v1.2.0&#47;go.mod h1:R4UdLID7HZT3taECzJs4YgbbH6PIGXB6W&#47;sc5OLb6RQ=</span>
 github.com&#47;dop251&#47;goja v0.0.0-20211022113120-dc8c55024d06&#47;go.mod h1:R9ET47fwRVRPZnOGvHxxhuZcbrMCuiqOz3Rlrh4KSnk=
 github.com&#47;dop251&#47;goja v0.0.0-20230806174421-c933cf95e127 h1:qwcF+vdFrvPSEUDSX5RVoRccG8a5DhOdWdQ4zN62zzo=
 github.com&#47;dop251&#47;goja v0.0.0-20230806174421-c933cf95e127&#47;go.mod h1:QMWlm50DNe14hD7t24KEqZuUdC9sOTy8W6XbCU1mlw4=
<span class="term-fg36">@@ -181,6 +188,8 @@</span> github.com&#47;envoyproxy&#47;go-control-plane v0.9.1-0.20191026205805-5f8ba28d4473&#47;go.mod h1:YTl&#47;9mNaCwkRvm6d1a2C3ymFceY&#47;DCBVvsKhRF0iEA4=
 github.com&#47;envoyproxy&#47;go-control-plane v0.9.4&#47;go.mod h1:6rpuAdCZL397s3pYoYcLgu1mIlRU8Am5FuJP05cCM98=
 github.com&#47;envoyproxy&#47;protoc-gen-validate v0.1.0&#47;go.mod h1:iSmxcyjqTsJpI2R4NaDN7+kN2VEUnK&#47;pcBlmesArF7c=
 github.com&#47;etcd-io&#47;bbolt v1.3.3&#47;go.mod h1:ZF2nL25h33cCyBtcyWeZ2&#47;I3HQOfTP+0PIEvHjkjCrw=
<span class="term-fg32">+github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20240318114348-52d3dbd1605d h1:K7HdD&#47;ZAcSFhcqqnUAbvU+8vsg0DzL8pvetHw5vRLCc=</span>
<span class="term-fg32">+github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20240318114348-52d3dbd1605d&#47;go.mod h1:7xh2awFQqsiZxFrHKTgEd+InVfDRrkKVUIuK8SAFHp0=</span>
 github.com&#47;ethereum&#47;c-kzg-4844 v0.4.0 h1:3MS1s4JtA868KpJxroZoepdV0ZKBp3u&#47;O5HcZ7R3nlY=
 github.com&#47;ethereum&#47;c-kzg-4844 v0.4.0&#47;go.mod h1:VewdlzQmpT5QSrVhbBuGoCdFJkpaJlO1aQputP83wc0=
 github.com&#47;fasthttp-contrib&#47;websocket v0.0.0-20160511215533-1f3b11f56072&#47;go.mod h1:duJ4Jxv5lDcvg4QuQr0oowTf7dz4&#47;CR8NtyCooz9HL8=
<span class="term-fg36">@@ -221,7 +230,6 @@</span> github.com&#47;go-logfmt&#47;logfmt v0.3.0&#47;go.mod h1:Qt1PoO58o5twSAckw1HlFXLmHsOX5&#47;0LbT9GBnD5lWE=
 github.com&#47;go-logfmt&#47;logfmt v0.4.0&#47;go.mod h1:3RMwSq7FuexP4Kalkev3ejPJsZTpXXBr9+V4qmtdjCk=
 github.com&#47;go-logfmt&#47;logfmt v0.5.0&#47;go.mod h1:wCYkCAKZfumFQihp8CzCvQ3paCTfi41vtzG1KdI&#47;P7A=
 github.com&#47;go-martini&#47;martini v0.0.0-20170121215854-22fa46961aab&#47;go.mod h1:&#47;P9AEU963A2AYjv4d1V5eVL1CQbEJq6aCNHDDjibzu8=
<span class="term-fg31">-github.com&#47;go-ole&#47;go-ole v1.2.5 h1:t4MGB5xEDZvXI+0rMjjsfBsD7yAgp&#47;s9ZDkL1JndXwY=</span>
 github.com&#47;go-ole&#47;go-ole v1.2.5&#47;go.mod h1:pprOEPIfldk&#47;42T2oK7lQ4v4JSDwmV0As9GaiUsvbm0=
 github.com&#47;go-ole&#47;go-ole v1.3.0 h1:Dt6ye7+vXGIKZ7Xtk4s6&#47;xVdGDQynvom7xCFEdWr6uE=
 github.com&#47;go-ole&#47;go-ole v1.3.0&#47;go.mod h1:5LS6F96DhAwUc7C+1HLexzMXY1xGRSryjyPPKW6zv78=
<span class="term-fg36">@@ -331,6 +339,7 @@</span> github.com&#47;hashicorp&#47;go-cleanhttp v0.5.2 h1:035FKYIWjmULyFRBKPs8TBQoi0x6d9G4xc9neXJWAZQ=
 github.com&#47;hashicorp&#47;go-cleanhttp v0.5.2&#47;go.mod h1:kO&#47;YDlP8L1346E6Sodw+PrpBSV4&#47;SoxCXGY6BqNFT48=
 github.com&#47;hashicorp&#47;go-hclog v0.9.2&#47;go.mod h1:5CU+agLiy3J7N7QjHK5d05KxGsuXiQLrjA0H7acj2lQ=
 github.com&#47;hashicorp&#47;go-hclog v1.2.0 h1:La19f8d7WIlm4ogzNHB0JGqs5AUDAZ2UfCY4sJXcJdM=
<span class="term-fg32">+github.com&#47;hashicorp&#47;go-hclog v1.2.0&#47;go.mod h1:whpDNt7SSdeAju8AWKIWsul05p54N&#47;39EeqMAyrmvFQ=</span>
 github.com&#47;hashicorp&#47;go-retryablehttp v0.7.4 h1:ZQgVdpTdAL7WpMIwLzCfbalOcSUdkDZnpUv3&#47;+BxzFA=
 github.com&#47;hashicorp&#47;go-retryablehttp v0.7.4&#47;go.mod h1:Jy&#47;gPYAdjqffZ&#47;yFGCFV2doI5wjtH1ewM9u8iYVjtX8=
 github.com&#47;hashicorp&#47;go-version v1.2.0&#47;go.mod h1:fltr4n8CU8Ke44wwGCBoEymUuxUHl09ZGVZPK5anwXA=
<span class="term-fg36">@@ -418,6 +427,7 @@</span> github.com&#47;labstack&#47;echo&#47;v4 v4.1.11&#47;go.mod h1:i541M3Fj6f76NZtHSj7TXnyM8n2gaodfvfxNnFqi74g=
 github.com&#47;labstack&#47;echo&#47;v4 v4.2.1&#47;go.mod h1:AA49e0DZ8kk5jTOOCKNuPR6oTnBS0dYiM4FW1e6jwpg=
 github.com&#47;labstack&#47;gommon v0.3.0&#47;go.mod h1:MULnywXg0yavhxWKc+lOruYdAhDwPK9wf0OL7NoOu+k=
 github.com&#47;leanovate&#47;gopter v0.2.9 h1:fQjYxZaynp97ozCzfOyOuAGOU4aU&#47;z37zf&#47;tOujFk7c=
<span class="term-fg32">+github.com&#47;leanovate&#47;gopter v0.2.9&#47;go.mod h1:U2L&#47;78B+KVFIx2VmW6onHJQzXtFb+p5y3y2Sh+Jxxv8=</span>
 github.com&#47;magiconair&#47;properties v1.8.0&#47;go.mod h1:PppfXfuXeibc&#47;6YijjN8zIbojt8czPbwD3XqdrwzmxQ=
 github.com&#47;mailru&#47;easyjson v0.0.0-20190614124828-94de47d64c63&#47;go.mod h1:C1wdFJiN94OJF2b5HbByQZoLdCWB1Yqtg26g4irojpc=
 github.com&#47;mailru&#47;easyjson v0.0.0-20190626092158-b2ccc519800e&#47;go.mod h1:C1wdFJiN94OJF2b5HbByQZoLdCWB1Yqtg26g4irojpc=
<span class="term-fg36">@@ -491,6 +501,7 @@</span> github.com&#47;peterh&#47;liner v1.1.1-0.20190123174540-a2c9a5303de7&#47;go.mod h1:CRroGNssyjTd&#47;qIG2FyxByd2S8JEAZXBl4qUrZf8GS0=
 github.com&#47;pingcap&#47;errors v0.11.4 h1:lFuQV&#47;oaUMGcD2tqt+01ROSmJs75VG1ToEOkZIZ4nE4=
 github.com&#47;pingcap&#47;errors v0.11.4&#47;go.mod h1:Oi8TUi2kEtXXLMJk9l1cGmz20kV3TaQ0usTwv5KuLY8=
 github.com&#47;pkg&#47;browser v0.0.0-20210911075715-681adbf594b8 h1:KoWmjvw+nsYOo29YJK9vDA65RGE3NrOnUtO7a+RF9HU=
<span class="term-fg32">+github.com&#47;pkg&#47;browser v0.0.0-20210911075715-681adbf594b8&#47;go.mod h1:HKlIX3XHQyzLZPlr7++PzdhaXEj94dEiJgZDTsxEqUI=</span>
 github.com&#47;pkg&#47;diff v0.0.0-20210226163009-20ebb0f2a09e&#47;go.mod h1:pJLUxLENpZxwdsKMEsNbx1VGcRFpLqf3715MtcvvzbA=
 github.com&#47;pkg&#47;errors v0.8.0&#47;go.mod h1:bwawxfHBFNV+L2hUp1rHADufV3IMtnDRdf1r5NINEl0=
 github.com&#47;pkg&#47;errors v0.8.1&#47;go.mod h1:bwawxfHBFNV+L2hUp1rHADufV3IMtnDRdf1r5NINEl0=
<span class="term-fg36">@@ -499,6 +510,7 @@</span> github.com&#47;pkg&#47;errors v0.9.1&#47;go.mod h1:bwawxfHBFNV+L2hUp1rHADufV3IMtnDRdf1r5NINEl0=
 github.com&#47;pmezard&#47;go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk&#47;f1lZbAQM=
 github.com&#47;pmezard&#47;go-difflib v1.0.0&#47;go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ&#47;4=
 github.com&#47;prashantv&#47;gostub v1.1.0 h1:BTyx3RfQjRHnUWaGF9oQos79AlQ5k8WNktv7VGvVH4g=
<span class="term-fg32">+github.com&#47;prashantv&#47;gostub v1.1.0&#47;go.mod h1:A5zLQHz7ieHGG7is6LLXLz7I8+3LZzsrV0P1IAHhP5U=</span>
 github.com&#47;prometheus&#47;client_golang v0.9.1&#47;go.mod h1:7SWBe2y4D6OKWSNQJUaRYU&#47;AaXPKyh&#47;dDVn+NZz0KFw=
 github.com&#47;prometheus&#47;client_golang v1.0.0&#47;go.mod h1:db9x61etRT2tGnBNRi70OPL5FsnadC4Ky3P0J6CfImo=
 github.com&#47;prometheus&#47;client_golang v1.7.1&#47;go.mod h1:PY5Wy2awLA44sXw4AOSfFBetzPP4j5+D6mVACh+pe2M=
<span class="term-fg36">@@ -528,8 +540,9 @@</span> github.com&#47;rivo&#47;uniseg v0.2.0 h1:S1pD9weZBuJdFmowNwbpi7BJ8TNftyUImj&#47;0WQi72jY=
 github.com&#47;rivo&#47;uniseg v0.2.0&#47;go.mod h1:J6wj4VEh+S6ZtnVlnTBMWIodfgj8LQOQFoIToxlJtxc=
 github.com&#47;rogpeppe&#47;go-internal v1.3.0&#47;go.mod h1:M8bDsm7K2OlrFYOpmOWEs&#47;qY81heoFRclV5y23lUDJ4=
 github.com&#47;rogpeppe&#47;go-internal v1.6.1&#47;go.mod h1:xXDCJY+GAPziupqXw64V24skbSoqbTEfhy4qGm1nDQc=
<span class="term-fg31">-github.com&#47;rogpeppe&#47;go-internal v1.9.0 h1:73kH8U+JUqXU8lRuOHeVHaa&#47;SZPifC7BkcraZVejAe8=</span>
 github.com&#47;rogpeppe&#47;go-internal v1.9.0&#47;go.mod h1:WtVeX8xhTBvf0smdhujwtBcq4Qrzq&#47;fJaraNFVN+nFs=
<span class="term-fg32">+github.com&#47;rogpeppe&#47;go-internal v1.10.0 h1:TMyTOH3F&#47;DB16zRVcYyreMH6GnZZrwQVAoYjRBZyWFQ=</span>
<span class="term-fg32">+github.com&#47;rogpeppe&#47;go-internal v1.10.0&#47;go.mod h1:UQnix2H7Ngw&#47;k4C5ijL5+65zddjncjaFoBhdsK&#47;akog=</span>
 github.com&#47;rs&#47;cors v1.7.0 h1:+88SsELBHx5r+hZ8TCkggzSstaWNbDvThkVK8H6f9ik=
 github.com&#47;rs&#47;cors v1.7.0&#47;go.mod h1:gFx+x8UowdsKA9AchylcLynDq+nNFfI8FkUZdN&#47;jGCU=
 github.com&#47;russross&#47;blackfriday v1.5.2&#47;go.mod h1:JO&#47;DiYxRf+HjHt06OyowR9PTA263kcR&#47;rfWxYHBV53g=
<span class="term-fg36">@@ -556,11 +569,16 @@</span> github.com&#47;status-im&#47;keycard-go v0.2.0 h1:QDLFswOQu1r5jsycloeQh3bVU8n&#47;NatHHaZobtDnDzA=
 github.com&#47;status-im&#47;keycard-go v0.2.0&#47;go.mod h1:wlp8ZLbsmrF6g6WjugPAx+IzoLrkdf9+mHxBEeo3Hbg=
 github.com&#47;stretchr&#47;objx v0.1.0&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
 github.com&#47;stretchr&#47;objx v0.1.1&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.4.0&#47;go.mod h1:YvHI0jy2hoMjB+UWwv71VJQ9isScKT&#47;TqJzVSSt89Yw=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.5.0 h1:1zr&#47;of2m5FGMsad5YfcqgdqdWrIhu+EBEJRhR1U7z&#47;c=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.5.0&#47;go.mod h1:Yh+to48EsGEfYuaHDzXPcE3xhTkx73EhmCGUpEOglKo=</span>
 github.com&#47;stretchr&#47;testify v1.2.2&#47;go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=
 github.com&#47;stretchr&#47;testify v1.3.0&#47;go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
 github.com&#47;stretchr&#47;testify v1.4.0&#47;go.mod h1:j7eGeouHqKxXV5pUuKE4zz7dFj8WfuZ+81PSLYec5m4=
 github.com&#47;stretchr&#47;testify v1.5.1&#47;go.mod h1:5W2xD1RspED5o8YsWQXVCued0rvSQ+mT+I5cxcmMvtA=
 github.com&#47;stretchr&#47;testify v1.7.0&#47;go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962&#47;h&#47;Wwjteg=
<span class="term-fg32">+github.com&#47;stretchr&#47;testify v1.7.1&#47;go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962&#47;h&#47;Wwjteg=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;testify v1.8.0&#47;go.mod h1:yNjHg4UonilssWZ8iaSj1OCr&#47;vHnekPRkoO+kdMU+MU=</span>
 github.com&#47;stretchr&#47;testify v1.8.4 h1:CcVxjf3Q8PM0mHUKJCdn+eZZtm5yQwehR5yeSVQQcUk=
 github.com&#47;stretchr&#47;testify v1.8.4&#47;go.mod h1:sz&#47;lmYIOXD&#47;1dqDmKjjqLyZ2RngseejIcXlSw2iwfAo=
 github.com&#47;supranational&#47;blst v0.3.11 h1:LyU6FolezeWAhvQk0k6O&#47;d49jqgO52MSDDfYgbeoEm4=
<span class="term-fg36">@@ -616,8 +634,8 @@</span> golang.org&#47;x&#47;crypto v0.0.0-20200622213623-75b288015ac9&#47;go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto=
 golang.org&#47;x&#47;crypto v0.0.0-20200820211705-5c72a883971a&#47;go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto=
 golang.org&#47;x&#47;crypto v0.0.0-20201221181555-eec23a3978ad&#47;go.mod h1:jdWPYTVW3xRLrWPugEBEK3UY2ZEsg3UU495nc5E+M+I=
 golang.org&#47;x&#47;crypto v0.0.0-20210921155107-089bfa567519&#47;go.mod h1:GvvjBRRGRdwPK5ydBHafDWAxML&#47;pGHZbMvKqRZ5+Abc=
<span class="term-fg31">-golang.org&#47;x&#47;crypto v0.17.0 h1:r8bRNjWL3GshPW3gkd+RpvzWrZAwPS49OmTGZ&#47;uhM4k=</span>
<span class="term-fg31">-golang.org&#47;x&#47;crypto v0.17.0&#47;go.mod h1:gCAAfMLgwOJRpTjQ2zCCt2OcSfYMTeZVSRtQlPC7Nq4=</span>
<span class="term-fg32">+golang.org&#47;x&#47;crypto v0.18.0 h1:PGVlW0xEltQnzFZ55hkuX5+KLyrMYhHld1YHO4AKcdc=</span>
<span class="term-fg32">+golang.org&#47;x&#47;crypto v0.18.0&#47;go.mod h1:R0j02AL6hcrfOiy9T4ZYp&#47;rcWeMxM3L6QYxlOuEG1mg=</span>
 golang.org&#47;x&#47;exp v0.0.0-20190121172915-509febef88a4&#47;go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA=
 golang.org&#47;x&#47;exp v0.0.0-20190306152737-a1d7652674e8&#47;go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA=
 golang.org&#47;x&#47;exp v0.0.0-20190510132918-efd6b22b2522&#47;go.mod h1:ZjyILWgesfNpC6sMxTJOJm9Kp84zZh5NQWvqDGG3Qr8=
<span class="term-fg36">@@ -777,8 +795,6 @@</span> golang.org&#47;x&#47;sys v0.1.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
 golang.org&#47;x&#47;sys v0.5.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
 golang.org&#47;x&#47;sys v0.8.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
 golang.org&#47;x&#47;sys v0.11.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
<span class="term-fg31">-golang.org&#47;x&#47;sys v0.15.0 h1:h48lPFYpsTvQJZF4EKyI4aLHaev3CxivZmv7yZig9pc=</span>
<span class="term-fg31">-golang.org&#47;x&#47;sys v0.15.0&#47;go.mod h1:&#47;VUhepiaJMQUp4+oa&#47;7Zr1D23ma6VTLIYjOOTFZPUcA=</span>
 golang.org&#47;x&#47;sys v0.16.0 h1:xWw16ngr6ZMtmxDyKyIgsE93KNKz5HKmMa3b8ALHidU=
 golang.org&#47;x&#47;sys v0.16.0&#47;go.mod h1:&#47;VUhepiaJMQUp4+oa&#47;7Zr1D23ma6VTLIYjOOTFZPUcA=
 golang.org&#47;x&#47;term v0.0.0-20201117132131-f5c789dd3221&#47;go.mod h1:Nr5EML6q2oocZ2LXRh80K7BxOlk5&#47;8JxuGnuhpl+muw=</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

                    </div>
                
            </div>
        </main>
    </div>

    <footer class="col-xl-10 col-xxl-8 mx-auto px-3 pt-5 my-5 text-muted border-top">
        <p>Fork-diff overview of <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>, a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>.
and execution-engine of the <a href="https://github.com/ethereum-optimism/optimism">OP-stack</a>.</p>

    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const storedTheme = localStorage.getItem('theme')

        // Get the preferred theme from the user's OS
        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        // Set the bootstrap theme
        const setTheme = function (theme) {
            document.documentElement.setAttribute('data-bs-theme', theme)
            if (theme === 'dark') {
                document.getElementById('dark-mode-toggle').setAttribute('checked', true)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-high-fill', 'bi-brightness-low')
            } else {
                document.getElementById('dark-mode-toggle').setAttribute('checked', false)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-low', 'bi-brightness-high-fill')
            }
        }

        // Returns true if the current theme is dark
        const isDark = () => {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark'
        }

        // Toggles dark mode
        const toggleDarkMode = () => {
            const newTheme = isDark() ? 'light' : 'dark'
            setTheme(newTheme)
            localStorage.setItem('theme', newTheme)
        }

        // Set the preferred theme on page load
        window.onload = () => {
            // Set preferred theme
            setTheme(getPreferredTheme());
            // Initialize tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        // Toggle dark mode when the toggle button is clicked
        addEventListener("click", (event) => {
            if (event.target.id === 'dark-mode-toggle') {
                toggleDarkMode();
                // De-focus the toggle
                document.activeElement.blur()
            }
        });
    </script>
</body>
</html>
